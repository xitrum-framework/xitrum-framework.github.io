
<!DOCTYPE html>

<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>документация Xitrum Scala Web Framework Guide 3.30.0</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="Алфавитный указатель" href="genindex.html" />
    <link rel="search" title="Поиск" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Навигация</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="#">документация Xitrum Scala Web Framework Guide 3.30.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">документация Xitrum Scala Web Framework Guide 3.30.0</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="xitrum-guide">
<h1>Xitrum Guide<a class="headerlink" href="#xitrum-guide" title="Ссылка на этот заголовок">¶</a></h1>

<p>
  <a href="../../xitrum-ru.pdf" title="PDF" style="float:left"><img src="../../../pdf-ru.png"/></a>
  <a href="../../xitrum-ru.pdf" title="PDF">Скачать PDF</a></p>
</p>
<div style="clear:both"></div>


<p>
  <a href="../../xitrum-ru.pdf" title="PDF" style="float:left"><img src="../../../pdf-ru.png"/></a>
  <a href="../../xitrum-ru.pdf" title="PDF">Скачать PDF</a></p>
</p>
<div style="clear:both"></div>

<p><a class="reference external" href="http://xitrum-framework.github.io/guide.html">Есть также английский, японский, корейский и вьетнамский версии.</a></p>
<div class="toctree-wrapper compound">
<span id="document-intro"></span><div class="section" id="id1">
<h2>Введение<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--------------------+</span>
<span class="o">|</span>      <span class="n">Клиенты</span>       <span class="o">|</span>
<span class="o">+--------------------+</span>
          <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span>       <span class="n">Netty</span>        <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span>       <span class="n">Xitrum</span>       <span class="o">|</span>
<span class="o">|</span> <span class="o">+----------------+</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span> <span class="n">HTTP</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="n">Сервер</span> <span class="o">|</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">|----------------|</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span> <span class="n">Web</span> <span class="n">фреймворк</span>  <span class="o">|</span> <span class="o">|</span>  <span class="o">&lt;-</span> <span class="n">Akka</span><span class="p">,</span> <span class="n">Hazelcast</span> <span class="o">-&gt;</span> <span class="n">Другие</span> <span class="n">экземпляры</span>
<span class="o">|</span> <span class="o">+----------------+</span> <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span>     <span class="n">Приложение</span>     <span class="o">|</span>
<span class="o">+--------------------+</span>
</pre></div>
</div>
<p>Xitrum - асинхронный и масштабируемый Scala веб фреймворк и HTTP(S) сервер. Он построен
на базе <a class="reference external" href="http://netty.io/">Netty</a> и <a class="reference external" href="http://akka.io/">Akka</a>.</p>
<p>Из отзывов <a class="reference external" href="https://groups.google.com/group/xitrum-framework/msg/d6de4865a8576d39">пользователей</a>:</p>
<blockquote>
<div><p>Wow, this is a really impressive body of work, arguably the most
complete Scala framework outside of Lift (but much easier to use).</p>
<p><a class="reference external" href="http://xitrum-framework.github.io/">Xitrum</a> is truly a full stack web framework, all the bases are covered,
including wtf-am-I-on-the-moon extras like ETags, static file cache
identifiers &amp; auto-gzip compression. Tack on built-in JSON converter,
before/around/after interceptors, request/session/cookie/flash scopes,
integrated validation (server &amp; client-side, nice), built-in cache
layer (<a class="reference external" href="http://www.hazelcast.org/">Hazelcast</a>), i18n a la GNU gettext, Netty (with Nginx, hello
blazing fast), etc. and you have, wow.</p>
</div></blockquote>
<div class="section" id="id3">
<h3>Возможности<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<ul class="simple">
<li><p>Безопасный относительно типов (typesafe) во всех отношениях где это возможно.</p></li>
<li><p>Полностью асинхронный. Необязательно слать ответ на запрос немедленно, можно запустить сложные вычисления и дать ответ, когда он будет готов. Поддерживаются Long polling, chunked response, WebSockets, SockJs, EventStream.</p></li>
<li><p>Встроенный веб сервер основан на высоко производительном <a class="reference external" href="http://netty.io/">Netty</a>, отдача статических файлов сравнима по производительности с <a class="reference external" href="https://gist.github.com/3293596">Nginx</a>.</p></li>
<li><p>Обширные возможности для кэширования как на серверной так и на клиентской стороне.
На уровне сервера файлы маленького размера сохраняются в памяти, большие файлы пересылаются с использованием NIO’s zero copy.
На уровне фреймворка есть возможность сохранить в кэш страницу, действие (action) или объект в стиле Rails.
Учтены рекомендации <a class="reference external" href="http://code.google.com/speed/page-speed/docs/rules_intro.html">Google</a>.
Ревалидация кэша возможна в любой момент.</p></li>
<li><p>Для статических файлов поддерживаются <a class="reference external" href="http://en.wikipedia.org/wiki/Byte_serving">Range запросы</a>. Эта функция необходима для отдачи видео файлов.</p></li>
<li><p>Поддержка <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>.</p></li>
<li><p>Автоматический расчет маршрутов (routes) приложения в стиле JAX-RS и Rails. Нет необходимости в объявлении маршрутов в каком-либо файле. Благодаря этому Xitrum позволяет объединять несколько приложений в одно. Все маршруты из jar файлов объединяются и работают как единое приложение.</p></li>
<li><p>Обратная маршрутизация: генерация ссылок на контроллеры и действия.</p></li>
<li><p>Генерация документации на основе <a class="reference external" href="http://swagger.wordnik.com/">Swagger Doc</a>.</p></li>
<li><p>Автоматическая перезагрузка классов и маршрутов при изменении (не требует перезапуска сервера).</p></li>
<li><p>Представления (views) могут быть созданы с использованием <a class="reference external" href="http://scalate.fusesource.org/">Scalate</a>, Scala или xml (во всех случаях происходит проверка типов на этапе компиляции).</p></li>
<li><p>Сессии могут хранится в куках или кластеризованны, например, с помощью <a class="reference external" href="http://www.hazelcast.org/">Hazelcast</a>.</p></li>
<li><p>Встроенная валидация с <a class="reference external" href="http://jqueryvalidation.org/">jQuery</a> (опционально).</p></li>
<li><p>i18n на основе <a class="reference external" href="http://en.wikipedia.org/wiki/GNU_gettext">GNU gettext</a>. Автоматическая генерация pot файлов из исходников. gettext поддерживает множественные и единственные формы числа.</p></li>
</ul>
<p>Идеологически Xitrum находится между <a class="reference external" href="https://github.com/scalatra/scalatra">Scalatra</a>
и <a class="reference external" href="http://liftweb.net/">Lift</a>: более функциональный чем Scalatra и гораздо проще чем Lift. Вы можете очень просто создавать RESTful APIs и postbacks. <a class="reference external" href="http://xitrum-framework.github.io/">Xitrum</a>
является controller-first фреймворком.</p>
<p><a class="reference internal" href="index.html#document-deps"><span class="doc">Связанные сcылки</span></a> список демонстрационных проектов, плагинов и прочее.</p>
</div>
<div class="section" id="id7">
<h3>Авторы<a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h3>
<p><a class="reference external" href="http://xitrum-framework.github.io/">Xitrum</a> - проект с открытым <a class="reference external" href="https://github.com/xitrum-framework/xitrum">исходным кодом</a> проект, вступайте в официальную <a class="reference external" href="http://groups.google.com/group/xitrum-framework">Google группу</a>.</p>
<p>Авторы в списке упорядочены по времени их
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/graphs/contributors">первого вклада в проект</a>.</p>
<p>(*): Участники команды разработки Xitrum.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ngocdaothanh">Ngoc Dao (*)</a></p></li>
<li><p><a class="reference external" href="https://github.com/alide">Linh Tran</a></p></li>
<li><p><a class="reference external" href="https://github.com/earldouglas">James Earl Douglas</a></p></li>
<li><p><a class="reference external" href="https://github.com/caiiiycuk">Aleksander Guryanov</a></p></li>
<li><p><a class="reference external" href="https://github.com/georgeOsdDev">Takeharu Oshida (*)</a></p></li>
<li><p><a class="reference external" href="https://github.com/kimkha">Nguyen Kim Kha</a></p></li>
<li><p><a class="reference external" href="https://github.com/murz">Michael Murray</a></p></li>
</ul>
</div>
</div>
<span id="document-tutorial"></span><div class="section" id="id1">
<h2>Как начать<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Эта глава описывает как создать и запустить Xitrum проект.
<strong>Предполагается что вы знакомы с операционной системой Linux и у вас установлена Java.</strong></p>
<div class="section" id="xitrum">
<h3>Создание пустого проекта Xitrum<a class="headerlink" href="#xitrum" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для создания проекта, скачайте файл
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/archive/master.zip">xitrum-new.zip</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">zip</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
<p>или:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="o">-</span><span class="n">o</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">zip</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Запуск<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Сложившийся стандарт запуска Scala проектов - использование
<a class="reference external" href="https://github.com/harrah/xsbt/wiki/Setup">SBT</a>. Проект созданный из шаблона уже включает
SBT в директории <code class="docutils literal notranslate"><span class="pre">sbt</span></code>. Если вы хотите установить SBT самостоятельно, воспользуйтесь
<a class="reference external" href="https://github.com/harrah/xsbt/wiki/Setup">руководством</a>.</p>
<p>Перейдите в директорию созданного проекта и выполните команду <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">fgRun</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unzip</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">zip</span>
<span class="n">cd</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span>
<span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="n">fgRun</span>
</pre></div>
</div>
<p>Данная команда выполнит скачивание всех <a class="reference internal" href="index.html#document-deps"><span class="doc">зависимостей</span></a>, компиляцию проекта
и запуск main-класса <code class="docutils literal notranslate"><span class="pre">quickstart.Boot</span></code>, который запустит сервер. В консоль будут напечатаны все
маршруты (routes) проекта:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Load</span> <span class="n">routes</span><span class="o">.</span><span class="n">cache</span> <span class="ow">or</span> <span class="n">recollect</span> <span class="n">routes</span><span class="o">...</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Normal</span> <span class="n">routes</span><span class="p">:</span>
<span class="n">GET</span>  <span class="o">/</span>  <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">SiteIndex</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">SockJS</span> <span class="n">routes</span><span class="p">:</span>
<span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span>  <span class="n">xitrum</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">XitrumMetricsChannel</span>  <span class="n">websocket</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">cookie_needed</span><span class="p">:</span> <span class="n">false</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Error</span> <span class="n">routes</span><span class="p">:</span>
<span class="mi">404</span>  <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">NotFoundError</span>
<span class="mi">500</span>  <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">ServerError</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Xitrum</span> <span class="n">routes</span><span class="p">:</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">webjars</span><span class="o">/</span><span class="n">swagger</span><span class="o">-</span><span class="n">ui</span><span class="o">/</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">17</span><span class="o">/</span><span class="n">index</span>                            <span class="n">xitrum</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">SwaggerUiVersioned</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">xitrum</span><span class="o">.</span><span class="n">js</span>                                           <span class="n">xitrum</span><span class="o">.</span><span class="n">js</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span>                                     <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">Greeting</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">eventsource</span>    <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">EventSourceReceive</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">htmlfile</span>       <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">HtmlFileReceive</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">jsonp</span>          <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">JsonPPollingReceive</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">jsonp_send</span>     <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">JsonPPollingSend</span>
<span class="n">WEBSOCKET</span>  <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">websocket</span>      <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">WebSocket</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">xhr</span>            <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">XhrPollingReceive</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">xhr_send</span>       <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">XhrSend</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">xhr_streaming</span>  <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">XhrStreamingReceive</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="n">info</span>                                <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">InfoGET</span>
<span class="n">WEBSOCKET</span>  <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="n">websocket</span>                           <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">RawWebSocket</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">viewer</span>                                      <span class="n">xitrum</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">XitrumMetricsViewer</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">iframe</span>                             <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">Iframe</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">websocket</span>      <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">WebSocketGET</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">websocket</span>      <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">WebSocketPOST</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">started</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">8000</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">HTTPS</span> <span class="n">server</span> <span class="n">started</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">4430</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Xitrum</span> <span class="n">started</span> <span class="ow">in</span> <span class="n">development</span> <span class="n">mode</span>
</pre></div>
</div>
<p>Во время запуска, все маршруты будут собраны и напечатаны в лог. Это очень удобно
иметь список всех маршрутов проекта, если вы планируете написать документацию для своего
RESTful API.</p>
<p>Откройте <a class="reference external" href="http://localhost:8000/">http://localhost:8000/</a> или <a class="reference external" href="https://localhost:4430/">https://localhost:4430/</a> в браузере. В консоль будет
напечатана информация о запросе:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">GET</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">SiteIndex</span><span class="p">,</span> <span class="mi">1</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="eclipse">
<h3>Импорт проекта в Eclipse<a class="headerlink" href="#eclipse" title="Ссылка на этот заголовок">¶</a></h3>
<p><a class="reference external" href="http://scala-ide.org/">Использование Eclipse для написания Scala кода</a>.</p>
<p>Из директории проекта выполните команду:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="n">eclipse</span>
</pre></div>
</div>
<p>Файл Eclipse проекта  <code class="docutils literal notranslate"><span class="pre">.project</span></code> будет создан из описание проекта <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>.
Откройте Eclipse и импортируйте созданный проект.</p>
</div>
<div class="section" id="intellij">
<h3>Импорт проекта в IntelliJ<a class="headerlink" href="#intellij" title="Ссылка на этот заголовок">¶</a></h3>
<p><a class="reference external" href="http://www.jetbrains.com/idea/">IntelliJ</a>, поддерживает Scala на очень хорошем уровне.</p>
<p>С установленным его Scala плагин, просто откройте свой проект SBT,
Вам не нужно для создания файлов проекта, как с Eclipse.</p>
</div>
<div class="section" id="id5">
<h3>Автоматическая перезагрузка<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum позволяет перезагружать .class файлы (hot swap) без перезапуска программы.
Однако, что бы избежать проблем с производительностью и получить более стабильное
приложение, эта функция должна быть использована только в режиме разработчика
(development mode).</p>
<div class="section" id="ide">
<h4>Запуск в IDE<a class="headerlink" href="#ide" title="Ссылка на этот заголовок">¶</a></h4>
<p>Во время разработки в IDE на подобии Eclipse или IntelliJ, автоматически будет происходить
перезагрузка кода.</p>
</div>
<div class="section" id="id6">
<h4>Запуск в SBT<a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h4>
<p>При использовании SBT, нужно открыть две консоли:</p>
<ul class="simple">
<li><p>В первой выполните <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">fgRun</span></code>. Эта команда запустить программу и будет
перезагружать .class файлы когда они изменятся.</p></li>
<li><p>Во второй <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">~compile</span></code>. При изменении исходных файлов они будут автоматически
компилироваться в .class файлы.</p></li>
</ul>
<p>В директории sbt расположен <a class="reference external" href="https://github.com/xitrum-framework/agent7">agent7.jar</a>.
Его задача заключается в перезагрузке .class файлов в рабочей директории (и под директориях).
Внутри скрипта <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span></code>, agent7.jar подключается специальной опцией <code class="docutils literal notranslate"><span class="pre">-javaagent:agent7.jar</span></code>.</p>
</div>
<div class="section" id="dcevm">
<h4>DCEVM<a class="headerlink" href="#dcevm" title="Ссылка на этот заголовок">¶</a></h4>
<p>Обычно JVM позволяет перезагружать только тела методов. Вы можете использовать
<a class="reference external" href="https://github.com/dcevm/dcevm">DCEVM</a> - открытую модификацию Java HotSpot VM,
которая позволяет полностью перезагружать классы.</p>
<p>Вы можете установить DCEVM двумя способами:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/dcevm/dcevm/releases">Изменить</a> существующую установку Java.</p></li>
<li><p>Установить <a class="reference external" href="http://dcevm.nentjes.com/">собранную</a> версию (проще).</p></li>
</ul>
<p>В первом варианте:</p>
<ul class="simple">
<li><p>DCEVM будет включен постоянно.</p></li>
<li><p>Или будет установлен в качестве «альтернативной» JVM. В этом случае, что бы включить
DCEVM, при запуске <code class="docutils literal notranslate"><span class="pre">java</span></code> нужно указывать опцию <code class="docutils literal notranslate"><span class="pre">-XXaltjvm=dcevm</span></code>.
Например, вам нужно добавить <code class="docutils literal notranslate"><span class="pre">-XXaltjvm=dcevm</span></code> в скрипт <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span></code>.</p></li>
</ul>
<p>Если вы используете IDE (например, Eclipse или IntelliJ), вам нужно настроить
их на использование DCEVM при работе с вашим проектом.</p>
<p>Если вы используете SBT, вам нужно настроить переменную окружения <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
так что бы команда <code class="docutils literal notranslate"><span class="pre">java</span></code> была из DCEVM (не из стандартной JVM). Вам
так же нужен <code class="docutils literal notranslate"><span class="pre">javaagent</span></code> описанный выше, поскольку DCEVM поддерживает изменения классов,
но сам их не перезагружает.</p>
<p>Смотри <a class="reference external" href="http://javainformed.blogspot.jp/2014/01/jrebel-free-alternative.html">DCEVM - бесплатная альтернатива JRebel</a>.</p>
</div>
</div>
<div class="section" id="id10">
<h3>Список игнорируемых файлов<a class="headerlink" href="#id10" title="Ссылка на этот заголовок">¶</a></h3>
<p>При создании проекта <a class="reference internal" href="index.html#document-tutorial"><span class="doc">по шаблону</span></a>, есть ряд файлов которые нужно
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/.gitignore">исключить</a> из системы контроля версий:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.*</span>
<span class="n">log</span>
<span class="n">project</span><span class="o">/</span><span class="n">project</span>
<span class="n">project</span><span class="o">/</span><span class="n">target</span>
<span class="n">target</span>
<span class="n">tmp</span>
</pre></div>
</div>
</div>
</div>
<span id="document-action_view"></span><div class="section" id="id1">
<h2>Контроллеры и представления<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Xitrum располагает тремя видами контроллеров или действий (actions):
стандартный контроллер <code class="docutils literal notranslate"><span class="pre">Action</span></code>, <code class="docutils literal notranslate"><span class="pre">FutureAction</span></code> и актор контроллер <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code>.</p>
<div class="section" id="normal-action">
<h3>Стандартный контроллер (normal action)<a class="headerlink" href="#normal-action" title="Ссылка на этот заголовок">¶</a></h3>
<p>Реализация данного контроллера синхронная.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HelloAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>В случае наследования от xitrum.Action, ваш код будет выполнятся в потоке Netty’s IO.
Это допустимо только в случае если ваш контроллер очень легковесный и не блокирующий
(возвращает ответ немедленно). Иначе Netty не сможет принимать новые подключения или
отправлять запросы клиентам.</p>
</div>
<div class="section" id="futureaction">
<h3>FutureAction<a class="headerlink" href="#futureaction" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.FutureAction</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HelloAction</span> <span class="n">extends</span> <span class="n">FutureAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>В случае наследования от xitrum.FutureAction, код контроллера будет выполнятся в отдельном потоке (в том же пуле что и <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code>) не занимая потоки Netty.</p>
</div>
<div class="section" id="actor-action">
<h3>Актор контроллер (actor action)<a class="headerlink" href="#actor-action" title="Ссылка на этот заголовок">¶</a></h3>
<p>Если вы хотите что бы контроллер был актором Akka наследуйтесь от <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="kn">import</span> <span class="nn">xitrum.ActorAction</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HelloAction</span> <span class="n">extends</span> <span class="n">ActorAction</span> <span class="k">with</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">See</span> <span class="n">Akka</span> <span class="n">doc</span> <span class="n">about</span> <span class="n">scheduler</span>
    <span class="kn">import</span> <span class="nn">context.dispatcher</span>
    <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">scheduleOnce</span><span class="p">(</span><span class="mi">3</span> <span class="n">seconds</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">())</span>

    <span class="o">//</span> <span class="n">See</span> <span class="n">Akka</span> <span class="n">doc</span> <span class="n">about</span> <span class="s2">&quot;become&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">become</span> <span class="p">{</span>
      <span class="n">case</span> <span class="n">pastTime</span> <span class="o">=&gt;</span>
        <span class="n">respondInlineView</span><span class="p">(</span><span class="n">s</span><span class="s2">&quot;It&#39;s $pastTime Unix ms 3s ago.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Экземпляр актора будет создан на каждый запрос. Актор будет остановлен в момент закрытия подключения
или когда ответ будет отправлен клиенту. Для chunked запросов актор будет остановлен когда будет
отправлен последний chunk.</p>
<p>Актор будет выполняться в пуле потоков Akka в системе с именем «xitrum».</p>
</div>
<div class="section" id="id2">
<h3>Отправка ответа клиенту<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Что бы отправить данные клиенту используются функции:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondView</span></code>: при ответе использует шаблон ассоциированный с контроллером</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondInlineView</span></code>: при ответе использует шаблон переданный как аргумент</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondText(&quot;hello&quot;)</span></code>: ответ строкой «plain/text»</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondHtml(&quot;&lt;html&gt;...&lt;/html&gt;&quot;)</span></code>: ответ строкой «text/html»</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJson(List(1,</span> <span class="pre">2,</span> <span class="pre">3))</span></code>: преобразовать Scala объект в JSON и ответить</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJs(&quot;myFunction([1,</span> <span class="pre">2,</span> <span class="pre">3])&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonP(List(1,</span> <span class="pre">2,</span> <span class="pre">3),</span> <span class="pre">&quot;myFunction&quot;)</span></code>: совмещение предыдущих двух</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonPText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;,</span> <span class="pre">&quot;myFunction&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondBinary</span></code>: ответ массивом байт</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondFile</span></code>: переслать файл с использованием техники <a class="reference external" href="http://www.ibm.com/developerworks/library/j-zerocopy/">zero-copy</a>  (aka send-file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondEventSource(&quot;data&quot;,</span> <span class="pre">&quot;event&quot;)</span></code></p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>Шаблонизация<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>Каждый контроллер может быть связан с шаблоном <a class="reference external" href="http://scalate.fusesource.org/">Scalate</a>.
В этом случае при вызове метода <cite>respondView</cite> будет задействован данный шаблон для формирования
ответа.</p>
<p>scr/main/scala/mypackage/MyAction.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>

<span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;myAction&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">what</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="o">=</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>scr/main/scalate/mypackage/MyAction.jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- import mypackage.MyAction

!!! 5
html
  head
    != antiCsrfMeta
    != xitrumCss
    != jsDefaults
    title Welcome to Xitrum

  body
    a(href={url}) Path to the current action
    p= currentAction.asInstanceOf[MyAction].hello(&quot;World&quot;)

    != jsForView
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xitrumCss</span></code> подключает стандартные CSS встроенные в Xitrum. Вы можете убрать их если
они не требуются</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code> подключает jQuery, jQuery Validate и пр. Если используется, вызов должен
быть размешен в секции &lt;head&gt;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jsForView</span></code> использует функцию контроллера <code class="docutils literal notranslate"><span class="pre">jsAddToView</span></code> и  включает JS фаргмент в шаблон.
Если используется, вызов должен быть в конце шаблона</p></li>
</ul>
<p>В шаблонах допускается использование любых методов из трейта <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/Action.scala">xitrum.Action</a>. Дополнительно можно использовать утильные методы Scalate,
такие как <code class="docutils literal notranslate"><span class="pre">unescape</span></code> (см. <a class="reference external" href="http://scalate.fusesource.org/documentation/index.html">Scalate doc</a>).</p>
<p>Синтаксис <a class="reference external" href="http://scalate.fusesource.org/documentation/jade.html">Jade</a> используется по умолчанию для Scalate.
Так же вы можете использовать синтаксис <a class="reference external" href="http://scalate.fusesource.org/documentation/mustache.html">Mustache</a>,
<a class="reference external" href="http://scalate.fusesource.org/documentation/scaml-reference.html">Scaml</a> или
<a class="reference external" href="http://scalate.fusesource.org/documentation/ssp-reference.html">Ssp</a>.
Что бы установить предпочитаемый синтаксис, отредактируйте файл xitrum.conf в директории config.</p>
<p>Кроме этого, метод <cite>respondView</cite> позволяет переопределять синтаксис шаблона.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondView</span><span class="p">(</span><span class="n">Map</span><span class="p">(</span><span class="s2">&quot;type&quot;</span> <span class="o">-&gt;</span><span class="s2">&quot;mustache&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="currentaction">
<h4>currentAction и приведение типов<a class="headerlink" href="#currentaction" title="Ссылка на этот заголовок">¶</a></h4>
<p>Если известен подкласс контроллера который используется с шаблоном, то можно выполнить
приведение <code class="docutils literal notranslate"><span class="pre">currentAction</span></code> к этому подклассу.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="o">=</span> <span class="n">currentAction</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="p">[</span><span class="n">MyAction</span><span class="p">]</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Или так:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">val</span> <span class="n">myAction</span> <span class="o">=</span> <span class="n">currentAction</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="p">[</span><span class="n">MyAction</span><span class="p">];</span> <span class="kn">import</span> <span class="nn">myAction._</span>

<span class="n">p</span><span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;Scala&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;Xitrum&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4>Mustache<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h4>
<p>Важно:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://mustache.github.com/mustache.5.html">Mustache syntax</a></p></li>
<li><p><a class="reference external" href="http://scalate.fusesource.org/documentation/mustache.html">Scalate implementation</a></p></li>
</ul>
<p>Mustache намеренно ограничивает возможности шаблонизации до минимума логики. Поэтому многие
возможности используемые в Jade не применимы в Mustache.</p>
<p>Для передачи моделей из контроллера в шаблон необходимо использовать <code class="docutils literal notranslate"><span class="pre">at</span></code>:</p>
<p>Контролер:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">at</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="s2">&quot;Jack&quot;</span>
<span class="n">at</span><span class="p">(</span><span class="s2">&quot;xitrumCss&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">xitrumCss</span>
</pre></div>
</div>
<p>Шаблон Mustache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Мое</span> <span class="n">имя</span> <span class="p">{{</span><span class="n">name</span><span class="p">}}</span>
<span class="p">{{</span><span class="n">xitrumCss</span><span class="p">}}</span>
</pre></div>
</div>
<p>Примечание: следующие слова зарезервированы и не могут быть использованы
как ключ в <code class="docutils literal notranslate"><span class="pre">at</span></code>:</p>
<ul class="simple">
<li><p>«context»: Scalate объект предоставляющий методы <code class="docutils literal notranslate"><span class="pre">unescape</span></code> и пр.</p></li>
<li><p>«helper»: текущий контроллер</p></li>
</ul>
</div>
<div class="section" id="coffeescript">
<h4>CoffeeScript<a class="headerlink" href="#coffeescript" title="Ссылка на этот заголовок">¶</a></h4>
<p>Scalate позволяет включать CoffeeScript в шаблоны
<a class="reference external" href="http://scalate.fusesource.org/documentation/jade-syntax.html#filters">:coffeescript filter</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">body</span>
  <span class="p">:</span><span class="n">coffeescript</span>
    <span class="n">alert</span> <span class="s2">&quot;Hello, Coffee!&quot;</span>
</pre></div>
</div>
<p>Результат:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;body&gt;
  &lt;script type=&#39;text/javascript&#39;&gt;
    //&lt;![CDATA[
      (function() {
        alert(&quot;Hello, Coffee!&quot;);
      }).call(this);
    //]]&gt;
  &lt;/script&gt;
&lt;/body&gt;
</pre></div>
</div>
<p>Однако, эта возможность работает достаточно <a class="reference external" href="http://groups.google.com/group/xitrum-framework/browse_thread/thread/6667a7608f0dc9c7">медленно</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jade</span><span class="o">+</span><span class="n">javascript</span><span class="o">+</span><span class="mi">1</span><span class="n">thread</span><span class="p">:</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
<span class="n">jade</span><span class="o">+</span><span class="n">coffesscript</span><span class="o">+</span><span class="mi">1</span><span class="n">thread</span><span class="p">:</span> <span class="mi">40</span><span class="o">-</span><span class="mi">70</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
<span class="n">jade</span><span class="o">+</span><span class="n">javascript</span><span class="o">+</span><span class="mi">100</span><span class="n">threads</span><span class="p">:</span> <span class="o">~</span><span class="mi">40</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
<span class="n">jade</span><span class="o">+</span><span class="n">coffesscript</span><span class="o">+</span><span class="mi">100</span><span class="n">threads</span><span class="p">:</span> <span class="mi">400</span><span class="o">-</span><span class="mi">700</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
</pre></div>
</div>
<p>Рекомендуется самостоятельно компилировать CoffeeScript в JavaScript для оптимизации производительности.</p>
</div>
</div>
<div class="section" id="layout">
<h3>Макет (Layout)<a class="headerlink" href="#layout" title="Ссылка на этот заголовок">¶</a></h3>
<p>При использовании <code class="docutils literal notranslate"><span class="pre">respondView</span></code> или <code class="docutils literal notranslate"><span class="pre">respondInlineView</span></code>, Xitrum
выполняет шаблонизацию в строку, и присваивает результат в переменную <code class="docutils literal notranslate"><span class="pre">renderedView</span></code>.
Затем, Xitrum вызывает метод <code class="docutils literal notranslate"><span class="pre">layout</span></code> текущего контроллера и отправляет результат работы
этого метода как ответ сервера.</p>
<p>По умолчанию метод <code class="docutils literal notranslate"><span class="pre">layout</span></code> просто возвращает переменную <code class="docutils literal notranslate"><span class="pre">renderedView</span></code>.
В случае перекрытия этого метода появляется возможность декорировать шаблон.
Таким образом достаточно просто реализовать произвольный макет (layout) для всех контроллеров.</p>
<p>Механизм <code class="docutils literal notranslate"><span class="pre">layout</span></code> очень простой и понятный. Никакой магии. Для удобства, вы можете
думать что Xitrum не поддерживает макеты (layout), есть только метод <code class="docutils literal notranslate"><span class="pre">layout</span></code> и вы вольны
делать с ним все что захотите.</p>
<p>Обычно, создается базовый класс для реализация стандартного макета:</p>
<p>src/main/scala/mypackage/AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>
<span class="kn">import</span> <span class="nn">xitrum.Action</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">renderViewNoLayout</span><span class="p">[</span><span class="n">AppAction</span><span class="p">]()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>src/main/scalate/mypackage/AppAction.jade</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!!! 5
html
  head
    != antiCsrfMeta
    != xitrumCss
    != jsDefaults
    title Welcome to Xitrum

  body
    != renderedView
    != jsForView
</pre></div>
</div>
<p>src/main/scala/mypackage/MyAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;myAction&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">what</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="o">=</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>scr/main/scalate/mypackage/MyAction.jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="kn">import</span> <span class="nn">mypackage.MyAction</span>

<span class="n">a</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">})</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">action</span>
<span class="n">p</span><span class="o">=</span> <span class="n">currentAction</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="p">[</span><span class="n">MyAction</span><span class="p">]</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="id6">
<h4>Макет в отдельном файле<a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h4>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="respondview">
<h4>Использование макета непосредственно в respondView<a class="headerlink" href="#respondview" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">specialLayout</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>
  <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>

<span class="n">respondView</span><span class="p">(</span><span class="n">specialLayout</span> <span class="n">_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id7">
<h3>Внутренние представления<a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h3>
<p>Обычно, шаблон описывается в отдельном файле, но существует возможность писать
шаблоны непосредственно в контроллере:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import xitrum.Action
import xitrum.annotation.GET

@GET(&quot;myAction&quot;)
class MyAction extends Action {
  def execute() {
    val s = &quot;World&quot;  // Will be automatically HTML-escaped
    respondInlineView(
      &lt;p&gt;Hello &lt;em&gt;{s}&lt;/em&gt;!&lt;/p&gt;
    )
  }
}
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>Фрагменты<a class="headerlink" href="#id8" title="Ссылка на этот заголовок">¶</a></h3>
<p>MyAction.jade:
<code class="docutils literal notranslate"><span class="pre">scr/main/scalate/mypackage/MyAction.jade</span></code></p>
<p>Шаблонизация с помощью фрагмента
<code class="docutils literal notranslate"><span class="pre">scr/main/scalate/mypackage/_MyFragment.jade</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">renderFragment</span><span class="p">[</span><span class="n">MyAction</span><span class="p">](</span><span class="s2">&quot;MyFragment&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Можно записать короче, если <code class="docutils literal notranslate"><span class="pre">MyAction</span></code> - текущий контроллер:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">renderFragment</span><span class="p">(</span><span class="s2">&quot;MyFragment&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3>Использование шаблона смежного контроллера<a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h3>
<p>Использование метода <code class="docutils literal notranslate"><span class="pre">respondView[ClassName]()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>

<span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">POST</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginFormAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Respond</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">LoginFormAction</span><span class="o">.</span><span class="n">jade</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DoLoginAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">authenticated</span> <span class="o">=</span> <span class="o">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">authenticated</span><span class="p">)</span>
      <span class="n">redirectTo</span><span class="p">[</span><span class="n">HomeAction</span><span class="p">]()</span>
    <span class="k">else</span>
      <span class="o">//</span> <span class="n">Reuse</span> <span class="n">the</span> <span class="n">view</span> <span class="n">of</span> <span class="n">LoginFormAction</span>
      <span class="n">respondView</span><span class="p">[</span><span class="n">LoginFormAction</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id10">
<h4>Один контроллер - много представлений<a class="headerlink" href="#id10" title="Ссылка на этот заголовок">¶</a></h4>
<p>Использование нескольких шаблонов для одного контроллера:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>

<span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="o">//</span> <span class="n">Шаблоны</span> <span class="n">автоматически</span> <span class="n">не</span> <span class="n">маршрутизируются</span>
<span class="o">//</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">HomeAction_NormalUser</span><span class="o">.</span><span class="n">jade</span>
<span class="o">//</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">HomeAction_Moderator</span><span class="o">.</span><span class="n">jade</span>
<span class="o">//</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">HomeAction_Admin</span><span class="o">.</span><span class="n">jade</span>
<span class="n">trait</span> <span class="n">HomeAction_NormalUser</span> <span class="n">extends</span> <span class="n">Action</span>
<span class="n">trait</span> <span class="n">HomeAction_Moderator</span>  <span class="n">extends</span> <span class="n">Action</span>
<span class="n">trait</span> <span class="n">HomeAction_Admin</span>      <span class="n">extends</span> <span class="n">Action</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HomeAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">userType</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">userType</span> <span class="n">match</span> <span class="p">{</span>
      <span class="n">case</span> <span class="n">NormalUser</span> <span class="o">=&gt;</span> <span class="n">respondView</span><span class="p">[</span><span class="n">HomeAction_NormalUser</span><span class="p">]()</span>
      <span class="n">case</span> <span class="n">Moderator</span>  <span class="o">=&gt;</span> <span class="n">respondView</span><span class="p">[</span><span class="n">HomeAction_Moderator</span><span class="p">]()</span>
      <span class="n">case</span> <span class="n">Admin</span>      <span class="o">=&gt;</span> <span class="n">respondView</span><span class="p">[</span><span class="n">HomeAction_Admin</span><span class="p">]()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Использование дополнительных не автоматических маршрутов выглядит утомительно, однако
это более безопасно относительно типов (typesafe).</p>
<p>Вы также можете использовать `` String`` указать местоположение шаблона:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondView</span><span class="p">(</span><span class="s2">&quot;mypackage/HomeAction_NormalUser&quot;</span><span class="p">)</span>
<span class="n">respondView</span><span class="p">(</span><span class="s2">&quot;mypackage/HomeAction_Moderator&quot;</span><span class="p">)</span>
<span class="n">respondView</span><span class="p">(</span><span class="s2">&quot;mypackage/HomeAction_Admin&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h3>Компонент<a class="headerlink" href="#id11" title="Ссылка на этот заголовок">¶</a></h3>
<p>Компоненты позволяют создавать переиспользуемое поведение и могут быть включены
во множество представлений. Концептуально компонент очень близок к контроллеру, но:</p>
<ul class="simple">
<li><p>Не имеет маршрутов, поэтому отсутствует метод <code class="docutils literal notranslate"><span class="pre">execute</span></code>.</p></li>
<li><p>Компонент не отправляет ответ сервера, он просто выполняет шаблонизацию фрагмента.
Поэтому внутри компонента, вместо вызовов <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code>, необходимо использовать <code class="docutils literal notranslate"><span class="pre">renderXXX</span></code>.</p></li>
<li><p>Как и контроллеры, компонент может иметь ни одного, одно или множество связанных представлений.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>package mypackage

import xitrum.{FutureAction, Component}
import xitrum.annotation.GET

class CompoWithView extends Component {
  def render() = {
    // Render associated view template, e.g. CompoWithView.jade
    // Note that this is renderView, not respondView!
    renderView()
  }
}

class CompoWithoutView extends Component {
  def render() = {
    &quot;Hello World&quot;
  }
}

@GET(&quot;foo/bar&quot;)
class MyAction extends FutureAction {
  def execute() {
    respondView()
  }
}
</pre></div>
</div>
<p>MyAction.jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="kn">import</span> <span class="nn">mypackage._</span>

<span class="o">!=</span> <span class="n">newComponent</span><span class="p">[</span><span class="n">CompoWithView</span><span class="p">]()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="o">!=</span> <span class="n">newComponent</span><span class="p">[</span><span class="n">CompoWithoutView</span><span class="p">]()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<span id="document-restful"></span><div class="section" id="restful-apis">
<h2>RESTful APIs<a class="headerlink" href="#restful-apis" title="Ссылка на этот заголовок">¶</a></h2>
<p>Разработка RESTful APIs с использованием Xitrum.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesIndex</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Подобным образом описываются POST, PUT, PATCH, DELETE, и OPTIONS запросы.
Xitrum автоматически обрабатывает HEAD запросы как GET с пустым ответом.</p>
<p>Для HTTP клиентов не поддерживающих PUT и DELETE (например, обычные браузеры), используется метод POST c параметрами <code class="docutils literal notranslate"><span class="pre">_method=put</span></code> или <code class="docutils literal notranslate"><span class="pre">_method=delete</span></code> внутри тела запроса.</p>
<p>При старте веб приложения, Xitrum сканирует аннотации, создает таблицу маршрутизации
и печатает ее в лог. Из лога понятно какое API приложение поддерживает на данный момент:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Routes</span><span class="p">:</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">articles</span>     <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">ArticlesIndex</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="p">:</span><span class="nb">id</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">ArticlesShow</span>
</pre></div>
</div>
<p>Маршруты (routes) автоматически строятся в духе JAX-RS и Rails. Нет необходимости
объявлять все маршруты в одном месте. Допускается включать одно приложение в другое.
Например, движок блога можно упаковать в JAR файл и подключить его в другое приложение,
после этого у приложения появятся все возможности блога. Маршрутизация осуществляется
в два направления, можно генерировать URL по контроллеру (обратная маршрутизация).
Автоматическое документирование ваших маршрутов можно выполнить используя
<a class="reference external" href="http://swagger.wordnik.com/">Swagger Doc</a>.</p>
<div class="section" id="id1">
<h3>Кэш маршрутов<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для более быстро скорости запуска, маршруты кэшируются в файл <code class="docutils literal notranslate"><span class="pre">routes.cache</span></code>.
В режиме разработчика, этот файл не используется. В случае изменения зависимостей
содержащих маршруты, необходимо удалить <code class="docutils literal notranslate"><span class="pre">routes.cache</span></code>. Этот файл не должен попасть
в ваши систему контроля версий.</p>
</div>
<div class="section" id="id2">
<h3>Очередность маршрутов<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Возможно вам потребуется организовать маршруты в определенном порядке.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="p">:</span><span class="nb">id</span> <span class="o">--&gt;</span> <span class="n">ArticlesShow</span>
<span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">new</span> <span class="o">--&gt;</span> <span class="n">ArticlesNew</span>
</pre></div>
</div>
<p>В данном случае необходимо что бы второй маршрут был проверен первым.
Для этих целей нужно использовать аннотацию <code class="docutils literal notranslate"><span class="pre">First</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">First</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@First</span>  <span class="o">//</span> <span class="n">This</span> <span class="n">route</span> <span class="n">has</span> <span class="n">higher</span> <span class="n">priority</span> <span class="n">than</span> <span class="s2">&quot;ArticlesShow&quot;</span> <span class="n">above</span>
<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/new&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesNew</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Last</span></code> работает помещает маршрут на обработку последним.</p>
</div>
<div class="section" id="id3">
<h3>Несколько маршрутов для одного контроллера<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image/:format&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Image</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">paramo</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrElse</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Точка в маршруте<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">,</span> <span class="s2">&quot;articles/:id.:format&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="nb">id</span>     <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">paramo</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrElse</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>Регулярные выражения в маршруте<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p>Регулярные выражения могут быть использованы для задания ограничений в маршруте:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&lt;[0-9]+&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>Обработка не стандартных маршрутов<a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h3>
<p>Использование символа <code class="docutils literal notranslate"><span class="pre">/</span></code> не допускается в именах параметров. Если есть необходимость в его
использовании вы можете определить маршрут следующим образом:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;service/:id/proxy/:*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Например, данный маршрут будет обрабатывать запросы:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="mi">123</span><span class="o">/</span><span class="n">proxy</span><span class="o">/</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">foo</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">bar</span>
</pre></div>
</div>
<p>Извлечение значение из части <code class="docutils literal notranslate"><span class="pre">:*</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">url</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>  <span class="o">//</span> <span class="n">Будет</span> <span class="s2">&quot;http://foo.com/bar&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>Ссылка на контроллер<a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum пытается быть достаточно безопасным. Не пишите ссылки самостоятельно (в явном виде).
Используйте генератор ссылок:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">ArticlesShow</span><span class="p">](</span><span class="s2">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">myArticle</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span><span class="o">&gt;</span><span class="p">{</span><span class="n">myArticle</span><span class="o">.</span><span class="n">title</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>Редирект на контроллер<a class="headerlink" href="#id8" title="Ссылка на этот заголовок">¶</a></h3>
<p>Читайте подробнее про <a class="reference external" href="http://en.wikipedia.org/wiki/URL_redirection">редирект</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">POST</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginInput</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DoLogin</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="o">//</span> <span class="n">After</span> <span class="n">login</span> <span class="n">success</span>
    <span class="n">redirectTo</span><span class="p">[</span><span class="n">AdminIndex</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">GET</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AdminIndex</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">user</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">logged</span> <span class="ow">in</span><span class="p">,</span> <span class="n">redirect</span> <span class="n">him</span> <span class="n">to</span> <span class="n">the</span> <span class="n">login</span> <span class="n">page</span>
    <span class="n">redirectTo</span><span class="p">[</span><span class="n">LoginInput</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Допускается делать редирект на тот же самый контроллер с помощью метода <code class="docutils literal notranslate"><span class="pre">redirecToThis()</span></code>.</p>
</div>
<div class="section" id="id10">
<h3>Форвардинг (перенаправление) на контроллер<a class="headerlink" href="#id10" title="Ссылка на этот заголовок">¶</a></h3>
<p>Используйте <code class="docutils literal notranslate"><span class="pre">forwardTo[AnotherAction]()</span></code>. <code class="docutils literal notranslate"><span class="pre">redirectTo</span></code> заставляет браузер делать новый запрос, в то
время как <code class="docutils literal notranslate"><span class="pre">forwardTo</span></code> работает в рамках одного запроса.</p>
</div>
<div class="section" id="ajax">
<h3>Определение Ajax запроса<a class="headerlink" href="#ajax" title="Ссылка на этот заголовок">¶</a></h3>
<p>Используйте <code class="docutils literal notranslate"><span class="pre">isAjax</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">В</span> <span class="n">контроллере</span>
<span class="n">val</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A message&quot;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">isAjax</span><span class="p">)</span>
  <span class="n">jsRender</span><span class="p">(</span><span class="s2">&quot;alert(&quot;</span> <span class="o">+</span> <span class="n">jsEscape</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">respondText</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="anti-csrf">
<h3>Anti-CSRF<a class="headerlink" href="#anti-csrf" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для запросов отличных от GET Xitrum автоматически защищает приложение от
<a class="reference external" href="http://en.wikipedia.org/wiki/CSRF">Cross-site request forgery</a>  атаки.</p>
<p>Включите в шаблон <code class="docutils literal notranslate"><span class="pre">antiCsrfMeta</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Тогда секция <code class="docutils literal notranslate"><span class="pre">&lt;head&gt;</span></code> будет включать в себя csrf-token:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    ...
    &lt;meta name=&quot;csrf-token&quot; content=&quot;5402330e-9916-40d8-a3f4-16b271d583be&quot; /&gt;
    ...
  &lt;/head&gt;
  ...
&lt;/html&gt;
</pre></div>
</div>
<p>Этот токен будет автоматически включен во все Ajax запросы jQuery как заголовок
<code class="docutils literal notranslate"><span class="pre">X-CSRF-Token</span></code> если вы подключите <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/js.scala">xitrum.js</a>. xitrum.js  подключается вызовом <code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code>. Если вы не хотите
использовать <code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code>, вы можете подключить xitrum.js следующим образом (или посылать токен самостоятельно):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">xitrum</span><span class="o">.</span><span class="n">js</span><span class="p">]}</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="anticsrfinput-anticsrftoken">
<h3>antiCsrfInput и antiCsrfToken<a class="headerlink" href="#anticsrfinput-anticsrftoken" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum использует CSRF токен из заголовка запроса с именем <code class="docutils literal notranslate"><span class="pre">X-CSRF-Token</span></code>. Если заголовок
не установлен, Xitrum берет значение из параметра <code class="docutils literal notranslate"><span class="pre">csrf-token</span></code> переданного в теле запроса
(не из URL).</p>
<p>Если вы вручную создаете формы, и не используйте мета тэг и xitrum.js как сказано выше,
то вам нужно использовать методы контроллера <code class="docutils literal notranslate"><span class="pre">antiCsrfInput</span></code> или <code class="docutils literal notranslate"><span class="pre">antiCsrfToken</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">AdminAddGroup</span><span class="p">]})</span>
  <span class="o">!=</span> <span class="n">antiCsrfInput</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">AdminAddGroup</span><span class="p">]})</span>
  <span class="nb">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;csrf-token&quot;</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="n">antiCsrfToken</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="skipcsrfcheck">
<h3>SkipCsrfCheck<a class="headerlink" href="#skipcsrfcheck" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для некоторые API не требуется защита от CSRF атак, в этом случае проще всего
пропустить эту проверку. Для этого дополнительно наследуйте свой контроллер
от трейта xitrum.SkipCsrfCheck:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">SkipCsrfCheck</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.POST</span>

<span class="n">trait</span> <span class="n">Api</span> <span class="n">extends</span> <span class="n">Action</span> <span class="k">with</span> <span class="n">SkipCsrfCheck</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;api/positions&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LogPositionAPI</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;api/todos&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CreateTodoAPI</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>Управление маршрутами<a class="headerlink" href="#id11" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum автоматически собирает маршруты при запуске.
Для управления этими маршрутами используйте
<a class="reference external" href="http://xitrum-framework.github.io/api/3.17/index.html#xitrum.routing.RouteCollection">xitrum.Config.routes</a>.</p>
<p>Например:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Config</span><span class="p">,</span> <span class="n">Server</span><span class="p">}</span>

<span class="nb">object</span> <span class="n">Boot</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Array</span><span class="p">[</span><span class="n">String</span><span class="p">])</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Вы</span> <span class="n">можете</span> <span class="n">поправить</span> <span class="n">маршруты</span> <span class="n">до</span> <span class="n">запуска</span> <span class="n">сервера</span>
    <span class="n">val</span> <span class="n">routes</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">routes</span>

    <span class="o">//</span> <span class="n">Удаление</span> <span class="n">маршрутов</span> <span class="n">относящихся</span> <span class="n">к</span> <span class="n">конкретному</span> <span class="n">классу</span>
    <span class="n">routes</span><span class="o">.</span><span class="n">removeByClass</span><span class="p">[</span><span class="n">MyClass</span><span class="p">]()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">demoVersion</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Удаление</span> <span class="n">маршрутов</span> <span class="n">начинающихся</span> <span class="n">с</span> <span class="n">префикса</span>
      <span class="n">routes</span><span class="o">.</span><span class="n">removeByPrefix</span><span class="p">(</span><span class="s2">&quot;premium/features&quot;</span><span class="p">)</span>

      <span class="o">//</span> <span class="n">Допустимый</span> <span class="n">вариант</span>
      <span class="n">routes</span><span class="o">.</span><span class="n">removeByPrefix</span><span class="p">(</span><span class="s2">&quot;/premium/features&quot;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="o">...</span>

    <span class="n">Server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>Получение полных (сырых) данных запроса<a class="headerlink" href="#id12" title="Ссылка на этот заголовок">¶</a></h3>
<p>Обычно когда mime тип запроса не соответствует <code class="docutils literal notranslate"><span class="pre">application/x-www-form-urlencoded</span></code>,
предполагается что содержимое запроса будет обработано в ручном режиме.</p>
<p>Получение тела запроса в виде строки:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">body</span> <span class="o">=</span> <span class="n">requestContentString</span>
</pre></div>
</div>
<p>JSON:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">myJValue</span> <span class="o">=</span> <span class="n">requestContentJValue</span>  <span class="o">//</span> <span class="o">=&gt;</span> <span class="n">JSON4S</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">json4s</span><span class="o">.</span><span class="n">org</span><span class="p">)</span> <span class="n">JValue</span>
<span class="n">val</span> <span class="n">myMap</span> <span class="o">=</span> <span class="n">xitrum</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromJValue</span><span class="p">[</span><span class="n">Map</span><span class="p">[</span><span class="n">String</span><span class="p">,</span> <span class="n">Int</span><span class="p">]](</span><span class="n">myJValue</span><span class="p">)</span>
</pre></div>
</div>
<p>Если вам нужно получить полный доступ к запросу, используйте <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/FullHttpRequest.html">request.getContent</a>. Он возвращает <a class="reference external" href="http://netty.io/4.0/api/io/netty/buffer/ByteBuf.html">ByteBuf</a>.</p>
</div>
<div class="section" id="api">
<h3>Документирование API<a class="headerlink" href="#api" title="Ссылка на этот заголовок">¶</a></h3>
<p>Из коробки вы можете документировать API и использованием <a class="reference external" href="https://developers.helloreverb.com/swagger/">Swagger</a>.
Добавьте аннотацию <code class="docutils literal notranslate"><span class="pre">&#64;Swagger</span></code> к контроллеру который нужно задокументировать
Xitrum генерирует <a class="reference external" href="https://github.com/wordnik/swagger-core/wiki/API-Declaration">/xitrum/swagger.json</a>.
Этот файл может быть использован в <a class="reference external" href="https://github.com/wordnik/swagger-ui">Swagger UI</a>
для генерации интерактивной документации.</p>
<p>Xitrum включает Swagger UI, по пути <code class="docutils literal notranslate"><span class="pre">/xitrum/swagger-ui</span></code>,
например <a class="reference external" href="http://localhost:8000/xitrum/swagger-ui">http://localhost:8000/xitrum/swagger-ui</a>.</p>
<img alt="_images/swagger.png" src="_images/swagger.png" />
<p>Рассмотрим <a class="reference external" href="https://github.com/xitrum-framework/xitrum-placeholder">пример</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">SkipCsrfCheck</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">Swagger</span><span class="p">}</span>

<span class="nd">@Swagger</span><span class="p">(</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Tags</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;APIs to create images&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Description</span><span class="p">(</span><span class="s2">&quot;Dimensions should not be bigger than 2000 x 2000&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">OptStringQuery</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Text to render on the image, default: Placeholder&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Produces</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;PNG image&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Width or height is invalid or too big&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">trait</span> <span class="n">ImageApi</span> <span class="n">extends</span> <span class="n">Action</span> <span class="k">with</span> <span class="n">SkipCsrfCheck</span> <span class="p">{</span>
  <span class="n">lazy</span> <span class="n">val</span> <span class="n">text</span> <span class="o">=</span> <span class="n">paramo</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrElse</span><span class="p">(</span><span class="s2">&quot;Placeholder&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;image/:width/:height&quot;</span><span class="p">)</span>
<span class="nd">@Swagger</span><span class="p">(</span>  <span class="o">//</span> <span class="o">&lt;--</span> <span class="n">Inherits</span> <span class="n">other</span> <span class="n">info</span> <span class="kn">from</span> <span class="nn">ImageApi</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="s2">&quot;Generate rectangle image&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">IntPath</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">IntPath</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">RectImageApi</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">height</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;image/:width&quot;</span><span class="p">)</span>
<span class="nd">@Swagger</span><span class="p">(</span>  <span class="o">//</span> <span class="o">&lt;--</span> <span class="n">Inherits</span> <span class="n">other</span> <span class="n">info</span> <span class="kn">from</span> <span class="nn">ImageApi</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="s2">&quot;Generate square image&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">IntPath</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">SquareImageApi</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/wordnik/swagger-spec/blob/master/versions/1.2.md">JSON для Swagger</a>
будет генерироваться при доступе <code class="docutils literal notranslate"><span class="pre">/xitrum/swagger</span></code>.</p>
<p>Swagger UI использует эту информацию для генерации интерактивной документации к API.</p>
<p>Возможные параметры на подобии Swagger.IntPath определяются шаблоном:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;Тип</span> <span class="pre">переменной&gt;&lt;Тип</span> <span class="pre">параметра&gt;</span></code> (обязательный параметр)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Opt&lt;Тип</span> <span class="pre">переменной&gt;&lt;Тип</span> <span class="pre">параметра&gt;</span></code> (опциональный параметр)</p></li>
</ul>
<p>Типы переменных: Byte, Int, Int32, Int64, Long, Number, Float, Double, String, Boolean, Date, DateTime</p>
<p>Типы параметров: Path, Query, Body, Header, Form</p>
<p>Подробнее о <a class="reference external" href="https://github.com/wordnik/swagger-core/wiki/Datatypes">типах переменных</a>
и <a class="reference external" href="https://github.com/wordnik/swagger-core/wiki/Parameters">типах параметров</a>.</p>
</div>
</div>
<span id="document-template_engines"></span><div class="section" id="id1">
<h2>Шаблонизация<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Выбранный шаблонизатор используется во время вызова методов <a class="reference internal" href="index.html#document-action_view"><span class="doc">renderView, renderFragment,
или respondView</span></a>.</p>
<div class="section" id="id2">
<h3>Настройка<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>В конфигурационном файле <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a>, шаблонизатор может быть указан двумя способами:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">EngineClassName</span>
</pre></div>
</div>
<p>Или:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="p">{</span>
  <span class="s2">&quot;my.template.EngineClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>По умолчанию используется <a class="reference external" href="https://github.com/xitrum-framework/xitrum-scalate">xitrum-scalate</a> в качестве шаблонизатора.</p>
</div>
<div class="section" id="id3">
<h3>Отключение шаблонизатора<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>В случае если ваш проект предоставляет просто API, обычно шаблонизатор не требуется. В этом случае
допускается убрать шаблонизатор из проекта что бы сделать его легче. Просто удалите
<code class="docutils literal notranslate"><span class="pre">templateEngine</span></code> в config/xitrum.conf.</p>
</div>
<div class="section" id="id4">
<h3>Реализация своего шаблонизатора<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для реализации своего шаблонизатора, создайте класс реализующий <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/view/TemplateEngine.scala">xitrum.view.TemplateEngine</a>.
После этого укажите имя этого класса в конфигурации config/xitrum.conf.</p>
<p>Пример реализации <a class="reference external" href="https://github.com/xitrum-framework/xitrum-scalate">xitrum-scalate</a>.</p>
</div>
</div>
<span id="document-postback"></span><div class="section" id="postbacks">
<h2>Postbacks<a class="headerlink" href="#postbacks" title="Ссылка на этот заголовок">¶</a></h2>
<p>Клиентами веб приложения могут быть:</p>
<ul class="simple">
<li><p>другие приложения или устройства: например, RESTful APIs которое широко используется смартфонами, другими веб сайтами</p></li>
<li><p>люди: например, интерактивные веб сайты предполагающие сложные взаимодействия</p></li>
</ul>
<p>Как фреймворк, Xitrum нацелен на создание легких решений для этих задача.
Для решения первой задачи, используются <a class="reference internal" href="index.html#document-restful"><span class="doc">RESTful контроллеры</span></a>.
Для решения второй задачи, в том числе существует возможность использовать postback.
Подробнее о технологии postback:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://en.wikipedia.org/wiki/Postback">http://en.wikipedia.org/wiki/Postback</a></p></li>
<li><p><a class="reference external" href="http://nitrogenproject.com/doc/tutorial.html">http://nitrogenproject.com/doc/tutorial.html</a></p></li>
</ul>
<p>Реализация в Xitrum’s сделана в стиле <a class="reference external" href="http://nitrogenproject.com/">Nitrogen</a>.</p>
<div class="section" id="id1">
<h3>Шаблон<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h3>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Форма<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Articles.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">POST</span><span class="p">,</span> <span class="n">First</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.validator._</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="nb">id</span>      <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">respondInlineView</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="p">{</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@First</span>  <span class="o">//</span> <span class="n">Этот</span> <span class="n">маршрут</span> <span class="n">будет</span> <span class="n">обработан</span> <span class="n">перед</span> <span class="s2">&quot;show&quot;</span>
<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/new&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesNew</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondInlineView</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="n">form</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">ArticlesCreate</span><span class="p">]}</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">Title</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;title&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;required&quot;</span> <span class="o">/&gt;&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>

        <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">Body</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">textarea</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;body&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;required&quot;</span><span class="o">&gt;&lt;/</span><span class="n">textarea</span><span class="o">&gt;&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>

        <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span> <span class="o">/&gt;</span>
      <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesCreate</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">title</span>   <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">body</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Article has been saved.&quot;</span><span class="p">)</span>
    <span class="n">jsRedirectTo</span><span class="p">(</span><span class="n">show</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>При возникновении события <code class="docutils literal notranslate"><span class="pre">submit</span></code> формы, состояние формы будет отправлено на сервер в контроллер <code class="docutils literal notranslate"><span class="pre">ArticlesCreate</span></code>.</p>
<p>Атрибут <code class="docutils literal notranslate"><span class="pre">action</span></code> формы зашифрован. Зашифрованный URL выступает в роли anti-CSRF токена.</p>
</div>
<div class="section" id="id3">
<h3>Другие элементы (не формы)<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>Postback может быть отправлен для любого элемента, не только для формы.</p>
<p>Вот пример для ссылки:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">postbackUrl</span><span class="p">[</span><span class="n">LogoutAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Переход по ссылке выполнит отправку состояния в LogoutAction.</p>
</div>
<div class="section" id="id4">
<h3>Диалог подтверждения<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h3>
<p>Отображение диалоговых окон подтверждения:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span>
            <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">postbackUrl</span><span class="p">[</span><span class="n">LogoutAction</span><span class="p">]}</span>
            <span class="n">data</span><span class="o">-</span><span class="n">confirm</span><span class="o">=</span><span class="s2">&quot;Do you want to logout?&quot;</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>В случае отказа от продолжения (при нажатии кнопки «Cancel») postback не будет отправлен.</p>
</div>
<div class="section" id="id5">
<h3>Дополнительные параметры<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p>В случае формы вы можете добавлять дополнительные поля <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;...</span></code> для отправки
дополнительных параметров как часть postback.</p>
<p>Для других элементов, вы можете поступать так:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span>
   <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span>
   <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">postbackUrl</span><span class="p">[</span><span class="n">ArticlesDestroy</span><span class="p">](</span><span class="s2">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span>
   <span class="n">data</span><span class="o">-</span><span class="n">params</span><span class="o">=</span><span class="s2">&quot;_method=delete&quot;</span>
   <span class="n">data</span><span class="o">-</span><span class="n">confirm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Do you want to delete </span><span class="si">%s</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)}</span><span class="o">&gt;</span><span class="n">Delete</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Или вы можете поместить дополнительные параметры в смежную форму:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">form</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;myform&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">postbackUrl</span><span class="p">[</span><span class="n">SiteSearch</span><span class="p">]}</span><span class="o">&gt;</span>
  <span class="n">Search</span><span class="p">:</span>
  <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;keyword&quot;</span> <span class="o">/&gt;</span>

  <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;pagination&quot;</span>
     <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span>
     <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span>
     <span class="n">data</span><span class="o">-</span><span class="n">form</span><span class="o">=</span><span class="s2">&quot;#myform&quot;</span>
     <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">postbackUrl</span><span class="p">[</span><span class="n">SiteSearch</span><span class="p">](</span><span class="s2">&quot;page&quot;</span> <span class="o">-&gt;</span> <span class="n">page</span><span class="p">)}</span><span class="o">&gt;</span><span class="p">{</span><span class="n">page</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Используйте селектор <code class="docutils literal notranslate"><span class="pre">#myform</span></code> для получения формы с дополнительными параметрами.</p>
</div>
<div class="section" id="ajax">
<h3>Отображение анимации во время Ajax загрузки<a class="headerlink" href="#ajax" title="Ссылка на этот заголовок">¶</a></h3>
<p>By default, this animated GIF image is displayed while Ajax is loading:</p>
<img alt="_images/ajax_loading.gif" src="_images/ajax_loading.gif" />
<p>To customize, please call this JS snippet after including <code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code> (which includes
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/js.scala">xitrum.js</a>)
in your view template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">target</span><span class="p">:</span> <span class="n">The</span> <span class="n">element</span> <span class="n">that</span> <span class="n">triggered</span> <span class="n">the</span> <span class="n">postback</span>
<span class="n">xitrum</span><span class="o">.</span><span class="n">ajaxLoading</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Called</span> <span class="n">when</span> <span class="n">the</span> <span class="n">animation</span> <span class="n">should</span> <span class="n">be</span> <span class="n">displayed</span> <span class="n">when</span> <span class="n">the</span> <span class="n">Ajax</span> <span class="n">postback</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">sent</span><span class="o">.</span>
  <span class="n">var</span> <span class="n">show</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">};</span>

  <span class="o">//</span> <span class="n">Called</span> <span class="n">when</span> <span class="n">the</span> <span class="n">animation</span> <span class="n">should</span> <span class="n">be</span> <span class="n">stopped</span> <span class="n">after</span> <span class="n">the</span> <span class="n">Ajax</span> <span class="n">postback</span> <span class="n">completes</span><span class="o">.</span>
  <span class="n">var</span> <span class="n">hide</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">{</span><span class="n">show</span><span class="p">:</span> <span class="n">show</span><span class="p">,</span> <span class="n">hide</span><span class="p">:</span> <span class="n">hide</span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<span id="document-xml"></span><div class="section" id="xml">
<h2>XML<a class="headerlink" href="#xml" title="Ссылка на этот заголовок">¶</a></h2>
<p>Scala позволяет использовать XML литералы. Xitrum позволяет использовать такую возможность как своеобразный «шаблонизатор»:</p>
<ul class="simple">
<li><p>Scala проверяет синтаксис XML во время компиляции: представления безопасны относительно типа.</p></li>
<li><p>Scala автоматически экранирует XML: представления по умолчанию защищены от <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> атак.</p></li>
</ul>
<p>Ниже приведены некоторые советы.</p>
<div class="section" id="id1">
<h3>Отключения экранирования XML<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h3>
<p>Используйте <code class="docutils literal notranslate"><span class="pre">scala.xml.Unparsed</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scala.xml.Unparsed</span>

<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="p">{</span><span class="n">Unparsed</span><span class="p">(</span><span class="s2">&quot;if (1 &lt; 2) alert(&#39;Xitrum rocks&#39;);&quot;</span><span class="p">)}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Или <code class="docutils literal notranslate"><span class="pre">&lt;xml:unparsed&gt;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">xml</span><span class="p">:</span><span class="n">unparsed</span><span class="o">&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">alert</span><span class="p">(</span><span class="s1">&#39;Xitrum rocks&#39;</span><span class="p">);</span>
  <span class="o">&lt;/</span><span class="n">xml</span><span class="p">:</span><span class="n">unparsed</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;xml:unparsed&gt;</span></code> не отображается в выводе:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">alert</span><span class="p">(</span><span class="s1">&#39;Xitrum rocks&#39;</span><span class="p">);</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Группировка XML элементов<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;header&quot;</span><span class="o">&gt;</span>
  <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">loggedIn</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LogoutAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span>
  <span class="k">else</span>
    <span class="o">&lt;</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">RegisterAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Register</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;xml:group&gt;</span></code> не будет отображаться в выводе, например в случае пользователя прошедшего аутентификацию:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;header&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">My</span> <span class="n">username</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/login&quot;</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="xhtml">
<h3>Отображение XHTML<a class="headerlink" href="#xhtml" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum отображает представления как XHTML автоматически. Допускается делать
это самостоятельно:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scala.xml.Xhtml</span>

<span class="n">val</span> <span class="n">br</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>
<span class="n">br</span><span class="o">.</span><span class="n">toString</span>            <span class="o">//</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;&lt;/</span><span class="n">br</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">some</span> <span class="n">browsers</span> <span class="n">will</span> <span class="n">render</span> <span class="n">this</span> <span class="k">as</span> <span class="mi">2</span> <span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span><span class="n">s</span>
<span class="n">Xhtml</span><span class="o">.</span><span class="n">toXhtml</span><span class="p">(</span><span class="o">&lt;</span><span class="n">br</span> <span class="o">/&gt;</span><span class="p">)</span>  <span class="o">//</span> <span class="o">=&gt;</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span>
</pre></div>
</div>
</div>
</div>
<span id="document-js"></span><div class="section" id="javascript-json">
<h2>JavaScript и JSON<a class="headerlink" href="#javascript-json" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="javascript">
<h3>JavaScript<a class="headerlink" href="#javascript" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum включает jQuery (опционально) с дополнительным набором утильных функций jsXXX.</p>
<div class="section" id="id1">
<h4>Вставка JavaScript фрагментов в представление<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h4>
<p>В контроллере вы можете использовать метод <code class="docutils literal notranslate"><span class="pre">jsAddToView</span></code> (множество раз, если необходимо):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">jsAddToView</span><span class="p">(</span><span class="s2">&quot;alert(&#39;Hello&#39;)&quot;</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">jsAddToView</span><span class="p">(</span><span class="s2">&quot;alert(&#39;Hello again&#39;)&quot;</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">My</span> <span class="n">view</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>В шаблоне метод <code class="docutils literal notranslate"><span class="pre">jsForView</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;flash&quot;</span><span class="o">&gt;</span><span class="p">{</span><span class="n">jsFlash</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>Отправка JavaScript непосредственно (без представления)<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h4>
<p>Для отправки JavaScript:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jsRespond</span><span class="p">(</span><span class="s2">&quot;$(&#39;#error&#39;).html(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jsEscape</span><span class="p">(</span><span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="o">&gt;</span><span class="n">Could</span> <span class="ow">not</span> <span class="n">login</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Для редиректа:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jsRedirectTo</span><span class="p">(</span><span class="s2">&quot;http://cntt.tv/&quot;</span><span class="p">)</span>
<span class="n">jsRedirectTo</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="json">
<h3>JSON<a class="headerlink" href="#json" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum включает <a class="reference external" href="https://github.com/json4s/json4s">JSON4S</a>.
Пожалуйста прочтите документацию проекта о том как считывать и генерировать JSON.</p>
<p>Конвертация case объекта в строку JSON:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.SeriDeseri</span>

<span class="n">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">phone</span><span class="p">:</span> <span class="n">Option</span><span class="p">[</span><span class="n">String</span><span class="p">])</span>
<span class="n">val</span> <span class="n">person1</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s2">&quot;Jack&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">val</span> <span class="n">json</span>    <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toJson</span><span class="p">(</span><span class="n">person1</span><span class="p">)</span>
<span class="n">val</span> <span class="n">person2</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromJson</span><span class="p">[</span><span class="n">Person</span><span class="p">](</span><span class="n">json</span><span class="p">)</span>
</pre></div>
</div>
<p>Отправка JSON клиенту:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">scalaData</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="o">//</span> <span class="n">Например</span>
<span class="n">respondJson</span><span class="p">(</span><span class="n">scalaData</span><span class="p">)</span>
</pre></div>
</div>
<p>JSON так же полезен для написания конфигурационных файлов со вложенными структурами.
Смотри <a class="reference internal" href="index.html#document-howto"><span class="doc">Загрузка конфигурационных файлов</span></a>.</p>
</div>
<div class="section" id="knockout-js">
<h3>Плагин для Knockout.js<a class="headerlink" href="#knockout-js" title="Ссылка на этот заголовок">¶</a></h3>
<p>Смотри <a class="reference external" href="https://github.com/xitrum-framework/xitrum-ko">https://github.com/xitrum-framework/xitrum-ko</a></p>
</div>
</div>
<span id="document-async"></span><div class="section" id="id1">
<h2>Асинхронная обработка запросов<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Основные методы для отправки ответа сервером:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondView</span></code>: при ответе использует шаблон ассоциированный с контроллером</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondInlineView</span></code>: при ответе использует шаблон переданный как аргумент</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondText(&quot;hello&quot;)</span></code>: ответ строкой «plain/text»</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondHtml(&quot;&lt;html&gt;...&lt;/html&gt;&quot;)</span></code>: ответ строкой «text/html»</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJson(List(1,</span> <span class="pre">2,</span> <span class="pre">3))</span></code>: преобразовать Scala объект в JSON и ответить</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJs(&quot;myFunction([1,</span> <span class="pre">2,</span> <span class="pre">3])&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonP(List(1,</span> <span class="pre">2,</span> <span class="pre">3),</span> <span class="pre">&quot;myFunction&quot;)</span></code>: совмещение предыдущих двух</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonPText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;,</span> <span class="pre">&quot;myFunction&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondBinary</span></code>: ответ массивом байт</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondFile</span></code>: переслать файл с использованием техники <a class="reference external" href="http://www.ibm.com/developerworks/library/j-zerocopy/">zero-copy</a>  (aka send-file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondEventSource(&quot;data&quot;,</span> <span class="pre">&quot;event&quot;)</span></code></p></li>
</ul>
<p>Xitrum автоматически не осуществляет отправку ответа клиенту. Вы должны явно вызвать один из методов <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code>
что бы отправить ответ клиенту. Если вы не вызовете метод``respondXXX``, Xitrum будет поддерживать HTTP соединение,
до тех пор пока не будет вызван метод <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code>.</p>
<p>Что бы убедиться что соединение открыто используйте метод <code class="docutils literal notranslate"><span class="pre">channel.isOpen</span></code>.
Вы можете использовать добавить слушателя используя метод <code class="docutils literal notranslate"><span class="pre">addConnectionClosedListener</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">addConnectionClosedListener</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Соединение</span> <span class="n">было</span> <span class="n">закрыто</span>
  <span class="o">//</span> <span class="n">Необходимо</span> <span class="n">освободить</span> <span class="n">ресурсы</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Ввиду асинхронной природы, ответ сервера не посылается немедленно.
<code class="docutils literal notranslate"><span class="pre">respondXXX</span></code> возвращает экземпляр <a class="reference external" href="http://netty.io/4.0/api/io/netty/channel/ChannelFuture.html">ChannelFuture</a>.
Его можно использовать для выполнения действий в момент кода ответ будет действительно отправлен.</p>
<p>Например, если вы хотите закрыть подключение сразу после отправки запроса:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.channel.</span><span class="p">{</span><span class="n">ChannelFuture</span><span class="p">,</span> <span class="n">ChannelFutureListener</span><span class="p">}</span>

<span class="n">val</span> <span class="n">future</span> <span class="o">=</span> <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
<span class="n">future</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">new</span> <span class="n">ChannelFutureListener</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">operationComplete</span><span class="p">(</span><span class="n">future</span><span class="p">:</span> <span class="n">ChannelFuture</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">future</span><span class="o">.</span><span class="n">getChannel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Или проще:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">ChannelFutureListener</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="websocket">
<h3>WebSocket<a class="headerlink" href="#websocket" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scala.runtime.ScalaRunTime</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.WEBSOCKET</span>
<span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">WebSocketAction</span><span class="p">,</span> <span class="n">WebSocketBinary</span><span class="p">,</span> <span class="n">WebSocketText</span><span class="p">,</span> <span class="n">WebSocketPing</span><span class="p">,</span> <span class="n">WebSocketPong</span><span class="p">}</span>

<span class="nd">@WEBSOCKET</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EchoWebSocketActor</span> <span class="n">extends</span> <span class="n">WebSocketAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Here</span> <span class="n">you</span> <span class="n">can</span> <span class="n">extract</span> <span class="n">session</span> <span class="n">data</span><span class="p">,</span> <span class="n">request</span> <span class="n">headers</span> <span class="n">etc</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">but</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">respondText</span><span class="p">,</span> <span class="n">respondView</span> <span class="n">etc</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">To</span> <span class="n">respond</span><span class="p">,</span> <span class="n">use</span> <span class="n">respondWebSocketXXX</span> <span class="n">like</span> <span class="n">below</span><span class="o">.</span>

    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;onOpen&quot;</span><span class="p">)</span>

    <span class="n">context</span><span class="o">.</span><span class="n">become</span> <span class="p">{</span>
      <span class="n">case</span> <span class="n">WebSocketText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onTextMessage: &quot;</span> <span class="o">+</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">respondWebSocketText</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">toUpperCase</span><span class="p">)</span>

      <span class="n">case</span> <span class="n">WebSocketBinary</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onBinaryMessage: &quot;</span> <span class="o">+</span> <span class="n">ScalaRunTime</span><span class="o">.</span><span class="n">stringOf</span><span class="p">(</span><span class="nb">bytes</span><span class="p">))</span>
        <span class="n">respondWebSocketBinary</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>

      <span class="n">case</span> <span class="n">WebSocketPing</span> <span class="o">=&gt;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;onPing&quot;</span><span class="p">)</span>

      <span class="n">case</span> <span class="n">WebSocketPong</span> <span class="o">=&gt;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;onPong&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">override</span> <span class="k">def</span> <span class="nf">postStop</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;onClose&quot;</span><span class="p">)</span>
    <span class="nb">super</span><span class="o">.</span><span class="n">postStop</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Актор будет создан при открытии подключения. И остановлен когда:</p>
<ul class="simple">
<li><p>Соединение будет разорвано</p></li>
<li><p>WebSocket закроет подключение</p></li>
</ul>
<p>Используйте следующие методы для отправки WebSocket сообщений (frame):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketText</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketBinary</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketPing</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketClose</span></code></p></li>
</ul>
<p>Метод respondWebSocketPong не предусмотрен, потому что Xitrum автоматически отправляет «pong» сообщение в ответ на «ping».</p>
<p>Для получения ссылки на контроллер:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">url</span> <span class="o">=</span> <span class="n">absWebSocketUrl</span><span class="p">[</span><span class="n">EchoWebSocketActor</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="sockjs">
<h3>SockJS<a class="headerlink" href="#sockjs" title="Ссылка на этот заголовок">¶</a></h3>
<p><a class="reference external" href="https://github.com/sockjs/sockjs-client">SockJS</a> предоставляет JavaScript объект
эмитирующий поддержку WebSocket, для браузеров которые не поддерживают этот стандарт.
SockJS пытается использовать WebSocket если он доступен в браузере. В другом случае
будет создан эмитирующий объект.</p>
<p>Если вы хотите использовать WebSocket API во всех браузерах, то следует использовать
SockJS вместо WebSocket.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="n">var</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SockJS</span><span class="p">(</span><span class="s1">&#39;http://mydomain.com/path_prefix&#39;</span><span class="p">);</span>
  <span class="n">sock</span><span class="o">.</span><span class="n">onopen</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="n">sock</span><span class="o">.</span><span class="n">onmessage</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="n">sock</span><span class="o">.</span><span class="n">onclose</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Xitrum включает файл SockJS по умолчанию.
В шаблоне следует написать:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">html</span>
  <span class="n">head</span>
    <span class="o">!=</span> <span class="n">jsDefaults</span>
<span class="o">...</span>
</pre></div>
</div>
<p>SockJS подразумевает наличие части реализации <a class="reference external" href="https://github.com/sockjs/sockjs-protocol">на сервере</a>.
Xitrum автоматически ее реализует:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">SockJsAction</span><span class="p">,</span> <span class="n">SockJsText</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.SOCKJS</span>

<span class="nd">@SOCKJS</span><span class="p">(</span><span class="s2">&quot;echo&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EchoSockJsActor</span> <span class="n">extends</span> <span class="n">SockJsAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">To</span> <span class="n">respond</span><span class="p">,</span> <span class="n">use</span> <span class="n">respondSockJsXXX</span> <span class="n">like</span> <span class="n">below</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onOpen&quot;</span><span class="p">)</span>

    <span class="n">context</span><span class="o">.</span><span class="n">become</span> <span class="p">{</span>
      <span class="n">case</span> <span class="n">SockJsText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onMessage: &quot;</span> <span class="o">+</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">respondSockJsText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">override</span> <span class="k">def</span> <span class="nf">postStop</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onClose&quot;</span><span class="p">)</span>
    <span class="nb">super</span><span class="o">.</span><span class="n">postStop</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Актор будет создан при открытии новой SockJS сессии. И остановлен когда сессия будет закрыта.</p>
<p>Для отправки SockJS сообщений используйте методы:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondSockJsText</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondSockJsClose</span></code></p></li>
</ul>
<p><a class="reference external" href="https://github.com/sockjs/sockjs-node#various-issues-and-design-considerations">Рекомендации по реализации</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Обычно</span> <span class="n">использование</span> <span class="n">кук</span> <span class="n">не</span> <span class="n">подходит</span> <span class="n">для</span> <span class="n">SockJS</span><span class="o">.</span> <span class="n">Если</span> <span class="n">вам</span> <span class="n">нужна</span> <span class="n">авторизация</span> <span class="n">внутри</span> <span class="n">сессии</span><span class="p">,</span> <span class="n">то</span>
<span class="n">для</span> <span class="n">каждой</span> <span class="n">страницы</span> <span class="n">присвойте</span> <span class="n">токен</span> <span class="n">и</span> <span class="n">используйте</span> <span class="n">его</span> <span class="n">в</span> <span class="n">SockJS</span> <span class="n">сессии</span><span class="p">,</span> <span class="n">для</span> <span class="n">валидации</span> <span class="n">на</span> <span class="n">серверной</span> <span class="n">стороне</span><span class="o">.</span>
<span class="n">В</span> <span class="n">сущности</span> <span class="n">это</span> <span class="n">повторение</span> <span class="n">механизма</span> <span class="n">куки</span> <span class="n">для</span> <span class="n">SockJS</span><span class="o">.</span>
</pre></div>
</div>
<p>Подробнее о настройке кластера SockJS, смотрите раздел <a class="reference internal" href="index.html#document-cluster"><span class="doc">Кластерезация с Akka</span></a>.</p>
</div>
<div class="section" id="chunked">
<h3>Chunked ответ<a class="headerlink" href="#chunked" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для отправки <a class="reference external" href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding">chunked ответа</a>:</p>
<ol class="arabic simple">
<li><p>Вызовите метод <code class="docutils literal notranslate"><span class="pre">setChunked</span></code></p></li>
<li><p>Отправляйте данные методами <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code>, столько раз сколько нужно</p></li>
<li><p>Последний ответ отправьте методом <code class="docutils literal notranslate"><span class="pre">respondLastChunk</span></code></p></li>
</ol>
<p>Chunked ответы имеют множество применений. Например, когда нужно генерировать большой
документ который не помещается в памяти, вы можете генерировать этот документ частями
и отправлять их последовательно:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="s2">&quot;Cache-Control&quot;</span> <span class="n">загаловок</span> <span class="n">будет</span> <span class="n">установлен</span> <span class="n">в</span><span class="p">:</span>
<span class="o">//</span> <span class="s2">&quot;no-store, no-cache, must-revalidate, max-age=0&quot;</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Важно</span> <span class="s2">&quot;Pragma: no-cache&quot;</span> <span class="n">привязывается</span> <span class="n">к</span> <span class="n">запросу</span><span class="p">,</span> <span class="n">а</span> <span class="n">не</span> <span class="n">к</span> <span class="n">ответу</span><span class="p">:</span>
<span class="o">//</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">palizine</span><span class="o">.</span><span class="n">plynt</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">issues</span><span class="o">/</span><span class="mi">2008</span><span class="n">Jul</span><span class="o">/</span><span class="n">cache</span><span class="o">-</span><span class="n">control</span><span class="o">-</span><span class="n">attributes</span><span class="o">/</span>
<span class="n">setChunked</span><span class="p">()</span>

<span class="n">val</span> <span class="n">generator</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MyCsvGenerator</span>

<span class="n">generator</span><span class="o">.</span><span class="n">onFirstLine</span> <span class="p">{</span> <span class="n">line</span> <span class="o">=&gt;</span>
  <span class="n">val</span> <span class="n">future</span> <span class="o">=</span> <span class="n">respondText</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;text/csv&quot;</span><span class="p">)</span>
  <span class="n">future</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">new</span> <span class="n">ChannelFutureListener</span> <span class="p">{</span>
    <span class="k">def</span> <span class="nf">operationComplete</span><span class="p">(</span><span class="n">future</span><span class="p">:</span> <span class="n">ChannelFuture</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">isSuccess</span><span class="p">)</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">generator</span><span class="o">.</span><span class="n">onNextLine</span> <span class="p">{</span> <span class="n">line</span> <span class="o">=&gt;</span>
  <span class="n">val</span> <span class="n">future</span> <span class="o">=</span> <span class="n">respondText</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="n">future</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">new</span> <span class="n">ChannelFutureListener</span> <span class="p">{</span>
    <span class="k">def</span> <span class="nf">operationComplete</span><span class="p">(</span><span class="n">future</span><span class="p">:</span> <span class="n">ChannelFuture</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">isSuccess</span><span class="p">)</span> <span class="n">generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="n">generator</span><span class="o">.</span><span class="n">onLastLine</span> <span class="p">{</span> <span class="n">line</span> <span class="o">=&gt;</span>
  <span class="n">val</span> <span class="n">future</span> <span class="o">=</span> <span class="n">respondText</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
  <span class="n">future</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">new</span> <span class="n">ChannelFutureListener</span> <span class="p">{</span>
    <span class="k">def</span> <span class="nf">operationComplete</span><span class="p">(</span><span class="n">future</span><span class="p">:</span> <span class="n">ChannelFuture</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">isSuccess</span><span class="p">)</span> <span class="n">respondLastChunk</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
</pre></div>
</div>
<p>Замечания:</p>
<ul class="simple">
<li><p>Заголовки отправляются при первом вызове <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code>.</p></li>
<li><p>Опционально, вы можете отправить дополнительные заголовки с вызовом метода <code class="docutils literal notranslate"><span class="pre">respondLastChunk</span></code></p></li>
<li><p><a class="reference internal" href="index.html#document-cache"><span class="doc">Кэш страницы и контроллера</span></a> не может быть использован совместно с chunked ответами.</p></li>
</ul>
<p>Используя chunked ответ вместе с <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code>, легко реализовать
<a class="reference external" href="http://www.cubrid.org/blog/dev-platform/faster-web-page-loading-with-facebook-bigpipe/">Facebook BigPipe</a>.</p>
<div class="section" id="iframe">
<h4>Бесконечный iframe<a class="headerlink" href="#iframe" title="Ссылка на этот заголовок">¶</a></h4>
<p>Chunked ответ <a class="reference external" href="http://www.shanison.com/2010/05/10/stop-the-browser-%E2%80%9Cthrobber-of-doom%E2%80%9D-while-loading-comet-forever-iframe/">может быть использован</a>
для реализации <a class="reference external" href="http://en.wikipedia.org/wiki/Comet_%28programming%29">Comet</a>.</p>
<p>Страница которая включает iframe:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="n">var</span> <span class="n">functionForForeverIframeSnippetsToCall</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">iframe</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;1&quot;</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;1&quot;</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;path/to/forever/iframe&quot;</span><span class="o">&gt;&lt;/</span><span class="n">iframe</span><span class="o">&gt;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Контроллер который последовательно отправляет <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// Подготовка к вечному iframe

setChunked()

// Необходимо отправить например &quot;123&quot; для некоторых браузеров
respondText(&quot;&lt;html&gt;&lt;body&gt;123&quot;, &quot;text/html&quot;)

// Большинство клиентов (даже curl!) не выполняют тело &lt;script&gt; немедленно,
// необходимо отправить около 2KB данных что бы обойти эту проблему
for (i &lt;- 1 to 100) respondText(&quot;&lt;script&gt;&lt;/script&gt;\n&quot;)
</pre></div>
</div>
<p>Позднее, когда вам нужно отправить данные браузеру, просто используйте шаблон:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if (channel.isOpen)
  respondText(&quot;&lt;script&gt;parent.functionForForeverIframeSnippetsToCall()&lt;/script&gt;\n&quot;)
else
  // Соединение было закрыто, необходимо освободить ресурсы
  // Вы можете использовать так же ``addConnectionClosedListener``.
</pre></div>
</div>
</div>
<div class="section" id="event-source">
<h4>Event Source<a class="headerlink" href="#event-source" title="Ссылка на этот заголовок">¶</a></h4>
<p>Смотри <a class="reference external" href="http://dev.w3.org/html5/eventsource/">http://dev.w3.org/html5/eventsource/</a></p>
<p>Event Source ответ, это специальный тип chunked ответа.
Данные должны быть в кодировке UTF-8.</p>
<p>Для ответа в формате event source, используйте метод <code class="docutils literal notranslate"><span class="pre">respondEventSource</span></code> столько раз сколько нужно.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondEventSource</span><span class="p">(</span><span class="s2">&quot;data1&quot;</span><span class="p">,</span> <span class="s2">&quot;event1&quot;</span><span class="p">)</span>  <span class="o">//</span> <span class="n">Имя</span> <span class="n">события</span> <span class="s2">&quot;event1&quot;</span>
<span class="n">respondEventSource</span><span class="p">(</span><span class="s2">&quot;data2&quot;</span><span class="p">)</span>            <span class="o">//</span> <span class="n">Имя</span> <span class="n">события</span> <span class="n">устанавливается</span> <span class="n">в</span> <span class="s2">&quot;message&quot;</span> <span class="n">по</span> <span class="n">умолчанию</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-static"></span><div class="section" id="id1">
<h2>Статичные файлы<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="id2">
<h3>Отправка статических файлов с диска<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Шаблонная директория Xitrum проекта:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span>
<span class="n">public</span>
  <span class="n">favicon</span><span class="o">.</span><span class="n">ico</span>
  <span class="n">robots</span><span class="o">.</span><span class="n">txt</span>
  <span class="mf">404.</span><span class="n">html</span>
  <span class="mf">500.</span><span class="n">html</span>
  <span class="n">img</span>
    <span class="n">myimage</span><span class="o">.</span><span class="n">png</span>
  <span class="n">css</span>
    <span class="n">mystyle</span><span class="o">.</span><span class="n">css</span>
  <span class="n">js</span>
    <span class="n">myscript</span><span class="o">.</span><span class="n">js</span>
<span class="n">src</span>
<span class="n">build</span><span class="o">.</span><span class="n">sbt</span>
</pre></div>
</div>
<p>Xitrum использует директорию <code class="docutils literal notranslate"><span class="pre">public</span></code> для хранения статических файлов.
Для генерации ссылок на статические файлы:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="n">myimage</span><span class="o">.</span><span class="n">png</span>
<span class="o">/</span><span class="n">css</span><span class="o">/</span><span class="n">mystyle</span><span class="o">.</span><span class="n">css</span>
<span class="o">/</span><span class="n">css</span><span class="o">/</span><span class="n">mystyle</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">css</span>
</pre></div>
</div>
<p>Используйте шаблон:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">publicUrl</span><span class="p">(</span><span class="s2">&quot;img/myimage.png&quot;</span><span class="p">)}</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>Для работы с обычными файлами в режиме разработчика и их минимизированными версиями
(например, mystyle.css и mystyle.min.css), используйте шаблон:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">publicUrl</span><span class="p">(</span><span class="s2">&quot;css&quot;</span><span class="p">,</span> <span class="s2">&quot;mystyle.css&quot;</span><span class="p">,</span> <span class="s2">&quot;mystyle.min.css&quot;</span><span class="p">)}</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>Для отправки файла с диска из контроллера используйте метод <code class="docutils literal notranslate"><span class="pre">respondFile</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondFile</span><span class="p">(</span><span class="s2">&quot;/absolute/path&quot;</span><span class="p">)</span>
<span class="n">respondFile</span><span class="p">(</span><span class="s2">&quot;path/relative/to/the/current/working/directory&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Для оптимизации работы со статическими файлами, вы можете избежать использование
не нужны файлов ограничив их маской (фильтром на основе регулярного выражения).
Если запрос не будет соответствовать регулярному выражению, Xitrum ответит страницей
404 на этот зарос.</p>
<p>Смотри <code class="docutils literal notranslate"><span class="pre">pathRegex</span></code> в <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code>.</p>
</div>
<div class="section" id="index-html">
<h3>index.html и обработка отсутствующих маршрутов<a class="headerlink" href="#index-html" title="Ссылка на этот заголовок">¶</a></h3>
<p>Если не существует контроллера для данного URL, например <code class="docutils literal notranslate"><span class="pre">/foo/bar</span></code> (или <code class="docutils literal notranslate"><span class="pre">/foo/bar/</span></code>),
Xitrum попытается найти подходящий статический файл <code class="docutils literal notranslate"><span class="pre">public/foo/bar/index.html</span></code>
(в директории «public»). Если файл существует, то он будет отправлен клиенту.</p>
</div>
<div class="section" id="id3">
<h3>404 и 500<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>404.html и 500.html в директории <code class="docutils literal notranslate"><span class="pre">public</span></code> используются когда маршрут не обнаружен или на сервере произошла ошибка.
Пример использования своего собственного обработчика ошибок:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">Error404</span><span class="p">,</span> <span class="n">Error500</span><span class="p">}</span>

<span class="nd">@Error404</span>
<span class="k">class</span> <span class="nc">My404ErrorHandlerAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isAjax</span><span class="p">)</span>
      <span class="n">jsRespond</span><span class="p">(</span><span class="s2">&quot;alert(&quot;</span> <span class="o">+</span> <span class="n">jsEscape</span><span class="p">(</span><span class="s2">&quot;Not Found&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">renderInlineView</span><span class="p">(</span><span class="s2">&quot;Not Found&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Error500</span>
<span class="k">class</span> <span class="nc">My500ErrorHandlerAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isAjax</span><span class="p">)</span>
      <span class="n">jsRespond</span><span class="p">(</span><span class="s2">&quot;alert(&quot;</span> <span class="o">+</span> <span class="n">jsEscape</span><span class="p">(</span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">renderInlineView</span><span class="p">(</span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Код ответа устанавливается в 404 или 500 еще до того как код контроллера будет запущен,
соответственно вам не нужно устанавливать его самостоятельно.</p>
</div>
<div class="section" id="webjars">
<h3>Использование файлов ресурсов в соответствии с WebJars<a class="headerlink" href="#webjars" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="id4">
<h4>WebJars<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h4>
<p><a class="reference external" href="http://www.webjars.org/">WebJars</a> предоставляет множество библиотек которые вы можете
объявить как зависимости вашего проекта.</p>
<p>Например, для использования <a class="reference external" href="http://underscorejs.org/">Underscore.js</a>,
достаточно прописать в <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;org.webjars&quot;</span> <span class="o">%</span> <span class="s2">&quot;underscorejs&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.6.0-3&quot;</span>
</pre></div>
</div>
<p>После этого, в шаблоне .jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">webJarsUrl</span><span class="p">(</span><span class="s2">&quot;underscorejs/1.6.0&quot;</span><span class="p">,</span> <span class="s2">&quot;underscore.js&quot;</span><span class="p">,</span> <span class="s2">&quot;underscore-min.js&quot;</span><span class="p">)})</span>
</pre></div>
</div>
<p>Xitrum будет автоматически использовать <code class="docutils literal notranslate"><span class="pre">underscore.js</span></code> в режиме разработчика, и
<code class="docutils literal notranslate"><span class="pre">underscore-min.js</span></code> в боевом режиме.</p>
<p>Результат будет таким:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/webjars/underscorejs/1.6.0/underscore.js?XOKgP8_KIpqz9yUqZ1aVzw
</pre></div>
</div>
<p>Для использования в одного и того же файла во всех режимах:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">webJarsUrl</span><span class="p">(</span><span class="s2">&quot;underscorejs/1.6.0/underscore.js&quot;</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="section" id="jar-webjars">
<h4>Хранение файлов ресурсов внутри .jar файла согласно WebJars<a class="headerlink" href="#jar-webjars" title="Ссылка на этот заголовок">¶</a></h4>
<p>Если вы разработчик библиотек и ваша библиотека включает myimage.png, то вы можете
сохранить myimage.png внутри .jar файла. Используя <a class="reference external" href="http://www.webjars.org/">WebJars</a>, например:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">META</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">webjars</span><span class="o">/</span><span class="n">mylib</span><span class="o">/</span><span class="mf">1.0</span><span class="o">/</span><span class="n">myimage</span><span class="o">.</span><span class="n">png</span>
</pre></div>
</div>
<p>Использование в проекте:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">webJarsUrl</span><span class="p">(</span><span class="s2">&quot;mylib/1.0/myimage.png&quot;</span><span class="p">)}</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>Во всех режимах URL будет:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/webjars/mylib/1.0/myimage.png?xyz123
</pre></div>
</div>
</div>
<div class="section" id="classpath">
<h4>Ответ файлом из classpath<a class="headerlink" href="#classpath" title="Ссылка на этот заголовок">¶</a></h4>
<p>Для ответа файлом находящимся внутри classpath (или внутри .jar файла), даже если файл
хранится не по стандарту <a class="reference external" href="http://www.webjars.org/">WebJars</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;path/relative/to/the/classpath/element&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Например:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;akka/actor/Actor.class&quot;</span><span class="p">)</span>
<span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;META-INF/resources/webjars/underscorejs/1.6.0/underscore.js&quot;</span><span class="p">)</span>
<span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;META-INF/resources/webjars/underscorejs/1.6.0/underscore-min.js&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="etag-max-age">
<h3>Кэширование на стороне клиента с ETag и max-age<a class="headerlink" href="#etag-max-age" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum автоматически добавляет <a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_ETag">Etag</a> для
статических файлов на диске и в classpath.</p>
<p>ETag для маленьких файлов - MD5 хэш от контента файла. Они кэшируются для последующего использования.
Ключ кэша - <code class="docutils literal notranslate"><span class="pre">(путь</span> <span class="pre">до</span> <span class="pre">файла,</span> <span class="pre">время</span> <span class="pre">изменения)</span></code>. Поскольку время изменения на разных серверах
может отличаться, каждый веб сервер в кластере имеет свой собственный ETag кэш.</p>
<p>Для больших файлов, только время изменения используется как ETag. Такая система не совершенна
поскольку идентичные файлы на разных серверах могут иметь различный ETag, но это все равно лучше
чем не использовать ETag вовсе.</p>
<p><code class="docutils literal notranslate"><span class="pre">publicUrl</span></code> и <code class="docutils literal notranslate"><span class="pre">webJarsUrl</span></code> автоматически добавляют ETag для ссылок. Например:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>webJarsUrl(&quot;jquery/2.1.1/jquery.min.js&quot;)
=&gt; /webjars/jquery/2.1.1/jquery.min.js?0CHJg71ucpG0OlzB-y6-mQ
</pre></div>
</div>
<p>Xitrum так же устанавливает заголовки <code class="docutils literal notranslate"><span class="pre">max-age</span></code> и <code class="docutils literal notranslate"><span class="pre">Expires</span></code> в значение
<a class="reference external" href="https://developers.google.com/speed/docs/best-practices/caching">1 год</a>.
Не переживайте, браузер все равно получит последнею версию файла. Потому что для
файлов хранящихся на диске, после изменении ссылка на файл меняется, т.к. генерируется с
помощью <code class="docutils literal notranslate"><span class="pre">publicUrl</span></code> и <code class="docutils literal notranslate"><span class="pre">webJarsUrl</span></code>. Их ETag кэш так же обновляется.</p>
</div>
<div class="section" id="gzip">
<h3>GZIP<a class="headerlink" href="#gzip" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum автоматически сжимает текстовые ответы. Проверяется заголовок <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code>
для определения текстового ответа: <code class="docutils literal notranslate"><span class="pre">text/html</span></code>, <code class="docutils literal notranslate"><span class="pre">xml/application</span></code> и пр.</p>
<p>Xitrum всегда сжимает текстовые файлы, но для динамических ответов с целью
повышения производительности ответы размером меньше 1 килобайта не сжимаются.</p>
</div>
<div class="section" id="id9">
<h3>Кэш на стороне сервера<a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h3>
<p>Для избежания загрузки файлов с диска, Xitrum кэширует маленькие файлы
(не только текстовые) в LRU кэше (вытеснение давно неиспользуемых).
Смотри <code class="docutils literal notranslate"><span class="pre">small_static_file_size_in_kb</span></code> и <code class="docutils literal notranslate"><span class="pre">max_cached_small_static_files</span></code>
в <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code>.</p>
</div>
</div>
<span id="document-flash"></span><div class="section" id="serve-flash-socket-policy-file">
<h2>Serve flash socket policy file<a class="headerlink" href="#serve-flash-socket-policy-file" title="Ссылка на этот заголовок">¶</a></h2>
<p>Read about flash socket policy:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.adobe.com/devnet/flashplayer/articles/socket_policy_files.html">http://www.adobe.com/devnet/flashplayer/articles/socket_policy_files.html</a></p></li>
<li><p><a class="reference external" href="http://www.lightsphere.com/dev/articles/flash_socket_policy.html">http://www.lightsphere.com/dev/articles/flash_socket_policy.html</a></p></li>
</ul>
<p>The protocol to serve flash socket policy file is different from HTTP.
To serve:</p>
<ol class="arabic simple">
<li><p>Modify <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/flash_socket_policy.xml">config/flash_socket_policy.xml</a> appropriately</p></li>
<li><p>Modify <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a> to enable serving the above file</p></li>
</ol>
</div>
<span id="document-scopes"></span><div class="section" id="id1">
<h2>Запросы, параметры, куки, сессии<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="id2">
<h3>Запросы<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="id3">
<h4>Типы параметров<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h4>
<p>Доступны два вида параметров запроса: текстовые параметры и параметры файлы (file upload, бинарные данные)</p>
<p>Текстовые параметры делятся на три вида, каждый имеет тип <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Seq[String]]</span></code>:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">queryParams</span></code>: параметры после символа ? в ссылке, например: <a class="reference external" href="http://example.com/blah?x=1&amp;y=2">http://example.com/blah?x=1&amp;y=2</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bodyTextParams</span></code>: параметры в теле POST запроса</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathParams</span></code>: параметры в пути запроса, например: <code class="docutils literal notranslate"><span class="pre">GET(&quot;articles/:id/:title&quot;)</span></code></p></li>
</ol>
<p>Параметры собираются воедино в переменной <code class="docutils literal notranslate"><span class="pre">textParams</span></code> в следующем порядке
(от 1 к 3, более поздние перекрывают более ранние).</p>
<p><code class="docutils literal notranslate"><span class="pre">bodyFileParams</span></code> имеет тип scala.collection.mutable.Map[String, Seq[<a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/multipart/FileUpload.html">FileUpload</a>]].</p>
</div>
<div class="section" id="id4">
<h4>Доступ к параметрам<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h4>
<p>Из контроллера в можете получить доступ к параметрам напрямую, или вы можете использовать
методы доступа.</p>
<p>Для доступа к <code class="docutils literal notranslate"><span class="pre">textParams</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">param(&quot;x&quot;)</span></code>: возвращает <code class="docutils literal notranslate"><span class="pre">String</span></code>, выбрасывает исключение если x не существует</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paramo(&quot;x&quot;)</span></code>: возвращает <code class="docutils literal notranslate"><span class="pre">Option[String]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params(&quot;x&quot;)</span></code>: возвращает <code class="docutils literal notranslate"><span class="pre">Seq[String]</span></code></p></li>
</ul>
<p>Вы можете преобразовывать их к другим типам (Int, Long, Fload, Double) автоматически
используя <code class="docutils literal notranslate"><span class="pre">param[Int](&quot;x&quot;)</span></code>, <code class="docutils literal notranslate"><span class="pre">params[Int](&quot;x&quot;)</span></code> и пр. Для преобразования текстовых параметров к
другим типам, перекройте метод <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala-2.11/xitrum/scope/request/ParamAccess.scala">convertTextParam</a>.</p>
<p>Для параметров файлов: <code class="docutils literal notranslate"><span class="pre">param[FileUpload](&quot;x&quot;)</span></code>, <code class="docutils literal notranslate"><span class="pre">params[FileUpload](&quot;x&quot;)</span></code> и пр.
Более подробно, смотри <a class="reference internal" href="index.html#document-upload"><span class="doc">Загрузка файлов</span></a>.</p>
</div>
<div class="section" id="at">
<h4>«at»<a class="headerlink" href="#at" title="Ссылка на этот заголовок">¶</a></h4>
<p>Для передачи данных из контроллера в представление вы можете использовать <code class="docutils literal notranslate"><span class="pre">at</span></code>.
Тип <code class="docutils literal notranslate"><span class="pre">at</span></code> - <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.HashMap[String,</span> <span class="pre">Any]</span></code>.
Если вы знакомы с Rails, <code class="docutils literal notranslate"><span class="pre">at</span></code> это аналог <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> из Rails.</p>
<p>Articles.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>  <span class="o">//</span> <span class="n">Например</span><span class="p">,</span> <span class="n">получаем</span> <span class="n">из</span> <span class="n">базы</span> <span class="n">данных</span>
    <span class="n">at</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">))</span> <span class="s2">&quot;My Site - &quot;</span> <span class="o">+</span> <span class="n">at</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;My Site&quot;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="atjson">
<h4>«atJson»<a class="headerlink" href="#atjson" title="Ссылка на этот заголовок">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">atJson</span></code> - утильный метод который автоматически конвертирует <code class="docutils literal notranslate"><span class="pre">at(&quot;key&quot;)</span></code> в JSON.
Метод может быть полезен для передачи моделей напрямую из Scala в JavaScript.</p>
<p><code class="docutils literal notranslate"><span class="pre">atJson(&quot;key&quot;)</span></code> эквивалент <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.toJson(at(&quot;key&quot;))</span></code>:</p>
<p>Action.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">case</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">login</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">at</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;Admin&quot;</span><span class="p">)</span>
  <span class="n">respondView</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Action.ssp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;script type=&quot;text/javascript&quot;&gt;
  var user = ${atJson(&quot;user&quot;)};
  alert(user.login);
  alert(user.name);
&lt;/script&gt;
</pre></div>
</div>
</div>
<div class="section" id="requestvar">
<h4>RequestVar<a class="headerlink" href="#requestvar" title="Ссылка на этот заголовок">¶</a></h4>
<p>У <code class="docutils literal notranslate"><span class="pre">at</span></code> есть недостаток, он не безопасен относительно типов, т.к. основан на не типизированной коллекции. Если вам нужна большая безопасность, можно использовать идею RequestVar, которая оборачивает <code class="docutils literal notranslate"><span class="pre">at</span></code>.</p>
<p>RVar.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.RequestVar</span>

<span class="nb">object</span> <span class="n">RVar</span> <span class="p">{</span>
  <span class="nb">object</span> <span class="n">title</span> <span class="n">extends</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Articles.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>  <span class="o">//</span> <span class="n">Get</span> <span class="kn">from</span> <span class="nn">DB</span>
    <span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">isDefined</span><span class="p">)</span> <span class="s2">&quot;My Site - &quot;</span> <span class="o">+</span> <span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">get</span> <span class="k">else</span> <span class="s2">&quot;My Site&quot;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>Куки<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p>Подробнее о <a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_cookie">куки</a>.</p>
<p>Внутри контроллера, используйте <code class="docutils literal notranslate"><span class="pre">requestCookies</span></code>, для чтения кук отправленных браузером (тип <code class="docutils literal notranslate"><span class="pre">Map[String,</span> <span class="pre">String]</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requestCookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myCookie&quot;</span><span class="p">)</span> <span class="n">match</span> <span class="p">{</span>
  <span class="n">case</span> <span class="kc">None</span>         <span class="o">=&gt;</span> <span class="o">...</span>
  <span class="n">case</span> <span class="n">Some</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Для отправки куки браузеру, создайте экземпляр <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/DefaultCookie.html">DefaultCookie</a> и добавьте его к массиву <code class="docutils literal notranslate"><span class="pre">responseCookies</span></code> который хранит все <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/Cookie.html">куки</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultCookie</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="n">cookie</span><span class="o">.</span><span class="n">setHttpOnly</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>  <span class="o">//</span> <span class="n">true</span><span class="p">:</span> <span class="n">JavaScript</span> <span class="n">не</span> <span class="n">может</span> <span class="n">получить</span> <span class="n">доступ</span> <span class="n">к</span> <span class="n">куки</span>
<span class="n">responseCookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</pre></div>
</div>
<p>Если вы не укажите путь для через метод <code class="docutils literal notranslate"><span class="pre">cookie.setPath(cookiePath)</span></code>, то
будет использован корень сайта как путь (<code class="docutils literal notranslate"><span class="pre">xitrum.Config.withBaseUrl(&quot;/&quot;)</span></code>).
Это позволяет избежать случайного дублирования кук.</p>
<p>Что бы удалить куку отправленную браузером, отправить куку с тем же именем и с
временем жизни 0. Браузер посчитает ее истекшей. Для того что бы создать куку
удаляемую при закрытии браузере, установите время жизни в <code class="docutils literal notranslate"><span class="pre">Long.MinValue</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cookie</span><span class="o">.</span><span class="n">setMaxAge</span><span class="p">(</span><span class="n">Long</span><span class="o">.</span><span class="n">MinValue</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference external" href="http://mrcoles.com/blog/cookies-max-age-vs-expires/">Internet Explorer не поддерживает «max-age»</a>,
но Netty умеет это определять и устанавливает «max-age» и «expires» должны образом. Не беспокойтесь!</p>
<p>Браузер не отправляет атрибуты куки обратно на сервер. Браузер отправляет
<a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_cookie#Cookie_attributes">только пары имя-значение</a>.</p>
<p>Если вы хотите подписать ваши куки, что бы защититься от подделки, используйте
<code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.toSecureUrlSafeBase64</span></code> и <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.fromSecureUrlSafeBase64</span></code>.
Подробнее смотри <a class="reference internal" href="index.html#document-howto"><span class="doc">Как шифровать данные</span></a>.</p>
<div class="section" id="id9">
<h4>Допустимые символы в куки<a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h4>
<p>Вы можете использовать только <a class="reference external" href="http://stackoverflow.com/questions/1969232/allowed-characters-in-cookies">ограниченный набор символов в куки</a>.
Например, если вам нужно передать UTF-8 символы, вы должны закодировать их. Можно использовать, например, <code class="docutils literal notranslate"><span class="pre">xitrum.utill.UrlSafeBase64</span></code> или <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri</span></code>.</p>
<p>Пример записи куки:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span>
<span class="kn">import</span> <span class="nn">xitrum.util.UrlSafeBase64</span>

<span class="n">val</span> <span class="n">value</span>   <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{&quot;identity&quot;:&quot;example@gmail.com&quot;,&quot;first_name&quot;:&quot;Alexander&quot;}&quot;&quot;&quot;</span>
<span class="n">val</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">noPaddingEncode</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="n">UTF_8</span><span class="p">))</span>
<span class="n">val</span> <span class="n">cookie</span>  <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultCookie</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span>
<span class="n">responseCookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</pre></div>
</div>
<p>Чтение куки:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requestCookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">foreach</span> <span class="p">{</span> <span class="n">encoded</span> <span class="o">=&gt;</span>
  <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">autoPaddingDecode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span><span class="o">.</span><span class="n">foreach</span> <span class="p">{</span> <span class="nb">bytes</span> <span class="o">=&gt;</span>
    <span class="n">val</span> <span class="n">value</span> <span class="o">=</span> <span class="n">new</span> <span class="n">String</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">CharsetUtil</span><span class="o">.</span><span class="n">UTF_8</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="s2">&quot;profile: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id11">
<h3>Сессии<a class="headerlink" href="#id11" title="Ссылка на этот заголовок">¶</a></h3>
<p>Хранение сессии, восстановление, шифрование и прочее выполняются автоматически.</p>
<p>В контроллере, вы можете использовать переменную <code class="docutils literal notranslate"><span class="pre">session</span></code>, которая имеет тип
<code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Any]</span></code>. Значения в <code class="docutils literal notranslate"><span class="pre">session</span></code> должны быть
сериализуемые.</p>
<p>Например, что бы сохранить что пользователь прошел авторизацию, вы можете сохранить
его имя в сессии:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">userId</span>
</pre></div>
</div>
<p>Позднее, если вы хотите убедиться что пользователь авторизован, вы просто проверяете
есть ли его имя в сессии:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">))</span> <span class="n">println</span><span class="p">(</span><span class="s2">&quot;This user has logged in&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Хранение идентификатора пользователя и загрузка его из базы данных при каждом запросе
обычно является не плохим решением. В этом случае информация о пользователе обновляется
при каждым запросе (включая изменения в правах доступа).</p>
<div class="section" id="session-clear">
<h4>session.clear()<a class="headerlink" href="#session-clear" title="Ссылка на этот заголовок">¶</a></h4>
<p><a class="reference external" href="http://guides.rubyonrails.org/security.html#session-fixation">Одна строчка кода позволяет защититься от фиксации сессии</a>.</p>
<p>Прочитайте статью по ссылке выше что бы узнать подробнее про эту атаку. Для защиты
от атаки, в контроллере который использует логин пользователя, вызовете <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="o">//</span> <span class="n">Сброс</span> <span class="n">сессии</span> <span class="n">прежде</span> <span class="n">чем</span> <span class="n">выполнять</span> <span class="n">какие</span> <span class="n">либо</span> <span class="n">дейтсвияthe</span> <span class="n">session</span>
    <span class="n">session</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">userId</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Это касается так же контроллера, который выполняет «выход пользователя» (log out).</p>
</div>
<div class="section" id="sessionvar">
<h4>SessionVar<a class="headerlink" href="#sessionvar" title="Ссылка на этот заголовок">¶</a></h4>
<p>SessionVar, как и RequestVar, это способ сделать сессию более безопасной.</p>
<p>Например, вы хотите хранить имя пользователя в сессии после того как он прошел авторизацию:</p>
<p>Объявите session var:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.SessionVar</span>

<span class="nb">object</span> <span class="n">SVar</span> <span class="p">{</span>
  <span class="nb">object</span> <span class="n">username</span> <span class="n">extends</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Присвойте значение во время авторизации:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Отобразите имя пользователя:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">isDefined</span><span class="p">)</span>
  <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">{</span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">get</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span>
<span class="k">else</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Для удаления используйте: <code class="docutils literal notranslate"><span class="pre">SVar.username.remove()</span></code></p></li>
<li><p>Для сброса всей сессии используйте: <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code></p></li>
</ul>
</div>
<div class="section" id="id13">
<h4>Хранилище сессии<a class="headerlink" href="#id13" title="Ссылка на этот заголовок">¶</a></h4>
<p>Из коробки Xitrum предоставляет 3 простых хранилища.
В файле <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a>
есть возможность настроить хранилище сессии:</p>
<p>CookieSessionStore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Хранение сессии на стороне клиента в куках</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">xitrum</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">CookieSessionStore</span>
</pre></div>
</div>
<p>LruSessionStore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Простое хранилище на стороне сервера</span>
<span class="n">store</span> <span class="p">{</span>
  <span class="s2">&quot;xitrum.local.LruSessionStore&quot;</span> <span class="p">{</span>
    <span class="n">maxElems</span> <span class="o">=</span> <span class="mi">10000</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Если вы запускаете несколько серверов, вы можете использовать
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">Hazelcast для хранения кластеризованных сессии</a>.</p>
<p>Важно, если вы используете CookieSessionStore или Hazelcast, ваши данные должны быть сериализуемыми. Если
ваши данные не подлежат сериализации используйте LruSessionStore.
При использовании LruSessionStore вы можете кластеризовать сессии используя load balancer и sticky sessions.</p>
<p>Эти три типа хранилища сессии обычно покрывают все необходимые случаи. Существует
возможность определить свою реализацию хранилища сессии, используйте наследование от
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/scope/session/SessionStore.scala">SessionStore</a>
или
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/scope/session/ServerSessionStore.scala">ServerSessionStore</a> и реализуйте абстрактные методы.</p>
<p>Хранилище может быть объявлено в двух видах:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">StoreClassName</span>
</pre></div>
</div>
<p>Или:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="p">{</span>
  <span class="s2">&quot;my.session.StoreClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Используйте куки когда это возможно, поскольку они более масштабируемы
(сериализуемым и меньше 4KB).
Храните сессии на сервере (в памяти или базе данных) если это необходимо.</p>
<p>Дальнейшее чтение:
<a class="reference external" href="http://www.technicalinfo.net/papers/WebBasedSessionManagement.html">Web Based Session Management - Best practices in managing HTTP-based client sessions</a>.</p>
</div>
</div>
<div class="section" id="object-vs-val">
<h3>object vs. val<a class="headerlink" href="#object-vs-val" title="Ссылка на этот заголовок">¶</a></h3>
<p>Пожалуйста, используйте <code class="docutils literal notranslate"><span class="pre">object</span></code> вместо <code class="docutils literal notranslate"><span class="pre">val</span></code>.</p>
<p><strong>Не делайте так</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">object</span> <span class="n">RVar</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">title</span>    <span class="o">=</span> <span class="n">new</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
  <span class="n">val</span> <span class="n">category</span> <span class="o">=</span> <span class="n">new</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">object</span> <span class="n">SVar</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">username</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
  <span class="n">val</span> <span class="n">isAdmin</span>  <span class="o">=</span> <span class="n">new</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">Boolean</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Приведенный код компилируется но не работает корректно, потому что Vars внутри
себя используют имена классов что бы выполнять поиск. При использовании
<code class="docutils literal notranslate"><span class="pre">val</span></code>, <code class="docutils literal notranslate"><span class="pre">title</span></code> и <code class="docutils literal notranslate"><span class="pre">category</span></code> мы имеем тоже самое имя класса «xitrum.RequestVar».
Одно и тоже как и для <code class="docutils literal notranslate"><span class="pre">username</span></code> и <code class="docutils literal notranslate"><span class="pre">isAdmin</span></code>.</p>
</div>
</div>
<span id="document-validation"></span><div class="section" id="id1">
<h2>Валидация<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Xitrum включает <a class="reference external" href="http://bassistance.de/jquery-plugins/jquery-plugin-validation/">плагин jQuery Validation</a>
для выполнения валидации на стороне клиента и предоставляет наоборот утильных методов на серверной стороне.</p>
<div class="section" id="id2">
<h3>Стандартные валидаторы<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum предоставляет набор валидаторов из пакета <code class="docutils literal notranslate"><span class="pre">xitrum.validator</span></code>.
Интерфейс валидатора:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">check</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="n">Boolean</span>
<span class="n">message</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="n">Option</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="n">exception</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>В случае если проверка не проходит, <code class="docutils literal notranslate"><span class="pre">message</span></code> возвращает <code class="docutils literal notranslate"><span class="pre">Some(error</span> <span class="pre">message)</span></code>,
а <code class="docutils literal notranslate"><span class="pre">exception</span></code> выбрасывает <code class="docutils literal notranslate"><span class="pre">xitrum.exception.InvalidInput(error</span> <span class="pre">message)</span></code>.</p>
<p>Вы можете использовать валидаторы везде где захотите.</p>
<p>Пример контроллера:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.validator.Required</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CreateArticle</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">title</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;tite&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">body</span>  <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
    <span class="n">Required</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">Required</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Body&quot;</span><span class="p">,</span>  <span class="n">body</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">дальнейшая</span> <span class="n">обработка</span> <span class="n">валидных</span> <span class="n">title</span> <span class="n">и</span> <span class="n">body</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Если вы не используете блок <code class="docutils literal notranslate"><span class="pre">try</span></code> и <code class="docutils literal notranslate"><span class="pre">catch</span></code>, когда валидация не проходит,
Xitrum автоматически обработает исключение и отправит сообщение клиенту. Это удобно
при написании API и когда у вас уже есть проверка на клиенте.</p>
<p>Пример модели:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.validator.Required</span>

<span class="n">case</span> <span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">Int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">isValid</span>           <span class="o">=</span> <span class="n">Required</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>   <span class="o">&amp;&amp;</span>     <span class="n">Required</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">validationMessage</span> <span class="o">=</span> <span class="n">Required</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="n">orElse</span> <span class="n">Required</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Смотри <a class="reference external" href="https://github.com/xitrum-framework/xitrum/tree/master/src/main/scala/xitrum/validator">пакет xitrum.validator</a>
для получения полного списка стандартных валидаторов.</p>
</div>
<div class="section" id="id3">
<h3>Написание своих валидаторов<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>Наследуйтесь от <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/validator/Validator.scala">xitrum.validator.Validator</a> для создания своего валидатора. Необходимо реализовать только методы <code class="docutils literal notranslate"><span class="pre">check</span></code> и <code class="docutils literal notranslate"><span class="pre">message</span></code>.</p>
<p>Так же вы можете использовать библиотеку <a class="reference external" href="http://commons.apache.org/proper/commons-validator/">Commons Validator</a>.</p>
</div>
</div>
<span id="document-upload"></span><div class="section" id="id1">
<h2>Загрузка файлов<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Смотри так же раздел <a class="reference internal" href="index.html#document-scopes"><span class="doc">обработка запросов</span></a>.</p>
<p>В вашей форме загрузки файла не забывайте устанавливать <code class="docutils literal notranslate"><span class="pre">enctype</span></code> в <code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>.</p>
<p>MyUpload.scalate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">MyUpload</span><span class="p">]}</span> <span class="n">enctype</span><span class="o">=</span><span class="s2">&quot;multipart/form-data&quot;</span><span class="p">)</span>
  <span class="o">!=</span> <span class="n">antiCsrfInput</span>

  <span class="n">label</span> <span class="n">Please</span> <span class="n">select</span> <span class="n">a</span> <span class="n">file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myFile&quot;</span><span class="p">)</span>

  <span class="n">button</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="p">)</span> <span class="n">Upload</span>
</pre></div>
</div>
<p>В контроллере <code class="docutils literal notranslate"><span class="pre">MyUpload</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.multipart.FileUpload</span>

<span class="n">val</span> <span class="n">myFile</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">FileUpload</span><span class="p">](</span><span class="s2">&quot;myFile&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">myFile</span></code> это экземпляр <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/multipart/FileUpload.html">FileUpload</a>.
Используйте его методы для получения имени файла, перемещения в директорию и пр.</p>
<p>Маленькие файлы (менее 16 Кб) сохраняются в памяти. Большие файлы сохраняются
в директорию для временных файлов (смотри конфигурацию <code class="docutils literal notranslate"><span class="pre">xitrum.request.tmpUploadDir</span></code> в xitrum.conf),
и будут удалены автоматически после закрытия соединения или когда запрос будет отправлен.</p>
<div class="section" id="ajax">
<h3>Ajax загрузка файлов<a class="headerlink" href="#ajax" title="Ссылка на этот заголовок">¶</a></h3>
<p>Доступно множество JavaScript библиотек осуществляющих Ajax загрузку файлов.
Они используют скрытый iframe или flash для отправки <code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code> на сервер.
Если вы не уверены какой параметр использует библиотека в форме для отправки файла, смотрите
лог доступа Xitrum.</p>
</div>
</div>
<span id="document-filter"></span><div class="section" id="id1">
<h2>Фильтры<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="before-filter">
<h3>Пре-фильтр (before filter)<a class="headerlink" href="#before-filter" title="Ссылка на этот заголовок">¶</a></h3>
<p>Если пре-фильтр отправляет ответ сервера (вызывает respond или forwardTo), то все остальные фильтры и сам контроллер не будет
запущен.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;before_filter&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">beforeFilter</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;I run therefore I am&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">метод</span> <span class="n">выполнится</span> <span class="n">после</span> <span class="n">всех</span> <span class="n">фильтров</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="s2">&quot;Пре-фильтр должны быть выполнен, проверьте лог&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="after-filter">
<h3>Пост-фильтры (after filter)<a class="headerlink" href="#after-filter" title="Ссылка на этот заголовок">¶</a></h3>
<p>Пост-фильтры запускаются после выполнения контроллера.
Они не принимают аргументов и не возвращают значений.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;after_filter&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">afterFilter</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Время запуска &quot;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Пост-фильтр должен будет запустится, проверьте лог&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="around-filter">
<h3>Внешние фильтры (around filter)<a class="headerlink" href="#around-filter" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;around_filter&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">aroundFilter</span> <span class="p">{</span> <span class="n">action</span> <span class="o">=&gt;</span>
    <span class="n">val</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
    <span class="n">action</span><span class="p">()</span>
    <span class="n">val</span> <span class="n">end</span>   <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
    <span class="n">val</span> <span class="n">dt</span>    <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="s2">&quot;Контролер выполнялся $dt [ms]&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Внешний фильтр должен выполниться, проверьте лог&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Если внешних фильтров будет несколько, они будут вложены друг в друга.</p>
</div>
<div class="section" id="id2">
<h3>Порядок выполнения фильтров<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<ul class="simple">
<li><p>Вначале выполняются пре-фильтры, затем внешние фильтры, и последними выполняются пост-фильтры.</p></li>
<li><p>Если пре-фильтр возвращает false, остальные фильтры (включая внешние и пост-фильтры) не будут запущены.</p></li>
<li><p>Пост-фильтры выполняются, в том числе, если хотя бы один из внешних фильтров выполнился.</p></li>
<li><p>Если внешний фильтр не вызывает <code class="docutils literal notranslate"><span class="pre">action</span></code>, вложенные внешние фильтры не будут выполнены.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before1</span> <span class="o">-</span><span class="n">true</span><span class="o">-&gt;</span> <span class="n">before2</span> <span class="o">-</span><span class="n">true</span><span class="o">-&gt;</span> <span class="o">+--------------------+</span> <span class="o">--&gt;</span> <span class="n">after1</span> <span class="o">--&gt;</span> <span class="n">after2</span>
                                <span class="o">|</span> <span class="n">around1</span> <span class="p">(</span><span class="mi">1</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">|</span>
                                <span class="o">|</span>   <span class="n">around2</span> <span class="p">(</span><span class="mi">1</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
                                <span class="o">|</span>     <span class="n">action</span>         <span class="o">|</span>
                                <span class="o">|</span>   <span class="n">around2</span> <span class="p">(</span><span class="mi">2</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
                                <span class="o">|</span> <span class="n">around1</span> <span class="p">(</span><span class="mi">2</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">|</span>
                                <span class="o">+--------------------+</span>
</pre></div>
</div>
</div>
</div>
<span id="document-cache"></span><div class="section" id="id1">
<h2>Кэш на стороне сервера<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Так же смотри главу про <a class="reference internal" href="index.html#document-cluster"><span class="doc">кластеризацию</span></a>.</p>
<p>Xitrum предоставляет широкие возможности для кэширования на стороне клиента и сервера.
На уровне веб сервера, маленькие файлы кэшируются в памяти, большие отправляются по
технологии zero copy. Скорость отдачи статических файлов сравнима с
<a class="reference external" href="https://gist.github.com/3293596">Nginx</a>.
На уровне фреймворка вы можете использовать кэш страницы, кэш контроллера или объектный кэш в
стиле Rails.
Xitrum придерживается <a class="reference external" href="http://code.google.com/speed/page-speed/docs/rules_intro.html">рекомендации Google</a>.</p>
<p>Для динамического контента, если контент не меняется после создания (как в случае статического
файла), вы можете установить необходимые заголовки для агрессивного кэширования. В этом
случае используйте метод <code class="docutils literal notranslate"><span class="pre">setClientCacheAggressively()</span></code> в контроллере.</p>
<p>Иногда требуется запретить кэширование на стороне клиента. В этом случае используйте
<code class="docutils literal notranslate"><span class="pre">setNoClientCache()</span></code> в контроллере.</p>
<p>Кэширование на стороне сервера более подробно рассматривается ниже.</p>
<div class="section" id="id2">
<h3>Кэширование страницы или контроллера<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">CacheActionMinute</span><span class="p">,</span> <span class="n">CachePageMinute</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="nd">@CachePageMinute</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesIndex</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="nd">@CacheActionMinute</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Термин «кэш страницы» и «кэш контроллера» позаимствован из
<a class="reference external" href="http://guides.rubyonrails.org/caching_with_rails.html">Ruby on Rails</a>.</p>
<p>Последовательность обработки запроса следующая:
(1) запрос -&gt; (2) пре-фильтры -&gt; (3) метод execute контроллера -&gt; (4) ответ</p>
<p>После первого запроса, Xitrum закеширует ответ на указанный период времени.
<code class="docutils literal notranslate"><span class="pre">&#64;CachePageMinute(1)</span></code> или <code class="docutils literal notranslate"><span class="pre">&#64;CacheActionMinute(1)</span></code> задают время кэша равное одной минуте.
Xitrum кэширует страницы только в случае если ответ имеет статус «200 OK». Например, ответ
со статусом «500 Internal Server Error» или «302 Found» (redirect) не будет помещен в кэш.</p>
<p>В случае запросов к тому же контроллеру, если кэш еще не устарел, Xitrum в качестве
ответа будет использовать значение из кэша:</p>
<ul class="simple">
<li><p>Для кэша страницы, последовательность обработки (1) -&gt; (4).</p></li>
<li><p>Для кэша контроллера, последовательность обработки (1) -&gt; (2) -&gt; (4), или просто (1) -&gt; (2)
если пре-фильтр вернет значение «false».</p></li>
</ul>
<p>Единственное различие: для кэша страницы пре-фильтры не запускаются.</p>
<p>Обычно, кэш страницы используется когда один и тот же ответ подходит для всех пользователей.
Кэш контроллера используется когда вам нужно использовать пре-фильтр как защиту, например
для проверки авторизации пользователя:</p>
<ul class="simple">
<li><p>Если пользователь прошел авторизацию, он может получать кэшированный ответ.</p></li>
<li><p>Если нет, отправить пользователя на страницу авторизации.</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>Кэш объект<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>Кэширующие методы предоставляются объектом <code class="docutils literal notranslate"><span class="pre">xitrum.Config.xitrum.cache</span></code>, наследником
<a class="reference external" href="http://xitrum-framework.github.io/api/3.17/index.html#xitrum.Cache">xitrum.Cache</a>.</p>
<p>Без указания TTL (времени жизни):</p>
<ul class="simple">
<li><p>put(key, value)</p></li>
</ul>
<p>С указанием TTL:</p>
<ul class="simple">
<li><p>putSecond(key, value, seconds)</p></li>
<li><p>putMinute(key, value, minutes)</p></li>
<li><p>putHour(key, value, hours)</p></li>
<li><p>putDay(key, value, days)</p></li>
</ul>
<p>Обновление кэша только в случае отсутствия значения:</p>
<ul class="simple">
<li><p>putIfAbsent(key, value)</p></li>
<li><p>putIfAbsentSecond(key, value, seconds)</p></li>
<li><p>putIfAbsentMinute(key, value, minutes)</p></li>
<li><p>putIfAbsentHour(key, value, hours)</p></li>
<li><p>putIfAbsentDay(key, value, days)</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>Удаление кэша<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h3>
<p>Удаление кэша страницы или контроллера:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">removeAction</span><span class="p">[</span><span class="n">MyAction</span><span class="p">]</span>
</pre></div>
</div>
<p>Удаление объектного кэша:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>Удаление всех ключей начинающихся с префикса:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">removePrefix</span><span class="p">(</span><span class="n">keyPrefix</span><span class="p">)</span>
</pre></div>
</div>
<p>При использовании <code class="docutils literal notranslate"><span class="pre">removePrefix</span></code>, вы можете организовать иерархический кэш. Например, вы можете
создавать кэш связанной со статьей, а когда статья изменится просто удалите весь кэш статьи.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Config.xitrum.cache</span>

<span class="o">//</span> <span class="n">Кэш</span> <span class="n">с</span> <span class="n">префиксом</span>
<span class="n">val</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;articles/&quot;</span> <span class="o">+</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span>
<span class="n">cache</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;/likes&quot;</span><span class="p">,</span> <span class="n">likes</span><span class="p">)</span>
<span class="n">cache</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;/comments&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Позднее</span><span class="p">,</span> <span class="n">очистка</span> <span class="n">кэша</span>
<span class="n">cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>Конфигурация<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p>Вы можете использовать свою реализацию кэша.</p>
<p>В файле <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a>,
вы можете настроить кэш двумя способами:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">EngineClassName</span>
</pre></div>
</div>
<p>Или:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="p">{</span>
  <span class="s2">&quot;my.cache.EngineClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Xitrum предоставляет реализацию по умолчанию:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="p">{</span>
  <span class="c1"># Simple in-memory cache</span>
  <span class="s2">&quot;xitrum.local.LruCache&quot;</span> <span class="p">{</span>
    <span class="n">maxElems</span> <span class="o">=</span> <span class="mi">10000</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Если вы используете кластер, вы можете использовать <a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">Hazelcast</a>.</p>
<p>Для создания своей реализации кэша, реализуйте интерфейс <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/Cache.scala">interface</a>
<code class="docutils literal notranslate"><span class="pre">xitrum.Cache</span></code>.</p>
</div>
<div class="section" id="id6">
<h3>Как работает кэш<a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h3>
<p>Вход:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               ответ контроллера
               должен быть в кэше
запрос         и кэш существует?
-------------------------+---------------НЕТ--------------&gt;
                         |
&lt;---------ДА-------------+
  ответ из кэша
</pre></div>
</div>
<p>Выход:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               ответ контроллера
               должен быть помещен в кэш
               кэш не существует?                     ответ
&lt;---------НЕТ------------+---------------------------------
                         |
&lt;---------ДА-------------+
  сохранить ответ в кэше
</pre></div>
</div>
</div>
<div class="section" id="xitrum-util-locallrucache">
<h3>xitrum.util.LocalLruCache<a class="headerlink" href="#xitrum-util-locallrucache" title="Ссылка на этот заголовок">¶</a></h3>
<p>Этот кэш переиспользуется всеми компонентами Xitrum. Если вам нужен отдельный небольшой
кэш, вы можете использовать <code class="docutils literal notranslate"><span class="pre">xitrum.util.LocalLruCache</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.LocalLruCache</span>

<span class="o">//</span> <span class="n">LRU</span> <span class="p">(</span><span class="n">Least</span> <span class="n">Recently</span> <span class="n">Used</span><span class="p">)</span> <span class="n">кэш</span> <span class="n">содержит</span> <span class="n">до</span> <span class="mi">1000</span> <span class="n">элементов</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Ключи</span> <span class="n">и</span> <span class="n">значения</span> <span class="n">имеет</span> <span class="n">тип</span> <span class="n">String</span><span class="o">.</span>
<span class="n">val</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">LocalLruCache</span><span class="p">[</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="p">](</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>Переменная  <code class="docutils literal notranslate"><span class="pre">cache</span></code> имеет тип <a class="reference external" href="http://docs.oracle.com/javase/6/docs/api/java/util/LinkedHashMap.html">java.util.LinkedHashMap</a>. Вы можете использовать методы из <code class="docutils literal notranslate"><span class="pre">LinkedHashMap</span></code>.</p>
</div>
</div>
<span id="document-i18n"></span><div class="section" id="id1">
<h2>Интернационализация<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Для интернационализации используется GNU gettext. В отличии от других программ, gettext поддерживает множественные
числа.</p>
<img alt="_images/poedit.png" src="_images/poedit.png" />
<div class="section" id="id2">
<h3>Используйте интернационализированные сообщения непосредственно в коде<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">xitrum.Action</span></code> наследуется от <code class="docutils literal notranslate"><span class="pre">xitrum.I18n</span></code> и предоставляет методы:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>t(&quot;Message&quot;)
tc(&quot;Context&quot;, &quot;Message&quot;)

t(&quot;Hello %s&quot;).format(&quot;World&quot;)

// 1$ and 2$ are placeholders
t(&quot;%1$s says hello to %2$s, then %2$s says hello back to %1$s&quot;).format(&quot;Bill&quot;, &quot;Hillary&quot;)

// {0} and {1} are placeholders
java.text.MessageFormat.format(t(&quot;{0} says hello to {1}, then {1} says hello back to {0}&quot;), &quot;Bill&quot;, &quot;Hillary&quot;)

t(&quot;%,.3f&quot;).format(1234.5678)                                // =&gt; 1,234.568
t(&quot;%,.3f&quot;).formatLocal(java.util.Locale.FRENCH, 1234.5678)  // =&gt; 1 234,568
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Above</span><span class="p">,</span> <span class="n">you</span> <span class="n">explicitly</span> <span class="n">specify</span> <span class="n">locale</span><span class="o">.</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">implicitly</span> <span class="n">use</span> <span class="n">locale</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">action</span><span class="p">:</span>
<span class="o">//</span> <span class="n">when</span> <span class="n">English</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span><span class="mf">234.568</span><span class="p">,</span> <span class="n">when</span> <span class="n">French</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="mi">234</span><span class="p">,</span><span class="mi">568</span>
<span class="n">t</span><span class="p">(</span><span class="s2">&quot;%,.3f&quot;</span><span class="p">,</span> <span class="mf">1234.5678</span><span class="p">)</span>
</pre></div>
</div>
<p>В других местах, вам нужно передать текущий контроллер что бы использовать <code class="docutils literal notranslate"><span class="pre">t</span></code> и <code class="docutils literal notranslate"><span class="pre">tc</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">В</span> <span class="n">контроллере</span>
<span class="n">respondText</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>

<span class="o">//</span> <span class="n">В</span> <span class="n">модели</span>
<span class="kn">import</span> <span class="nn">xitrum.I18n</span>
<span class="nb">object</span> <span class="n">MyModel</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">i18n</span><span class="p">:</span> <span class="n">I18n</span><span class="p">)</span> <span class="o">=</span> <span class="n">i18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pot">
<h3>Извлечение сообщений в pot файл<a class="headerlink" href="#pot" title="Ссылка на этот заголовок">¶</a></h3>
<p>Создайте пустой i18n.pot файл в корневой директории проекта, скомпилируйте проект.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="n">clean</span>
<span class="n">rm</span> <span class="n">i18n</span><span class="o">.</span><span class="n">pot</span>
<span class="n">touch</span> <span class="n">i18n</span><span class="o">.</span><span class="n">pot</span>
<span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="nb">compile</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">clean</span></code> удалит все .class файлы, тем самым принудит SBT выполнить компиляцию всего проекта.
Поскольку после <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">clean</span></code>, SBT выполняет обновление всех <a class="reference internal" href="index.html#document-deps"><span class="doc">зависимостей</span></a>,
вы можете ускорить процесс выполнив команду <code class="docutils literal notranslate"><span class="pre">find</span> <span class="pre">target</span> <span class="pre">-name</span> <span class="pre">*.class</span> <span class="pre">-delete</span></code>, которая удалит
все .class файлы в директории <code class="docutils literal notranslate"><span class="pre">target</span></code>.</p>
<p>После компиляции, i18n.pot будет заполнен сообщениями извлеченными из исходного кода. Такое поведение реализуется
через <a class="reference external" href="http://www.scala-lang.org/node/140">плагин для компилятора Scala</a>.</p>
<p>Единственный недостаток этого метода в том что сообщения извлекаются только из
исходного кода Scala. Если у вас используются java файлы, вам придется добавить сообщения
самостоятельно через командную строку используя интерфейс <code class="docutils literal notranslate"><span class="pre">xgettext</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>xgettext -kt -ktc:1c,2 -ktn:1,2 -ktcn:1c,2,3 -o i18n_java.pot --from-code=UTF-8 $(find src/main/java -name &quot;*.java&quot;)
</pre></div>
</div>
<p>Затем вам необходимо объединить i18n_java.pot и i18n.pot.</p>
</div>
<div class="section" id="po">
<h3>Где сохранять po файлы<a class="headerlink" href="#po" title="Ссылка на этот заголовок">¶</a></h3>
<p>i18n.pot это шаблонный файл. Вы должны перевести его и сохранить как &lt;язык&gt;.po.</p>
<p>Xitrum отслеживает директорию <code class="docutils literal notranslate"><span class="pre">i18n</span></code> в classpath.
Файлы &lt;язык&gt;.po  из этой директории загружаются во время работы приложения,
Xitrum автоматически перезагружает эти файлы если они изменились.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">src</span>
  <span class="n">main</span>
    <span class="n">scala</span>
    <span class="n">view</span>
    <span class="n">resources</span>
      <span class="n">i18n</span>
        <span class="n">ja</span><span class="o">.</span><span class="n">po</span>
        <span class="n">vi</span><span class="o">.</span><span class="n">po</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Используйте <a class="reference external" href="http://www.poedit.net/">Poedit</a> для редактирования po файлов.
Вы можете использовать его для добавления новых pot файлов в po файл.</p>
<img alt="_images/update_from_pot.png" src="_images/update_from_pot.png" />
<p>Вы можете поставлять po файлы в составе JAR. Xitrum  автоматически объединит их
при запуске.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mylib</span><span class="o">.</span><span class="n">jar</span>
  <span class="n">i18n</span>
    <span class="n">ja</span><span class="o">.</span><span class="n">po</span>
    <span class="n">vi</span><span class="o">.</span><span class="n">po</span>
        <span class="o">...</span>

<span class="n">another</span><span class="o">.</span><span class="n">jar</span>
  <span class="n">i18n</span>
    <span class="n">ja</span><span class="o">.</span><span class="n">po</span>
    <span class="n">vi</span><span class="o">.</span><span class="n">po</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>Выбор языка<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<ul class="simple">
<li><p>Для выбор языка согласно заголовку запроса <code class="docutils literal notranslate"><span class="pre">Accept-Language</span></code>,
используйте метод <code class="docutils literal notranslate"><span class="pre">browserLanguages</span></code>. Результат выбора определяется согласно приоритету
браузера.</p></li>
<li><p>Язык по умолчанию устанавливается «en». Для смены текущего языка используйте присвоение переменной <code class="docutils literal notranslate"><span class="pre">language</span></code>.
Например, для русского языка <code class="docutils literal notranslate"><span class="pre">language</span> <span class="pre">=</span> <span class="pre">&quot;ru&quot;</span></code>.</p></li>
<li><p>Для выбора подходящего языка из доступных, используйте вызов
<code class="docutils literal notranslate"><span class="pre">autosetLanguage(availableLanguages)</span></code>, где
<code class="docutils literal notranslate"><span class="pre">availableLanguages</span></code> список доступных языков из директории
<code class="docutils literal notranslate"><span class="pre">resources/i18n</span></code> и JAR файлов.
Если подходящего языка нет, будет установлен язык «en».</p></li>
<li><p>Для получения текущего языка используйте <code class="docutils literal notranslate"><span class="pre">language</span></code>.</p></li>
</ul>
<p>В контроллере обычно объявляют пре-фильтр для установки языка:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">beforeFilter</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">lango</span><span class="p">:</span> <span class="n">Option</span><span class="p">[</span><span class="n">String</span><span class="p">]</span> <span class="o">=</span> <span class="n">yourMethodToGetUserPreferenceLanguageInSession</span><span class="p">()</span>
  <span class="n">lango</span> <span class="n">match</span> <span class="p">{</span>
    <span class="n">case</span> <span class="kc">None</span>       <span class="o">=&gt;</span> <span class="n">autosetLanguage</span><span class="p">(</span><span class="n">Locale</span><span class="o">.</span><span class="n">forLanguageTag</span><span class="p">(</span><span class="s2">&quot;ja&quot;</span><span class="p">),</span> <span class="n">Locale</span><span class="o">.</span><span class="n">forLanguageTag</span><span class="p">(</span><span class="s2">&quot;vi&quot;</span><span class="p">))</span>
    <span class="n">case</span> <span class="n">Some</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">language</span> <span class="o">=</span> <span class="n">lang</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Валидационные сообщения<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h3>
<p>Плагин jQuery Validation предоставляет возможности для <a class="reference external" href="https://github.com/jzaefferer/jquery-validation/tree/master/src/localization">интернационализации сообщений</a>.
Xitrum автоматически подключает файл с сообщениями подходящими для данного языка.</p>
<p>На стороне сервера для стандартных валидаторов из пакета <code class="docutils literal notranslate"><span class="pre">xitrum.validator</span></code> Xitrum предоставляет переводы.</p>
</div>
<div class="section" id="id6">
<h3>Множественные числа<a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tn</span><span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="s2">&quot;Plural form&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">tcn</span><span class="p">(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="s2">&quot;Plural form&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>Xitrum может работать с множественными числами представленными ниже:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.gnu.org/software/gettext/manual/html_node/Plural-forms.html#Plural-forms">What are plural forms</a></p></li>
<li><p><a class="reference external" href="http://www.gnu.org/software/gettext/manual/html_node/Translating-plural-forms.html#Translating-plural-forms">Translating plural forms</a></p></li>
</ul>
<p>Шаблон множественных чисел может быть одним из:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nplurals=1; plural=0
nplurals=2; plural=n != 1
nplurals=2; plural=n&gt;1
nplurals=3; plural=n%10==1 &amp;&amp; n%100!=11 ? 0 : n != 0 ? 1 : 2
nplurals=3; plural=n==1 ? 0 : n==2 ? 1 : 2
nplurals=3; plural=n==1 ? 0 : (n==0 || (n%100 &gt; 0 &amp;&amp; n%100 &lt; 20)) ? 1 : 2
nplurals=3; plural=n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2
nplurals=3; plural=n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2
nplurals=3; plural=(n==1) ? 0 : (n&gt;=2 &amp;&amp; n&lt;=4) ? 1 : 2
nplurals=3; plural=n==1 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2
nplurals=4; plural=n%100==1 ? 0 : n%100==2 ? 1 : n%100==3 || n%100==4 ? 2 : 3
</pre></div>
</div>
</div>
</div>
<span id="document-log"></span><div class="section" id="id1">
<h2>Логирование<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="xitrum-log">
<h3>Использование объекта xitrum.Log<a class="headerlink" href="#xitrum-log" title="Ссылка на этот заголовок">¶</a></h3>
<p>Везде вы можете использовать напрямую:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xitrum</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;My debug msg&quot;</span><span class="p">)</span>
<span class="n">xitrum</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;My info msg&quot;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Использование трейта xitrum.Log<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Если вам важно сообщать дополнительную информацию о том какой класс генерирует
информационные сообщения, используйте наследование он xitrum.Log</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">my_package</span>
<span class="kn">import</span> <span class="nn">xitrum.Log</span>

<span class="nb">object</span> <span class="n">MyModel</span> <span class="n">extends</span> <span class="n">Log</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;My debug msg&quot;</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;My info msg&quot;</span><span class="p">)</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>В файле log/xitrum.log вы увидите сообщение <code class="docutils literal notranslate"><span class="pre">MyModel</span></code>.</p>
<p>Контролеры Xitrum наследуют xitrum.Log и предоставляют метод <code class="docutils literal notranslate"><span class="pre">log</span></code>.
В любом контроллере вы можете писать:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>Проверка уровня логирования<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">xitrum.Log</span></code> основан на <a class="reference external" href="http://slf4s.org/">SLF4S</a> (<a class="reference external" href="http://slf4s.org/api/1.7.7/">API</a>),
который в свою очередь на <a class="reference external" href="http://www.slf4j.org/">SLF4J</a>.</p>
<p>Обычно, перед выполнением сложных вычислений которые будут отправлены в лог, выполняют
проверку уровня логирования что бы избежать не нужных вычислений.</p>
<p><a class="reference external" href="https://github.com/mattroberts297/slf4s/blob/master/src/main/scala/org/slf4s/Logger.scala">SLF4S автоматически выполняет эти проверки</a>,
поэтому нет нужды их выполнять самому.</p>
<p>До Xitrum 3.13+:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">isTraceEnabled</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">result</span> <span class="o">=</span> <span class="n">heavyCalculation</span><span class="p">()</span>
  <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Output: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Теперь:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="s2">&quot;Output: #{heavyCalculation()}&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>Настройка уровня и способов логирования<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h3>
<p>В build.sbt есть строчка:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;ch.qos.logback&quot;</span> <span class="o">%</span> <span class="s2">&quot;logback-classic&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.1.2&quot;</span>
</pre></div>
</div>
<p>Что означает использовать <a class="reference external" href="http://logback.qos.ch/">Logback</a>.
Конфигурационный файл Logback - <code class="docutils literal notranslate"><span class="pre">config/logback.xml</span></code>.</p>
<p>Вы можете заменить Logback любой другой реализацией <a class="reference external" href="http://www.slf4j.org/">SLF4J</a>.</p>
</div>
<div class="section" id="fluentd">
<h3>Использование Fluentd<a class="headerlink" href="#fluentd" title="Ссылка на этот заголовок">¶</a></h3>
<p><a class="reference external" href="http://www.fluentd.org/">Fluentd</a> очень популярная система сбора логов. Вы можете
настроить Logback так что бы отправлять логи (возможно из нескольких мест) на Fluentd сервер.</p>
<p>Первое, добавьте библиотеку <a class="reference external" href="https://github.com/sndyuk/logback-more-appenders">logback-more-appenders</a>
в ваш проект:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;org.fluentd&quot;</span> <span class="o">%</span> <span class="s2">&quot;fluent-logger&quot;</span> <span class="o">%</span> <span class="s2">&quot;0.2.11&quot;</span>

<span class="n">resolvers</span> <span class="o">+=</span> <span class="s2">&quot;Logback more appenders&quot;</span> <span class="n">at</span> <span class="s2">&quot;http://sndyuk.github.com/maven&quot;</span>

<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;com.sndyuk&quot;</span> <span class="o">%</span> <span class="s2">&quot;logback-more-appenders&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.1.0&quot;</span>
</pre></div>
</div>
<p>Затем исправьте конфигурацию <code class="docutils literal notranslate"><span class="pre">config/logback.xml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...

&lt;appender name=&quot;FLUENT&quot; class=&quot;ch.qos.logback.more.appenders.DataFluentAppender&quot;&gt;
  &lt;tag&gt;mytag&lt;/tag&gt;
  &lt;label&gt;mylabel&lt;/label&gt;
  &lt;remoteHost&gt;localhost&lt;/remoteHost&gt;
  &lt;port&gt;24224&lt;/port&gt;
  &lt;maxQueueSize&gt;20000&lt;/maxQueueSize&gt;  &lt;!-- Позволяет экономить память если сервер выключен --&gt;
&lt;/appender&gt;

&lt;root level=&quot;DEBUG&quot;&gt;
  &lt;appender-ref ref=&quot;FLUENT&quot;/&gt;
  &lt;appender-ref ref=&quot;OTHER_APPENDER&quot;/&gt;
&lt;/root&gt;

...
</pre></div>
</div>
</div>
</div>
<span id="document-deploy"></span><div class="section" id="id1">
<h2>Развертывание на сервере<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Вы можете запустить Xitrum напрямую:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Браузер</span> <span class="o">------</span> <span class="n">экземпляр</span> <span class="n">Xitrum</span> <span class="n">сервера</span>
</pre></div>
</div>
<p>Или добавить балансировщик нагрузки (например, HAProxy), или обратный прокси сервер (например, Apache или Nginx):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Браузер</span> <span class="o">------</span> <span class="n">Балансировщик</span><span class="o">/</span><span class="n">Прокси</span> <span class="o">-+----</span> <span class="n">экземпляр</span> <span class="n">Xitrum</span> <span class="n">сервера</span>
                                     <span class="o">+----</span> <span class="n">экземпляр</span> <span class="n">Xitrum</span> <span class="n">сервера</span>
</pre></div>
</div>
<div class="section" id="id2">
<h3>Сборка<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Используйте команду <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">xitrumPackage</span></code> для подготовки директории <code class="docutils literal notranslate"><span class="pre">target/xitrum</span></code>, которая
может быть развернута на сервере:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">target</span><span class="o">/</span><span class="n">xitrum</span>
  <span class="n">config</span>
    <span class="p">[</span><span class="n">config</span> <span class="n">files</span><span class="p">]</span>
  <span class="n">public</span>
    <span class="p">[</span><span class="n">static</span> <span class="n">public</span> <span class="n">files</span><span class="p">]</span>
  <span class="n">lib</span>
    <span class="p">[</span><span class="n">dependencies</span> <span class="ow">and</span> <span class="n">packaged</span> <span class="n">project</span> <span class="n">file</span><span class="p">]</span>
  <span class="n">script</span>
    <span class="n">runner</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">bat</span>
    <span class="n">scalive</span>
    <span class="n">scalive</span><span class="o">.</span><span class="n">jar</span>
    <span class="n">scalive</span><span class="o">.</span><span class="n">bat</span>
</pre></div>
</div>
</div>
<div class="section" id="xitrum-package">
<h3>Сборка и xitrum-package<a class="headerlink" href="#xitrum-package" title="Ссылка на этот заголовок">¶</a></h3>
<p>По умолчанию команда <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">xitrumPackage</span></code> копирует директории
<code class="docutils literal notranslate"><span class="pre">config</span></code>, <code class="docutils literal notranslate"><span class="pre">public</span></code>, и <code class="docutils literal notranslate"><span class="pre">script</span></code> в <code class="docutils literal notranslate"><span class="pre">target/xitrum</span></code>. Если необходимо
дополнительно копировать какие-то директории или файлы измените <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code>
следующим образом:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XitrumPackage</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;public, &quot;</span><span class="n">script</span><span class="s2">&quot;, &quot;</span><span class="n">doc</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">txt</span><span class="s2">&quot;, &quot;</span><span class="n">etc</span><span class="o">.</span><span class="s2">&quot;)</span>
</pre></div>
</div>
<p>Подробнее смотри <a class="reference external" href="https://github.com/xitrum-framework/xitrum-package">xitrum-package</a>.</p>
</div>
<div class="section" id="scala-jvm">
<h3>Подключение Scala консоли к запущенному JVM процессу<a class="headerlink" href="#scala-jvm" title="Ссылка на этот заголовок">¶</a></h3>
<p>В боевом режиме, при определенной настройке, допускается использовать
<a class="reference external" href="https://github.com/xitrum-framework/scalive">Scalive</a> для подключения
Scala консоли к работающему JVM процессу для живой отладки.</p>
<p>Запустите <code class="docutils literal notranslate"><span class="pre">scalive</span></code> из директории script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span>
  <span class="n">runner</span>
  <span class="n">runner</span><span class="o">.</span><span class="n">bat</span>
  <span class="n">scalive</span>
  <span class="n">scalive</span><span class="o">.</span><span class="n">jar</span>
  <span class="n">scalive</span><span class="o">.</span><span class="n">bat</span>
</pre></div>
</div>
</div>
<div class="section" id="oracle-jdk-centos-ubuntu">
<h3>Установка Oracle JDK на CentOS или Ubuntu<a class="headerlink" href="#oracle-jdk-centos-ubuntu" title="Ссылка на этот заголовок">¶</a></h3>
<p>Приведенная информация размещена здесь для удобства. Вы можете установить Java используя
пакетный менеджер.</p>
<p>Проверьте установленные альтернативы:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="nb">list</span> <span class="n">java</span>
</pre></div>
</div>
<p>Пример вывода:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_15</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_25</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>
</pre></div>
</div>
<p>Определите ваше окружение (32 бита или 64 бита):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span>
</pre></div>
</div>
<p>Пример вывода:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span><span class="p">:</span> <span class="n">ELF</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">shared</span> <span class="nb">object</span><span class="p">,</span> <span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">version</span> <span class="mi">1</span> <span class="p">(</span><span class="n">SYSV</span><span class="p">),</span> <span class="n">dynamically</span> <span class="n">linked</span> <span class="p">(</span><span class="n">uses</span> <span class="n">shared</span> <span class="n">libs</span><span class="p">),</span> <span class="k">for</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="mf">2.6</span><span class="o">.</span><span class="mi">24</span><span class="p">,</span> <span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="mh">0x4efe732752ed9f8cc491de1c8a271eb7f4144a5c</span><span class="p">,</span> <span class="n">stripped</span>
</pre></div>
</div>
<p>Скачайте JDK по ссылке <a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html">Oracle</a>.
<a class="reference external" href="http://stackoverflow.com/questions/10268583/how-to-automate-download-and-instalation-of-java-jdk-on-linux">Обходной путь</a> для загрузки jdk без браузера:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cookies</span> <span class="o">--</span><span class="n">header</span> <span class="s2">&quot;Cookie: gpw_e24=http%3A</span><span class="si">%2F%2F</span><span class="s2">www.oracle.com&quot;</span> <span class="s2">&quot;http://download.oracle.com/otn-pub/java/jdk/7u45-b18/jdk-7u45-linux-x64.tar.gz&quot;</span>
</pre></div>
</div>
<p>Распакуйте и переместите в подходящею папку:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">xzvf</span> <span class="n">jdk</span><span class="o">-</span><span class="mi">7</span><span class="n">u45</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span>
</pre></div>
</div>
<p>Зарегистрируйте как альтернативу:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/java&quot;</span> <span class="s2">&quot;java&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/java&quot;</span> <span class="mi">1</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/javac&quot;</span> <span class="s2">&quot;javac&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/javac&quot;</span> <span class="mi">1</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/javap&quot;</span> <span class="s2">&quot;javap&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/javap&quot;</span> <span class="mi">1</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/javaws&quot;</span> <span class="s2">&quot;javaws&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/javaws&quot;</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Установите как активную альтернативу:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">java</span>
</pre></div>
</div>
<p>Пример вывода:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">There</span> <span class="n">are</span> <span class="mi">3</span> <span class="n">choices</span> <span class="k">for</span> <span class="n">the</span> <span class="n">alternative</span> <span class="n">java</span> <span class="p">(</span><span class="n">providing</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span><span class="p">)</span><span class="o">.</span>

  <span class="n">Selection</span>    <span class="n">Path</span>                               <span class="n">Priority</span>   <span class="n">Status</span>
<span class="o">------------------------------------------------------------</span>
<span class="o">*</span> <span class="mi">0</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_25</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">50001</span>     <span class="n">auto</span> <span class="n">mode</span>
  <span class="mi">1</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_15</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">50000</span>     <span class="n">manual</span> <span class="n">mode</span>
  <span class="mi">2</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_25</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">50001</span>     <span class="n">manual</span> <span class="n">mode</span>
  <span class="mi">3</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">1</span>         <span class="n">manual</span> <span class="n">mode</span>

<span class="n">Press</span> <span class="n">enter</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">current</span> <span class="n">choice</span><span class="p">[</span><span class="o">*</span><span class="p">],</span> <span class="ow">or</span> <span class="nb">type</span> <span class="n">selection</span> <span class="n">number</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">update</span><span class="o">-</span><span class="n">alternatives</span><span class="p">:</span> <span class="n">using</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span> <span class="n">to</span> <span class="n">provide</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span> <span class="p">(</span><span class="n">java</span><span class="p">)</span> <span class="ow">in</span> <span class="n">manual</span> <span class="n">mode</span>
</pre></div>
</div>
<p>Проверьте версию:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">version</span>
</pre></div>
</div>
<p>Пример вывода:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="n">version</span> <span class="s2">&quot;1.7.0_45&quot;</span>
<span class="n">Java</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">SE</span> <span class="n">Runtime</span> <span class="n">Environment</span> <span class="p">(</span><span class="n">build</span> <span class="mf">1.7</span><span class="o">.</span><span class="mi">0_45</span><span class="o">-</span><span class="n">b18</span><span class="p">)</span>
<span class="n">Java</span> <span class="n">HotSpot</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="mi">64</span><span class="o">-</span><span class="n">Bit</span> <span class="n">Server</span> <span class="n">VM</span> <span class="p">(</span><span class="n">build</span> <span class="mf">24.45</span><span class="o">-</span><span class="n">b08</span><span class="p">,</span> <span class="n">mixed</span> <span class="n">mode</span><span class="p">)</span>
</pre></div>
</div>
<p>Установите альтернативы так же для:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">javac</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">javap</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">javaws</span>
</pre></div>
</div>
</div>
<div class="section" id="xitrum">
<h3>Запускайте Xitrum в боевом режиме когда система запускается<a class="headerlink" href="#xitrum" title="Ссылка на этот заголовок">¶</a></h3>
<p>Скрипт <code class="docutils literal notranslate"><span class="pre">script/runner</span></code> (для <a href="#id5"><span class="problematic" id="id6">*</span></a>nix) и <code class="docutils literal notranslate"><span class="pre">script/runner.bat</span></code> (для Windows) запускает
сервер в боевом окружении используя указанный объект как <code class="docutils literal notranslate"><span class="pre">main</span></code> класс.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="o">/</span><span class="n">runner</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">Boot</span>
</pre></div>
</div>
<p>Вы можете улучшить <code class="docutils literal notranslate"><span class="pre">runner</span></code> (или <code class="docutils literal notranslate"><span class="pre">runner.bat</span></code>)
<a class="reference external" href="http://www.oracle.com/technetwork/java/hotspotfaq-138619.html">настроив JVM</a>.
Так же смотри <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code>.</p>
<p>Для запуска Xitrum в фоновом режиме при старте Linux системы проще всего добавить строчку в <code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">su</span> <span class="o">-</span> <span class="n">user_foo_bar</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">the</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">above</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>Кроме того можно использовать утилиту <a class="reference external" href="http://cr.yp.to/daemontools.html">daemontools</a>. Для установки на CentOS, смотри <a class="reference external" href="http://whomwah.com/2008/11/04/installing-daemontools-on-centos5-x86_64/">инструкцию</a>.</p>
<p>Или используйте <a class="reference external" href="http://supervisord.org/">Supervisord</a>.
Пример <code class="docutils literal notranslate"><span class="pre">/etc/supervisord.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">my_app</span><span class="p">]</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_app</span>
<span class="n">command</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_app</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">runner</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">Boot</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">startsecs</span><span class="o">=</span><span class="mi">3</span>
<span class="n">user</span><span class="o">=</span><span class="n">my_user</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_app</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">stdout</span><span class="o">.</span><span class="n">log</span>
<span class="n">stdout_logfile_maxbytes</span><span class="o">=</span><span class="mi">10</span><span class="n">MB</span>
<span class="n">stdout_logfile_backups</span><span class="o">=</span><span class="mi">7</span>
<span class="n">stdout_capture_maxbytes</span><span class="o">=</span><span class="mi">1</span><span class="n">MB</span>
<span class="n">stdout_events_enabled</span><span class="o">=</span><span class="n">false</span>
<span class="n">environment</span><span class="o">=</span><span class="n">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">aws</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">~/</span><span class="nb">bin</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>Настройка портов<a class="headerlink" href="#id8" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum слушает порт 8000 и 4430 по умолчанию.
Вы можете изменить эти порты в конфигурации <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code>.</p>
<p>Вы можете обновить <code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/iptables</span></code> для перенаправления портов
80 на 8000 и 443 на 4430:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span> <span class="n">root</span>
<span class="n">chmod</span> <span class="mi">700</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">port</span> <span class="mi">8000</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">port</span> <span class="mi">4430</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">ports</span> <span class="mi">8000</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">ports</span> <span class="mi">4430</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">-</span><span class="n">c</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
<span class="n">chmod</span> <span class="mi">644</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
</pre></div>
</div>
<p>Конечно в данном примере предполагается что эти порты свободны. Если на них работает Apache
остановите его командой:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">httpd</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">chkconfig</span> <span class="n">httpd</span> <span class="n">off</span>
</pre></div>
</div>
<p>Смотри так же:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.frozentux.net/iptables-tutorial/chunkyhtml/">Iptables</a></p></li>
</ul>
</div>
<div class="section" id="linux">
<h3>Настройка Linux для обработки большого числа подключений<a class="headerlink" href="#linux" title="Ссылка на этот заголовок">¶</a></h3>
<p>Важно: <a class="reference external" href="https://groups.google.com/forum/#!topic/spray-user/S-SNR2m0BWU">JDK страдает серьезной проблемой производительности IO (NIO) на Mac</a>.</p>
<p>Смотри так же:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.basho.com/riak/latest/ops/tuning/linux/">Linux Performance Tuning (Riak)</a></p></li>
<li><p><a class="reference external" href="http://docs.basho.com/riak/latest/ops/tuning/aws/">AWS Performance Tuning (Riak)</a></p></li>
<li><p><a class="reference external" href="http://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/">Ipsysctl tutorial</a></p></li>
<li><p><a class="reference external" href="http://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/tcpvariables.html">TCP variables</a></p></li>
</ul>
<div class="section" id="id9">
<h4>Увеличьте лимит открытых файлов<a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h4>
<p>Каждое подключение рассматривается операционной системой как открытый файл.
По умолчанию максимальное количество открытых файлов 1024.
Для увеличения этого лимита, исправьте /etc/security/limits.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span>  <span class="n">soft</span>  <span class="n">nofile</span>  <span class="mi">1024000</span>
<span class="o">*</span>  <span class="n">hard</span>  <span class="n">nofile</span>  <span class="mi">1024000</span>
</pre></div>
</div>
<p>Нужно заново зайти в систему что бы этот конфигурация подействовала.
Убедитесь что лимит изменился <code class="docutils literal notranslate"><span class="pre">ulimit</span> <span class="pre">-n</span></code>.</p>
</div>
<div class="section" id="id10">
<h4>Оптимизация ядра<a class="headerlink" href="#id10" title="Ссылка на этот заголовок">¶</a></h4>
<p>Согласно
<a class="reference external" href="http://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-1">A Million-user Comet Application with Mochiweb</a>,
измените /etc/sysctl.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># General gigabit tuning</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">rmem_max</span> <span class="o">=</span> <span class="mi">16777216</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">wmem_max</span> <span class="o">=</span> <span class="mi">16777216</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_rmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">87380</span> <span class="mi">16777216</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_wmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">65536</span> <span class="mi">16777216</span>

<span class="c1"># This gives the kernel more memory for TCP</span>
<span class="c1"># which you need with many (100k+) open socket connections</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_mem</span> <span class="o">=</span> <span class="mi">50576</span> <span class="mi">64768</span> <span class="mi">98152</span>

<span class="c1"># Backlog</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">netdev_max_backlog</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_max_syn_backlog</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_syncookies</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># If you run clients</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">ip_local_port_range</span> <span class="o">=</span> <span class="mi">1024</span> <span class="mi">65535</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_tw_recycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_tw_reuse</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_fin_timeout</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>Выполните <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sysctl</span> <span class="pre">-p</span></code> что бы применить изменения. Перезагрузка не требуется,
теперь ваше ядро способно обработать гораздо больше подключений.</p>
</div>
<div class="section" id="backlog">
<h4>Замечание об использовании backlog<a class="headerlink" href="#backlog" title="Ссылка на этот заголовок">¶</a></h4>
<p>TCP выполняет 3 рукопожатия (handshake) для установки соединения.
Когда удаленный клиент устанавливает подключение к серверу, он отправляет
SYN пакет, а сервер отвечает SYN-ACK, затем клиент посылает ACK пакет и
соединение устанавливается. Xitrum получает соединение после
того как оно было полностью установлено.</p>
<p>Согласно статье
<a class="reference external" href="https://sites.google.com/site/beingroot/articles/apache/socket-backlog-tuning-for-apache">Socket backlog tuning for Apache</a>, таймаут подключение случается когда SYN пакет теряется. Это происходит потому что
очередь backlog переполняется подключениями посылающими SYN-ACK медленным клиентам.</p>
<p>Согласно
<a class="reference external" href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/configtuning-kernel-limits.html">FreeBSD Handbook</a>,
значение 128 обычно слишком мало для обработки подключений на высоко нагруженных серверах. Для
таких окружений, рекомендуется увеличить это значение до 1024 или даже выше. Это так же
способствует в предотвращении атак Denial of Service (DoS).</p>
<p>Размер backlog для Xitrum установлен в 1024 (memcached так же использует это значение),
но вам так же нужно изменить ядро как показано ниже.</p>
<p>Для проверки конфигурации backlog:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">somaxconn</span>
</pre></div>
</div>
<p>Или:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sysctl</span> <span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span>
</pre></div>
</div>
<p>Для установки нового значения используйте:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">w</span> <span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span><span class="o">=</span><span class="mi">1024</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="haproxy">
<h3>HAProxy<a class="headerlink" href="#haproxy" title="Ссылка на этот заголовок">¶</a></h3>
<p>Смотри <a class="reference external" href="https://github.com/sockjs/sockjs-node/blob/master/examples/haproxy.cfg">пример</a> настройки HAProxy для SockJS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defaults</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">10</span><span class="n">h</span>  <span class="c1"># Set to long time to avoid WebSocket connections being closed when there&#39;s no network activity</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">10</span><span class="n">h</span>  <span class="c1"># Set to long time to avoid ERR_INCOMPLETE_CHUNKED_ENCODING on Chrome</span>

<span class="n">frontend</span> <span class="n">xitrum_with_discourse</span>
    <span class="n">bind</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span>

    <span class="n">option</span> <span class="n">forwardfor</span>

    <span class="n">acl</span> <span class="n">is_discourse</span> <span class="n">path_beg</span> <span class="o">/</span><span class="n">forum</span>
    <span class="n">use_backend</span> <span class="n">discourse</span> <span class="k">if</span> <span class="n">is_discourse</span>
    <span class="n">default_backend</span> <span class="n">xitrum</span>

<span class="n">backend</span> <span class="n">xitrum</span>
    <span class="n">server</span> <span class="n">srv_xitrum</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span>

<span class="n">backend</span> <span class="n">discourse</span>
    <span class="n">server</span> <span class="n">srv_discourse</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">3000</span>
</pre></div>
</div>
<p>В этом <a class="reference external" href="http://serverfault.com/questions/165883/is-there-a-way-to-add-more-backend-server-to-haproxy-without-restarting-haproxy">обсуждении</a> предлагается способ настройки HAProxy который позволяет перезагружать конфигурационные файлы без перезапуска сервера.</p>
<p>HAProxy гораздо проще в использовании чем Nginx. Он подходи Xitrum поскольку как сказано <a class="reference internal" href="index.html#document-cache"><span class="doc">в секции про кэширование</span></a>, Xitrum отдает статические файлы
<a class="reference external" href="https://gist.github.com/3293596">очень быстро</a>. Вам не нужна возможность отдачи статики в Nginx.</p>
</div>
<div class="section" id="nginx">
<h3>Nginx<a class="headerlink" href="#nginx" title="Ссылка на этот заголовок">¶</a></h3>
<p>Если вы используете WebSocket или SockJS в Xitrum и Nginx 1.2, то вам следует
установить дополнительный модуль <a class="reference external" href="https://github.com/yaoweibin/nginx_tcp_proxy_module">nginx_tcp_proxy_module</a>.
Nginx 1.3+ поддерживает WebSocket из коробки.</p>
<p>Nginx по умолчанию использует протокол HTTP 1.0. Если ваш сервер возвращает
chunked response, вам нужно использовать протокол HTTP 1.1, пример:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
  <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
  <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Как <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">сказано в документации</a> к http keepalive, вам следует установить proxy_set_header Connection «»;</p>
</div>
<div class="section" id="heroku">
<h3>Развертывание в Heroku<a class="headerlink" href="#heroku" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum может быть запущен на <a class="reference external" href="https://www.heroku.com/">Heroku</a>.</p>
<div class="section" id="id16">
<h4>Зарегистрируйтесь и создайте репозиторий<a class="headerlink" href="#id16" title="Ссылка на этот заголовок">¶</a></h4>
<p>Следуя <a class="reference external" href="https://devcenter.heroku.com/articles/quickstart">официальной документации</a>,
зарегистрируйтесь и создайте git репозиторий.</p>
</div>
<div class="section" id="procfile">
<h4>Создание Procfile<a class="headerlink" href="#procfile" title="Ссылка на этот заголовок">¶</a></h4>
<p>Создайте Procfile и сохраните его в корневой директории. Heroku читает этот файл
при старте.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>web: target/xitrum/script/runner &lt;YOUR_PACKAGE.YOUR_MAIN_CLASS&gt; $PORT
</pre></div>
</div>
</div>
<div class="section" id="id18">
<h4>Изменения порта<a class="headerlink" href="#id18" title="Ссылка на этот заголовок">¶</a></h4>
<p>Поскольку Heroku назначает порт автоматически, используйте код:</p>
<p>config/xitrum.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>port {
  http              = ${PORT}
  # https             = 4430
  # flashSocketPolicy = 8430  # flash_socket_policy.xml will be returned
}
</pre></div>
</div>
<p><a class="reference external" href="https://addons.heroku.com/ssl">Поддержка SSL</a>.</p>
</div>
<div class="section" id="id19">
<h4>Уровень логирования<a class="headerlink" href="#id19" title="Ссылка на этот заголовок">¶</a></h4>
<p>config/logback.xml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">root</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">appender</span><span class="o">-</span><span class="n">ref</span> <span class="n">ref</span><span class="o">=</span><span class="s2">&quot;CONSOLE&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">root</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Просмотр логов в Heroku:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">logs</span> <span class="o">-</span><span class="n">tail</span>
</pre></div>
</div>
</div>
<div class="section" id="id20">
<h4>Создание алиаса для <code class="docutils literal notranslate"><span class="pre">xitrum-package</span></code><a class="headerlink" href="#id20" title="Ссылка на этот заголовок">¶</a></h4>
<p>Во время развертывания, Heroky выполняет <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">clean</span> <span class="pre">compile</span> <span class="pre">stage</span></code>.
Поэтому вам нужно добавить алиас для <code class="docutils literal notranslate"><span class="pre">xitrum-package</span></code>.</p>
<p>build.sbt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">addCommandAlias</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;;xitrum-package&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id21">
<h4>Развертывание на Heroku<a class="headerlink" href="#id21" title="Ссылка на этот заголовок">¶</a></h4>
<p>Процесс развертывания запускается автоматически после git push.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</pre></div>
</div>
<p>Смотри также <a class="reference external" href="https://devcenter.heroku.com/articles/getting-started-with-scala">официальная документация по языку Scala</a>.</p>
</div>
</div>
</div>
<span id="document-cluster"></span><div class="section" id="akka-and-hazelcast">
<h2>Масштабирование вместе с Akka and Hazelcast<a class="headerlink" href="#akka-and-hazelcast" title="Ссылка на этот заголовок">¶</a></h2>
<p>Xitrum спроектирован с расчетом на работу нескольких экземпляров приложения за
балансировщиком нагрузки или прокси сервером:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                                        <span class="o">/</span> <span class="n">экземпляр</span> <span class="n">Xitrum</span> <span class="mi">1</span>
<span class="n">Балансировщик</span> <span class="n">нагрузки</span><span class="o">/</span><span class="n">Прокси</span> <span class="n">сервер</span> <span class="o">----</span> <span class="n">экземпляр</span> <span class="n">Xitrum</span> <span class="mi">2</span>
                                        \ <span class="n">экземпляр</span> <span class="n">Xitrum</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Кэш, сессии и SockJS сессии могут быть кластеризованы из коробки благодаря использованию
<a class="reference external" href="http://akka.io/">Akka</a> и <a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">Hazelcast</a>.</p>
<p>Совместно с Hazelcast, экземпляр Xitrum становится одновременно кэширующим сервером. Вам не нужна
дополнительная сущность вроде Memcache.</p>
<p>Смотри конфигурацию <code class="docutils literal notranslate"><span class="pre">config/akka.conf</span></code>, <a class="reference external" href="http://akka.io/docs/">Akka doc</a> и
<a class="reference external" href="http://hazelcast.org/documentation/">Hazelcast doc</a> что бы узнать как настроить
Akka и Hazelcast для кластеризации.</p>
<p>Важно: Сессию вы может так же хранить <a class="reference internal" href="index.html#document-scopes"><span class="doc">внутри куки</span></a>.</p>
</div>
<span id="document-handler"></span><div class="section" id="netty-handlers">
<h2>Netty handlers<a class="headerlink" href="#netty-handlers" title="Ссылка на этот заголовок">¶</a></h2>
<p>This chapter is advanced, you don’t have to know to use Xitrum normally. To
understand, you must have knowlege about <a class="reference external" href="http://netty.io/">Netty</a>.</p>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Rack_(Web_server_interface)">Rack</a>,
<a class="reference external" href="http://en.wikipedia.org/wiki/Web_Server_Gateway_Interface">WSGI</a>, and
<a class="reference external" href="http://en.wikipedia.org/wiki/PSGI">PSGI</a> have middleware architecture.
Xitrum is based on <a class="reference external" href="http://netty.io/">Netty</a> which has the same thing called
handlers. You can create additional handlers and customize the channel pipeline
of handlers. Doing this, you can maximize server performance for your specific
use case.</p>
<p>This chaper describes:</p>
<ul class="simple">
<li><p>Netty handler architecture</p></li>
<li><p>Handlers that Xitrum provides and their default order</p></li>
<li><p>How to create and use custom handler</p></li>
</ul>
<div class="section" id="netty-handler-architecture">
<h3>Netty handler architecture<a class="headerlink" href="#netty-handler-architecture" title="Ссылка на этот заголовок">¶</a></h3>
<p>For each connection, there is a channel pipeline to handle the IO data.
A channel pipeline is a series of handlers. There are 2 types of handlers:</p>
<ul class="simple">
<li><p>Inbound: the request direction client -&gt; server</p></li>
<li><p>Outbound: the response direction server -&gt; client</p></li>
</ul>
<p>Please see the doc of <a class="reference external" href="http://netty.io/4.0/api/io/netty/channel/ChannelPipeline.html">ChannelPipeline</a>
for more information.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                                               <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">Request</span>
                                          <span class="n">via</span> <span class="n">Channel</span> <span class="ow">or</span>
                                      <span class="n">ChannelHandlerContext</span>
                                                    <span class="o">|</span>
<span class="o">+---------------------------------------------------+---------------+</span>
<span class="o">|</span>                           <span class="n">ChannelPipeline</span>         <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>                                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+---------------------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span>  <span class="n">N</span>  <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span>  <span class="mi">1</span>  <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">|</span>                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span> <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span>  <span class="mi">2</span>  <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">.</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">.</span>                                   <span class="o">.</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">ChannelHandlerContext</span><span class="o">.</span><span class="n">fireIN_EVT</span><span class="p">()</span> <span class="n">ChannelHandlerContext</span><span class="o">.</span><span class="n">OUT_EVT</span><span class="p">()</span><span class="o">|</span>
<span class="o">|</span>        <span class="p">[</span> <span class="n">method</span> <span class="n">call</span><span class="p">]</span>                       <span class="p">[</span><span class="n">method</span> <span class="n">call</span><span class="p">]</span>         <span class="o">|</span>
<span class="o">|</span>               <span class="o">.</span>                                   <span class="o">.</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">.</span>                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span>  <span class="mi">2</span>  <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span> <span class="n">M</span><span class="o">-</span><span class="mi">1</span> <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">|</span>                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span>  <span class="mi">1</span>  <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span>  <span class="n">M</span>  <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">|</span>               <span class="o">|</span>
<span class="o">+---------------+-----------------------------------+---------------+</span>
                <span class="o">|</span>                                  \<span class="o">|/</span>
<span class="o">+---------------+-----------------------------------+---------------+</span>
<span class="o">|</span>               <span class="o">|</span>                                   <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>       <span class="p">[</span> <span class="n">Socket</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="p">]</span>                    <span class="p">[</span> <span class="n">Socket</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> <span class="p">]</span>     <span class="o">|</span>
<span class="o">|</span>                                                                   <span class="o">|</span>
<span class="o">|</span>  <span class="n">Netty</span> <span class="n">Internal</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">Threads</span> <span class="p">(</span><span class="n">Transport</span> <span class="n">Implementation</span><span class="p">)</span>            <span class="o">|</span>
<span class="o">+-------------------------------------------------------------------+</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-handlers">
<h3>Custom handlers<a class="headerlink" href="#custom-handlers" title="Ссылка на этот заголовок">¶</a></h3>
<p>When starting Xitrum server, you can pass in your own
<a class="reference external" href="http://netty.io/4.0/api/io/netty/channel/ChannelInitializer.html">ChannelInitializer</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Server</span>

<span class="nb">object</span> <span class="n">Boot</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Array</span><span class="p">[</span><span class="n">String</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">Server</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">myChannelInitializer</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For HTTPS server, Xitrum will automatically prepend SSL handler to the pipeline.
You can reuse Xitrum handlers in your pipeline.</p>
</div>
<div class="section" id="xitrum-default-handlers">
<h3>Xitrum default handlers<a class="headerlink" href="#xitrum-default-handlers" title="Ссылка на этот заголовок">¶</a></h3>
<p>See <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/handler/DefaultHttpChannelInitializer.scala">xitrum.handler.DefaultHttpChannelInitializer</a>.</p>
<p>Sharable handlers (same instances are shared among many connections) are put in
<code class="docutils literal notranslate"><span class="pre">DefaultHttpChannelInitializer</span></code> object above so that they can be easily picked
up by apps that want to use custom pipeline. Those apps may only want a subset
of default handlers.</p>
<p>For example, when an app uses its own dispatcher (not Xitrum’s routing/dispatcher)
and only needs Xitrum’s fast static file serving, it may use only these handlers:</p>
<p>Inbound:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HttpRequestDecoder</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PublicFileServer</span></code></p></li>
<li><p>Its own dispatcher</p></li>
</ul>
<p>Outbound:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HttpResponseEncoder</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ChunkedWriteHandler</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XSendFile</span></code></p></li>
</ul>
</div>
</div>
<span id="document-metrics"></span><div class="section" id="id1">
<h2>Метрики<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<p>Xitrum собирает информацию об использовании памяти, CPU и информацию об использовании
контроллеров каждой ноды вашего Akka кластера. Эти данные публикуются в JSON формате.
Xitrum так же позволяет публиковать ваши метрики.</p>
<p>Эти метрики базируются на библиотеке <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/">Coda Hale Metrics</a>.</p>
<div class="section" id="id2">
<h3>Агрегирование метрик<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="cpu">
<h4>Память и CPU<a class="headerlink" href="#cpu" title="Ссылка на этот заголовок">¶</a></h4>
<p>Информация по памяти и CPU собирается с помощью
<a class="reference external" href="http://doc.akka.io/api/akka/2.3.0/index.html#akka.cluster.NodeMetrics">NodeMetrics</a>
системы актров каждой ноды.</p>
<p>Память:</p>
<img alt="_images/metrics_heapmemory.png" src="_images/metrics_heapmemory.png" />
<p>CPU: Количество процессоров и средняя загрузка</p>
<img alt="_images/metrics_cpu.png" src="_images/metrics_cpu.png" />
</div>
<div class="section" id="id3">
<h4>Метрики контроллера<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h4>
<p>Xitrum собирает состояния выполнения каждого контроллера в формате
<a class="reference external" href="http://metrics.dropwizard.io/3.1.0/getting-started/#histograms">гистограммы</a>.
Вы можете узнать сколько раз контроллер запускался, время выполнения для
не асинхронных запросов.</p>
<img alt="_images/metrics_action_count.png" src="_images/metrics_action_count.png" />
<p>Последнее время выполнения конкретного контроллера:</p>
<img alt="_images/metrics_action_time.png" src="_images/metrics_action_time.png" />
</div>
<div class="section" id="id5">
<h4>Дополнительные метрики<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h4>
<p>Дополнительные метрики вы можете собирать самостоятельно. Подробнее про использование читайте
<a class="reference external" href="http://metrics.dropwizard.io/3.1.0/">Coda Hale Metrics</a> и
<a class="reference external" href="https://github.com/erikvanoosten/metrics-scala">реализация на Scala</a>. Используйте
пакет <code class="docutils literal notranslate"><span class="pre">xitru.Metrics</span></code>, в нем <code class="docutils literal notranslate"><span class="pre">gauge</span></code>, <code class="docutils literal notranslate"><span class="pre">counter</span></code>, <code class="docutils literal notranslate"><span class="pre">meter</span></code>, <code class="docutils literal notranslate"><span class="pre">timer</span></code> и <code class="docutils literal notranslate"><span class="pre">histogram</span></code>.</p>
<p>Пример таймера:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">Metrics</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nb">object</span> <span class="n">MyAction</span> <span class="p">{</span>
  <span class="n">lazy</span> <span class="n">val</span> <span class="n">myTimer</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;myTimer&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;my/action&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="kn">import</span> <span class="nn">MyAction._</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">myTimer</span><span class="o">.</span><span class="n">time</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Задача</span> <span class="n">время</span> <span class="n">выполнения</span> <span class="n">которой</span> <span class="n">вы</span> <span class="n">хотите</span> <span class="n">замерить</span>
      <span class="o">...</span>
    <span class="p">}</span>
    <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id7">
<h3>Публикация метрик<a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum публикует последние значения метрики в JSON формате через определенный интервал времени.
Этот интервал имеет не постоянное значение и может меняться.</p>
<p>Информация о памяти:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;TYPE&quot;</span>      <span class="p">:</span> <span class="s2">&quot;heapMemory&quot;</span><span class="p">,</span>
  <span class="s2">&quot;SYSTEM&quot;</span>    <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
  <span class="s2">&quot;HOST&quot;</span>      <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
  <span class="s2">&quot;PORT&quot;</span>      <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
  <span class="s2">&quot;HASH&quot;</span>      <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">hashCode</span><span class="p">,</span>
  <span class="s2">&quot;TIMESTAMP&quot;</span> <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">NodeMetrics</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
  <span class="s2">&quot;USED&quot;</span>      <span class="p">:</span> <span class="n">Number</span> <span class="k">as</span> <span class="n">byte</span><span class="p">,</span>
  <span class="s2">&quot;COMMITTED&quot;</span> <span class="p">:</span> <span class="n">Number</span> <span class="k">as</span> <span class="n">byte</span><span class="p">,</span>
  <span class="s2">&quot;MAX&quot;</span>       <span class="p">:</span> <span class="n">Number</span> <span class="k">as</span> <span class="n">byte</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Информация о CPU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;TYPE&quot;</span>              <span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
  <span class="s2">&quot;SYSTEM&quot;</span>            <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
  <span class="s2">&quot;HOST&quot;</span>              <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
  <span class="s2">&quot;PORT&quot;</span>              <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
  <span class="s2">&quot;HASH&quot;</span>              <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">hashCode</span><span class="p">,</span>
  <span class="s2">&quot;TIMESTAMP&quot;</span>         <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">NodeMetrics</span><span class="o">.</span><span class="n">timestamp</span>
  <span class="s2">&quot;SYSTEMLOADAVERAGE&quot;</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
  <span class="s2">&quot;CPUCOMBINED&quot;</span>       <span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
  <span class="s2">&quot;PROCESSORS&quot;</span>        <span class="p">:</span> <span class="n">Number</span>
<span class="p">}</span>
</pre></div>
</div>
<p>MetricsRegistry использует <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/manual/json/">metrics-json</a> для разбора
JSON файла.</p>
<div class="section" id="xitrum">
<h4>Просмотр метрик через Xitrum<a class="headerlink" href="#xitrum" title="Ссылка на этот заголовок">¶</a></h4>
<p>Xitrum предоставляет стандартный способ просмотра метрик по ссылке <code class="docutils literal notranslate"><span class="pre">/xitrum/metrics/viewer?api_key=&lt;смотри</span> <span class="pre">xitrum.conf&gt;</span></code>.
По этой ссылке доступны графики представленные выше.
Графики созданы с использованием <a class="reference external" href="http://d3js.org/">D3.js</a>.</p>
<p>Ссылка может быть сформирована следующим образом:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Config</span>
<span class="kn">import</span> <span class="nn">xitrum.metrics.XitrumMetricsViewer</span>

<span class="n">url</span><span class="p">[</span><span class="n">XitrumMetricsViewer</span><span class="p">](</span><span class="s2">&quot;api_key&quot;</span> <span class="o">-&gt;</span> <span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">apiKey</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="jconsole">
<h4>Jconsole<a class="headerlink" href="#jconsole" title="Ссылка на этот заголовок">¶</a></h4>
<p>Метрики можно просматривать через <code class="docutils literal notranslate"><span class="pre">jconsole</span></code> используя <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/getting-started/#reporting-via-jmx">JVM Reporter</a>.</p>
<img alt="_images/metrics_jconsole.png" src="_images/metrics_jconsole.png" />
<p>Запуск:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.codahale.metrics.JmxReporter</span>

<span class="nb">object</span> <span class="n">Boot</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Array</span><span class="p">[</span><span class="n">String</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">Server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">JmxReporter</span><span class="o">.</span><span class="n">forRegistry</span><span class="p">(</span><span class="n">xitrum</span><span class="o">.</span><span class="n">Metrics</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Затем используйте <a class="reference external" href="http://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html">jconsole</a>.</p>
</div>
<div class="section" id="id9">
<h4>Просмотр метрик сторонними средствами<a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h4>
<p>Метрики публикуются как ссылка SockJS <code class="docutils literal notranslate"><span class="pre">xitrum/metrics/channel</span></code> в формате JSON.
<code class="docutils literal notranslate"><span class="pre">jsAddMetricsNameSpace</span></code> - шаблон JavaScript кода который предоставляет Xitrum
для установки соединения.</p>
<p>Реализуйте свой собственный JSON обработчик используя метод <code class="docutils literal notranslate"><span class="pre">initMetricsChannel</span></code>.</p>
<p>Пример контроллера:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>
<span class="kn">import</span> <span class="nn">xitrum.metrics.MetricsViewer</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;my/metrics/viewer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MySubscriber</span> <span class="n">extends</span> <span class="n">MetricsViewer</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">jsAddMetricsNameSpace</span><span class="p">(</span><span class="s2">&quot;window&quot;</span><span class="p">)</span>
    <span class="n">jsAddToView</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      function onValue(json) {</span>
<span class="s2">        console.log(json);</span>
<span class="s2">      }</span>
<span class="s2">      function onClose(){</span>
<span class="s2">        console.log(&quot;channel closed&quot;);</span>
<span class="s2">      }</span>
<span class="s2">      window.initMetricsChannel(onValue, onClose);</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h4>Хранения метрик<a class="headerlink" href="#id10" title="Ссылка на этот заголовок">¶</a></h4>
<p>Для экономии памяти, Xitrum не хранит старые значения метрик. Если вы хотите хранить эти
значения, вам передается реализовать собственный обработчик.</p>
<p>Например:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.Actor</span>
<span class="kn">import</span> <span class="nn">xitrum.metrics.PublisherLookUp</span>

<span class="k">class</span> <span class="nc">MySubscriber</span> <span class="n">extends</span> <span class="n">Actor</span> <span class="k">with</span> <span class="n">PublisherLookUp</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">preStart</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">lookUpPublisher</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">receive</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">_</span> <span class="o">=&gt;</span>
  <span class="p">}</span>

  <span class="n">override</span> <span class="k">def</span> <span class="nf">doWithPublisher</span><span class="p">(</span><span class="n">globalPublisher</span><span class="p">:</span> <span class="n">ActorRef</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">context</span><span class="o">.</span><span class="n">become</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">When</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">multinode</span> <span class="n">environment</span>
      <span class="n">case</span> <span class="n">multinodeMetrics</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">NodeMetrics</span><span class="p">]</span> <span class="o">=&gt;</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">to</span> <span class="n">DB</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>

      <span class="o">//</span> <span class="n">When</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">single</span> <span class="n">node</span> <span class="n">environment</span>
      <span class="n">case</span> <span class="n">nodeMetrics</span><span class="p">:</span> <span class="n">NodeMetrics</span> <span class="o">=&gt;</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">to</span> <span class="n">DB</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>

      <span class="n">case</span> <span class="n">Publish</span><span class="p">(</span><span class="n">registryAsJson</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">to</span> <span class="n">DB</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>

      <span class="n">case</span> <span class="n">_</span> <span class="o">=&gt;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-howto"></span><div class="section" id="howto">
<h2>HOWTO<a class="headerlink" href="#howto" title="Ссылка на этот заголовок">¶</a></h2>
<p>Эта глава представляет некоторое число небольших примеров. Каждый пример достаточно
мал что бы писать отдельную главу.</p>
<div class="section" id="id1">
<h3>Авторизация<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h3>
<p>Вы можете защитить весь сайт или некоторые контроллеры с использованием
<a class="reference external" href="http://en.wikipedia.org/wiki/Basic_access_authentication">basic authentication (базовая аутентификация)</a>.</p>
<p>Важно: Xitrum не поддерживает
<a class="reference external" href="http://en.wikipedia.org/wiki/Digest_access_authentication">digest authentication (цифровая аутентификация)</a>
поскольку она не так безопасна как кажется. Она подвержена <code class="docutils literal notranslate"><span class="pre">man-in-the-middle</span></code> атаке.
Для большей безопасности вы должны использовать HTTPS, поддержка которого встроена в Xitrum
(не нужен дополнительный прокси вроде Apache или Nginx).</p>
<div class="section" id="id2">
<h4>Конфигурация для базовой аутентификации<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h4>
<p>В config/xitrum.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;basicAuth&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;realm&quot;</span><span class="p">:</span>    <span class="s2">&quot;xitrum&quot;</span><span class="p">,</span>
  <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;xitrum&quot;</span><span class="p">,</span>
  <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;xitrum&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h4>Базовая аутентификация на конкретный контроллер<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>

<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">beforeFilter</span> <span class="p">{</span>
    <span class="n">basicAuth</span><span class="p">(</span><span class="s2">&quot;Realm&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;username&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">password</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h3>Загрузка конфигурационных файлов<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="json">
<h4>JSON файл<a class="headerlink" href="#json" title="Ссылка на этот заголовок">¶</a></h4>
<p>JSON подходит для конфигурационных файлов со сложной структурой.</p>
<p>Сохраняйте вашу конфигурацию в директорию «config». Эта директория попадает в classpath
в режиме разработки благодаря build.sbt и в боевом режиме благодаря скрипту запуска script/runner (и script/runner.bat).</p>
<p>myconfig.json:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;God&quot;</span><span class="p">,</span>
  <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;Does God need a password?&quot;</span><span class="p">,</span>
  <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adam&quot;</span><span class="p">,</span> <span class="s2">&quot;Eva&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Загрузка:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Loader</span>

<span class="n">case</span> <span class="k">class</span> <span class="nc">MyConfig</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">children</span><span class="p">:</span> <span class="n">Seq</span><span class="p">[</span><span class="n">String</span><span class="p">])</span>
<span class="n">val</span> <span class="n">myConfig</span> <span class="o">=</span> <span class="n">Loader</span><span class="o">.</span><span class="n">jsonFromClasspath</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">](</span><span class="s2">&quot;myconfig.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Замечания:</p>
<ul class="simple">
<li><p>Ключи и строки должны быть в двойных кавычках</p></li>
<li><p>На данный момент нельзя писать комментарии в JSON файле</p></li>
</ul>
</div>
<div class="section" id="protperties">
<h4>Файлы свойств (protperties)<a class="headerlink" href="#protperties" title="Ссылка на этот заголовок">¶</a></h4>
<p>Вы можете использовать файлы свойств, но рекомендуется использовать
JSON везде где это возможно. Файлы свойств не безопасны относительно типа, не поддерживают
UTF-8 и не подразумевают вложенность.</p>
<p>myconfig.properties:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>username = God
password = Does God need a password?
children = Adam, Eva
</pre></div>
</div>
<p>Загрузка:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Loader</span>

<span class="o">//</span> <span class="n">Here</span> <span class="n">you</span> <span class="n">get</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Properties</span>
<span class="n">val</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">Loader</span><span class="o">.</span><span class="n">propertiesFromClasspath</span><span class="p">(</span><span class="s2">&quot;myconfig.properties&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="typesafe">
<h4>Typesafe конфигурационный файл<a class="headerlink" href="#typesafe" title="Ссылка на этот заголовок">¶</a></h4>
<p>Xitrum включает Akka, которая включает
<a class="reference external" href="https://github.com/typesafehub/config">конфигурационную библиотеку</a> от
<a class="reference external" href="http://typesafe.com/company">Typesafe</a>.
Возможно это самый лучший путь загрузки конфигурационных файлов.</p>
<p>myconfig.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>username = God
password = Does God need a password?
children = [&quot;Adam&quot;, &quot;Eva&quot;]
</pre></div>
</div>
<p>Загрузка:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.typesafe.config.</span><span class="p">{</span><span class="n">Config</span><span class="p">,</span> <span class="n">ConfigFactory</span><span class="p">}</span>

<span class="n">val</span> <span class="n">config</span>   <span class="o">=</span> <span class="n">ConfigFactory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;myconfig.conf&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">username</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">password</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">children</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getStringList</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id7">
<h3>Сериализация и десериализация<a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h3>
<p>Сериализация <code class="docutils literal notranslate"><span class="pre">Array[Byte]</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.SeriDeseri</span>
<span class="n">val</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toBytes</span><span class="p">(</span><span class="s2">&quot;my serializable object&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Десериализация:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">option</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromBytes</span><span class="p">[</span><span class="n">MyType</span><span class="p">](</span><span class="nb">bytes</span><span class="p">)</span>  <span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">MyType</span><span class="p">]</span>
</pre></div>
</div>
<p>Если вы хотите сохранить в файле:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Loader</span>
<span class="n">Loader</span><span class="o">.</span><span class="n">bytesToFile</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="s2">&quot;myObject.bin&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Чтобы загрузить из файла:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">Loader</span><span class="o">.</span><span class="n">bytesFromFile</span><span class="p">(</span><span class="s2">&quot;myObject.bin&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>Шифрование данных<a class="headerlink" href="#id8" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum предоставляет встроенное шифрование:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Secure</span>

<span class="o">//</span> <span class="n">Array</span><span class="p">[</span><span class="n">Byte</span><span class="p">]</span>
<span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&quot;my data&quot;</span><span class="o">.</span><span class="n">getBytes</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="n">Byte</span><span class="p">]]</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
</pre></div>
</div>
<p>Вы можете использовать <code class="docutils literal notranslate"><span class="pre">xitrum.util.UrlSafeBase64</span></code> для кодирования и декодирования бинарных данных
в обычную строку.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Строка</span> <span class="n">которая</span> <span class="n">может</span> <span class="n">быть</span> <span class="n">использована</span> <span class="n">как</span> <span class="n">URL</span> <span class="n">или</span> <span class="n">в</span> <span class="n">куки</span>
<span class="n">val</span> <span class="n">string</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">noPaddingEncode</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="n">Byte</span><span class="p">]]</span>
<span class="n">val</span> <span class="n">encrypted2</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">autoPaddingDecode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</pre></div>
</div>
<p>Или короче:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.SeriDeseri</span>

<span class="n">val</span> <span class="n">mySerializableObject</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MySerializableClass</span>

<span class="o">//</span> <span class="n">String</span>
<span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toSecureUrlSafeBase64</span><span class="p">(</span><span class="n">mySerializableObject</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">MySerializableClass</span><span class="p">]</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromSecureUrlSafeBase64</span><span class="p">[</span><span class="n">MySerializableClass</span><span class="p">](</span><span class="n">encrypted</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SeriDeseri</span></code> использует <a class="reference external" href="https://github.com/twitter/chill">Twitter Chill</a>
для сериализации и десериализации. Ваши данные должны быть сериализуемыми.</p>
<p>Вы можете задать ключ шифрования.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&quot;my data&quot;</span><span class="o">.</span><span class="n">getBytes</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toSecureUrlSafeBase64</span><span class="p">(</span><span class="n">mySerializableObject</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromSecureUrlSafeBase64</span><span class="p">[</span><span class="n">MySerializableClass</span><span class="p">](</span><span class="n">encrypted</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Если ключ не указан, то <code class="docutils literal notranslate"><span class="pre">secureKey</span></code> из xitrum.conf будет использован.</p>
</div>
<div class="section" id="id9">
<h3>Множество сайтов на одном доменном имени<a class="headerlink" href="#id9" title="Ссылка на этот заголовок">¶</a></h3>
<p>При использовании прокси, например, Nginx, для запуска нескольких сайтов на одном
доменном имени:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">site1</span><span class="o">/...</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">site2</span><span class="o">/...</span>
</pre></div>
</div>
<p>Вы можете указать baseUrl в config/xitrum.conf.</p>
<p>В JS коде, для того что бы использовать корректные ссылки в Ajax запросах, используйте <code class="docutils literal notranslate"><span class="pre">withBaseUrl</span></code>
из <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/js.scala">xitrum.js</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Если текущий сайт имеет baseUrl &quot;site1&quot;, результат будет:</span>
<span class="c1"># /site1/path/to/my/action</span>
<span class="n">xitrum</span><span class="o">.</span><span class="n">withBaseUrl</span><span class="p">(</span><span class="s1">&#39;/path/to/my/action&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="markdown-html">
<h3>Преобразование разметки (markdown) в HTML<a class="headerlink" href="#markdown-html" title="Ссылка на этот заголовок">¶</a></h3>
<p>Если ваш проект использует <a class="reference internal" href="index.html#document-template_engines"><span class="doc">шаблонизатор Scalate</span></a>,
тогда:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.fusesource.scalamd.Markdown</span>
<span class="n">val</span> <span class="n">html</span> <span class="o">=</span> <span class="n">Markdown</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>В другом случае, вам нужно добавить зависимость в build.sbt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;org.fusesource.scalamd&quot;</span> <span class="o">%%</span> <span class="s2">&quot;scalamd&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.6&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>Временные директории<a class="headerlink" href="#id10" title="Ссылка на этот заголовок">¶</a></h3>
<p>По умолчанию Xitrum использует директорию <code class="docutils literal notranslate"><span class="pre">tmp</span></code> в текущем (рабочем) каталоге
для хранения генерируемых файлов Scalate, больших загружаемых и других файлов
(настраивается опцией <code class="docutils literal notranslate"><span class="pre">tmpDir</span></code> в xitrum.conf).</p>
<p>Получение пути временной директории:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xitrum</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">tmpDir</span><span class="o">.</span><span class="n">getAbsolutePath</span>
</pre></div>
</div>
<p>Создание нового файла или каталога во временной директории:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">file</span> <span class="o">=</span> <span class="n">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">xitrum</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">tmpDir</span><span class="p">,</span> <span class="s2">&quot;myfile&quot;</span><span class="p">)</span>

<span class="n">val</span> <span class="nb">dir</span> <span class="o">=</span> <span class="n">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">xitrum</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">tmpDir</span><span class="p">,</span> <span class="s2">&quot;mydir&quot;</span><span class="p">)</span>
<span class="nb">dir</span><span class="o">.</span><span class="n">mkdirs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>Потоковые видео<a class="headerlink" href="#id11" title="Ссылка на этот заголовок">¶</a></h3>
<p>Существует несколько способов транслировать потоковое видео. Наиболее простой:</p>
<ul class="simple">
<li><p>На сервере хранить interleaved .mp4 видео файлы, пользователь сможет просматривать
их в в процессе загрузки.</p></li>
<li><p>Использовать HTTP сервер который поддерживает
<a class="reference external" href="http://en.wikipedia.org/wiki/Byte_serving">range requests</a> (например, Xitrum),
тогда пользователи смогут проматывать воспроизведение во время загрузки.</p></li>
</ul>
<p>Вы можете использовать <a class="reference external" href="http://gpac.wp.mines-telecom.fr/mp4box/">MP4Box</a> для генерации
interleaved .mp4 с блоками по 500 milliseconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MP4Box</span> <span class="o">-</span><span class="n">inter</span> <span class="mi">500</span> <span class="n">movie</span><span class="o">.</span><span class="n">mp4</span>
</pre></div>
</div>
</div>
</div>
<span id="document-deps"></span><div class="section" id="id1">
<h2>Зависимости<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="id2">
<h3>Библиотеки<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h3>
<p>Xitrum использует некоторые библиотеки. Вы можете использовать их напрямую
если захотите.</p>
<img alt="_images/deps.png" src="_images/deps.png" />
<p>Главные зависимости:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.scala-lang.org/">Scala</a>:
Xitrum написан на языке программирования Scala.</p></li>
<li><p><a class="reference external" href="https://netty.io/">Netty</a>:
В качестве асинхронного HTTP(S) сервера.
Многие возможности Xitrum используют Netty,
например WebSocket и zero copy.</p></li>
<li><p><a class="reference external" href="http://akka.io/">Akka</a>:
Для SockJS. Akka зависит от <a class="reference external" href="https://github.com/typesafehub/config">Typesafe Config</a>,
который так же используется в Xitrum.</p></li>
</ul>
<p>Другие зависимости:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://commons.apache.org/lang/">Commons Lang</a>:
Для экранирования JSON данных.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/glokka">Glokka</a>:
Для кластеризация акторов SockJS.</p></li>
<li><p><a class="reference external" href="https://github.com/json4s/json4s">JSON4S</a>:
Для разбора и генерации JSON данных. JSON4S зависит от
<a class="reference external" href="http://paranamer.codehaus.org/">Paranamer</a>.</p></li>
<li><p><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Rhino">Rhino</a>:
В Scalate для компиляции CoffeeScript в JavaScript.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/sclasner">Sclasner</a>:
Для поиска HTTP маршрутов в контроллерах, .class и .jar файлах.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/scaposer">Scaposer</a>:
Для интернационализации.</p></li>
<li><p><a class="reference external" href="https://github.com/twitter/chill">Twitter Chill</a>:
Для сериализации и десериализации куки и сессий.
Chill базируется на <a class="reference external" href="http://code.google.com/p/kryo/">Kryo</a>.</p></li>
<li><p><a class="reference external" href="http://slf4s.org/">SLF4S</a>, <a class="reference external" href="http://logback.qos.ch/">Logback</a>:
Для логирования.</p></li>
</ul>
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new">Шаблон пустого проекта Xitrum</a>
включает утилиты:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/scala-xgettext">scala-xgettext</a>:
<a class="reference internal" href="index.html#document-i18n"><span class="doc">Извелечение сообщений</span></a> из .scala файлов во время компиляции.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-package">xitrum-package</a>:
Для <a class="reference internal" href="index.html#document-deploy"><span class="doc">подготовки проекта к развертыванию</span></a> на сервере.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/scalive">Scalive</a>:
Для подключения Scala консоли к JVM процессу для живой отладки.</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>Связанные проекты<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h3>
<p>Демо проекты:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new">xitrum-new</a>:
Шаблон пустого проекта Xitrum.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-demos">xitrum-demos</a>:
Демонстрационный проект возможностей Xitrum.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-placeholder">xitrum-placeholder</a>:
Демонстрационный проекта RESTful API который возвращает изображения.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/comy">comy</a>:
Демонстрационный проект: короткие ссылки.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-multimodule-demo">xitrum-multimodule-demo</a>:
Пример мульти модульного <a class="reference external" href="http://www.scala-sbt.org/">SBT</a> проекта.</p></li>
</ul>
<p>Проекты:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-scalate">xitrum-scalate</a>:
Стандартный шаблонизатор для Xitrum, подключенный в
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new">шаблонном проекте</a>.
Вы можете заменить его другим шаблонизатором, или вообще убрать если вам
не нужен шаблонизатор. Он зависит от
<a class="reference external" href="http://scalate.fusesource.org/">Scalate</a> и
<a class="reference external" href="https://github.com/chirino/scalamd">Scalamd</a>.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">xitrum-hazelcast</a>:
Для кластеризации кэша и сессии на стороне сервера.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-ko">xitrum-ko</a>:
Предоставляет дополнительные возможности для <a class="reference external" href="http://knockoutjs.com/">Knockoutjs</a>.</p></li>
</ul>
<p>Другие проекты:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-doc">xitrum-doc</a>:
Исходный код <a class="reference external" href="http://xitrum-framework.github.io/guide.html">учебника Xitrum</a>.</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-framework.github.io">xitrum-hp</a>:
Исходный код <a class="reference external" href="http://xitrum-framework.github.io/">домашней страниц Xitrum</a>.</p></li>
</ul>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Оглавление</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-intro">Введение</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Возможности</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">Авторы</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-tutorial">Как начать</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum">Создание пустого проекта Xitrum</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Запуск</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#eclipse">Импорт проекта в Eclipse</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#intellij">Импорт проекта в IntelliJ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">Автоматическая перезагрузка</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#ide">Запуск в IDE</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id6">Запуск в SBT</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#dcevm">DCEVM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">Список игнорируемых файлов</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-action_view">Контроллеры и представления</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#normal-action">Стандартный контроллер (normal action)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#futureaction">FutureAction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#actor-action">Актор контроллер (actor action)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Отправка ответа клиенту</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Шаблонизация</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#currentaction">currentAction и приведение типов</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id4">Mustache</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#coffeescript">CoffeeScript</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#layout">Макет (Layout)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id6">Макет в отдельном файле</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#respondview">Использование макета непосредственно в respondView</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">Внутренние представления</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">Фрагменты</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">Использование шаблона смежного контроллера</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id10">Один контроллер - много представлений</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">Компонент</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-restful">RESTful APIs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">Кэш маршрутов</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Очередность маршрутов</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Несколько маршрутов для одного контроллера</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Точка в маршруте</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">Регулярные выражения в маршруте</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">Обработка не стандартных маршрутов</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">Ссылка на контроллер</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">Редирект на контроллер</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">Форвардинг (перенаправление) на контроллер</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ajax">Определение Ajax запроса</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#anti-csrf">Anti-CSRF</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#anticsrfinput-anticsrftoken">antiCsrfInput и antiCsrfToken</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#skipcsrfcheck">SkipCsrfCheck</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">Управление маршрутами</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id12">Получение полных (сырых) данных запроса</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#api">Документирование API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-template_engines">Шаблонизация</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Настройка</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Отключение шаблонизатора</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Реализация своего шаблонизатора</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-postback">Postbacks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">Шаблон</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Форма</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Другие элементы (не формы)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Диалог подтверждения</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">Дополнительные параметры</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ajax">Отображение анимации во время Ajax загрузки</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-xml">XML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">Отключения экранирования XML</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Группировка XML элементов</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xhtml">Отображение XHTML</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-js">JavaScript и JSON</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#javascript">JavaScript</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id1">Вставка JavaScript фрагментов в представление</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id2">Отправка JavaScript непосредственно (без представления)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#json">JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#knockout-js">Плагин для Knockout.js</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-async">Асинхронная обработка запросов</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#websocket">WebSocket</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#sockjs">SockJS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#chunked">Chunked ответ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#iframe">Бесконечный iframe</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#event-source">Event Source</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-static">Статичные файлы</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Отправка статических файлов с диска</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#index-html">index.html и обработка отсутствующих маршрутов</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">404 и 500</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#webjars">Использование файлов ресурсов в соответствии с WebJars</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id4">WebJars</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#jar-webjars">Хранение файлов ресурсов внутри .jar файла согласно WebJars</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#classpath">Ответ файлом из classpath</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#etag-max-age">Кэширование на стороне клиента с ETag и max-age</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#gzip">GZIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">Кэш на стороне сервера</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-flash">Serve flash socket policy file</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-scopes">Запросы, параметры, куки, сессии</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Запросы</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id3">Типы параметров</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id4">Доступ к параметрам</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#at">«at»</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#atjson">«atJson»</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#requestvar">RequestVar</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">Куки</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">Допустимые символы в куки</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">Сессии</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#session-clear">session.clear()</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#sessionvar">SessionVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id13">Хранилище сессии</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#object-vs-val">object vs. val</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-validation">Валидация</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Стандартные валидаторы</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Написание своих валидаторов</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-upload">Загрузка файлов</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#ajax">Ajax загрузка файлов</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-filter">Фильтры</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#before-filter">Пре-фильтр (before filter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#after-filter">Пост-фильтры (after filter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#around-filter">Внешние фильтры (around filter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Порядок выполнения фильтров</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cache">Кэш на стороне сервера</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Кэширование страницы или контроллера</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Кэш объект</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Удаление кэша</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">Конфигурация</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">Как работает кэш</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-util-locallrucache">xitrum.util.LocalLruCache</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-i18n">Интернационализация</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Используйте интернационализированные сообщения непосредственно в коде</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pot">Извлечение сообщений в pot файл</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#po">Где сохранять po файлы</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Выбор языка</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Валидационные сообщения</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">Множественные числа</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-log">Логирование</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-log">Использование объекта xitrum.Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Использование трейта xitrum.Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Проверка уровня логирования</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">Настройка уровня и способов логирования</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#fluentd">Использование Fluentd</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deploy">Развертывание на сервере</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Сборка</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-package">Сборка и xitrum-package</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#scala-jvm">Подключение Scala консоли к запущенному JVM процессу</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#oracle-jdk-centos-ubuntu">Установка Oracle JDK на CentOS или Ubuntu</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum">Запускайте Xitrum в боевом режиме когда система запускается</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">Настройка портов</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux">Настройка Linux для обработки большого числа подключений</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">Увеличьте лимит открытых файлов</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id10">Оптимизация ядра</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#backlog">Замечание об использовании backlog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#haproxy">HAProxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#nginx">Nginx</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#heroku">Развертывание в Heroku</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id16">Зарегистрируйтесь и создайте репозиторий</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#procfile">Создание Procfile</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id18">Изменения порта</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id19">Уровень логирования</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id20">Создание алиаса для <code class="docutils literal notranslate"><span class="pre">xitrum-package</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id21">Развертывание на Heroku</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cluster">Масштабирование вместе с Akka and Hazelcast</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-handler">Netty handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#netty-handler-architecture">Netty handler architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#custom-handlers">Custom handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-default-handlers">Xitrum default handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-metrics">Метрики</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Агрегирование метрик</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#cpu">Память и CPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id3">Метрики контроллера</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id5">Дополнительные метрики</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">Публикация метрик</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#xitrum">Просмотр метрик через Xitrum</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#jconsole">Jconsole</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">Просмотр метрик сторонними средствами</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id10">Хранения метрик</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-howto">HOWTO</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">Авторизация</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id2">Конфигурация для базовой аутентификации</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id3">Базовая аутентификация на конкретный контроллер</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">Загрузка конфигурационных файлов</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#json">JSON файл</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#protperties">Файлы свойств (protperties)</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#typesafe">Typesafe конфигурационный файл</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id7">Сериализация и десериализация</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">Шифрование данных</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">Множество сайтов на одном доменном имени</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#markdown-html">Преобразование разметки (markdown) в HTML</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">Временные директории</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">Потоковые видео</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deps">Зависимости</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">Библиотеки</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Связанные проекты</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Навигация</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="#">документация Xitrum Scala Web Framework Guide 3.30.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">документация Xitrum Scala Web Framework Guide 3.30.0</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Ngoc Dao.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>
