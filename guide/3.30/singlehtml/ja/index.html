
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xitrum Scala Web Framework Guide 3.30.0 ドキュメント</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="#">Xitrum Scala Web Framework Guide 3.30.0 ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Xitrum Scala Web Framework Guide 3.30.0 ドキュメント</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="xitrum">
<h1>Xitrum ガイド<a class="headerlink" href="#xitrum" title="このヘッドラインへのパーマリンク">¶</a></h1>

<p>
  <a href="../../xitrum-ja.pdf" title="PDF" style="float:left"><img src="../../../pdf-ja.png"/></a>
  <a href="../../xitrum-ja.pdf" title="PDF">PDF ダウンロード</a></p>
</p>
<div style="clear:both"></div>


<p>
  <a href="../../xitrum-ja.pdf" title="PDF" style="float:left"><img src="../../../pdf-ja.png"/></a>
  <a href="../../xitrum-ja.pdf" title="PDF">PDF ダウンロード</a></p>
</p>
<div style="clear:both"></div>

<p><a class="reference external" href="http://xitrum-framework.github.io/guide.html">Xitrum ガイドは英語版、韓国語版、ロシア語版、ベトナム語版もあります。</a></p>
<div class="toctree-wrapper compound">
<span id="document-intro"></span><div class="section" id="id1">
<h2>はじめに<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--------------------+</span>
<span class="o">|</span>      <span class="n">Clients</span>       <span class="o">|</span>
<span class="o">+--------------------+</span>
          <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span>       <span class="n">Netty</span>        <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span>       <span class="n">Xitrum</span>       <span class="o">|</span>
<span class="o">|</span> <span class="o">+----------------+</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span> <span class="n">HTTP</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="n">Server</span> <span class="o">|</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">|----------------|</span> <span class="o">|</span>
<span class="o">|</span> <span class="o">|</span> <span class="n">Web</span> <span class="n">framework</span>  <span class="o">|</span> <span class="o">|</span>  <span class="o">&lt;-</span> <span class="n">Akka</span><span class="p">,</span> <span class="n">Hazelcast</span> <span class="o">-&gt;</span> <span class="n">Other</span> <span class="n">instances</span>
<span class="o">|</span> <span class="o">+----------------+</span> <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span>      <span class="n">Your</span> <span class="n">app</span>      <span class="o">|</span>
<span class="o">+--------------------+</span>
</pre></div>
</div>
<p>Xitrumは <a class="reference external" href="http://netty.io/">Netty</a> と <a class="reference external" href="http://akka.io/">Akka</a> をベースに構築された非同期でスケーラブルなHTTP(S) WEBフレームワークです。</p>
<p>Xitrum <a class="reference external" href="https://groups.google.com/group/xitrum-framework/msg/d6de4865a8576d39">ユーザーの声</a>:</p>
<blockquote>
<div><p>これは本当に印象的な作品である。Liftを除いておそらく最も完全な（そしてとても簡単に使える）Scalaフレームワークです。</p>
<p>XitrumはWebアプリケーションフレームワークの基本的な機能を全て満たしている本物のフルスタックのWebフレームワークである。
とてもうれしいことにそこには、ETag、静的ファイルキャッシュ、自動gzip圧縮があり、
組込みのJSONのコンバータ、インターセプタ、リクエスト/セッション/クッキー/フラッシュの各種スコープ、
サーバー・クライアントにおける統合的バリデーション、内蔵キャッシュ(<a class="reference external" href="http://www.hazelcast.org/">Hazelcast</a>)、i18N、そしてNettyが組み込まれている。
これらの機能を直ぐに使うことができる。ワオ。</p>
</div></blockquote>
<div class="section" id="id3">
<h3>特徴<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Scalaの思想に基づく型安全。 全てのAPIは型安全であるべくデザインされています。</p></li>
<li><p>Nettyの思想に基づく非同期。 リクエストを捌くアクションは直ぐにレスポンスを返す必要はありません。
ロングポーリング、チャンクレスポンス（ストリーミング）、WebSocket、そしてSockJSをサポートしています。</p></li>
<li><p><a class="reference external" href="http://netty.io/">Netty</a> 上に構築された高速HTTP(S) サーバー。
(HTTPSはJavaエンジンとOpenSSLエンジン選択できます。)
Xitrumの静的ファイル配信速度は <a class="reference external" href="https://gist.github.com/3293596">Nginxに匹敵</a> します。</p></li>
<li><p>高速なレスポンスを実現する大規模なサーバサイドおよびクライアントサイド双方のキャッシュシステム。
サーバーレイヤでは小さなファイルはメモリにキャッシュされ、大きなファイルはNIOのzero copyを使用して送信されます。
ウェブフレームワークとしてpage、action、そしてobjectをRailsのスタイルでキャッシュすることができます。
<a class="reference external" href="http://code.google.com/speed/page-speed/docs/rules_intro.html">All Google's best practices</a> にあるように、
条件付きGETに対してはクライアントサイドキャッシュが適用されます。
もちろんブラウザにリクエストの再送信を強制させることもできます。</p></li>
<li><p>静的ファイルに対する <a class="reference external" href="http://en.wikipedia.org/wiki/Byte_serving">Range requests</a> サポート。
この機能により、スマートフォンに対する動画配信や、全てのクライアントに対するファイルダウンロードの停止と再開を実現できます。</p></li>
<li><p><a class="reference external" href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a> 対応。</p></li>
<li><p>JAX-RSとRailsエンジンの思想に基づく自動ルートコレクション。全てのルートを１箇所に宣言する必要はありません。
この機能は分散ルーティングと捉えることができます。この機能のおかげでアプリケーションを他のアプリケーションに取り込むことが可能になります。
もしあなたがブログエンジンを作ったならそれをJARにして別のアプリケーションに取り込むだけですぐにブログ機能が使えるようになるでしょう。
ルーティングには更に2つの特徴があります。
ルートの作成（リバースルーティング）は型安全に実施され、
<a class="reference external" href="http://swagger.wordnik.com/">Swagger Doc</a> を使用したルーティングに関するドキュメント作成も可能となります。</p></li>
<li><p>クラスファイルおよびルートは開発時にはXitrumによって自動的にリロードされます。</p></li>
<li><p>Viewは独立した <a class="reference external" href="http://scalate.fusesource.org/">Scalate</a> テンプレートとして、
またはScalaによるインラインXMLとして、どちらも型安全に記述することが可能です。</p></li>
<li><p>クッキーによる（よりスケーラブルな）、<a class="reference external" href="http://www.hazelcast.org/">Hazelcast</a> クラスターによる(よりセキュアな)セッション管理。
Hazelcastは（とても早くて、簡単に）プロセス間分散キャッシュも提供してくれます。
このため別のキャッシュサーバーを用意する必要はなくなります。これはAkkaのpubsub機能にも言えることです。</p></li>
<li><p><a class="reference external" href="http://jqueryvalidation.org/">jQuery Validation</a> によるブラウザー、サーバーサイド双方でのバリデーション。</p></li>
<li><p><a class="reference external" href="http://en.wikipedia.org/wiki/GNU_gettext">GNU gettext</a> を使用した国際化対応。
翻訳テキストの抽出は自動で行われるため、プロパティファイルに煩わされることはなくなるでしょう。
翻訳とマージ作業には <a class="reference external" href="http://www.poedit.net/screenshots.php">Poedit</a> のようなパワフルなツールが使えます。
gettextは、他のほとんどのソリューションとは異なり、単数系と複数系の両方の形式をサポートしています。</p></li>
</ul>
<p>Xitrumは <a class="reference external" href="https://github.com/scalatra/scalatra">Scalatra</a> よりパワフルに、
<a class="reference external" href="http://liftweb.net/">Lift</a> より簡単であることで両者のスペクトルを満たすことを目的としています。
<a class="reference external" href="http://xitrum-framework.github.io/">Xitrum</a> はScalatraのようにcontroller-firstであり、Liftのような <a class="reference external" href="http://www.assembla.com/wiki/show/liftweb/View_First">view-first</a> ではありません。
多くの開発者にとって馴染み部会controller-firstスタイルです。</p>
<p><a class="reference internal" href="index.html#document-deps"><span class="doc">関係プロジェクト</span></a> サンプルやプラグインなどのプロジェクト一覧をご覧ください。</p>
</div>
<div class="section" id="id6">
<h3>貢献者<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="http://xitrum-framework.github.io/">Xitrum</a> は <a class="reference external" href="https://github.com/xitrum-framework/xitrum">オープンソース</a> プロジェクトです。
<a class="reference external" href="http://groups.google.com/group/xitrum-framework">Google group</a>. のコミュニティに参加してみてください。</p>
<p>貢献者の一覧が <a class="reference external" href="https://github.com/xitrum-framework/xitrum/graphs/contributors">最初の貢献</a> の順番で記載されています:</p>
<p>(*): 現在アクティブなコアメンバー</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ngocdaothanh">Ngoc Dao (*)</a></p></li>
<li><p><a class="reference external" href="https://github.com/alide">Linh Tran</a></p></li>
<li><p><a class="reference external" href="https://github.com/earldouglas">James Earl Douglas</a></p></li>
<li><p><a class="reference external" href="https://github.com/caiiiycuk">Aleksander Guryanov</a></p></li>
<li><p><a class="reference external" href="https://github.com/georgeOsdDev">Takeharu Oshida (*)</a></p></li>
<li><p><a class="reference external" href="https://github.com/kimkha">Nguyen Kim Kha</a></p></li>
<li><p><a class="reference external" href="https://github.com/murz">Michael Murray</a></p></li>
</ul>
</div>
</div>
<span id="document-tutorial"></span><div class="section" id="id1">
<h2>チュートリアル<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>本章ではXitrumプロジェクトを作成して実行するところまでを簡単に紹介します。</p>
<p><strong>このチュートリアルではJavaがインストールされたLinux環境を想定しています。</strong></p>
<div class="section" id="xitrum">
<h3>Xitrumプロジェクトの作成<a class="headerlink" href="#xitrum" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>新規のプロジェクトを作成するには
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/archive/master.zip">xitrum-new.zip</a> をダウンロードします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">zip</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
<p>または:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="o">-</span><span class="n">o</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">zip</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">framework</span><span class="o">/</span><span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">master</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>起動<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Scalaのビルドツールとしてデファクトスタンダードである <a class="reference external" href="https://github.com/harrah/xsbt/wiki/Setup">SBT</a> を使用します。
先ほどダウンロードしたプロジェクトには既に SBT 0.13 が <code class="docutils literal notranslate"><span class="pre">sbt</span></code> ディレクトリに梱包されています。
SBTを自分でインストールするには、SBTの <a class="reference external" href="https://github.com/harrah/xsbt/wiki/Setup">セットアップガイド</a> を参照してください。</p>
<p>作成したプロジェクトのルートディレクトリで <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">fgRun</span></code> と実行することでXitrumが起動します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unzip</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span><span class="o">.</span><span class="n">zip</span>
<span class="n">cd</span> <span class="n">xitrum</span><span class="o">-</span><span class="n">new</span>
<span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="n">fgRun</span>
</pre></div>
</div>
<p>このコマンドは依存ライブラリ( <a class="reference internal" href="index.html#document-deps"><span class="doc">dependencies</span></a> )のダウンロード, およびプロジェクトのコンパイルを実行後、
<code class="docutils literal notranslate"><span class="pre">quickstart.Boot</span></code> クラスが実行され、WEBサーバーが起動します。
コンソールには以下の様なルーティング情報が表示されます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Load</span> <span class="n">routes</span><span class="o">.</span><span class="n">cache</span> <span class="ow">or</span> <span class="n">recollect</span> <span class="n">routes</span><span class="o">...</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Normal</span> <span class="n">routes</span><span class="p">:</span>
<span class="n">GET</span>  <span class="o">/</span>  <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">SiteIndex</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">SockJS</span> <span class="n">routes</span><span class="p">:</span>
<span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span>  <span class="n">xitrum</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">XitrumMetricsChannel</span>  <span class="n">websocket</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span> <span class="n">cookie_needed</span><span class="p">:</span> <span class="n">false</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Error</span> <span class="n">routes</span><span class="p">:</span>
<span class="mi">404</span>  <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">NotFoundError</span>
<span class="mi">500</span>  <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">ServerError</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Xitrum</span> <span class="n">routes</span><span class="p">:</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">webjars</span><span class="o">/</span><span class="n">swagger</span><span class="o">-</span><span class="n">ui</span><span class="o">/</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">17</span><span class="o">/</span><span class="n">index</span>                            <span class="n">xitrum</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">SwaggerUiVersioned</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">xitrum</span><span class="o">.</span><span class="n">js</span>                                           <span class="n">xitrum</span><span class="o">.</span><span class="n">js</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span>                                     <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">Greeting</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">eventsource</span>    <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">EventSourceReceive</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">htmlfile</span>       <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">HtmlFileReceive</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">jsonp</span>          <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">JsonPPollingReceive</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">jsonp_send</span>     <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">JsonPPollingSend</span>
<span class="n">WEBSOCKET</span>  <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">websocket</span>      <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">WebSocket</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">xhr</span>            <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">XhrPollingReceive</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">xhr_send</span>       <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">XhrSend</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">xhr_streaming</span>  <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">XhrStreamingReceive</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="n">info</span>                                <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">InfoGET</span>
<span class="n">WEBSOCKET</span>  <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="n">websocket</span>                           <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">RawWebSocket</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">viewer</span>                                      <span class="n">xitrum</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">XitrumMetricsViewer</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">iframe</span>                             <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">Iframe</span>
<span class="n">GET</span>        <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">websocket</span>      <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">WebSocketGET</span>
<span class="n">POST</span>       <span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">metrics</span><span class="o">/</span><span class="n">channel</span><span class="o">/</span><span class="p">:</span><span class="n">serverId</span><span class="o">/</span><span class="p">:</span><span class="n">sessionId</span><span class="o">/</span><span class="n">websocket</span>      <span class="n">xitrum</span><span class="o">.</span><span class="n">sockjs</span><span class="o">.</span><span class="n">WebSocketPOST</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">HTTP</span> <span class="n">server</span> <span class="n">started</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">8000</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">HTTPS</span> <span class="n">server</span> <span class="n">started</span> <span class="n">on</span> <span class="n">port</span> <span class="mi">4430</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Xitrum</span> <span class="n">started</span> <span class="ow">in</span> <span class="n">development</span> <span class="n">mode</span>
</pre></div>
</div>
<p>初回起動時には、全てのルーティングが収集されログに出力されます。
この情報はアプリケーションのRESTful APIについてドキュメントを書く場合この情報はとても役立つことでしょう。</p>
<p>ブラウザで <a class="reference external" href="http://localhost:8000/">http://localhost:8000</a> もしくは <a class="reference external" href="http://localhost:4430/">https://localhost:4430</a> にアクセスしてみましょう。
次のようなリクエスト情報がコンソールから確認できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">GET</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">SiteIndex</span><span class="p">,</span> <span class="mi">1</span> <span class="p">[</span><span class="n">ms</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="eclipse">
<h3>Eclipseプロジェクトの作成<a class="headerlink" href="#eclipse" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>開発環境に <a class="reference external" href="http://scala-ide.org/">Eclipse</a> を使用する場合</p>
<p>プロジェクトディレクトリで以下のコマンドを実行します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="n">eclipse</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> に記載されたプロジェクト設定に応じてEclipse用の <code class="docutils literal notranslate"><span class="pre">.project</span></code> ファイルが生成されます。
Eclipseを起動してインポートしてください。</p>
</div>
<div class="section" id="intellij-idea">
<h3>IntelliJ IDEAプロジェクトのインポート<a class="headerlink" href="#intellij-idea" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>開発環境に <a class="reference external" href="http://www.jetbrains.com/idea/">IntelliJ IDEA</a> を使用する場合、
そのScalaプラグインをインストールして、SBTプロジェクトをそのままインポートしてください。
Eclipseの場合のように事前にプロジェクトファイルを生成しなくてもいいです。</p>
</div>
<div class="section" id="id6">
<h3>自動リロード<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>プログラムを再起動することなく .classファイルをリロード（ホットスワップ)することができます。
ただし、プログラムのパフォーマンスと安定性を維持するため、自動リロード機能は開発時のみ使用することを推奨します。</p>
<div class="section" id="ide">
<h4>IDEを使用する場合<a class="headerlink" href="#ide" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>最新のEclipseやIntelliJのようなIDEを使用して開発、起動を行う場合、
デフォルトでIDEがソースコードの変更を監視して、変更があった場合に自動でコンパイルしてくれます。</p>
</div>
<div class="section" id="id7">
<h4>SBTを使用する場合<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>SBTを使用する場合、2つのコンソールを用意する必要があります:</p>
<ul class="simple">
<li><p>一つ目は <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">fgRun</span></code> を実行します。 このコマンドはプログラムを起動して、 .classファイルに変更があった場合にリロードを行います。</p></li>
<li><p>もう一方は <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">~compile</span></code> を実行します。 このコマンドはソースコードの変更を監視して、変更があった場合に .classファイルにコンパイルします。</p></li>
</ul>
<p>sbtディレクトリには <a class="reference external" href="https://github.com/xitrum-framework/agent7">agent7.jar</a> が含まれます。
このライブラリは、カレントディレクトリ（およびサブディレクトリ)の .classファイルのリロードを担当します。
<code class="docutils literal notranslate"><span class="pre">sbt/sbt</span></code> スクリプトの中で <code class="docutils literal notranslate"><span class="pre">-javaagent:agent7.jar</span></code> として使用されています。</p>
</div>
<div class="section" id="dcevm">
<h4>DCEVM<a class="headerlink" href="#dcevm" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>通常のJVMはクラスファイルがリロードされた際、メソッドのボディのみ変更が反映されます。
Java HotSpot VM のオープンソース実装である <a class="reference external" href="https://github.com/dcevm/dcevm">DCEVM</a> を使用することで、
ロードしたクラスの再定義をより柔軟に行うことができるようになります。</p>
<p>DCEVMは以下の2つの方法でインストールできます:</p>
<ul class="simple">
<li><p>インストール済みのJavaへ <a class="reference external" href="https://github.com/dcevm/dcevm/releases">Patch</a> を行う方法</p></li>
<li><p><a class="reference external" href="http://dcevm.nentjes.com/">prebuilt</a> バージョンのインストール (こちらのほうが簡単です)</p></li>
</ul>
<p>パッチを使用してインストールを行う場合:</p>
<ul class="simple">
<li><p>DCEVMを常に有効にすることができます。</p></li>
<li><p>もしくはDCEVMを&quot;alternative&quot; JVMとして適用することができます。
この場合、<code class="docutils literal notranslate"><span class="pre">java</span></code> コマンドに <code class="docutils literal notranslate"><span class="pre">-XXaltjvm=dcevm</span></code> オプションを指定することでDCEVMを使用することができます。
例えば、 <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span></code> スクリプトファイルに <code class="docutils literal notranslate"><span class="pre">-XXaltjvm=dcevm</span></code> を追記する必要があります。</p></li>
</ul>
<p>EclipseやIntelliJのようなIDEを使用している場合、DCEVMをプロジェクトの実行JVMに指定する必要があります。</p>
<p>SBTを使用している場合は、 <code class="docutils literal notranslate"><span class="pre">java</span></code> コマンドがDCEVMのものを利用できるように <code class="docutils literal notranslate"><span class="pre">PATH</span></code> 環境変数を設定する必要があります。
DCEVM自体はクラスの変更をサポートしますが、リロードは行わないため、DCEVMを使用する場合も前述の <code class="docutils literal notranslate"><span class="pre">javaagent</span></code> は必要となります。</p>
<p>詳細は <a class="reference external" href="http://javainformed.blogspot.jp/2014/01/jrebel-free-alternative.html">DCEVM - A JRebel free alternative</a> を参照してください。</p>
</div>
</div>
<div class="section" id="ignore">
<h3>ignoreファイルの設定<a class="headerlink" href="#ignore" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference internal" href="index.html#document-tutorial"><span class="doc">チュートリアル</span></a> に沿ってプロジェクトを作成した場合 <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/.gitignore">ignored</a> を参考にignoreファイルを作成してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.*</span>
<span class="n">log</span>
<span class="n">project</span><span class="o">/</span><span class="n">project</span>
<span class="n">project</span><span class="o">/</span><span class="n">target</span>
<span class="n">target</span>
<span class="n">tmp</span>
</pre></div>
</div>
</div>
</div>
<span id="document-action_view"></span><div class="section" id="action-view">
<h2>Action と view<a class="headerlink" href="#action-view" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Xitrumは3種類のActionを提供しています。
通常の <code class="docutils literal notranslate"><span class="pre">Action</span></code> 、<code class="docutils literal notranslate"><span class="pre">FutureAction</span></code> 、そして <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code> です。</p>
<div class="section" id="action">
<h3>Action<a class="headerlink" href="#action" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HelloAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>リクエストはNettyのIOスレッド上で直ちに処理されますので、時間かかる処理（ブロック処理）を含めて
はいけません。NettyのIOスレッドを長い時間使ってしまうとNettyは新しいコネクションを受信できなく
なったりリスポンスを返信できなくなったりします。</p>
</div>
<div class="section" id="futureaction">
<h3>FutureAction<a class="headerlink" href="#futureaction" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.FutureAction</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HelloAction</span> <span class="n">extends</span> <span class="n">FutureAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>リクエストは下記の <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code> と同じスレッドプールが使用されます。これはNettyのスレッドプールとは異なります。</p>
</div>
<div class="section" id="actoraction">
<h3>ActorAction<a class="headerlink" href="#actoraction" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ActionをAkka actorとして定義したい場合、<code class="docutils literal notranslate"><span class="pre">ActorAction</span></code> を継承します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="kn">import</span> <span class="nn">xitrum.ActorAction</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HelloAction</span> <span class="n">extends</span> <span class="n">ActorAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">See</span> <span class="n">Akka</span> <span class="n">doc</span> <span class="n">about</span> <span class="n">scheduler</span>
    <span class="kn">import</span> <span class="nn">context.dispatcher</span>
    <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">scheduleOnce</span><span class="p">(</span><span class="mi">3</span> <span class="n">seconds</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">())</span>

    <span class="o">//</span> <span class="n">See</span> <span class="n">Akka</span> <span class="n">doc</span> <span class="n">about</span> <span class="s2">&quot;become&quot;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">become</span> <span class="p">{</span>
      <span class="n">case</span> <span class="n">pastTime</span> <span class="o">=&gt;</span>
        <span class="n">respondInlineView</span><span class="p">(</span><span class="n">s</span><span class="s2">&quot;It&#39;s $pastTime Unix ms 3s ago.&quot;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Actorインスタンスはリクエストが発生時に生成されます。このactorインスタンスはコネクションが切断された時、
または <code class="docutils literal notranslate"><span class="pre">respondText</span></code> 、 <code class="docutils literal notranslate"><span class="pre">respondView</span></code> 等を使用してレスポンスが返された時に停止されます。
チャンクレスポンスの場合すぐには停止されず、最後のチャンクが送信された時点で停止されます。</p>
<p>リクエストは「xitrum」（システム名）というAkka actorシステムのスレッドプール上で処理されます。</p>
</div>
<div class="section" id="id1">
<h3>クライアントへのレスポンス送信<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Actionからクライアントへレスポンスを返すには以下のメソッドを使用します</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondView</span></code>: レイアウトファイルを使用または使用せずに、Viewテンプレートファイルを送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondInlineView</span></code>: レイアウトファイルを使用または使用せずに、インライン記述されたテンプレートを送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondText(&quot;hello&quot;)</span></code>: レイアウトファイルを使用せずに文字列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondHtml(&quot;&lt;html&gt;...&lt;/html&gt;&quot;)</span></code>: contentTypeを&quot;text/html&quot;として文字列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJson(List(1,</span> <span class="pre">2,</span> <span class="pre">3))</span></code>: ScalaオブジェクトをJSONに変換し、contentTypeを&quot;application/json&quot;として送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJs(&quot;myFunction([1,</span> <span class="pre">2,</span> <span class="pre">3])&quot;)</span></code> contentTypeを&quot;application/javascript&quot;として文字列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonP(List(1,</span> <span class="pre">2,</span> <span class="pre">3),</span> <span class="pre">&quot;myFunction&quot;)</span></code>: 上記2つの組み合わせをJSONPとして送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;)</span></code>: contentTypeを&quot;application/javascript&quot;として文字列として送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonPText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;,</span> <span class="pre">&quot;myFunction&quot;)</span></code>: <cite>respondJs</cite> 、 <cite>respondJsonText</cite> の2つの組み合わせをJSONPとして送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondBinary</span></code>: バイト配列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondFile</span></code>: ディスクからファイルを直接送信します。 <a class="reference external" href="http://www.ibm.com/developerworks/library/j-zerocopy/">zero-copy</a> を使用するため非常に高速です。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondEventSource(&quot;data&quot;,</span> <span class="pre">&quot;event&quot;)</span></code>: チャンクレスポンスを送信します</p></li>
</ul>
</div>
<div class="section" id="view">
<h3>テンプレートViewファイルのレスポンス<a class="headerlink" href="#view" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>全てのActionは <a class="reference external" href="http://scalate.fusesource.org/">Scalate</a> のテンプレートViewファイルと関連付ける事ができます。
上記のレスポンスメソッドを使用して直接レスポンスを送信する代わりに独立したViewファイルを使用することができます。</p>
<p>scr/main/scala/mypackage/MyAction.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>

<span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;myAction&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">what</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="o">=</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>scr/main/scalate/mypackage/MyAction.jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- import mypackage.MyAction

!!! 5
html
  head
    != antiCsrfMeta
    != xitrumCss
    != jsDefaults
    title Welcome to Xitrum

  body
    a(href={url}) Path to the current action
    p= currentAction.asInstanceOf[MyAction].hello(&quot;World&quot;)

    != jsForView
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xitrumCss</span></code> XitrumのデフォルトCSSファイルです。削除しても問題ありません。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code> jQuery, jQuery Validate plugin等を含みます。&lt;head&gt;内に記載する必要があります。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jsForView</span></code> <code class="docutils literal notranslate"><span class="pre">jsAddToView</span></code> によって追加されたjavascriptが出力されます。レイアウトの末尾に記載する必要があります。</p></li>
</ul>
<p>テンプレートファイル内では <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/Action.scala">xitrum.Action</a> クラスの全てのメソッドを使用することができます。
また、<cite>unescape</cite> のようなScalateのユーティリティも使用することができます。Scalateのユーティリティについては <a class="reference external" href="http://scalate.fusesource.org/documentation/index.html">Scalate doc</a>　を参照してください。</p>
<p>Scalateテンプレートのデフォルトタイプは <a class="reference external" href="http://scalate.fusesource.org/documentation/jade.html">Jade</a> を使用しています。
ほかには <a class="reference external" href="http://scalate.fusesource.org/documentation/mustache.html">Mustache</a> 、
<a class="reference external" href="http://scalate.fusesource.org/documentation/scaml-reference.html">Scaml</a> 、
<a class="reference external" href="http://scalate.fusesource.org/documentation/ssp-reference.html">Ssp</a> を選択することもできます。
テンプレートのデフォルトタイプを指定は、アプリケーションのconfigディレクトリ内の`xitrum.conf`で設定することができます。</p>
<p><cite>respondView</cite> メソッドにtypeパラメータとして&quot;jade&quot;、 &quot;mustache&quot;、&quot;scaml&quot;、&quot;ssp&quot;のいずれか指定することでデフォルトテンプレートタイプをオーバーライドすることも可能です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">options</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="s2">&quot;type&quot;</span> <span class="o">-&gt;</span><span class="s2">&quot;mustache&quot;</span><span class="p">)</span>
<span class="n">respondView</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="currentaction">
<h4>currentActionのキャスト<a class="headerlink" href="#currentaction" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>現在のActionのインスタンスを正確に指定したい場合、<code class="docutils literal notranslate"><span class="pre">currentAction</span></code> を指定したActionにキャストします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span><span class="o">=</span> <span class="n">currentAction</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="p">[</span><span class="n">MyAction</span><span class="p">]</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>複数行で使用する場合、キャスト処理は1度だけ呼び出します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">val</span> <span class="n">myAction</span> <span class="o">=</span> <span class="n">currentAction</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="p">[</span><span class="n">MyAction</span><span class="p">];</span> <span class="kn">import</span> <span class="nn">myAction._</span>

<span class="n">p</span><span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;Scala&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span> <span class="n">hello</span><span class="p">(</span><span class="s2">&quot;Xitrum&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4>Mustache<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Mustacheについての参考資料:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://mustache.github.com/mustache.5.html">Mustache syntax</a></p></li>
<li><p><a class="reference external" href="http://scalate.fusesource.org/documentation/mustache.html">Scalate implementation</a></p></li>
</ul>
<p>Mustachのシンタックスは堅牢なため、Jadeで可能な処理の一部は使用できません。</p>
<p>Actionから何か値を渡す場合、<code class="docutils literal notranslate"><span class="pre">at</span></code> メソッドを使用します。</p>
<p>Action:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">at</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="s2">&quot;Jack&quot;</span>
<span class="n">at</span><span class="p">(</span><span class="s2">&quot;xitrumCss&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">xitrumCss</span>
</pre></div>
</div>
<p>Mustache template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">My</span> <span class="n">name</span> <span class="ow">is</span> <span class="p">{{</span><span class="n">name</span><span class="p">}}</span>
<span class="p">{{</span><span class="n">xitrumCss</span><span class="p">}}</span>
</pre></div>
</div>
<p>注意:以下のキーは予約語のため、 <code class="docutils literal notranslate"><span class="pre">at</span></code> メソッドでScalateテンプレートに渡すことはできません。</p>
<ul class="simple">
<li><p>&quot;context&quot;: <code class="docutils literal notranslate"><span class="pre">unescape</span></code> 等のメソッドを含むScalateのユーティリティオブジェクト</p></li>
<li><p>&quot;helper&quot;: 現在のActionオブジェクト</p></li>
</ul>
</div>
<div class="section" id="coffeescript">
<h4>CoffeeScript<a class="headerlink" href="#coffeescript" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="http://scalate.fusesource.org/documentation/jade-syntax.html#filters">:coffeescript filter</a> を使用して
CoffeeScriptをテンプレート内に展開することができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">body</span>
  <span class="p">:</span><span class="n">coffeescript</span>
    <span class="n">alert</span> <span class="s2">&quot;Hello, Coffee!&quot;</span>
</pre></div>
</div>
<p>出力結果:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;body&gt;
  &lt;script type=&#39;text/javascript&#39;&gt;
    //&lt;![CDATA[
      (function() {
        alert(&quot;Hello, Coffee!&quot;);
      }).call(this);
    //]]&gt;
  &lt;/script&gt;
&lt;/body&gt;
</pre></div>
</div>
<p>注意: ただしこの処理は <a class="reference external" href="http://groups.google.com/group/xitrum-framework/browse_thread/thread/6667a7608f0dc9c7">低速</a> です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jade</span><span class="o">+</span><span class="n">javascript</span><span class="o">+</span><span class="mi">1</span><span class="n">thread</span><span class="p">:</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
<span class="n">jade</span><span class="o">+</span><span class="n">coffesscript</span><span class="o">+</span><span class="mi">1</span><span class="n">thread</span><span class="p">:</span> <span class="mi">40</span><span class="o">-</span><span class="mi">70</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
<span class="n">jade</span><span class="o">+</span><span class="n">javascript</span><span class="o">+</span><span class="mi">100</span><span class="n">threads</span><span class="p">:</span> <span class="o">~</span><span class="mi">40</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
<span class="n">jade</span><span class="o">+</span><span class="n">coffesscript</span><span class="o">+</span><span class="mi">100</span><span class="n">threads</span><span class="p">:</span> <span class="mi">400</span><span class="o">-</span><span class="mi">700</span><span class="n">ms</span> <span class="k">for</span> <span class="n">page</span>
</pre></div>
</div>
<p>高速で動作させるにはあらかじめCoffeeScriptからJavaScriptを生成しておく必要があります。</p>
</div>
</div>
<div class="section" id="id4">
<h3>レイアウト<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">respondView</span></code> または <code class="docutils literal notranslate"><span class="pre">respondInlineView</span></code> を使用してViewを送信した場合、
Xitrumはその結果の文字列を、<code class="docutils literal notranslate"><span class="pre">renderedView</span></code> の変数としてセットします。
そして現在のActionの <code class="docutils literal notranslate"><span class="pre">layout</span></code> メソッドが実行されます。
ブラウザーに送信されるデータは最終的にこのメソッドの結果となります。</p>
<p>デフォルトでは、<code class="docutils literal notranslate"><span class="pre">layout</span></code> メソッドは単に <code class="docutils literal notranslate"><span class="pre">renderedView</span></code> を呼び出します。
もし、この処理に追加で何かを加えたい場合、オーバーライドします。もし、 <code class="docutils literal notranslate"><span class="pre">renderedView</span></code> をメソッド内にインクルードした場合、
そのViewはレイアウトの一部としてインクルードされます。</p>
<p>ポイントは <code class="docutils literal notranslate"><span class="pre">layout</span></code> は現在のActionのViewが実行された後に呼ばれるということです。
そしてそこで返却される値がブラウザーに送信される値となります。</p>
<p>このメカニズムはとてもシンプルで魔法ではありません。便宜上Xitrumにはレイアウトが存在しないと考えることができます。
そこにはただ <code class="docutils literal notranslate"><span class="pre">layout</span></code> メソッドがあるだけで、全てをこのメソッドで賄うことができます。</p>
<p>典型的な例として、共通レイアウトを親クラスとして使用するパターンを示します。</p>
<p>src/main/scala/mypackage/AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>
<span class="kn">import</span> <span class="nn">xitrum.Action</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">renderViewNoLayout</span><span class="p">[</span><span class="n">AppAction</span><span class="p">]()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>src/main/scalate/mypackage/AppAction.jade</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!!! 5
html
  head
    != antiCsrfMeta
    != xitrumCss
    != jsDefaults
    title Welcome to Xitrum

  body
    != renderedView
    != jsForView
</pre></div>
</div>
<p>src/main/scala/mypackage/MyAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;myAction&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">what</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="o">=</span> <span class="s2">&quot;Hello </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>scr/main/scalate/mypackage/MyAction.jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="kn">import</span> <span class="nn">mypackage.MyAction</span>

<span class="n">a</span><span class="p">(</span><span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">})</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">action</span>
<span class="n">p</span><span class="o">=</span> <span class="n">currentAction</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="p">[</span><span class="n">MyAction</span><span class="p">]</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s2">&quot;World&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="id5">
<h4>独立したレイアウトファイルを使用しないパターン<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="respondview">
<h4>respondViewにレイアウトを直接指定するパターン<a class="headerlink" href="#respondview" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">specialLayout</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span>
  <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>

<span class="n">respondView</span><span class="p">(</span><span class="n">specialLayout</span> <span class="n">_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="respondinlineview">
<h3>respondInlineView<a class="headerlink" href="#respondinlineview" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>通常ViewはScalateファイルに記載しますが、直接Actionに記載することもできます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import xitrum.Action
import xitrum.annotation.GET

@GET(&quot;myAction&quot;)
class MyAction extends Action {
  def execute() {
    val s = &quot;World&quot;  // Will be automatically HTML-escaped
    respondInlineView(
      &lt;p&gt;Hello &lt;em&gt;{s}&lt;/em&gt;!&lt;/p&gt;
    )
  }
}
</pre></div>
</div>
</div>
<div class="section" id="renderfragment">
<h3>renderFragment<a class="headerlink" href="#renderfragment" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>MyAction.jadeが
<code class="docutils literal notranslate"><span class="pre">scr/main/scalate/mypackage/MyAction.jade</span></code>
にある場合、同じディレクトリにあるフラグメント
<code class="docutils literal notranslate"><span class="pre">scr/main/scalate/mypackage/_MyFragment.jade</span></code>
を返す場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">renderFragment</span><span class="p">[</span><span class="n">MyAction</span><span class="p">](</span><span class="s2">&quot;MyFragment&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>現在のActionが``MyAction``の場合、以下のように省略できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">renderFragment</span><span class="p">(</span><span class="s2">&quot;MyFragment&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>別のアクションに紐付けられたViewをレスポンスする場合<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>次のシンタックスを使用します <code class="docutils literal notranslate"><span class="pre">respondView[ClassName]()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>

<span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">POST</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginFormAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Respond</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">LoginFormAction</span><span class="o">.</span><span class="n">jade</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DoLoginAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">authenticated</span> <span class="o">=</span> <span class="o">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">authenticated</span><span class="p">)</span>
      <span class="n">redirectTo</span><span class="p">[</span><span class="n">HomeAction</span><span class="p">]()</span>
    <span class="k">else</span>
      <span class="o">//</span> <span class="n">Reuse</span> <span class="n">the</span> <span class="n">view</span> <span class="n">of</span> <span class="n">LoginFormAction</span>
      <span class="n">respondView</span><span class="p">[</span><span class="n">LoginFormAction</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id7">
<h4>ひとつのアクションに複数のViewを紐付ける方法<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">mypackage</span>

<span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="o">//</span> <span class="n">These</span> <span class="n">are</span> <span class="n">non</span><span class="o">-</span><span class="n">routed</span> <span class="n">actions</span><span class="p">,</span> <span class="k">for</span> <span class="n">mapping</span> <span class="n">to</span> <span class="n">view</span> <span class="n">template</span> <span class="n">files</span><span class="p">:</span>
<span class="o">//</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">HomeAction_NormalUser</span><span class="o">.</span><span class="n">jade</span>
<span class="o">//</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">HomeAction_Moderator</span><span class="o">.</span><span class="n">jade</span>
<span class="o">//</span> <span class="n">scr</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">scalate</span><span class="o">/</span><span class="n">mypackage</span><span class="o">/</span><span class="n">HomeAction_Admin</span><span class="o">.</span><span class="n">jade</span>
<span class="n">trait</span> <span class="n">HomeAction_NormalUser</span> <span class="n">extends</span> <span class="n">Action</span>
<span class="n">trait</span> <span class="n">HomeAction_Moderator</span>  <span class="n">extends</span> <span class="n">Action</span>
<span class="n">trait</span> <span class="n">HomeAction_Admin</span>      <span class="n">extends</span> <span class="n">Action</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HomeAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">userType</span> <span class="o">=</span> <span class="o">...</span>
    <span class="n">userType</span> <span class="n">match</span> <span class="p">{</span>
      <span class="n">case</span> <span class="n">NormalUser</span> <span class="o">=&gt;</span> <span class="n">respondView</span><span class="p">[</span><span class="n">HomeAction_NormalUser</span><span class="p">]()</span>
      <span class="n">case</span> <span class="n">Moderator</span>  <span class="o">=&gt;</span> <span class="n">respondView</span><span class="p">[</span><span class="n">HomeAction_Moderator</span><span class="p">]()</span>
      <span class="n">case</span> <span class="n">Admin</span>      <span class="o">=&gt;</span> <span class="n">respondView</span><span class="p">[</span><span class="n">HomeAction_Admin</span><span class="p">]()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上記のようにルーティングとは関係ないアクションを記述することは一見して面倒ですが、
この方法はプログラムをタイプセーフに保つことができます。</p>
<p>またはテンプレートのパスを文字列で指定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondView</span><span class="p">(</span><span class="s2">&quot;mypackage/HomeAction_NormalUser&quot;</span><span class="p">)</span>
<span class="n">respondView</span><span class="p">(</span><span class="s2">&quot;mypackage/HomeAction_Moderator&quot;</span><span class="p">)</span>
<span class="n">respondView</span><span class="p">(</span><span class="s2">&quot;mypackage/HomeAction_Admin&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">renderView</span></code>, <code class="docutils literal notranslate"><span class="pre">renderViewNoLayout</span></code>, <code class="docutils literal notranslate"><span class="pre">respondView</span></code>, <code class="docutils literal notranslate"><span class="pre">respondViewNoLayout</span></code> では <code class="docutils literal notranslate"><span class="pre">src/main/scalate</span></code> からのテンプレートファイルへのパス、
<code class="docutils literal notranslate"><span class="pre">renderFragment</span></code> にはフラグメントを配置したディレクトリーへのパスをクラスの代わりに指定することができます。</p>
</div>
</div>
<div class="section" id="component">
<h3>Component<a class="headerlink" href="#component" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>複数のViewに対して組み込むことができる再利用可能なコンポーネントを作成することもできます。
コンポーネントのコンセプトはアクションに非常に似ています。
以下のような特徴があります。</p>
<ul class="simple">
<li><p>コンポーネントはルートを持ちません。すなわち <code class="docutils literal notranslate"><span class="pre">execute</span></code> メソッドは不要となります。</p></li>
<li><p>コンポーネントは全レスポンスを返すわけではありません。 断片的なviewを &quot;render&quot; するのみとなります。
そのため、コンポーネント内部では <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code> の代わりに <code class="docutils literal notranslate"><span class="pre">renderXXX</span></code> を呼び出す必要があります。</p></li>
<li><p>アクションのように、コンポーネントは単一のまたは複数のViewと紐付けるたり、あるいは紐付けないで使用することも可能です。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>package mypackage

import xitrum.{FutureAction, Component}
import xitrum.annotation.GET

class CompoWithView extends Component {
  def render() = {
    // Render associated view template, e.g. CompoWithView.jade
    // Note that this is renderView, not respondView!
    renderView()
  }
}

class CompoWithoutView extends Component {
  def render() = {
    &quot;Hello World&quot;
  }
}

@GET(&quot;foo/bar&quot;)
class MyAction extends FutureAction {
  def execute() {
    respondView()
  }
}
</pre></div>
</div>
<p>MyAction.jade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="kn">import</span> <span class="nn">mypackage._</span>

<span class="o">!=</span> <span class="n">newComponent</span><span class="p">[</span><span class="n">CompoWithView</span><span class="p">]()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
<span class="o">!=</span> <span class="n">newComponent</span><span class="p">[</span><span class="n">CompoWithoutView</span><span class="p">]()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<span id="document-restful"></span><div class="section" id="restful-apis">
<h2>RESTful APIs<a class="headerlink" href="#restful-apis" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>XitrumではiPhone、Androidなどのアプリケーション用のRESTful APIsを非常に簡単に記述することができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesIndex</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>POST、 PUT、 PATCH、 DELETEそしてOPTIONSと同様に
XitrumはHEADリクエストをボディが空のGETリクエストとして自動的に扱います。</p>
<p>通常のブラウザーのようにPUTとDELETEをサポートしていないHTTPクライアントにおいて、
PUTとDELETEを実現するには、リクエストボディに <code class="docutils literal notranslate"><span class="pre">_method=put</span></code> や、 <code class="docutils literal notranslate"><span class="pre">_method=delete</span></code> を含めることで
可能になります。</p>
<p>アプリケーションの起動時にXitrumはアプリケーションをスキャンし、ルーティングテーブルを作成し出力します。
以下の様なログからアプリケーションがどのようなAPIをサポートしているか知ることができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Routes</span><span class="p">:</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">articles</span>     <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">ArticlesIndex</span>
<span class="n">GET</span> <span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="p">:</span><span class="nb">id</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">ArticlesShow</span>
</pre></div>
</div>
<p>ルーティングはJAX-RSとRailsエンジンの思想に基づいて自動で収集されます。
全てのルートを１箇所に宣言する必要はありません。
この機能は分散ルーティングと捉えることができます。この機能のおかげでアプリケーションを他のアプリケーションに取り込むことが可能になります。
もしあなたがブログエンジンを作ったならそれをJARにして別のアプリケーションに取り込むだけですぐにブログ機能が使えるようになるでしょう。
ルーティングには更に2つの特徴があります。
ルートの作成（リバースルーティング）は型安全に実施され、
<a class="reference external" href="http://swagger.wordnik.com/">Swagger Doc</a> を使用したルーティングに関するドキュメント作成も可能となります。</p>
<div class="section" id="id1">
<h3>ルートのキャッシング<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>起動スピード改善のため、ルートは <code class="docutils literal notranslate"><span class="pre">routes.cache</span></code> ファイルにキャッシュされます。
開発時には <code class="docutils literal notranslate"><span class="pre">target</span></code> にあるクラスファイル内のルートはキャッシュされません。
もしルートを含む依存ライブラリを更新した場合、 <code class="docutils literal notranslate"><span class="pre">routes.cache</span></code> ファイルを削除してください。
また、このファイルはソースコードリポジトリにコミットしないよう気をつけましょう。</p>
</div>
<div class="section" id="firstlast">
<h3>ルートの優先順位(first、last)<a class="headerlink" href="#firstlast" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下の様なルートを作成した場合</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="p">:</span><span class="nb">id</span> <span class="o">--&gt;</span> <span class="n">ArticlesShow</span>
<span class="o">/</span><span class="n">articles</span><span class="o">/</span><span class="n">new</span> <span class="o">--&gt;</span> <span class="n">ArticlesNew</span>
</pre></div>
</div>
<p>2番目のルートを優先させるには <code class="docutils literal notranslate"><span class="pre">&#64;First</span></code> アノテーションを追加します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">First</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@First</span>  <span class="o">//</span> <span class="n">This</span> <span class="n">route</span> <span class="n">has</span> <span class="n">higher</span> <span class="n">priority</span> <span class="n">than</span> <span class="s2">&quot;ArticlesShow&quot;</span> <span class="n">above</span>
<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/new&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesNew</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Last</span></code> も同じように使用できます。</p>
</div>
<div class="section" id="action">
<h3>Actionへの複数パスの関連付け<a class="headerlink" href="#action" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="s2">&quot;image/:format&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Image</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">paramo</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrElse</span><span class="p">(</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>ドットを含むルート<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">,</span> <span class="s2">&quot;articles/:id.:format&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="nb">id</span>     <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">paramo</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrElse</span><span class="p">(</span><span class="s2">&quot;html&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>正規表現によるルーティング<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ルーティングに正規表現を使用することも可能です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&lt;[0-9]+&gt;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>パスの残り部分の取得<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">/</span></code> 文字が特別でパラメータ名に含まれられません。<code class="docutils literal notranslate"><span class="pre">/</span></code> 文字を使いたい場合、以下のように書きます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span><span class="p">(</span><span class="s2">&quot;service/:id/proxy/:*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>以下のパスがマッチされます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">service</span><span class="o">/</span><span class="mi">123</span><span class="o">/</span><span class="n">proxy</span><span class="o">/</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">foo</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">bar</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">:*</span></code> を取得:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">url</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>  <span class="o">//</span> <span class="s2">&quot;http://foo.com/bar&quot;</span><span class="n">となります</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>アクションへのリンク<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは型安全指向です。URLは直截記載せずにいかのように参照します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">ArticlesShow</span><span class="p">](</span><span class="s2">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">myArticle</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span><span class="o">&gt;</span><span class="p">{</span><span class="n">myArticle</span><span class="o">.</span><span class="n">title</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>他のアクションへのリダイレクト<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">redirectTo[AnotherAction]()</span></code> を使用します。
リダイレクトについては <a class="reference external" href="http://en.wikipedia.org/wiki/URL_redirection">こちら（英語）</a> を参照してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">POST</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginInput</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DoLogin</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="o">//</span> <span class="n">After</span> <span class="n">login</span> <span class="n">success</span>
    <span class="n">redirectTo</span><span class="p">[</span><span class="n">AdminIndex</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">GET</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AdminIndex</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="o">//</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">user</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">logged</span> <span class="ow">in</span><span class="p">,</span> <span class="n">redirect</span> <span class="n">him</span> <span class="n">to</span> <span class="n">the</span> <span class="n">login</span> <span class="n">page</span>
    <span class="n">redirectTo</span><span class="p">[</span><span class="n">LoginInput</span><span class="p">]()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>また、<code class="docutils literal notranslate"><span class="pre">redirecToThis()</span></code> を使用して現在のアクションへリダイレクトさせることも可能です。</p>
</div>
<div class="section" id="id8">
<h3>他のアクションへのフォワード<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">forwardTo[AnotherAction]()</span></code> を使用します。前述の <code class="docutils literal notranslate"><span class="pre">redirectTo</span></code> ではブラウザは別のリクエストを送信しますが、
<code class="docutils literal notranslate"><span class="pre">forwardTo</span></code> ではリクエストは引き継がれます。</p>
</div>
<div class="section" id="ajax">
<h3>Ajaxリクエストの判定<a class="headerlink" href="#ajax" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">isAjax</span></code> を使用します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">In</span> <span class="n">an</span> <span class="n">action</span>
<span class="n">val</span> <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A message&quot;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">isAjax</span><span class="p">)</span>
  <span class="n">jsRender</span><span class="p">(</span><span class="s2">&quot;alert(&quot;</span> <span class="o">+</span> <span class="n">jsEscape</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
<span class="k">else</span>
  <span class="n">respondText</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="csrf">
<h3>CSRF対策<a class="headerlink" href="#csrf" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>GET以外のリクエストに対して、Xitrumはデフォルトで <a class="reference external" href="http://en.wikipedia.org/wiki/CSRF">Cross-site request forgery</a> 対策を実施します。</p>
<p><code class="docutils literal notranslate"><span class="pre">antiCsrfMeta</span></code> Tagsをレイアウト内に記載した場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>出力される <code class="docutils literal notranslate"><span class="pre">&lt;head&gt;</span></code> は以下のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    ...
    &lt;meta name=&quot;csrf-token&quot; content=&quot;5402330e-9916-40d8-a3f4-16b271d583be&quot; /&gt;
    ...
  &lt;/head&gt;
  ...
&lt;/html&gt;
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/js.scala">xitrum.js</a> をテンプレート内で使用した場合、
このトークンは <code class="docutils literal notranslate"><span class="pre">X-CSRF-Token</span></code> ヘッダーとしてGETを除く全てのjQueryによるAjaxリクエストに含まれます。
xitrum.jsは <code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code> タグを使用することでロードされます。
もし <code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code> を使用したくない場合、以下のようにテンプレートに記載することですることでxitrum.jsをロードすることができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">xitrum</span><span class="o">.</span><span class="n">js</span><span class="p">]}</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="csrfcsrf">
<h3>CSRF対策インプットとCSRF対策トークン<a class="headerlink" href="#csrfcsrf" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>XitrumはCSRF対策トークンをリクエストヘッダーの <code class="docutils literal notranslate"><span class="pre">X-CSRF-Token</span></code> から取得します。
もしリクエストヘッダーが存在しない場合、Xitrumはリクエストボディの <code class="docutils literal notranslate"><span class="pre">csrf-token</span></code> から取得します。
（URLパラメータ内には含まれません。）</p>
<p>前述したメタタグとxitrum.jsを使用せずにformを作成する場合、<code class="docutils literal notranslate"><span class="pre">antiCsrfInput</span></code> または
<code class="docutils literal notranslate"><span class="pre">antiCsrfToken</span></code> を使用する必要があります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">AdminAddGroup</span><span class="p">]})</span>
  <span class="o">!=</span> <span class="n">antiCsrfInput</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">AdminAddGroup</span><span class="p">]})</span>
  <span class="nb">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;csrf-token&quot;</span> <span class="n">value</span><span class="o">=</span><span class="p">{</span><span class="n">antiCsrfToken</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h3>CSRFチェックの省略<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>スマートフォン向けアプリケーションなどでCSRFチェックを省略したい場合、
<code class="docutils literal notranslate"><span class="pre">xitrum.SkipCsrfCheck</span></code> を継承してActionを作成します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">SkipCsrfCheck</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.POST</span>

<span class="n">trait</span> <span class="n">Api</span> <span class="n">extends</span> <span class="n">Action</span> <span class="k">with</span> <span class="n">SkipCsrfCheck</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;api/positions&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LogPositionAPI</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;api/todos&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CreateTodoAPI</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>ルーティングの操作<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは起動時に自動でルーティングを収集します。
収集されたルーティングにアクセスするには、<a class="reference external" href="http://xitrum-framework.github.io/api/3.17/index.html#xitrum.routing.RouteCollection">xitrum.Config.routes</a> を使用します。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import xitrum.{Config, Server}

object Boot {
  def main(args: Array[String]) {
    // サーバーをスタートさせる前にルーティングを操作します。
    val routes = Config.routes

    // クラスを指定してルートを削除する場合
    routes.removeByClass[MyClass]()

    if (demoVersion) {
      // prefixを指定してルートを削除する場合
      routes.removeByPrefix(&quot;premium/features&quot;)

      // &#39;/&#39;が先頭にある場合も同じ効果が得られます
      routes.removeByPrefix(&quot;/premium/features&quot;)
    }

    ...

    Server.start()
  }
}
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>リクエストコンテンツの取得<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>通常リクエストコンテンツタイプが <code class="docutils literal notranslate"><span class="pre">application/x-www-form-urlencoded</span></code> 以外の場合、
以下のようにしてリクエストコンテンツを取得することができます。</p>
<p>文字列として取得:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">body</span> <span class="o">=</span> <span class="n">requestContentString</span>
</pre></div>
</div>
<p>文字列として取得し、JSONへのパース:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">myJValue</span> <span class="o">=</span> <span class="n">requestContentJValue</span>  <span class="o">//</span> <span class="o">=&gt;</span> <span class="n">JSON4S</span> <span class="p">(</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">json4s</span><span class="o">.</span><span class="n">org</span><span class="p">)</span> <span class="n">JValue</span>
<span class="n">val</span> <span class="n">myMap</span> <span class="o">=</span> <span class="n">xitrum</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromJValue</span><span class="p">[</span><span class="n">Map</span><span class="p">[</span><span class="n">String</span><span class="p">,</span> <span class="n">Int</span><span class="p">]](</span><span class="n">myJValue</span><span class="p">)</span>
</pre></div>
</div>
<p>より詳細にリクエストを扱う場合、 <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/FullHttpRequest.html">request.getContent</a> を使用することで
<a class="reference external" href="http://netty.io/4.0/api/io/netty/buffer/ByteBuf.html">ByteBuf</a> としてリクエストを取得することができます。</p>
</div>
<div class="section" id="swaggerapi">
<h3>SwaggerによるAPIドキュメンテーション<a class="headerlink" href="#swaggerapi" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://developers.helloreverb.com/swagger/">Swagger</a> を使用してAPIドキュメントを作成することができます。
<code class="docutils literal notranslate"><span class="pre">&#64;Swagger</span></code> アノテーションをドキュメント化したいActionに記述します。
Xitrumはアノテーション情報から <a class="reference external" href="https://github.com/wordnik/swagger-core/wiki/API-Declaration">/xitrum/swagger.json</a> を作成します。
このファイルを <a class="reference external" href="https://github.com/wordnik/swagger-ui">Swagger UI</a> で読み込むことでインタラクティブなAPIドキュメンテーションとなります。
XitrumはSwagger UI を内包しており、 <code class="docutils literal notranslate"><span class="pre">/xitrum/swagger-ui</span></code> というパスにルーティングします。
例: <a class="reference external" href="http://localhost:8000/xitrum/swagger-ui">http://localhost:8000/xitrum/swagger-ui</a>.</p>
<img alt="_images/swagger.png" src="_images/swagger.png" />
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-placeholder">サンプル</a> を見てみましょう。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">SkipCsrfCheck</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">Swagger</span><span class="p">}</span>

<span class="nd">@Swagger</span><span class="p">(</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Tags</span><span class="p">(</span><span class="s2">&quot;APIs to create images&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Description</span><span class="p">(</span><span class="s2">&quot;Dimensions should not be bigger than 2000 x 2000&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">OptStringQuery</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;Text to render on the image, default: Placeholder&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Produces</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;PNG image&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Width or height is invalid or too big&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">trait</span> <span class="n">ImageApi</span> <span class="n">extends</span> <span class="n">Action</span> <span class="k">with</span> <span class="n">SkipCsrfCheck</span> <span class="p">{</span>
  <span class="n">lazy</span> <span class="n">val</span> <span class="n">text</span> <span class="o">=</span> <span class="n">paramo</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrElse</span><span class="p">(</span><span class="s2">&quot;Placeholder&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;image/:width/:height&quot;</span><span class="p">)</span>
<span class="nd">@Swagger</span><span class="p">(</span>  <span class="o">//</span> <span class="o">&lt;--</span> <span class="n">Inherits</span> <span class="n">other</span> <span class="n">info</span> <span class="kn">from</span> <span class="nn">ImageApi</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="s2">&quot;Generate rectangle image&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">IntPath</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">IntPath</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">RectImageApi</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">height</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;height&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;image/:width&quot;</span><span class="p">)</span>
<span class="nd">@Swagger</span><span class="p">(</span>  <span class="o">//</span> <span class="o">&lt;--</span> <span class="n">Inherits</span> <span class="n">other</span> <span class="n">info</span> <span class="kn">from</span> <span class="nn">ImageApi</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="s2">&quot;Generate square image&quot;</span><span class="p">),</span>
  <span class="n">Swagger</span><span class="o">.</span><span class="n">IntPath</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">class</span> <span class="nc">SquareImageApi</span> <span class="n">extends</span> <span class="n">Api</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">width</span>  <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">Int</span><span class="p">](</span><span class="s2">&quot;width&quot;</span><span class="p">)</span>
    <span class="o">//</span> <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/xitrum/swagger</span></code> にアクセスすると
<a class="reference external" href="https://github.com/wordnik/swagger-spec/blob/master/versions/1.2.md">SwaggerのためのJSON</a>
が生成されます。</p>
<p>Swagger UIはこの情報をもとにインタラクティブなAPIドキュメンテーションを作成します。</p>
<p>ここででてきたSwagger.IntPath、Swagger.OptStringQuery以外にも、BytePath, IntQuery, OptStringFormなど
以下の形式でアノテーションを使用することができます。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;Value</span> <span class="pre">type&gt;&lt;Param</span> <span class="pre">type&gt;</span></code> (必須パラメータ)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Opt&lt;Value</span> <span class="pre">type&gt;&lt;Param</span> <span class="pre">type&gt;</span></code> (オプションパラメータ)</p></li>
</ul>
<p>Value type: Byte, Int, Int32, Int64, Long, Number, Float, Double, String, Boolean, Date, DateTime</p>
<p>Param type: Path, Query, Body, Header, Form</p>
<p>詳しくは <a class="reference external" href="https://github.com/wordnik/swagger-core/wiki/Datatypes">value type</a> 、
<a class="reference external" href="https://github.com/wordnik/swagger-core/wiki/Parameters">param type</a> を参照してください。</p>
</div>
</div>
<span id="document-template_engines"></span><div class="section" id="id1">
<h2>テンプレートエンジン<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="index.html#document-action_view"><span class="doc">renderViewやrenderFragment, respondView</span></a> 実行時には
設定ファイルで指定したテンプレートエンジンが使用されます。</p>
<div class="section" id="id2">
<h3>テンプレートエンジンの設定<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a> において
テンプレートエンジンはその種類に応じて以下ように設定することができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">EngineClassName</span>
</pre></div>
</div>
<p>または:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="p">{</span>
  <span class="s2">&quot;my.template.EngineClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>デフォルトのテンプレートエンジンは <a class="reference external" href="https://github.com/xitrum-framework/xitrum-scalate">xitrum-scalate</a> です。</p>
</div>
<div class="section" id="id3">
<h3>テンプレートエンジンの削除<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>一般にRESTfulなAPIのみを持つプロジェクトを作成した場合、renderView、renderFragment、あるいはrespondView
は不要となります。このようなケースではテンプレートエンジンを削除することでプロジェクトを軽量化することができます。
その場合 config/xitrum.conf から <code class="docutils literal notranslate"><span class="pre">templateEngine</span></code> の設定をコメントアウトします。</p>
</div>
<div class="section" id="id4">
<h3>テンプレートエンジンの作成<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>独自のテンプレートエンジンを作成する場合、 <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/view/TemplateEngine.scala">xitrum.view.TemplateEngine</a> を継承したクラスを作成します。
そして作成したクラスを config/xitrum.conf にて指定します。</p>
<p>参考例: <a class="reference external" href="https://github.com/xitrum-framework/xitrum-scalate">xitrum-scalate</a></p>
</div>
</div>
<span id="document-postback"></span><div class="section" id="id1">
<h2>ポストバック<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Webアプリケーションには主に以下の2つのユースケースが考えられます。</p>
<ul class="simple">
<li><p>機械向けのサーバー機能: スマートフォンや他のWebサイトのためのWebサービスとしてRESTfulなAPIを作成する必要があるケース</p></li>
<li><p>人間向けのサーバー機能: インタラクティブなWebページを作成する必要があるケース</p></li>
</ul>
<p>WebフレームワークとしてXitrumはこれら2つのユースケースを簡単に解決することを目指しています。
1つ目のユースケースには、<a class="reference internal" href="index.html#document-restful"><span class="doc">RESTful actions</span></a> を適用することで対応し、
2つ目のユースケースには、Ajaxフォームポストバックを適用することで対応します。
ポストバックのアイデアについては以下のリンク（英語）を参照することを推奨します。</p>
<ul class="simple">
<li><p><a class="reference external" href="http://en.wikipedia.org/wiki/Postback">http://en.wikipedia.org/wiki/Postback</a></p></li>
<li><p><a class="reference external" href="http://nitrogenproject.com/doc/tutorial.html">http://nitrogenproject.com/doc/tutorial.html</a></p></li>
</ul>
<p>Xitrumのポストバック機能は <a class="reference external" href="http://nitrogenproject.com/">Nitrogen</a> を参考にしています。</p>
<div class="section" id="id2">
<h3>レイアウト<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">Xitrum</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>フォーム<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Articles.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">POST</span><span class="p">,</span> <span class="n">First</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.validator._</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="nb">id</span>      <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">respondInlineView</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">article</span><span class="o">.</span><span class="n">title</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="p">{</span><span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@First</span>  <span class="o">//</span> <span class="n">Force</span> <span class="n">this</span> <span class="n">route</span> <span class="n">to</span> <span class="n">be</span> <span class="n">matched</span> <span class="n">before</span> <span class="s2">&quot;show&quot;</span>
<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/new&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesNew</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondInlineView</span><span class="p">(</span>
      <span class="o">&lt;</span><span class="n">form</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">ArticlesCreate</span><span class="p">]}</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">Title</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;title&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;required&quot;</span> <span class="o">/&gt;&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>

        <span class="o">&lt;</span><span class="n">label</span><span class="o">&gt;</span><span class="n">Body</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">textarea</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;body&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;required&quot;</span><span class="o">&gt;&lt;/</span><span class="n">textarea</span><span class="o">&gt;&lt;</span><span class="n">br</span> <span class="o">/&gt;</span>

        <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span> <span class="o">/&gt;</span>
      <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesCreate</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">title</span>   <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">body</span>    <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="n">flash</span><span class="p">(</span><span class="s2">&quot;Article has been saved.&quot;</span><span class="p">)</span>
    <span class="n">jsRedirectTo</span><span class="p">(</span><span class="n">show</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">submit</span></code> イベントがJavaScript上で実行された時、フォームの内容は <code class="docutils literal notranslate"><span class="pre">ArticlesCreate</span></code> へポストバックされます。
<code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code> の <code class="docutils literal notranslate"><span class="pre">action</span></code> 属性は暗号化され、暗号化されたURLはCSRF対策トークンとして機能します。</p>
</div>
<div class="section" id="form">
<h3>formエレメント以外への適用<a class="headerlink" href="#form" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ポストバックはform以外のHTMLエレメントにも適用することができます。</p>
<p>リンク要素への適用例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LogoutAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>リンク要素をクリックした場合LogoutActionへポストバックが行われます。</p>
</div>
<div class="section" id="id4">
<h3>コンファームダイアログ<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>コンファームダイアログを表する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span>
            <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LogoutAction</span><span class="p">]}</span>
            <span class="n">data</span><span class="o">-</span><span class="n">confirm</span><span class="o">=</span><span class="s2">&quot;Do you want to logout?&quot;</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>&quot;キャンセル&quot;がクリックされた場合、ポストバックの送信は行われません。</p>
</div>
<div class="section" id="id5">
<h3>パラメーターの追加<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>formエレメントに対して  <code class="docutils literal notranslate"><span class="pre">&lt;input</span> <span class="pre">type=&quot;hidden&quot;...</span></code> を追加することで追加パラメーターをポストバックリクエストに付与することができます。</p>
<p>formエレメント以外に対しては、以下のように指定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span>
   <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span>
   <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">ArticlesDestroy</span><span class="p">](</span><span class="s2">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span>
   <span class="n">data</span><span class="o">-</span><span class="n">params</span><span class="o">=</span><span class="s2">&quot;_method=delete&quot;</span>
   <span class="n">data</span><span class="o">-</span><span class="n">confirm</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Do you want to delete </span><span class="si">%s</span><span class="s2">?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)}</span><span class="o">&gt;</span><span class="n">Delete</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>または以下のように別のエレメントに指定することも可能です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">form</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;myform&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">SiteSearch</span><span class="p">]}</span><span class="o">&gt;</span>
  <span class="n">Search</span><span class="p">:</span>
  <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;keyword&quot;</span> <span class="o">/&gt;</span>

  <span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;pagination&quot;</span>
     <span class="n">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span>
     <span class="n">data</span><span class="o">-</span><span class="n">postback</span><span class="o">=</span><span class="s2">&quot;click&quot;</span>
     <span class="n">data</span><span class="o">-</span><span class="n">form</span><span class="o">=</span><span class="s2">&quot;#myform&quot;</span>
     <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">SiteSearch</span><span class="p">](</span><span class="s2">&quot;page&quot;</span> <span class="o">-&gt;</span> <span class="n">page</span><span class="p">)}</span><span class="o">&gt;</span><span class="p">{</span><span class="n">page</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">#myform</span></code> はJQueryのセレクタ形式で追加パラメーターを含むエレメントを指定します。</p>
</div>
<div class="section" id="id6">
<h3>ローディングイメージの表示<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下のローディングイメージがAjax通信中に表示されます:</p>
<img alt="_images/ajax_loading.gif" src="_images/ajax_loading.gif" />
<p>カスタマイズするには、テンプレート内で、<code class="docutils literal notranslate"><span class="pre">jsDefaults</span></code> (これは <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/js.scala">xitrum.js</a>
をインクルードするための関数です) の後に次を追加します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">target</span><span class="p">:</span> <span class="n">The</span> <span class="n">element</span> <span class="n">that</span> <span class="n">triggered</span> <span class="n">the</span> <span class="n">postback</span>
<span class="n">xitrum</span><span class="o">.</span><span class="n">ajaxLoading</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Called</span> <span class="n">when</span> <span class="n">the</span> <span class="n">animation</span> <span class="n">should</span> <span class="n">be</span> <span class="n">displayed</span> <span class="n">when</span> <span class="n">the</span> <span class="n">Ajax</span> <span class="n">postback</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">sent</span><span class="o">.</span>
  <span class="n">var</span> <span class="n">show</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">};</span>

  <span class="o">//</span> <span class="n">Called</span> <span class="n">when</span> <span class="n">the</span> <span class="n">animation</span> <span class="n">should</span> <span class="n">be</span> <span class="n">stopped</span> <span class="n">after</span> <span class="n">the</span> <span class="n">Ajax</span> <span class="n">postback</span> <span class="n">completes</span><span class="o">.</span>
  <span class="n">var</span> <span class="n">hide</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">{</span><span class="n">show</span><span class="p">:</span> <span class="n">show</span><span class="p">,</span> <span class="n">hide</span><span class="p">:</span> <span class="n">hide</span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
<span id="document-xml"></span><div class="section" id="xml">
<h2>XML<a class="headerlink" href="#xml" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ScalaではXMLリテラルを記述することが可能です。Xitrumではこの機能をテンプレートエンジンとして利用しています。</p>
<ul class="simple">
<li><p>ScalaコンパイラによるXMLシンタックスチェックは、Viewの型安全につながります。</p></li>
<li><p>ScalaによるXMLの自動的なエスケープは、<a class="reference external" href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a>　攻撃を防ぎます。</p></li>
</ul>
<p>いくつかのTipsを示します。</p>
<div class="section" id="id1">
<h3>XMLのアンエスケープ<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">scala.xml.Unparsed</span></code> を使用する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scala.xml.Unparsed</span>

<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="p">{</span><span class="n">Unparsed</span><span class="p">(</span><span class="s2">&quot;if (1 &lt; 2) alert(&#39;Xitrum rocks&#39;);&quot;</span><span class="p">)}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;xml:unparsed&gt;</span></code> を使用する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">xml</span><span class="p">:</span><span class="n">unparsed</span><span class="o">&gt;</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">alert</span><span class="p">(</span><span class="s1">&#39;Xitrum rocks&#39;</span><span class="p">);</span>
  <span class="o">&lt;/</span><span class="n">xml</span><span class="p">:</span><span class="n">unparsed</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;xml:unparsed&gt;</span></code> は実際の出力には含まれません:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">alert</span><span class="p">(</span><span class="s1">&#39;Xitrum rocks&#39;</span><span class="p">);</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>XMLエレメントのグループ化<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;header&quot;</span><span class="o">&gt;</span>
  <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">loggedIn</span><span class="p">)</span>
    <span class="o">&lt;</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="p">{</span><span class="n">username</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LogoutAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span>
  <span class="k">else</span>
    <span class="o">&lt;</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">RegisterAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Register</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">xml</span><span class="p">:</span><span class="n">group</span><span class="o">&gt;</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;xml:group&gt;</span></code> は実際の出力には含まれません。ユーザーがログイン状態の場合、以下のように出力されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;header&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="n">My</span> <span class="n">username</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/login&quot;</span><span class="o">&gt;</span><span class="n">Logout</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="xhtml">
<h3>XHTMLの描画<a class="headerlink" href="#xhtml" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>XitrumはviewとレイアウトはXHTMLとして出力します。
レアケースではありますが、もしあなたが直接、出力内容を定義する場合、以下のコードが示す内容に注意してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import scala.xml.Xhtml

val br = &lt;br /&gt;
br.toString            // =&gt; &lt;br&gt;&lt;/br&gt;, この場合ブラウザによってはbrタグが2つあると認識されることがあります。
Xhtml.toXhtml(&lt;br /&gt;)  // =&gt; &quot;&lt;br /&gt;&quot;
</pre></div>
</div>
</div>
</div>
<span id="document-js"></span><div class="section" id="javascript-json">
<h2>JavaScript と JSON<a class="headerlink" href="#javascript-json" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="javascript">
<h3>JavaScript<a class="headerlink" href="#javascript" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>XitrumはjQueryを内包しています。</p>
<p>またいくつかのjsXXXヘルパー関数を提供しています。</p>
<div class="section" id="javascriptview">
<h4>JavaScriptフラグメントをViewに追加する方法<a class="headerlink" href="#javascriptview" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>アクション内では <code class="docutils literal notranslate"><span class="pre">jsAddToView</span></code> を呼び出します。（必要であれば何度でも呼び出すことができます）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">jsAddToView</span><span class="p">(</span><span class="s2">&quot;alert(&#39;Hello&#39;)&quot;</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">jsAddToView</span><span class="p">(</span><span class="s2">&quot;alert(&#39;Hello again&#39;)&quot;</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">My</span> <span class="n">view</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>レイアウト内では <code class="docutils literal notranslate"><span class="pre">jsForView</span></code> を呼び出します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;flash&quot;</span><span class="o">&gt;</span><span class="p">{</span><span class="n">jsFlash</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h4>JavaScriptを直接レスポンスする方法<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Javascriptをレスポンスする場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jsRespond</span><span class="p">(</span><span class="s2">&quot;$(&#39;#error&#39;).html(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jsEscape</span><span class="p">(</span><span class="o">&lt;</span><span class="n">p</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="o">&gt;</span><span class="n">Could</span> <span class="ow">not</span> <span class="n">login</span><span class="o">.&lt;/</span><span class="n">p</span><span class="o">&gt;</span><span class="p">)))</span>
</pre></div>
</div>
<p>Javascriptでリダイレクトさせる場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jsRedirectTo</span><span class="p">(</span><span class="s2">&quot;http://cntt.tv/&quot;</span><span class="p">)</span>
<span class="n">jsRedirectTo</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="json">
<h3>JSON<a class="headerlink" href="#json" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは <a class="reference external" href="https://github.com/json4s/json4s">JSON4S</a> を内包しています。
JSONのパースと生成についてはJSON4Sを一読することを推奨します。</p>
<p>ScalaのcaseオブジェクトをJSON文字列に変換する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.SeriDeseri</span>

<span class="n">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">phone</span><span class="p">:</span> <span class="n">Option</span><span class="p">[</span><span class="n">String</span><span class="p">])</span>
<span class="n">val</span> <span class="n">person1</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="s2">&quot;Jack&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">val</span> <span class="n">json</span>    <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toJson</span><span class="p">(</span><span class="n">person</span><span class="p">)</span>
<span class="n">val</span> <span class="n">person2</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromJson</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
</pre></div>
</div>
<p>JSONをレスポンスする場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">scalaData</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="o">//</span> <span class="n">An</span> <span class="n">example</span>
<span class="n">respondJson</span><span class="p">(</span><span class="n">scalaData</span><span class="p">)</span>
</pre></div>
</div>
<p>JSONはネストした構造が必要な設定ファイルを作成する場合に適しています。</p>
<p>参照 <a class="reference internal" href="index.html#document-howto"><span class="doc">設定ファイルの読み込み</span></a></p>
</div>
<div class="section" id="knockout-js">
<h3>Knockout.jsプラグイン<a class="headerlink" href="#knockout-js" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>参照 <a class="reference external" href="https://github.com/xitrum-framework/xitrum-ko">xitrum-ko</a></p>
</div>
</div>
<span id="document-async"></span><div class="section" id="id1">
<h2>非同期レスポンス<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Actionからクライアントへレスポンスを返すには以下のメソッドを使用します</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondView</span></code>: レイアウトファイルを使用または使用せずに、Viewテンプレートファイルを送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondInlineView</span></code>: レイアウトファイルを使用または使用せずに、インライン記述されたテンプレートを送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondText(&quot;hello&quot;)</span></code>: レイアウトファイルを使用せずに文字列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondHtml(&quot;&lt;html&gt;...&lt;/html&gt;&quot;)</span></code>: contentTypeを&quot;text/html&quot;として文字列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJson(List(1,</span> <span class="pre">2,</span> <span class="pre">3))</span></code>: ScalaオブジェクトをJSONに変換し、contentTypeを&quot;application/json&quot;として送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJs(&quot;myFunction([1,</span> <span class="pre">2,</span> <span class="pre">3])&quot;)</span></code> contentTypeを&quot;application/javascript&quot;として文字列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonP(List(1,</span> <span class="pre">2,</span> <span class="pre">3),</span> <span class="pre">&quot;myFunction&quot;)</span></code>: 上記2つの組み合わせをJSONPとして送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;)</span></code>: contentTypeを&quot;application/javascript&quot;として文字列として送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondJsonPText(&quot;[1,</span> <span class="pre">2,</span> <span class="pre">3]&quot;,</span> <span class="pre">&quot;myFunction&quot;)</span></code>: <cite>respondJs</cite> 、 <cite>respondJsonText</cite> の2つの組み合わせをJSONPとして送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondBinary</span></code>: バイト配列を送信します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondFile</span></code>: ディスクからファイルを直接送信します。 <a class="reference external" href="http://www.ibm.com/developerworks/library/j-zerocopy/">zero-copy</a> を使用するため非常に高速です。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondEventSource(&quot;data&quot;,</span> <span class="pre">&quot;event&quot;)</span></code>: チャンクレスポンスを送信します</p></li>
</ul>
<p>Xitrumは自動でデフォルトレスポンスを送信しません。自分で明確に上記の``respondXXX``を呼ばなければなりません。
呼ばなければ、XitrumがそのHTTP接続を保持します。あとで``respondXXX``を読んでもいいです。</p>
<p>接続がopen状態になっているかを確認するには``channel.isOpen``を呼びます。<code class="docutils literal notranslate"><span class="pre">addConnectionClosedListener</span></code>
でコールバックを登録することもできませす。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>addConnectionClosedListener {
  // 切断されました。
  // リソース開放などをする。
}
</pre></div>
</div>
<p>非同期なのでレスポンスはすぐに送信されません。<code class="docutils literal notranslate"><span class="pre">respondXXX</span></code> の戻り値が
<a class="reference external" href="http://netty.io/4.0/api/io/netty/channel/ChannelFuture.html">ChannelFuture</a>
となります。それを使って実際にレスポンスを送信されるコールバックを登録できます。</p>
<p>例えばレスポンスの送信あとに切断するには:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.channel.</span><span class="p">{</span><span class="n">ChannelFuture</span><span class="p">,</span> <span class="n">ChannelFutureListener</span><span class="p">}</span>

<span class="n">val</span> <span class="n">future</span> <span class="o">=</span> <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>
<span class="n">future</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">new</span> <span class="n">ChannelFutureListener</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">operationComplete</span><span class="p">(</span><span class="n">future</span><span class="p">:</span> <span class="n">ChannelFuture</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">future</span><span class="o">.</span><span class="n">getChannel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>より短い例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addListener</span><span class="p">(</span><span class="n">ChannelFutureListener</span><span class="o">.</span><span class="n">CLOSE</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="websocket">
<h3>WebSocket<a class="headerlink" href="#websocket" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import scala.runtime.ScalaRunTime
import xitrum.annotation.WEBSOCKET
import xitrum.{WebSocketAction, WebSocketBinary, WebSocketText, WebSocketPing, WebSocketPong}

@WEBSOCKET(&quot;echo&quot;)
class EchoWebSocketActor extends WebSocketAction {
  def execute() {
    // ここでセッションデータ、リクエストヘッダなどを抽出できますが
    // respondTextやrespondViewなどは使えません。
    // レスポンスするには以下のようにrespondWebSocketXXXを使ってください。

    log.debug(&quot;onOpen&quot;)

    context.become {
      case WebSocketText(text) =&gt;
        log.info(&quot;onTextMessage: &quot; + text)
        respondWebSocketText(text.toUpperCase)

      case WebSocketBinary(bytes) =&gt;
        log.info(&quot;onBinaryMessage: &quot; + ScalaRunTime.stringOf(bytes))
        respondWebSocketBinary(bytes)

      case WebSocketPing =&gt;
        log.debug(&quot;onPing&quot;)

      case WebSocketPong =&gt;
        log.debug(&quot;onPong&quot;)
    }
  }

  override def postStop() {
    log.debug(&quot;onClose&quot;)
    super.postStop()
  }
}
</pre></div>
</div>
<p>リクエストが来る際に上記のアクターインスタンスが生成されます。次のときにアクターが停止されます:</p>
<ul class="simple">
<li><p>コネクションが切断されるとき</p></li>
<li><p>WebSocketのcloseフレームが受信されるまたは送信されるとき</p></li>
</ul>
<p>WebSocketフレームを送信するメソッド:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketText</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketBinary</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketPing</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondWebSocketClose</span></code></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">respondWebSocketPong</span></code> はありません。Xitrumがpingフレームを受信したら自動でpongフレームを
送信するからです。</p>
<p>上記のWebSocketアクションへのURLを取得するには:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Scalateテンプレートファイルなどで</span>
<span class="n">val</span> <span class="n">url</span> <span class="o">=</span> <span class="n">absWebSocketUrl</span><span class="p">[</span><span class="n">EchoWebSocketActor</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="sockjs">
<h3>SockJS<a class="headerlink" href="#sockjs" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://github.com/sockjs/sockjs-client">SockJS</a> とはWebSocketのようなAPIを提供
するJavaScriptライブラリです。WebSocketを対応しないブラウザで使います。SockJSがブラウザがの
WebSocketの機能の存在を確認し、存在しない場合、他の適切な通信プロトコルへフォルバックします。</p>
<p>WebSocket対応ブラウザ関係なくすべてのブラウザでWebSocket APIを使いたい場合、WebSocketを
直接使わないでSockJSを使ったほうがいいです。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="n">var</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SockJS</span><span class="p">(</span><span class="s1">&#39;http://mydomain.com/path_prefix&#39;</span><span class="p">);</span>
  <span class="n">sock</span><span class="o">.</span><span class="n">onopen</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="n">sock</span><span class="o">.</span><span class="n">onmessage</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="n">sock</span><span class="o">.</span><span class="n">onclose</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>XitrumがSockJSライブラリのファイルを含めており、テンプレートなどで以下のように書くだけでいいです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">html</span>
  <span class="n">head</span>
    <span class="o">!=</span> <span class="n">jsDefaults</span>
<span class="o">...</span>
</pre></div>
</div>
<p>SockJSは <a class="reference external" href="https://github.com/sockjs/sockjs-protocol">サーバー側の特別処理</a> が必要ですが、
Xitrumがその処理をやってくれるのです。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import xitrum.{Action, SockJsAction, SockJsText}
import xitrum.annotation.SOCKJS

@SOCKJS(&quot;echo&quot;)
class EchoSockJsActor extends SockJsAction {
  def execute() {
    // ここでセッションデータ、リクエストヘッダなどを抽出できますが
    // respondTextやrespondViewなどは使えません。
    // レスポンスするには以下のようにrespondSockJsXXXを使ってください。

    log.info(&quot;onOpen&quot;)

    context.become {
      case SockJsText(text) =&gt;
        log.info(&quot;onMessage: &quot; + text)
        respondSockJsText(text)
    }
  }

  override def postStop() {
    log.info(&quot;onClose&quot;)
    super.postStop()
  }
}
</pre></div>
</div>
<p>新しいSockJSセッションが生成されるとき上記のアクターインスタンスが生成されます。セッションが
停止されるときにアクターが停止されます。</p>
<p>SockJSフレームを送信するには:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">respondSockJsText</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondSockJsClose</span></code></p></li>
</ul>
<p><a class="reference external" href="https://github.com/sockjs/sockjs-node#various-issues-and-design-considerations">SockJsの注意事項</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>クッキーがSockJsと合わないです。認証を実装するには自分でトークンを生成しSockJsページを埋め込んで、
ブラウザ側からサーバー側へSockJs接続ができたらそのトークンを送信し認証すれば良い。クッキーが
本質的にはそのようなメカニズムで動きます。
</pre></div>
</div>
<p>SockJSクラスタリングを構築するには <a class="reference internal" href="index.html#document-cluster"><span class="doc">Akkaでサーバーをクラスタリングする</span></a>
説明をご覧ください。</p>
</div>
<div class="section" id="chunk">
<h3>Chunkレスポンス<a class="headerlink" href="#chunk" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding">Chunkレスポンス</a> を送信するには:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">setChunked</span></code> を呼ぶ</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">respondXXX</span></code> を呼ぶ（複数回呼んでよい）</p></li>
<li><p>最後に <code class="docutils literal notranslate"><span class="pre">respondLastChunk</span></code> を呼ぶ</p></li>
</ol>
<p>Chunkレスポンスはいろいろな応用があります。例えばメモリがかかる大きなCSVファイルを一括で生成
できない場合、生成しながら送信して良い:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 「Cache-Control」ヘッダが自動で設定されます:
// 「no-store, no-cache, must-revalidate, max-age=0」
//
// 因みに 「Pragma: no-cache」 ヘッダはレスポンスでなくリクエストのためです:
// http://palizine.plynt.com/issues/2008Jul/cache-control-attributes/
setChunked()

val generator = new MyCsvGenerator

generator.onFirstLine { line =&gt;
  val future = respondText(header, &quot;text/csv&quot;)
  future.addListener(new ChannelFutureListener {
    def operationComplete(future: ChannelFuture) {
      if (future.isSuccess) generator.next()
    }
  }
}

generator.onNextLine { line =&gt;
  val future = respondText(line)
  future.addListener(new ChannelFutureListener {
    def operationComplete(future: ChannelFuture) {
      if (future.isSuccess) generator.next()
    }
  })
}

generator.onLastLine { line =&gt;
  val future = respondText(line)
  future.addListener(new ChannelFutureListener {
    def operationComplete(future: ChannelFuture) {
      if (future.isSuccess) respondLastChunk()
    }
  })
}

generator.generate()
</pre></div>
</div>
<p>注意:</p>
<ul class="simple">
<li><p>ヘッダが最初の <code class="docutils literal notranslate"><span class="pre">respondXXX</span></code> で送信されます。</p></li>
<li><p>末尾ヘッダがオプションで <code class="docutils literal notranslate"><span class="pre">respondLastChunk</span></code> に設定できます。</p></li>
<li><p><a class="reference internal" href="index.html#document-cache"><span class="doc">ページとアクションキャッシュ</span></a> はchunkレスポンスとは使えません。</p></li>
</ul>
<p>Chunkレスポンスを <code class="docutils literal notranslate"><span class="pre">ActorAction</span></code> の組み合わせて
<a class="reference external" href="http://www.cubrid.org/blog/dev-platform/faster-web-page-loading-with-facebook-bigpipe/">Facebook BigPipe</a>
が実装できます。</p>
<div class="section" id="iframe">
<h4>無限iframe<a class="headerlink" href="#iframe" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Chunkレスポンスで <a class="reference external" href="http://en.wikipedia.org/wiki/Comet_%28programming%29">Comet</a> を
実装することが
<a class="reference external" href="http://www.shanison.com/2010/05/10/stop-the-browser-%E2%80%9Cthrobber-of-doom%E2%80%9D-while-loading-comet-forever-iframe/">可能</a>
です。</p>
<p>Iframeを含めるページ:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
  <span class="n">var</span> <span class="n">functionForForeverIframeSnippetsToCall</span> <span class="o">=</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">...</span>
<span class="o">&lt;</span><span class="n">iframe</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;1&quot;</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;1&quot;</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;path/to/forever/iframe&quot;</span><span class="o">&gt;&lt;/</span><span class="n">iframe</span><span class="o">&gt;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>無限 <code class="docutils literal notranslate"><span class="pre">&lt;script&gt;</span></code> を生成するアクションで:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// 準備

setChunked()

// Firefox対応
respondText(&quot;&lt;html&gt;&lt;body&gt;123&quot;, &quot;text/html&quot;)

// curlを含む多くのクライアントが&lt;script&gt;をすぐに出しません。
// 2KB仮データで対応。
for (i &lt;- 1 to 100) respondText(&quot;&lt;script&gt;&lt;/script&gt;\n&quot;)
</pre></div>
</div>
<p>そのあと実際データを送信するには:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if (channel.isOpen)
  respondText(&quot;&lt;script&gt;parent.functionForForeverIframeSnippetsToCall()&lt;/script&gt;\n&quot;)
else
  // 切断されました。リソースなどを開放。
  // ``addConnectionClosedListener``を使って良い。
</pre></div>
</div>
</div>
<div class="section" id="event-source">
<h4>Event Source<a class="headerlink" href="#event-source" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>参考: <a class="reference external" href="http://dev.w3.org/html5/eventsource/">http://dev.w3.org/html5/eventsource/</a></p>
<p>Event SourceはデータがUTF-8でchunkレスポンスの一種です。</p>
<p>Event Sourceをレスポンスするには <code class="docutils literal notranslate"><span class="pre">respondEventSource</span></code> を呼んでください（複数回可）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>respondEventSource(&quot;data1&quot;, &quot;event1&quot;)  // イベント名が「event1」となります
respondEventSource(&quot;data2&quot;)            // イベント名がデフォルトで「message」となります
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-static"></span><div class="section" id="id1">
<h2>静的ファイル<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id2">
<h3>ディスク上の静的ファイルの配信<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>プロジェクトディレクトリーレイアウト:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span>
<span class="n">public</span>
  <span class="n">favicon</span><span class="o">.</span><span class="n">ico</span>
  <span class="n">robots</span><span class="o">.</span><span class="n">txt</span>
  <span class="mf">404.</span><span class="n">html</span>
  <span class="mf">500.</span><span class="n">html</span>
  <span class="n">img</span>
    <span class="n">myimage</span><span class="o">.</span><span class="n">png</span>
  <span class="n">css</span>
    <span class="n">mystyle</span><span class="o">.</span><span class="n">css</span>
  <span class="n">js</span>
    <span class="n">myscript</span><span class="o">.</span><span class="n">js</span>
<span class="n">src</span>
<span class="n">build</span><span class="o">.</span><span class="n">sbt</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">public</span></code> ディレクトリ内に配置された静的ファイルはXitrumにより自動的に配信されます。
配信されるファイルのURLは以下のようになります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="n">myimage</span><span class="o">.</span><span class="n">png</span>
<span class="o">/</span><span class="n">css</span><span class="o">/</span><span class="n">mystyle</span><span class="o">.</span><span class="n">css</span>
<span class="o">/</span><span class="n">css</span><span class="o">/</span><span class="n">mystyle</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">css</span>
</pre></div>
</div>
<p>プログラムからそのURLを参照するには以下のように指定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">publicUrl</span><span class="p">(</span><span class="s2">&quot;img/myimage.png&quot;</span><span class="p">)}</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>開発環境で非圧縮ファイルをレスポンスし、本番環境でその圧縮ファイルをレスポンスするには(例: 上記の
mystyle.cssとmystyle.min.css):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">publicUrl</span><span class="p">(</span><span class="s2">&quot;css&quot;</span><span class="p">,</span> <span class="s2">&quot;mystyle.css&quot;</span><span class="p">,</span> <span class="s2">&quot;mystyle.min.css&quot;</span><span class="p">)}</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>ディスク上の静的ファイルをアクションからレスポンスするには <code class="docutils literal notranslate"><span class="pre">respondFile</span></code> を使用します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondFile</span><span class="p">(</span><span class="s2">&quot;/absolute/path&quot;</span><span class="p">)</span>
<span class="n">respondFile</span><span class="p">(</span><span class="s2">&quot;path/relative/to/the/current/working/directory&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>静的ファイルの配信速度を最適化するため、
ファイル存在チェックを正規表現を使用して回避することができます。
リクエストされたURLが <code class="docutils literal notranslate"><span class="pre">pathRegex</span></code> にマッチしない場合、Xitrumはそのリクエストに対して404エラーを返します。</p>
<p>詳しくは <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> の <code class="docutils literal notranslate"><span class="pre">pathRegex</span></code> の設定を参照してください。</p>
</div>
<div class="section" id="index-html">
<h3>index.htmlへのフォールバック<a class="headerlink" href="#index-html" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">/foo/bar</span></code> (または <code class="docutils literal notranslate"><span class="pre">/foo/bar/</span></code> )へのルートが存在しない場合、
Xitrumは <code class="docutils literal notranslate"><span class="pre">public</span></code> ディレクトリ内に、<code class="docutils literal notranslate"><span class="pre">public/foo/bar/index.html</span></code> が存在するかチェックします。
もしindex.htmlファイルが存在した場合、Xitrumはクライアントからのリクエストに対してindex.htmlを返します。</p>
</div>
<div class="section" id="id3">
<h3>404 と 500<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">public</span></code> ディレクトリ内の404.htmlと500.htmlはそれぞれ、
マッチするルートが存在しない場合、リクエスト処理中にエラーが発生した場合に使用されます。
独自のエラーハンドラーを使用する場合、以下の様に記述します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">Error404</span><span class="p">,</span> <span class="n">Error500</span><span class="p">}</span>

<span class="nd">@Error404</span>
<span class="k">class</span> <span class="nc">My404ErrorHandlerAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isAjax</span><span class="p">)</span>
      <span class="n">jsRespond</span><span class="p">(</span><span class="s2">&quot;alert(&quot;</span> <span class="o">+</span> <span class="n">jsEscape</span><span class="p">(</span><span class="s2">&quot;Not Found&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">renderInlineView</span><span class="p">(</span><span class="s2">&quot;Not Found&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Error500</span>
<span class="k">class</span> <span class="nc">My500ErrorHandlerAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isAjax</span><span class="p">)</span>
      <span class="n">jsRespond</span><span class="p">(</span><span class="s2">&quot;alert(&quot;</span> <span class="o">+</span> <span class="n">jsEscape</span><span class="p">(</span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">renderInlineView</span><span class="p">(</span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>HTTPレスポンスステータスは、アノテーションにより自動的に404または500がセットされるため、
あなたのプログラム上でセットする必要はありません。</p>
</div>
<div class="section" id="webjar">
<h3>WebJarによるクラスパス上のリソースファイルの配信<a class="headerlink" href="#webjar" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="webjars">
<h4>WebJars<a class="headerlink" href="#webjars" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="http://www.webjars.org/">WebJars</a> はフロントエンドに関わるのライブラリを多く提供しています。
Xitrumプロジェクトではそれらを依存ライブラリとして利用することができます。</p>
<p>例えば <a class="reference external" href="http://underscorejs.org/">Underscore.js</a> を使用する場合、
プロジェクトの <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> に以下のように記述します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;org.webjars&quot;</span> <span class="o">%</span> <span class="s2">&quot;underscorejs&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.6.0-3&quot;</span>
</pre></div>
</div>
<p>そして.jadeファイルからは以下のように参照します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">webJarsUrl</span><span class="p">(</span><span class="s2">&quot;underscorejs/1.6.0&quot;</span><span class="p">,</span> <span class="s2">&quot;underscore.js&quot;</span><span class="p">,</span> <span class="s2">&quot;underscore-min.js&quot;</span><span class="p">)})</span>
</pre></div>
</div>
<p>開発環境では  <code class="docutils literal notranslate"><span class="pre">underscore.js</span></code> が、 本番環境では　<code class="docutils literal notranslate"><span class="pre">underscore-min.js</span></code> が、
Xitrumによって自動的に選択されます。</p>
<p>コンパイル結果は以下のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/webjars/underscorejs/1.6.0/underscore.js?XOKgP8_KIpqz9yUqZ1aVzw
</pre></div>
</div>
<p>いずれの環境でも同じファイルを使用したい場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">webJarsUrl</span><span class="p">(</span><span class="s2">&quot;underscorejs/1.6.0/underscore.js&quot;</span><span class="p">)})</span>
</pre></div>
</div>
<p>バージョンの競合が発生した場合（<a href="#id5"><span class="problematic" id="id6">``</span></a>sbt xitrumPackage``コマンドを実行して生成されるディレクトリ``target/xitrum/lib``の
中のファイルを見て確認できます）、<a href="#id7"><span class="problematic" id="id8">``</span></a>dependencyOverrides``で正しいバージョンを強制的に指定できます。
例えば、Internet Explorer 6, 7, 8対応のためにjQuery 1.xを指定したい場合：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dependencyOverrides</span> <span class="o">+=</span> <span class="s2">&quot;org.webjars&quot;</span> <span class="o">%</span> <span class="s2">&quot;jquery&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.11.3&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h4>WebJars形式によるリソースの保存<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>もしあなたがライブラリ開発者で、ライブラリ内のmyimage.pngというファイルを配信したい場合、
<a class="reference external" href="http://www.webjars.org/">WebJars</a> 形式で.jarファイルを作成し
クラスパス上に配置します。 .jarは以下の様な形式となります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">META</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">resources</span><span class="o">/</span><span class="n">webjars</span><span class="o">/</span><span class="n">mylib</span><span class="o">/</span><span class="mf">1.0</span><span class="o">/</span><span class="n">myimage</span><span class="o">.</span><span class="n">png</span>
</pre></div>
</div>
<p>プログラムから参照する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="p">{</span><span class="n">webJarsUrl</span><span class="p">(</span><span class="s2">&quot;mylib/1.0/myimage.png&quot;</span><span class="p">)}</span> <span class="o">/&gt;</span>
</pre></div>
</div>
<p>開発環境、本番環境ともに以下のようにコンパイルされます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/webjars/mylib/1.0/myimage.png?xyz123
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h4>クラスパス上の要素をレスポンスする場合<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="http://www.webjars.org/">WebJars</a> 形式で保存されていない
クラスパス上の静的ファイル(.jarファイルやディレクトリ)をレスポンスする場合</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;path/relative/to/the/classpath/element&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;akka/actor/Actor.class&quot;</span><span class="p">)</span>
<span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;META-INF/resources/webjars/underscorejs/1.6.0/underscore.js&quot;</span><span class="p">)</span>
<span class="n">respondResource</span><span class="p">(</span><span class="s2">&quot;META-INF/resources/webjars/underscorejs/1.6.0/underscore-min.js&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="etagmax-age">
<h3>ETagとmax-ageによるクライアントサイドキャッシュ<a class="headerlink" href="#etagmax-age" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ディスクとクラスパス上にある静的ファイルに対して、Xitrumは自動的に <a class="reference external" href="http://ja.wikipedia.org/wiki/HTTP_ETag">Etag</a> を付加します。</p>
<p>小さなファイルはMD5化してキャッシュされます。
キャッシュエントリーのキーには <code class="docutils literal notranslate"><span class="pre">(ファイルパス,</span> <span class="pre">更新日時)</span></code> が使用されます。
ファイルの変更時刻はサーバによって異なる可能性があるため
クラスタ上の各サーバはそれぞれETagキャッシュを保持することになります。</p>
<p>大きなファイルに対しては、更新日時のみがETagに使用されます。
これはサーバ間で異なるETagを保持してしまう可能性があるため完全ではありませんが、
ETagを全く使用しないよりはいくらかマシといえます。</p>
<p><code class="docutils literal notranslate"><span class="pre">publicUrl</span></code> と <code class="docutils literal notranslate"><span class="pre">resourceUrl</span></code> メソッドは自動的にETagをURLに付加します。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>resourceUrl(&quot;xitrum/jquery-1.6.4.js&quot;)
=&gt; /resources/public/xitrum/jquery-1.6.4.js?xndGJVH0zA8q8ZJJe1Dz9Q
</pre></div>
</div>
<p>またXitrumは、<code class="docutils literal notranslate"><span class="pre">max-age</span></code> と <code class="docutils literal notranslate"><span class="pre">Expires</span></code> を <a class="reference external" href="https://developers.google.com/speed/docs/best-practices/caching">一年</a> としてヘッダに設定します。.
ブラウザが最新ファイルを参照しなくなるのではないかと心配する必要はありません。
なぜなら、あなたがディスク上のファイルを変更した場合、その <code class="docutils literal notranslate"><span class="pre">更新時刻</span></code> は変化します。
これによって、<code class="docutils literal notranslate"><span class="pre">publicUrl</span></code> と <code class="docutils literal notranslate"><span class="pre">resourceUrl</span></code> が生成するURLも変わります。
ETagキャッシュもまた、キーが変わったため更新される事になります。</p>
</div>
<div class="section" id="gzip">
<h3>GZIP<a class="headerlink" href="#gzip" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ヘッダーの <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> 属性を元にレスポンスがテキストかどうかを判定し、
<code class="docutils literal notranslate"><span class="pre">text/html</span></code>, <code class="docutils literal notranslate"><span class="pre">xml/application</span></code> などテキスト形式のレスポンスの場合、Xitrumは自動でgzip圧縮を適用します。</p>
<p>静的なテキストファイルは常にgzipの対象となりますが、動的に生成されたテキストコンテンツに対しては、
パフォーマンス最適化のため1KB以下のものはgzipの対象となりません。</p>
</div>
<div class="section" id="id14">
<h3>サーバーサイドキャッシュ<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ディスクからのファイル読み込みを避けるため、Xitrumは小さな静的ファイルは（テキストファイル以外も）、
LRU(Least Recently Used)キャッシュとしてメモリ上に保持します。</p>
<p>詳しくは <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> の <code class="docutils literal notranslate"><span class="pre">small_static_file_size_in_kb</span></code> と <code class="docutils literal notranslate"><span class="pre">max_cached_small_static_files</span></code> の設定を参照してください。</p>
</div>
</div>
<span id="document-flash"></span><div class="section" id="flash">
<h2>Flashのソケットポリシーファイル<a class="headerlink" href="#flash" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Flashのソケットポリシーファイルについて:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.adobe.com/devnet/flashplayer/articles/socket_policy_files.html">http://www.adobe.com/devnet/flashplayer/articles/socket_policy_files.html</a></p></li>
<li><p><a class="reference external" href="http://www.lightsphere.com/dev/articles/flash_socket_policy.html">http://www.lightsphere.com/dev/articles/flash_socket_policy.html</a></p></li>
</ul>
<p>FlashのソケットポリシーファイルのプロトコルはHTTPと異なります。</p>
<p>XitrumからFlashのソケットポリシーファイルを返信するには:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/flash_socket_policy.xml">config/flash_socket_policy.xml</a>
を修正します。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a>
を修正し上記ファイルの返信を有効にします。</p></li>
</ol>
</div>
<span id="document-scopes"></span><div class="section" id="id1">
<h2>スコープ<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id2">
<h3>リクエストスコープ<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="id3">
<h4>リクエストパラメーター<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>リクエストパラメーターには2種類あります:</p>
<ol class="arabic simple">
<li><p>テキストパラメータ</p></li>
<li><p>ファイルアップロードパラメーター（バイナリー）</p></li>
</ol>
<p>テキストパラメーターは <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Seq[String]]</span></code> の型をとる3種類があります:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">queryParams</span></code>: URL内の?以降で指定されたパラメーター  例: <code class="docutils literal notranslate"><span class="pre">http://example.com/blah?x=1&amp;y=2</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bodyTextParams</span></code>: POSTリクエストのbodyで指定されたパラメーター</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathParams</span></code>: URL内に含まれるパラメーター  例: <code class="docutils literal notranslate"><span class="pre">GET(&quot;articles/:id/:title&quot;)</span></code></p></li>
</ol>
<p>これらのパラメーターは上記の順番で、 <code class="docutils literal notranslate"><span class="pre">textParams</span></code> としてマージされます。
（後からマージされるパラメーターは上書きとなります。）</p>
<p><code class="docutils literal notranslate"><span class="pre">bodyFileParams</span></code> は <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Seq[</span></code> <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/multipart/FileUpload.html">FileUpload</a> <code class="docutils literal notranslate"><span class="pre">]]</span></code> の型をとります。</p>
</div>
<div class="section" id="id4">
<h4>パラメーターへのアクセス<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>アクションからは直接、またはアクセサメソッドを使用して上記のパラメーターを取得することができます。</p>
<p><code class="docutils literal notranslate"><span class="pre">textParams</span></code> にアクセスする場合:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">param(&quot;x&quot;)</span></code>: <code class="docutils literal notranslate"><span class="pre">String</span></code> を返却します。xが存在しないエクセプションがスローされます。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paramo(&quot;x&quot;)</span></code>: <code class="docutils literal notranslate"><span class="pre">Option[String]</span></code> を返却します。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params(&quot;x&quot;)</span></code>: <code class="docutils literal notranslate"><span class="pre">Seq[String]</span></code> を返却します。 xが存在しない場合``Seq.empty``を返却します。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">param[Int](&quot;x&quot;)</span></code> や <code class="docutils literal notranslate"><span class="pre">params[Int](&quot;x&quot;)</span></code> と型を指定することでテキストパラメーターを別の型として取得することができます。
テキストパラメーターを独自の型に変換する場合、 <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala-2.11/xitrum/scope/request/ParamAccess.scala">convertTextParam</a> をオーバーライドすることで可能となります。</p>
<p>ファイルアップロードに対しては、<code class="docutils literal notranslate"><span class="pre">param[FileUpload](&quot;x&quot;)</span></code> や <code class="docutils literal notranslate"><span class="pre">params[FileUpload](&quot;x&quot;)</span></code> でアクセスすることができます。
詳しくは <a class="reference internal" href="index.html#document-upload"><span class="doc">ファイルアップロードの章</span></a> を参照してください。</p>
</div>
<div class="section" id="at">
<h4>&quot;at&quot;<a class="headerlink" href="#at" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>リクエストの処理中にパラメーターを受け渡し(例えばアクションからViewやレイアウトファイルへ）を行う場合、
<code class="docutils literal notranslate"><span class="pre">at</span></code> を使用することで実現できます。 <code class="docutils literal notranslate"><span class="pre">at</span></code> は <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.HashMap[String,</span> <span class="pre">Any]</span></code> の型となります。
<code class="docutils literal notranslate"><span class="pre">at</span></code> はRailsにおける <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> と同じ役割を果たします。</p>
<p>Articles.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>  <span class="o">//</span> <span class="n">Get</span> <span class="kn">from</span> <span class="nn">DB</span>
    <span class="n">at</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>AppAction.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">))</span> <span class="s2">&quot;My Site - &quot;</span> <span class="o">+</span> <span class="n">at</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;My Site&quot;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="atjson">
<h4>&quot;atJson&quot;<a class="headerlink" href="#atjson" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">atJson</span></code> は <code class="docutils literal notranslate"><span class="pre">at(&quot;key&quot;)</span></code> を自動的にJSONに変換するヘルパーメソッドです。
ScalaからJavascriptへのモデルの受け渡しに役立ちます。</p>
<p><code class="docutils literal notranslate"><span class="pre">atJson(&quot;key&quot;)</span></code> は <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.toJson(at(&quot;key&quot;))</span></code> と同等です。</p>
<p>Action.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">case</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">login</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">at</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;Admin&quot;</span><span class="p">)</span>
  <span class="n">respondView</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Action.ssp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;script type=&quot;text/javascript&quot;&gt;
  var user = ${atJson(&quot;user&quot;)};
  alert(user.login);
  alert(user.name);
&lt;/script&gt;
</pre></div>
</div>
</div>
<div class="section" id="requestvar">
<h4>RequestVar<a class="headerlink" href="#requestvar" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>前述の <code class="docutils literal notranslate"><span class="pre">at</span></code> はどのような値もmapとして保存できるため型安全ではありません。
より型安全な実装を行うには、 <code class="docutils literal notranslate"><span class="pre">at</span></code> のラッパーである <code class="docutils literal notranslate"><span class="pre">RequestVar</span></code> を使用します。</p>
<p>RVar.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.RequestVar</span>

<span class="nb">object</span> <span class="n">RVar</span> <span class="p">{</span>
  <span class="nb">object</span> <span class="n">title</span> <span class="n">extends</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Articles.scala:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>  <span class="o">//</span> <span class="n">Get</span> <span class="kn">from</span> <span class="nn">DB</span>
    <span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">isDefined</span><span class="p">)</span> <span class="s2">&quot;My Site - &quot;</span> <span class="o">+</span> <span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">get</span> <span class="k">else</span> <span class="s2">&quot;My Site&quot;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>クッキー<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>クッキーの仕組みについては <a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_cookie">Wikipedia</a> を参照してください。</p>
<p>アクション内では <code class="docutils literal notranslate"><span class="pre">requestCookies</span></code> を使用することで、ブラウザから送信されたクッキーを <code class="docutils literal notranslate"><span class="pre">Map[String,</span> <span class="pre">String]</span></code> として取得できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requestCookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myCookie&quot;</span><span class="p">)</span> <span class="n">match</span> <span class="p">{</span>
  <span class="n">case</span> <span class="kc">None</span>         <span class="o">=&gt;</span> <span class="o">...</span>
  <span class="n">case</span> <span class="n">Some</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ブラウザにクッキーを送信するには、<a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/DefaultCookie.html">DefaultCookie</a> インスタンスを生成し、<a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/Cookie.html">Cookie</a> を含む <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> である、 <code class="docutils literal notranslate"><span class="pre">responseCookies</span></code> にアペンドします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultCookie</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="n">cookie</span><span class="o">.</span><span class="n">setHttpOnly</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>  <span class="o">//</span> <span class="n">true</span><span class="p">:</span> <span class="n">JavaScript</span> <span class="n">cannot</span> <span class="n">access</span> <span class="n">this</span> <span class="n">cookie</span>
<span class="n">responseCookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cookie.setPath(cookiePath)</span></code> でパスをセットせずにクッキーを使用した場合、
クッキーのパスはサイトルート(<code class="docutils literal notranslate"><span class="pre">xitrum.Config.withBaseUrl(&quot;/&quot;)</span></code>)が設定されます。</p>
<p>ブラウザから送信されたクッキーを削除するには、&quot;max-age&quot;を0にセットした同じ名前のクッキーをサーバーから送信することで、
ブラウザは直ちにクッキーを消去します。</p>
<p>ブラウザがウィンドウを閉じた際にクッキーが消去されるようにするには、&quot;max-age&quot;に <code class="docutils literal notranslate"><span class="pre">Long.MinValue</span></code> をセットします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cookie</span><span class="o">.</span><span class="n">setMaxAge</span><span class="p">(</span><span class="n">Long</span><span class="o">.</span><span class="n">MinValue</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference external" href="http://mrcoles.com/blog/cookies-max-age-vs-expires/">Internet Explorer は &quot;max-age&quot; をサポートしていません</a> 。
しかし、Nettyが適切に判断して &quot;max-age&quot; または &quot;expires&quot; を設定してくれるので心配する必要はありません！</p>
<p>ブラウザはクッキーの属性をサーバーに送信することはありません。
ブラウザは <a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_cookie#Cookie_attributes">name-value pairs</a> のみを送信します。</p>
<p>署名付きクッキーを使用して、クッキーの改ざんを防ぐには、
<code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.toSecureUrlSafeBase64</span></code> と <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.fromSecureUrlSafeBase64</span></code> を使用します。
詳しくは <a class="reference internal" href="index.html#document-howto"><span class="doc">データの暗号化</span></a> を参照してください。</p>
<div class="section" id="id6">
<h4>クッキーに使用可能な文字<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>クッキーには <a class="reference external" href="http://stackoverflow.com/questions/1969232/allowed-characters-in-cookies">任意の文字</a> を使用することができます。
例えば、UTF-8の文字として使用する場合、UTF-8にエンコードする必要があります。
エンコーディング処理には <code class="docutils literal notranslate"><span class="pre">xitrum.utill.UrlSafeBase64</span></code> または <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri</span></code> を使用することができます。</p>
<p>クッキー書き込みの例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span>
<span class="kn">import</span> <span class="nn">xitrum.util.UrlSafeBase64</span>

<span class="n">val</span> <span class="n">value</span>   <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{&quot;identity&quot;:&quot;example@gmail.com&quot;,&quot;first_name&quot;:&quot;Alexander&quot;}&quot;&quot;&quot;</span>
<span class="n">val</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">noPaddingEncode</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="n">UTF_8</span><span class="p">))</span>
<span class="n">val</span> <span class="n">cookie</span>  <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultCookie</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span>
<span class="n">responseCookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</pre></div>
</div>
<p>クッキー読み込みの例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requestCookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">foreach</span> <span class="p">{</span> <span class="n">encoded</span> <span class="o">=&gt;</span>
  <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">autoPaddingDecode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span><span class="o">.</span><span class="n">foreach</span> <span class="p">{</span> <span class="nb">bytes</span> <span class="o">=&gt;</span>
    <span class="n">val</span> <span class="n">value</span> <span class="o">=</span> <span class="n">new</span> <span class="n">String</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">CharsetUtil</span><span class="o">.</span><span class="n">UTF_8</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="s2">&quot;profile: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h3>セッション<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>セッションの保存、破棄、暗号化などはXitrumが自動的に行いますので、頭を悩ます必要はありません。</p>
<p>アクション内で、 <code class="docutils literal notranslate"><span class="pre">session</span></code> を使用することができます。 セッションは <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Any]</span></code> のインスタンスです。 <code class="docutils literal notranslate"><span class="pre">session</span></code> に保存されるものはシリアライズ可能である必要があります。</p>
<p>ログインユーザーに対してユーザー名をセッションに保存する例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">userId</span>
</pre></div>
</div>
<p>ユーザーがログインしているかどうかを判定するには、
セッションにユーザーネームが保存されているかをチェックするだけですみます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">))</span> <span class="n">println</span><span class="p">(</span><span class="s2">&quot;This user has logged in&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>ユーザーIDをセッションに保存し、アクセス毎にデータベースからユーザー情報を取得するやり方は多くの場合推奨されます。
アクセス毎にユーザーが更新(権限や認証を含む)されているかを知ることができます。</p>
<div class="section" id="session-clear">
<h4>session.clear()<a class="headerlink" href="#session-clear" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>1行のコードで <a class="reference external" href="http://guides.rubyonrails.org/security.html#session-fixation">session fixation</a> の脅威からアプリケーションを守ることができます。</p>
<p>session fixation については上記のリンクを参照してください。session fixation攻撃を防ぐには、
ユーザーログインを行うアクションにて、 <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code> を呼び出します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="o">//</span> <span class="n">Reset</span> <span class="n">first</span> <span class="n">before</span> <span class="n">doing</span> <span class="n">anything</span> <span class="k">else</span> <span class="k">with</span> <span class="n">the</span> <span class="n">session</span>
    <span class="n">session</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">userId</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ログアウト処理においても同様に <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code> を呼び出しましょう。</p>
</div>
<div class="section" id="sessionvar">
<h4>SessionVar<a class="headerlink" href="#sessionvar" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">RequestVar</span></code> と同じく、より型安全な実装を提供します。
例では、ログイン後にユーザー名をセッションに保存します。</p>
<p>SessionVarの定義:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.SessionVar</span>

<span class="nb">object</span> <span class="n">SVar</span> <span class="p">{</span>
  <span class="nb">object</span> <span class="n">username</span> <span class="n">extends</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ログイン処理成功後:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>ユーザー名の表示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">isDefined</span><span class="p">)</span>
  <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">{</span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">get</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span>
<span class="k">else</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>SessionVarの削除方法: <code class="docutils literal notranslate"><span class="pre">SVar.username.remove()</span></code></p></li>
<li><p>セッション全体のクリア方法: <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code></p></li>
</ul>
</div>
<div class="section" id="id9">
<h4>セッションストア<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Xitrumはセッションストアを3種類提供しています。
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a> において、セッションストアを設定することができます。</p>
<p>CookieSessionStore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Store sessions on client side</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">xitrum</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">CookieSessionStore</span>
</pre></div>
</div>
<p>LruSessionStore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple in-memory server side session store</span>
<span class="n">store</span> <span class="p">{</span>
  <span class="s2">&quot;xitrum.local.LruSessionStore&quot;</span> <span class="p">{</span>
    <span class="n">maxElems</span> <span class="o">=</span> <span class="mi">10000</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>クラスター環境で複数のサーバーを起動する場合、<a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">Hazelcast</a> をクラスタ間で共有するセッションストアとして使用することができます。</p>
<p>CookieSessionStore やHazelcastを使用する場合、セッションに保存するデータはシリアライズ可能である必要があります。
シリアライズできないデータを保存しなければいけない場合、 LruSessionStore を使用してください。
LruSessionStore を使用して、クラスタ環境で複数のサーバーを起動する場合、
スティッキーセッションをサポートしたロードバランサーを使用する必要があります。</p>
<p>一般的に、上記のデフォルトセッションストアのいずれかで事足りることですが、
もし特殊なセッションストアを独自に実装する場合
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/scope/session/SessionStore.scala">SessionStore</a>
または
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/scope/session/ServerSessionStore.scala">ServerSessionStore</a>
を継承し、抽象メソッドを実装してください。</p>
<p>設定ファイルには、使用するセッションストアに応じて以下のように設定できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">StoreClassName</span>
</pre></div>
</div>
<p>または:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="p">{</span>
  <span class="s2">&quot;my.session.StoreClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>スケーラブルにする場合、できるだけセッションはクライアントサイドのクッキーに保存しましょう
（リアライズ可能かつ`4KB以下 &lt;<a class="reference external" href="http://stackoverflow.com/questions/640938/what-is-the-maximum-size-of-a-web-browsers-cookies-key">http://stackoverflow.com/questions/640938/what-is-the-maximum-size-of-a-web-browsers-cookies-key</a>&gt;`_）。
サーバーサイド（メモリ上やDB）には必要なときだけセッションを保存しましょう。</p>
<p>参考（英語）:
<a class="reference external" href="http://www.technicalinfo.net/papers/WebBasedSessionManagement.html">Web Based Session Management - Best practices in managing HTTP-based client sessions</a>.</p>
</div>
</div>
<div class="section" id="object-vs-val">
<h3>object vs. val<a class="headerlink" href="#object-vs-val" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">val</span></code> の代わりに <code class="docutils literal notranslate"><span class="pre">object</span></code> を使用してください。</p>
<p><strong>以下のような実装は推奨されません</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">object</span> <span class="n">RVar</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">title</span>    <span class="o">=</span> <span class="n">new</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
  <span class="n">val</span> <span class="n">category</span> <span class="o">=</span> <span class="n">new</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">object</span> <span class="n">SVar</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">username</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
  <span class="n">val</span> <span class="n">isAdmin</span>  <span class="o">=</span> <span class="n">new</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">Boolean</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>上記のコードはコンパイルには成功しますが、正しく動作しません。
なぜなら valは内部ではルックアップ時にクラス名が使用されます。
<code class="docutils literal notranslate"><span class="pre">title</span></code> と <code class="docutils literal notranslate"><span class="pre">category</span></code> が <code class="docutils literal notranslate"><span class="pre">val</span></code> を使用して宣言された場合、いずれもクラス名は &quot;xitrum.RequestVar&quot; となります。
同じことは <code class="docutils literal notranslate"><span class="pre">username</span></code> と <code class="docutils literal notranslate"><span class="pre">isAdmin</span></code> にも当てはまります。</p>
</div>
</div>
<span id="document-validation"></span><div class="section" id="id1">
<h2>バリデーション<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Xitrumは、クライアントサイドでのバリデーション用に <a class="reference external" href="http://bassistance.de/jquery-plugins/jquery-plugin-validation/">jQuery Validation plugin</a> を内包し、サーバーサイドにおけるバリデーション用のいくつかのヘルパーを提供します。</p>
<div class="section" id="id2">
<h3>デフォルトバリデーター<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">xitrum.validator</span></code> パッケージには以下の3つのメソッドが含まれます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">check</span><span class="p">(</span><span class="n">value</span><span class="p">):</span> <span class="n">Boolean</span>
<span class="n">message</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span> <span class="n">Option</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="n">exception</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>もしバリデーション結果が <code class="docutils literal notranslate"><span class="pre">false</span></code> である場合、
<code class="docutils literal notranslate"><span class="pre">message</span></code> は <code class="docutils literal notranslate"><span class="pre">Some(error,</span> <span class="pre">message)</span></code> を返却します。
<code class="docutils literal notranslate"><span class="pre">exception</span></code> メソッドは <code class="docutils literal notranslate"><span class="pre">xitrum.exception.InvalidInput(error</span> <span class="pre">message)</span></code> をスローします。</p>
<p>バリデーターは何処ででも使用することができます。</p>
<p>Actionで使用する例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.validator.Required</span>

<span class="nd">@POST</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CreateArticle</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">title</span> <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;tite&quot;</span><span class="p">)</span>
    <span class="n">val</span> <span class="n">body</span>  <span class="o">=</span> <span class="n">param</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
    <span class="n">Required</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Title&quot;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">Required</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Body&quot;</span><span class="p">,</span>  <span class="n">body</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Do</span> <span class="k">with</span> <span class="n">the</span> <span class="n">valid</span> <span class="n">title</span> <span class="ow">and</span> <span class="n">body</span><span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">try</span></code> 、 <code class="docutils literal notranslate"><span class="pre">catch</span></code> ブロックを使用しない場合において、バリデーションエラーとなると、
xitrumは自動でエラーをキャッチし、クライアントに対してエラーメッセージを送信します。
これはクライアントサイドでバリデーションを正しく書いている場合や、webAPIを作成する場合において便利なやり方と言えます。</p>
<p>Modelで使用する例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.validator.Required</span>

<span class="n">case</span> <span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">Int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="n">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">String</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">isValid</span>           <span class="o">=</span> <span class="n">Required</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>   <span class="o">&amp;&amp;</span>     <span class="n">Required</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">validationMessage</span> <span class="o">=</span> <span class="n">Required</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="n">orElse</span> <span class="n">Required</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>デフォルトバリデーターの一覧については　<a class="reference external" href="https://github.com/xitrum-framework/xitrum/tree/master/src/main/scala/xitrum/validator">xitrum.validator パッケージ</a> を参照してください。</p>
</div>
<div class="section" id="id3">
<h3>カスタムバリデーターの作成<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/validator/Validator.scala">xitrum.validator.Validator</a> を継承し、
<code class="docutils literal notranslate"><span class="pre">check</span></code> メソッドと、 <code class="docutils literal notranslate"><span class="pre">message</span></code> メソッドのみ実装することでカスタムバリデーターとして使用できます。</p>
<p>また、 <a class="reference external" href="http://commons.apache.org/proper/commons-validator/">Commons Validator</a> を使用することもできます。</p>
</div>
</div>
<span id="document-upload"></span><div class="section" id="id1">
<h2>ファイルアップロード<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="index.html#document-scopes"><span class="doc">スコープ</span></a> についてもご覧ください。</p>
<p>ファイルアップロードformで <code class="docutils literal notranslate"><span class="pre">enctype</span></code> を <code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code> に設定します。</p>
<p>MyUpload.scalate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">form</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;post&quot;</span> <span class="n">action</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">MyUpload</span><span class="p">]}</span> <span class="n">enctype</span><span class="o">=</span><span class="s2">&quot;multipart/form-data&quot;</span><span class="p">)</span>
  <span class="o">!=</span> <span class="n">antiCsrfInput</span>

  <span class="n">label</span> <span class="n">ファイルを選択してください</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;file&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;myFile&quot;</span><span class="p">)</span>

  <span class="n">button</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="p">)</span> <span class="n">アップロード</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MyUpload</span></code> アクション:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.multipart.FileUpload</span>

<span class="n">val</span> <span class="n">myFile</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">FileUpload</span><span class="p">](</span><span class="s2">&quot;myFile&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">myFile</span></code> が <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/multipart/FileUpload.html">FileUpload</a>
のインスタンスとなります。そのメソッドを使ってファイル名の取得やファイル移動などができます。</p>
<p>小さいファイル (16KB未満)はメモリへ保存されます。大きいファイルはシステムのテンポラリ・ディレクトリ
または xitrum.conf の <code class="docutils literal notranslate"><span class="pre">xitrum.request.tmpUploadDir</span></code> に設定したディレクトリへ一時的に保存されます。
一時ファイルはコネクション切断やレスポンス送信のあとに削除されます。</p>
<div class="section" id="ajax">
<h3>Ajax風ファイルアップロード<a class="headerlink" href="#ajax" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>世の中にはAjax風ファイルアップロードJavaScriptライブラリがいっぱいあります。その動作としては
隠しiframeやFlashなどで上記の <code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code> をサーバー側へ送ります。
ファイルが具体的にどんなパラメータで送信されるかはXitrumアクセスログで確認できます。</p>
</div>
</div>
<span id="document-filter"></span><div class="section" id="id1">
<h2>アクションフィルター<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="before">
<h3>Beforeフィルター<a class="headerlink" href="#before" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Beforeフィルターが関数でアクションの実行前に実行されます。</p>
<ul class="simple">
<li><p>入力: なし</p></li>
<li><p>出力: true/false</p></li>
</ul>
<p>Beforeフィルターを複数設定できます。その中、ーつのbeforeフィルターが何かrespondするとき、その
フィルターの後ろのフィルターとアクションの実行が中止されます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;before_filter&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">beforeFilter</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;我行くゆえに我あり&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="o">//</span> <span class="n">This</span> <span class="n">method</span> <span class="ow">is</span> <span class="n">run</span> <span class="n">after</span> <span class="n">the</span> <span class="n">above</span> <span class="n">filters</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="s2">&quot;Beforeフィルターが実行されました。ログを確認してください。&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="after">
<h3>Afterフィルター<a class="headerlink" href="#after" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Afterフィルターが関数でアクションの実行後に実行されます。</p>
<ul class="simple">
<li><p>入力: なし</p></li>
<li><p>出力: 無視されます</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;after_filter&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">afterFilter</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;実行時刻: &quot;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Afterフィルターが実行されました。ログを確認してください。&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="around">
<h3>Aroundフィルター<a class="headerlink" href="#around" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;around_filter&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">aroundFilter</span> <span class="p">{</span> <span class="n">action</span> <span class="o">=&gt;</span>
    <span class="n">val</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
    <span class="n">action</span><span class="p">()</span>
    <span class="n">val</span> <span class="n">end</span>   <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
    <span class="n">val</span> <span class="n">dt</span>    <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="s2">&quot;アクション実行時間: $dt [ms]&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">respondText</span><span class="p">(</span><span class="s2">&quot;Around filter should have been run, please check the log&quot;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Aroundフィルターが複数あるとき、それらは外・内の構成でネストされます。</p>
</div>
<div class="section" id="id2">
<h3>フィルターの実行順番<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>Beforeフィルター -&gt; aroundフィルター -&gt; afterフィルター。</p></li>
<li><p>あるbeforeフィルタがfalseを返すと、残りフィルターが実行されません。</p></li>
<li><p>Aroundフィルターが実行されると、すべてのafterフィルター実行されます。</p></li>
<li><p>外のaround filterフィルターが <code class="docutils literal notranslate"><span class="pre">action</span></code> 引数を呼ばないと、内のaroundフィルターが実行されません。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">before1</span> <span class="o">-</span><span class="n">true</span><span class="o">-&gt;</span> <span class="n">before2</span> <span class="o">-</span><span class="n">true</span><span class="o">-&gt;</span> <span class="o">+--------------------+</span> <span class="o">--&gt;</span> <span class="n">after1</span> <span class="o">--&gt;</span> <span class="n">after2</span>
                                <span class="o">|</span> <span class="n">around1</span> <span class="p">(</span><span class="mi">1</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">|</span>
                                <span class="o">|</span>   <span class="n">around2</span> <span class="p">(</span><span class="mi">1</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
                                <span class="o">|</span>     <span class="n">action</span>         <span class="o">|</span>
                                <span class="o">|</span>   <span class="n">around2</span> <span class="p">(</span><span class="mi">2</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
                                <span class="o">|</span> <span class="n">around1</span> <span class="p">(</span><span class="mi">2</span> <span class="n">of</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">|</span>
                                <span class="o">+--------------------+</span>
</pre></div>
</div>
</div>
</div>
<span id="document-cache"></span><div class="section" id="id1">
<h2>サーバーサイドキャッシュ<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><a class="reference internal" href="index.html#document-cluster"><span class="doc">クラスタリング</span></a> の章についても参照してください。</p>
<p>より高速なレスポンスの実現のために、Xitrumはクライアントサイドとサーバーサイドにおける広範なキャッシュ機能を提供します。</p>
<p>サーバーサイドレイヤーでは、小さなファイルはメモリ上にキャッシュされ、大きなファイルはNIOのゼロコピーを使用して送信されます。
Xitrumの静的ファイルの配信速度は <a class="reference external" href="https://gist.github.com/3293596">Nginxと同等</a> です。</p>
<p>Webフレームワークのレイヤーでは、Railsのスタイルでページやアクション、オブジェクトをキャッシュすることができます。</p>
<p><a class="reference external" href="http://code.google.com/speed/page-speed/docs/rules_intro.html">All Google's best practices（英語）</a>
にあるように、条件付きGETリクエストはクライアントサイドでキャッシュされます。</p>
<p>動的なコンテンツに対しては、もしファイルが作成されてから変更されない場合、クライアントに積極的にキャッシュするように
ヘッダーをセットする必要があります。
このケースでは、<code class="docutils literal notranslate"><span class="pre">setClientCacheAggressively()</span></code> をアクションにて呼び出すことで実現できます。</p>
<p>クライアントにキャッシュさせたくない場合もあるでしょう、
そういったケースでは、 <code class="docutils literal notranslate"><span class="pre">setNoClientCache()</span></code> をアクションにて呼び出すことで実現できます。</p>
<p>サーバーサイドキャッシュについては以下のサンプルでより詳しく説明します。</p>
<div class="section" id="id2">
<h3>ページまたはアクションのキャッシュ<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.</span><span class="p">{</span><span class="n">GET</span><span class="p">,</span> <span class="n">CacheActionMinute</span><span class="p">,</span> <span class="n">CachePageMinute</span><span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles&quot;</span><span class="p">)</span>
<span class="nd">@CachePageMinute</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesIndex</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="nd">@CacheActionMinute</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>&quot;page cache&quot; と &quot;acation cache&quot; の期間設定は <a class="reference external" href="http://guides.rubyonrails.org/caching_with_rails.html">Ruby on Rails</a> を参考にしています。</p>
<p>リクエスト処理プロセスの順番は以下のようになります。</p>
<ol class="arabic simple">
<li><p>リクエスト -&gt; (2) Beforeフィルター -&gt; (3) アクション execute method -&gt; (4) レスポンス</p></li>
</ol>
<p>初回のリクエスト時に、Xitrumはレスポンスを指定された期間だけキャッシュします。
<code class="docutils literal notranslate"><span class="pre">&#64;CachePageMinute(1)</span></code> や <code class="docutils literal notranslate"><span class="pre">&#64;CacheActionMinute(1)</span></code> は1分間キャッシュすることを意味します。
Xitrumはレスポンスステータスが &quot;200 OK&quot; の場合のみキャッシュします。
そのため、レスポンスステータスが &quot;500 Internal Server Error&quot; や &quot;302 Found&quot; (リダイレクト) となるレスポンスはキャッシュされせん。</p>
<p>同じアクションに対する2回目以降のリクエストは、もし、キャッシュされたレスポンスが有効期間内の場合、
Xitrumはすぐにキャッシュされたレスポンスを返却します:</p>
<ul class="simple">
<li><p>ページキャッシュの場合、 処理プロセスは、　(1) -&gt; (4) となります。</p></li>
<li><p>アクションキャッシュの場合、 (1) -&gt; (2) -&gt; (4), またはBeforeフィルターが&quot;false&quot;を返した場合 (1) -&gt; (2) となります。</p></li>
</ul>
<p>すなわち、actionキャッシュとpageキャッシュとの違いは、Beforeフィルターを実施するか否かになります。</p>
<p>一般に、ページキャッシュは全てのユーザーに共通なレスポンスの場合に使用します。
アクションキャッシュは、Beforeフィルターを通じて、例えばユーザーのログイン状態チェックなどを行い、キャッシュされたレスポンスを &quot;ガード&quot; する場合に用います:</p>
<ul class="simple">
<li><p>ログインしている場合、キャッシュされたレスポンスにアクセス可能。</p></li>
<li><p>ログインしていない場合、ログインページヘリダイレクト。</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>オブジェクトのキャッシュ<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="http://xitrum-framework.github.io/api/3.17/index.html#xitrum.Cache">xitrum.Cache</a> のインスタンスである、
<code class="docutils literal notranslate"><span class="pre">xitrum.Config.xitrum.cache</span></code> を使用することができます。</p>
<p>明示的な有効期限を設定しない場合:</p>
<ul class="simple">
<li><p>put(key, value)</p></li>
</ul>
<p>有効期限を設定する場合:</p>
<ul class="simple">
<li><p>putSecond(key, value, seconds)</p></li>
<li><p>putMinute(key, value, minutes)</p></li>
<li><p>putHour(key, value, hours)</p></li>
<li><p>putDay(key, value, days)</p></li>
</ul>
<p>存在しない場合のみキャッシュする方法:</p>
<ul class="simple">
<li><p>putIfAbsent(key, value)</p></li>
<li><p>putIfAbsentSecond(key, value, seconds)</p></li>
<li><p>putIfAbsentMinute(key, value, minutes)</p></li>
<li><p>putIfAbsentHour(key, value, hours)</p></li>
<li><p>putIfAbsentDay(key, value, days)</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>キャッシュの削除<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ページまたはアクションキャッシュの削除:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">removeAction</span><span class="p">[</span><span class="n">MyAction</span><span class="p">]</span>
</pre></div>
</div>
<p>オブジェクトキャッシュの削除:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>指定したプレフィックスで始まるキー全てを削除:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">removePrefix</span><span class="p">(</span><span class="n">keyPrefix</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">removePrefix</span></code> を使用することで、プレフィックスを使用した階層的なキャッシュを構築することができます。</p>
<p>例えば、記事に関連する要素をキャッシュしたい場合、記事が変更された時に関連するキャッシュは以下の方法で全てクリアできます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>import xitrum.Config.xitrum.cache

// prefixを使用してキャッシュします。
val prefix = &quot;articles/&quot; + article.id
cache.put(prefix + &quot;/likes&quot;, likes)
cache.put(prefix + &quot;/comments&quot;, comments)

// articleに関連する全てのキャッシュを削除したい場合は以下のようにします。
cache.remove(prefix)
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>キャッシュエンジンの設定<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumのキャッシュ機能はキャッシュエンジンによって提供されます。
キャッシュエンジンはプロジェクトの必要に応じて選択することができます。
キャッシュエンジンの設定は、<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a> において、使用するエンジンに応じて以下の2通りの記載方法で設定できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">EngineClassName</span>
</pre></div>
</div>
<p>または:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="p">{</span>
  <span class="s2">&quot;my.cache.EngineClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Xitrumは以下のエンジンを内包しています:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cache</span> <span class="p">{</span>
  <span class="c1"># Simple in-memory cache</span>
  <span class="s2">&quot;xitrum.local.LruCache&quot;</span> <span class="p">{</span>
    <span class="n">maxElems</span> <span class="o">=</span> <span class="mi">10000</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>もし、クラスタリングされたサーバーを使用する場合、キャッシュエンジンには、<a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">Hazelcast</a> を使用することができます。</p>
<p>独自のキャッシュエンジンを使用する場合、<code class="docutils literal notranslate"><span class="pre">xitrum.Cache</span></code> の <a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/Cache.scala">interface</a> を実装してください。</p>
</div>
<div class="section" id="id6">
<h3>キャッシュ動作の仕組み<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>入力方向（Inbound）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               <span class="n">アクションのレスポンスが</span>
               <span class="n">キャッシュ対象かつ</span>
<span class="n">request</span>        <span class="n">キャッシュが存在している</span>
<span class="o">-------------------------+---------------</span><span class="n">NO</span><span class="o">---------------&gt;</span>
                         <span class="o">|</span>
<span class="o">&lt;---------</span><span class="n">YES</span><span class="o">------------+</span>
  <span class="n">キャッシュからレスポンス</span>
</pre></div>
</div>
<p>出力方向（Outbound）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               <span class="n">アクションのレスポンスが</span>
               <span class="n">キャッシュ対象かつ</span>
               <span class="n">キャッシュがまだ存在していない</span> 　          <span class="n">response</span>
<span class="o">&lt;---------</span><span class="n">NO</span><span class="o">-------------+---------------------------------</span>
                         <span class="o">|</span>
<span class="o">&lt;---------</span><span class="n">YES</span><span class="o">------------+</span>
  <span class="n">store</span> <span class="n">response</span> <span class="n">to</span> <span class="n">cache</span>
</pre></div>
</div>
</div>
<div class="section" id="xitrum-util-locallrucache">
<h3>xitrum.util.LocalLruCache<a class="headerlink" href="#xitrum-util-locallrucache" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>上記で述べたキャッシュエンジンは、システム全体で共有されるキャッシュとなります。
もし小さくで簡易なキャッシュエンジンのみ必要な場合、<code class="docutils literal notranslate"><span class="pre">xitrum.util.LocalLruCache</span></code> を使用します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.LocalLruCache</span>

<span class="o">//</span> <span class="n">LRU</span> <span class="p">(</span><span class="n">Least</span> <span class="n">Recently</span> <span class="n">Used</span><span class="p">)</span> <span class="n">キャッシュは1000要素まで保存できます</span>
<span class="o">//</span> <span class="n">キーとバリューは両方String型となります</span>
<span class="n">val</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">LocalLruCache</span><span class="p">[</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="p">](</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
<p>使用できる <code class="docutils literal notranslate"><span class="pre">cache</span></code> は <a class="reference external" href="http://docs.oracle.com/javase/6/docs/api/java/util/LinkedHashMap.html">java.util.LinkedHashMap</a> のインスタンスであるため、
<code class="docutils literal notranslate"><span class="pre">LinkedHashMap</span></code> のメソッドを使用して扱う事ができます。</p>
</div>
</div>
<span id="document-i18n"></span><div class="section" id="i18n">
<h2>I18n<a class="headerlink" href="#i18n" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>GNU gettext を使用します。gettextは他の国際化方法と異なり、複数形をサポートしています。</p>
<img alt="_images/poedit.png" src="_images/poedit.png" />
<div class="section" id="id1">
<h3>ソースコード内への国際化メッセージの記載<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">xitrum.Action</span></code> は <code class="docutils literal notranslate"><span class="pre">xitrum.I18n</span></code> を継承しており以下の2つのメソッドを持ちます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>t(&quot;Message&quot;)
tc(&quot;Context&quot;, &quot;Message&quot;)

t(&quot;Hello %s&quot;).format(&quot;World&quot;)

// 1$ and 2$ are placeholders
t(&quot;%1$s says hello to %2$s, then %2$s says hello back to %1$s&quot;).format(&quot;Bill&quot;, &quot;Hillary&quot;)

// {0} and {1} are placeholders
java.text.MessageFormat.format(t(&quot;{0} says hello to {1}, then {1} says hello back to {0}&quot;), &quot;Bill&quot;, &quot;Hillary&quot;)

t(&quot;%,.3f&quot;).format(1234.5678)                                // =&gt; 1,234.568
t(&quot;%,.3f&quot;).formatLocal(java.util.Locale.FRENCH, 1234.5678)  // =&gt; 1 234,568
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Above</span><span class="p">,</span> <span class="n">you</span> <span class="n">explicitly</span> <span class="n">specify</span> <span class="n">locale</span><span class="o">.</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">implicitly</span> <span class="n">use</span> <span class="n">locale</span> <span class="n">of</span> <span class="n">the</span> <span class="n">current</span> <span class="n">action</span><span class="p">:</span>
<span class="o">//</span> <span class="n">when</span> <span class="n">English</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span><span class="mf">234.568</span><span class="p">,</span> <span class="n">when</span> <span class="n">French</span> <span class="o">=&gt;</span> <span class="mi">1</span> <span class="mi">234</span><span class="p">,</span><span class="mi">568</span>
<span class="n">t</span><span class="p">(</span><span class="s2">&quot;%,.3f&quot;</span><span class="p">,</span> <span class="mf">1234.5678</span><span class="p">)</span>
</pre></div>
</div>
<p>actionの中では、それらのメソッドを直接呼び出すことができます。
modelのようにaction以外の場所では、<code class="docutils literal notranslate"><span class="pre">xitrum.I18n</span></code> オブジェクトをインポートし、 <code class="docutils literal notranslate"><span class="pre">t</span></code> または <code class="docutils literal notranslate"><span class="pre">tc</span></code> メソッドを呼び出します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">In</span> <span class="n">an</span> <span class="n">action</span>
<span class="n">respondText</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>

<span class="o">//</span> <span class="n">In</span> <span class="n">the</span> <span class="n">model</span>
<span class="kn">import</span> <span class="nn">xitrum.I18n</span>
<span class="nb">object</span> <span class="n">MyModel</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">i18n</span><span class="p">:</span> <span class="n">I18n</span><span class="p">)</span> <span class="o">=</span> <span class="n">i18n</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pot">
<h3>potファイルへのメッセージの展開<a class="headerlink" href="#pot" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>空のi18n.potファイルをプロジェクトのルートディレクトリに作成し、
プロジェクト全体を再コンパイルします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="n">clean</span>
<span class="n">rm</span> <span class="n">i18n</span><span class="o">.</span><span class="n">pot</span>
<span class="n">touch</span> <span class="n">i18n</span><span class="o">.</span><span class="n">pot</span>
<span class="n">sbt</span><span class="o">/</span><span class="n">sbt</span> <span class="nb">compile</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">clean</span></code> で全ての.classファイルを削除し、SBTにプロジェクト全体の再コンパイルを実施します。
<code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">clean</span></code> の後、SBTはコンパイル時に全ての <a class="reference internal" href="index.html#document-deps"><span class="doc">依存ライブラリ</span></a> を再ダウンロードを行いますので、
より時間を節約するには <code class="docutils literal notranslate"><span class="pre">find</span> <span class="pre">target</span> <span class="pre">-name</span> <span class="pre">*.class</span> <span class="pre">-delete</span></code> と実施することで
同じように <code class="docutils literal notranslate"><span class="pre">target</span></code> ディレクトリ内の.classファイルを削除することができます。</p>
<p>リコンパイル実施後、ソースコードから抽出されたメッセージがi18n.potファイルにgettext形式で出力されます。
この魔法のような動作は <a class="reference external" href="http://www.scala-lang.org/node/140">Scala compiler plugin technique</a> により実現されています。</p>
<p>ただし一つ注意点があります。このメソッドはScalaのコードからのみメッセージを抽出します。
もしプロジェクト内にJavaファイルがある場合、 <code class="docutils literal notranslate"><span class="pre">xgettext</span></code> コマンドを使用してメッセージを抽出します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>xgettext -kt -ktc:1c,2 -ktn:1,2 -ktcn:1c,2,3 -o i18n_java.pot --from-code=UTF-8 $(find src/main/java -name &quot;*.java&quot;)
</pre></div>
</div>
<p>出力されたi18n_java.potはi18n.potにマージする必要があります。</p>
</div>
<div class="section" id="po">
<h3>po ファイルの保存先<a class="headerlink" href="#po" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>i18n.potはテンプレートであるため、各言語に対応させるにはi18n.potファイルをコピーして、&lt;language&gt;.po として保存し翻訳を開始します。</p>
<p>Xitrumはクラスパス中の <code class="docutils literal notranslate"><span class="pre">i18n</span></code> という名前のディレクトリを監視します。
もしそのディレクトリ内の &lt;language&gt;.po ファイルに変更があった場合
Xitrumは自動的に &lt;language&gt;.po ファイルをリロードします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">src</span>
  <span class="n">main</span>
    <span class="n">scala</span>
    <span class="n">view</span>
    <span class="n">resources</span>
      <span class="n">i18n</span>
        <span class="n">ja</span><span class="o">.</span><span class="n">po</span>
        <span class="n">vi</span><span class="o">.</span><span class="n">po</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>poファイルを編集やマージには <a class="reference external" href="http://www.poedit.net/">Poedit</a> のようなツールを使用することができます。</p>
<img alt="_images/update_from_pot.png" src="_images/update_from_pot.png" />
<p>poファイルは複数のJARに含めることができ、Xitrumはそれらを自動的にマージします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mylib</span><span class="o">.</span><span class="n">jar</span>
  <span class="n">i18n</span>
    <span class="n">ja</span><span class="o">.</span><span class="n">po</span>
    <span class="n">vi</span><span class="o">.</span><span class="n">po</span>
        <span class="o">...</span>

<span class="n">another</span><span class="o">.</span><span class="n">jar</span>
  <span class="n">i18n</span>
    <span class="n">ja</span><span class="o">.</span><span class="n">po</span>
    <span class="n">vi</span><span class="o">.</span><span class="n">po</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>言語の設定<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>ブラウザからのリクエストに含まれる <code class="docutils literal notranslate"><span class="pre">Accept-Language</span></code> リクエストヘッダーを取得するには、
<code class="docutils literal notranslate"><span class="pre">browserLanguages</span></code> を実行します。結果はブラウザによって送信された優先順位の高い順にソートされて取得できます。</p></li>
<li><p>デフォルト値は &quot;en&quot; です。現在の言語を日本語に変更するには、 <code class="docutils literal notranslate"><span class="pre">language</span> <span class="pre">=</span> <span class="pre">&quot;ja&quot;</span></code> と実行します。</p></li>
<li><p>適切な言語を言語リソースから自動でセットするには
<code class="docutils literal notranslate"><span class="pre">autosetLanguage(availableLanguages)</span></code> を実行します。
<code class="docutils literal notranslate"><span class="pre">availableLanguages</span></code> は <code class="docutils literal notranslate"><span class="pre">resources/i18n</span></code> ディレクトリーとJARファイル内に含まれる言語リソースのリストを指定します。
もし指定された言語リソースが存在しない場合、言語設定は&quot;en&quot;が使用されます。</p></li>
<li><p>設定された言語を確認するには、<code class="docutils literal notranslate"><span class="pre">language</span></code> 変数にセットされた値を参照します。</p></li>
</ul>
<p>一般的にアクションではビフォアフィルターにおいて言語を設定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">beforeFilter</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">lango</span><span class="p">:</span> <span class="n">Option</span><span class="p">[</span><span class="n">String</span><span class="p">]</span> <span class="o">=</span> <span class="n">yourMethodToGetUserPreferenceLanguageInSession</span><span class="p">()</span>
  <span class="n">lango</span> <span class="n">match</span> <span class="p">{</span>
    <span class="n">case</span> <span class="kc">None</span>       <span class="o">=&gt;</span> <span class="n">autosetLanguage</span><span class="p">(</span><span class="n">Locale</span><span class="o">.</span><span class="n">forLanguageTag</span><span class="p">(</span><span class="s2">&quot;ja&quot;</span><span class="p">),</span> <span class="n">Locale</span><span class="o">.</span><span class="n">forLanguageTag</span><span class="p">(</span><span class="s2">&quot;vi&quot;</span><span class="p">))</span>
    <span class="n">case</span> <span class="n">Some</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">language</span> <span class="o">=</span> <span class="n">lang</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>バリデーションメッセージ<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>jQuery Validation プラグインは <a class="reference external" href="https://github.com/jzaefferer/jquery-validation/tree/master/src/localization">i18n error messages</a> を提供しています。
Xitrumは現在の言語に対応するメッセージファイルを自動的にインポートします。</p>
<p><code class="docutils literal notranslate"><span class="pre">xitrum.validator</span></code> パッケージが提供するサーバサイドバリデーションにおいても、
Xitrumはそれらの翻訳を提供しています。</p>
</div>
<div class="section" id="id4">
<h3>複数形への対応<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tn</span><span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="s2">&quot;Plural form&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">tcn</span><span class="p">(</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="s2">&quot;Plural form&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
<p>Xitrumは以下の仕様に沿って複数形の単語を翻訳します。</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.gnu.org/software/gettext/manual/html_node/Plural-forms.html#Plural-forms">What are plural forms</a></p></li>
<li><p><a class="reference external" href="http://www.gnu.org/software/gettext/manual/html_node/Translating-plural-forms.html#Translating-plural-forms">Translating plural forms</a></p></li>
</ul>
<p>複数形の単語は以下のいずれかの書式に従う必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nplurals=1; plural=0
nplurals=2; plural=n != 1
nplurals=2; plural=n&gt;1
nplurals=3; plural=n%10==1 &amp;&amp; n%100!=11 ? 0 : n != 0 ? 1 : 2
nplurals=3; plural=n==1 ? 0 : n==2 ? 1 : 2
nplurals=3; plural=n==1 ? 0 : (n==0 || (n%100 &gt; 0 &amp;&amp; n%100 &lt; 20)) ? 1 : 2
nplurals=3; plural=n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2
nplurals=3; plural=n%10==1 &amp;&amp; n%100!=11 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2
nplurals=3; plural=(n==1) ? 0 : (n&gt;=2 &amp;&amp; n&lt;=4) ? 1 : 2
nplurals=3; plural=n==1 ? 0 : n%10&gt;=2 &amp;&amp; n%10&lt;=4 &amp;&amp; (n%100&lt;10 || n%100&gt;=20) ? 1 : 2
nplurals=4; plural=n%100==1 ? 0 : n%100==2 ? 1 : n%100==3 || n%100==4 ? 2 : 3
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>日付と数値のフォーマット<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>もしScalateテンプレートエンジンを使用している場合、日付と数値のフォーマットは現在のアクションの言語設定に従うことになります。</p>
<p>異なるフォーマットを使用する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">java.text.</span><span class="p">{</span><span class="n">DateFormat</span><span class="p">,</span> <span class="n">NumberFormat</span><span class="p">}</span>

<span class="n">val</span> <span class="n">myDateFormat</span>   <span class="o">=</span> <span class="o">...</span>
<span class="n">val</span> <span class="n">myNumberFormat</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">val</span> <span class="n">options</span>        <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="s2">&quot;date&quot;</span> <span class="o">-&gt;</span> <span class="n">myDateFormat</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span> <span class="o">-&gt;</span> <span class="n">myNumberFormat</span><span class="p">)</span>
<span class="n">respondView</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-log"></span><div class="section" id="id1">
<h2>ログ<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="xitrum-log">
<h3>xitrum.Logオブジェクトを直接使用する<a class="headerlink" href="#xitrum-log" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>xitrum.Logはどこからでも直接使用することができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xitrum</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;My debug msg&quot;</span><span class="p">)</span>
<span class="n">xitrum</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;My info msg&quot;</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>xitrum.Logトレイトを直接使用する<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ログが生成された場所(クラス)を明確に知りたい場合、
xitrum.Logトレイトを継承します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">my_package</span>
<span class="kn">import</span> <span class="nn">xitrum.Log</span>

<span class="nb">object</span> <span class="n">MyModel</span> <span class="n">extends</span> <span class="n">Log</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;My debug msg&quot;</span><span class="p">)</span>
  <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;My info msg&quot;</span><span class="p">)</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">log/xitrum.log</span></code> にはメッセージが <code class="docutils literal notranslate"><span class="pre">MyModel</span></code> から出力されていることがわかります。</p>
<p>Xitrumのアクションはxitrum.Logトレイトを継承しており、どのactionからでも以下のようにログを出力することができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>ログレベルをチェックする必要はありません<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">xitrum.Log</span></code> は <a class="reference external" href="http://slf4s.org/">SLF4S</a> (<a class="reference external" href="http://slf4s.org/api/1.7.7/">API</a>) を使用しており、
SLF4Sは <a class="reference external" href="http://www.slf4j.org/">SLF4J</a> の上に構築されています。</p>
<p>ログに出力時の計算によるCPU負荷を減らす目的で、ログ出力前にログレベルをチェックする伝統的な手法がありますが、
<a class="reference external" href="https://github.com/mattroberts297/slf4s/blob/master/src/main/scala/org/slf4s/Logger.scala">SLF4Sが自動でチェックしてくれる</a> ため、
あなたが気にする必要はありません。</p>
<p>これまで (このコードは Xitrum 3.13 以降では動作しません):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">isTraceEnabled</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">result</span> <span class="o">=</span> <span class="n">heavyCalculation</span><span class="p">()</span>
  <span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Output: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>現行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="s2">&quot;Output: #{heavyCalculation()}&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>ログレベル、ログファイル等の設定<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>build.sbtに以下の1行があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;ch.qos.logback&quot;</span> <span class="o">%</span> <span class="s2">&quot;logback-classic&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.1.2&quot;</span>
</pre></div>
</div>
<p>これはデフォルトで <a class="reference external" href="http://logback.qos.ch/">Logback</a> が使用されていることを意味します。
Logbackの設定ファイルは <code class="docutils literal notranslate"><span class="pre">config/logback.xml</span></code> になります。</p>
<p>Logback以外の <a class="reference external" href="http://www.slf4j.org/">SLF4J</a> 対応ライブラリに置き換えることも可能です。</p>
</div>
<div class="section" id="fluentd">
<h3>Fluentd へのログ出力<a class="headerlink" href="#fluentd" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ログコレクターとして有名な <a class="reference external" href="http://www.fluentd.org/">Fluentd</a> というソフトウェアがあります。
Logbackの設定を変更することでFluentdサーバにXitrumのログを（複数の箇所から）転送することができます。</p>
<p>利用するにはまず、プロジェクトの依存ライブラリに <a class="reference external" href="https://github.com/sndyuk/logback-more-appenders">logback-more-appenders</a> を追加します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;org.fluentd&quot;</span> <span class="o">%</span> <span class="s2">&quot;fluent-logger&quot;</span> <span class="o">%</span> <span class="s2">&quot;0.2.11&quot;</span>

<span class="n">resolvers</span> <span class="o">+=</span> <span class="s2">&quot;Logback more appenders&quot;</span> <span class="n">at</span> <span class="s2">&quot;http://sndyuk.github.com/maven&quot;</span>

<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;com.sndyuk&quot;</span> <span class="o">%</span> <span class="s2">&quot;logback-more-appenders&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.1.0&quot;</span>
</pre></div>
</div>
<p>そして <code class="docutils literal notranslate"><span class="pre">config/logback.xml</span></code> を編集します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...

&lt;appender name=&quot;FLUENT&quot; class=&quot;ch.qos.logback.more.appenders.DataFluentAppender&quot;&gt;
  &lt;tag&gt;mytag&lt;/tag&gt;
  &lt;label&gt;mylabel&lt;/label&gt;
  &lt;remoteHost&gt;localhost&lt;/remoteHost&gt;
  &lt;port&gt;24224&lt;/port&gt;
  &lt;maxQueueSize&gt;20000&lt;/maxQueueSize&gt;  &lt;!-- Save to memory when remote server is down --&gt;
&lt;/appender&gt;

&lt;root level=&quot;DEBUG&quot;&gt;
  &lt;appender-ref ref=&quot;FLUENT&quot;/&gt;
  &lt;appender-ref ref=&quot;OTHER_APPENDER&quot;/&gt;
&lt;/root&gt;

...
</pre></div>
</div>
</div>
</div>
<span id="document-deploy"></span><div class="section" id="id1">
<h2>プロダクション環境へのデプロイ<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Xitrumを直接動かすことができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ブラウザ</span> <span class="o">------</span> <span class="n">Xitrum</span> <span class="n">インスタンス</span>
</pre></div>
</div>
<p>HAProxyのようなロードバランサーや、ApacheやNginxのようなリバースプロキシの背後で動かすこともできます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ブラウザ</span> <span class="o">------</span> <span class="n">ロードバランサー</span><span class="o">/</span><span class="n">リバースプロキシ</span>   <span class="o">-+----</span> <span class="n">Xitrum</span> <span class="n">インスタンス1</span>
                                            　<span class="o">+----</span> <span class="n">Xitrum</span> <span class="n">インスタンス2</span>
</pre></div>
</div>
<div class="section" id="id2">
<h3>ディレクトリのパッケージ化<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">xitrumPackage</span></code> を実行することで、プロダクション環境へデプロイ可能な <code class="docutils literal notranslate"><span class="pre">target/xitrum</span></code> ディレクトリが生成されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">target</span><span class="o">/</span><span class="n">xitrum</span>
  <span class="n">config</span>
    <span class="p">[</span><span class="n">config</span> <span class="n">files</span><span class="p">]</span>
  <span class="n">public</span>
    <span class="p">[</span><span class="n">static</span> <span class="n">public</span> <span class="n">files</span><span class="p">]</span>
  <span class="n">lib</span>
    <span class="p">[</span><span class="n">dependencies</span> <span class="ow">and</span> <span class="n">packaged</span> <span class="n">project</span> <span class="n">file</span><span class="p">]</span>
  <span class="n">script</span>
    <span class="n">runner</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">bat</span>
    <span class="n">scalive</span>
    <span class="n">scalive</span><span class="o">.</span><span class="n">jar</span>
    <span class="n">scalive</span><span class="o">.</span><span class="n">bat</span>
</pre></div>
</div>
</div>
<div class="section" id="xitrum-package">
<h3>xitrum-packageのカスタマイズ<a class="headerlink" href="#xitrum-package" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>デフォルトでは <code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">xitrumPackage</span></code> コマンドは、</p>
<p><code class="docutils literal notranslate"><span class="pre">config</span></code> 、 <code class="docutils literal notranslate"><span class="pre">public</span></code> および <code class="docutils literal notranslate"><span class="pre">script</span></code> ディレクトリを <code class="docutils literal notranslate"><span class="pre">target/xitrum</span></code> 以下にコピーします。
コピーするディレクトリを追加したい場合は、以下のように <code class="docutils literal notranslate"><span class="pre">build.sbt</span></code> を編集します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XitrumPackage</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;public, &quot;</span><span class="n">script</span><span class="s2">&quot;, &quot;</span><span class="n">doc</span><span class="o">/</span><span class="n">README</span><span class="o">.</span><span class="n">txt</span><span class="s2">&quot;, &quot;</span><span class="n">etc</span><span class="o">.</span><span class="s2">&quot;)</span>
</pre></div>
</div>
<p>詳しくは <a class="reference external" href="https://github.com/xitrum-framework/xitrum-package">xitrum-packageのサイト</a> を参照ください。</p>
</div>
<div class="section" id="jvmscala">
<h3>稼働中のJVMプロセスに対するScalaコンソール接続<a class="headerlink" href="#jvmscala" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>プロダクション環境においても特別な準備をすることなく、<a class="reference external" href="https://github.com/xitrum-framework/scalive">Scalive</a> を使用することで、
稼働中のJVMプロセスに対してScalaコンソールを接続してデバッギングを行うことができます。</p>
<p><code class="docutils literal notranslate"><span class="pre">script</span></code> ディレクトリの <code class="docutils literal notranslate"><span class="pre">scalive</span></code> コマンドを実行します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span>
  <span class="n">runner</span>
  <span class="n">runner</span><span class="o">.</span><span class="n">bat</span>
  <span class="n">scalive</span>
  <span class="n">scalive</span><span class="o">.</span><span class="n">jar</span>
  <span class="n">scalive</span><span class="o">.</span><span class="n">bat</span>
</pre></div>
</div>
</div>
<div class="section" id="centosubuntuoraclejdk">
<h3>CentOSまたはUbuntuへのOracleJDKインストール<a class="headerlink" href="#centosubuntuoraclejdk" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ここではJavaのインストール方法についての簡単なガイドを紹介します。
パッケージマネージャを使用してJavaをインストールすることも可能です。</p>
<p>現在インストールされているJavaの確認:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="nb">list</span> <span class="n">java</span>
</pre></div>
</div>
<p>出力例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_15</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_25</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>
</pre></div>
</div>
<p>サーバ環境の確認 (32 bit または 64 bit):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span>
</pre></div>
</div>
<p>出力例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">init</span><span class="p">:</span> <span class="n">ELF</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">LSB</span> <span class="n">shared</span> <span class="nb">object</span><span class="p">,</span> <span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">version</span> <span class="mi">1</span> <span class="p">(</span><span class="n">SYSV</span><span class="p">),</span> <span class="n">dynamically</span> <span class="n">linked</span> <span class="p">(</span><span class="n">uses</span> <span class="n">shared</span> <span class="n">libs</span><span class="p">),</span> <span class="k">for</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="mf">2.6</span><span class="o">.</span><span class="mi">24</span><span class="p">,</span> <span class="n">BuildID</span><span class="p">[</span><span class="n">sha1</span><span class="p">]</span><span class="o">=</span><span class="mh">0x4efe732752ed9f8cc491de1c8a271eb7f4144a5c</span><span class="p">,</span> <span class="n">stripped</span>
</pre></div>
</div>
<p>JDKを <a class="reference external" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html">Oracle</a> のサイトからダウンロードします。
ブラウザを介さないでダウンロードするにはちょっとした <a class="reference external" href="http://stackoverflow.com/questions/10268583/how-to-automate-download-and-instalation-of-java-jdk-on-linux">工夫</a> が必要です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cookies</span> <span class="o">--</span><span class="n">header</span> <span class="s2">&quot;Cookie: gpw_e24=http%3A</span><span class="si">%2F%2F</span><span class="s2">www.oracle.com&quot;</span> <span class="s2">&quot;http://download.oracle.com/otn-pub/java/jdk/7u45-b18/jdk-7u45-linux-x64.tar.gz&quot;</span>
</pre></div>
</div>
<p>ダウンロードしたアーカイブを解凍して移動します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">xzvf</span> <span class="n">jdk</span><span class="o">-</span><span class="mi">7</span><span class="n">u45</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x64</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">sudo</span> <span class="n">mv</span> <span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span>
</pre></div>
</div>
<p>コマンドを登録します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/java&quot;</span> <span class="s2">&quot;java&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/java&quot;</span> <span class="mi">1</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/javac&quot;</span> <span class="s2">&quot;javac&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/javac&quot;</span> <span class="mi">1</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/javap&quot;</span> <span class="s2">&quot;javap&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/javap&quot;</span> <span class="mi">1</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">install</span> <span class="s2">&quot;/usr/bin/javaws&quot;</span> <span class="s2">&quot;javaws&quot;</span> <span class="s2">&quot;/usr/lib/jvm/jdk1.7.0_45/bin/javaws&quot;</span> <span class="mi">1</span>
</pre></div>
</div>
<p>対話型のシェルで新しいパスを指定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">java</span>
</pre></div>
</div>
<p>出力例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">There</span> <span class="n">are</span> <span class="mi">3</span> <span class="n">choices</span> <span class="k">for</span> <span class="n">the</span> <span class="n">alternative</span> <span class="n">java</span> <span class="p">(</span><span class="n">providing</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span><span class="p">)</span><span class="o">.</span>

  <span class="n">Selection</span>    <span class="n">Path</span>                               <span class="n">Priority</span>   <span class="n">Status</span>
<span class="o">------------------------------------------------------------</span>
<span class="o">*</span> <span class="mi">0</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_25</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">50001</span>     <span class="n">auto</span> <span class="n">mode</span>
  <span class="mi">1</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_15</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">50000</span>     <span class="n">manual</span> <span class="n">mode</span>
  <span class="mi">2</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_25</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">50001</span>     <span class="n">manual</span> <span class="n">mode</span>
  <span class="mi">3</span>            <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span>   <span class="mi">1</span>         <span class="n">manual</span> <span class="n">mode</span>

<span class="n">Press</span> <span class="n">enter</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">current</span> <span class="n">choice</span><span class="p">[</span><span class="o">*</span><span class="p">],</span> <span class="ow">or</span> <span class="nb">type</span> <span class="n">selection</span> <span class="n">number</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">update</span><span class="o">-</span><span class="n">alternatives</span><span class="p">:</span> <span class="n">using</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">jvm</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0_45</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span> <span class="n">to</span> <span class="n">provide</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">java</span> <span class="p">(</span><span class="n">java</span><span class="p">)</span> <span class="ow">in</span> <span class="n">manual</span> <span class="n">mode</span>
</pre></div>
</div>
<p>バージョンを確認します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">version</span>
</pre></div>
</div>
<p>出力例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">java</span> <span class="n">version</span> <span class="s2">&quot;1.7.0_45&quot;</span>
<span class="n">Java</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="n">SE</span> <span class="n">Runtime</span> <span class="n">Environment</span> <span class="p">(</span><span class="n">build</span> <span class="mf">1.7</span><span class="o">.</span><span class="mi">0_45</span><span class="o">-</span><span class="n">b18</span><span class="p">)</span>
<span class="n">Java</span> <span class="n">HotSpot</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="mi">64</span><span class="o">-</span><span class="n">Bit</span> <span class="n">Server</span> <span class="n">VM</span> <span class="p">(</span><span class="n">build</span> <span class="mf">24.45</span><span class="o">-</span><span class="n">b08</span><span class="p">,</span> <span class="n">mixed</span> <span class="n">mode</span><span class="p">)</span>
</pre></div>
</div>
<p>javac等も同様に行います:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">javac</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">javap</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">alternatives</span> <span class="o">--</span><span class="n">config</span> <span class="n">javaws</span>
</pre></div>
</div>
</div>
<div class="section" id="xitrum">
<h3>システム起動時にXitrumをスタートさせる<a class="headerlink" href="#xitrum" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">script/runner</span></code> （<a href="#id5"><span class="problematic" id="id6">*</span></a>nix環境向け）と <code class="docutils literal notranslate"><span class="pre">script/runner.bat</span></code> （Windows環境向け）はオブジェクトの <code class="docutils literal notranslate"><span class="pre">main</span></code> メソッドを実行するためのスクリプトになります。
プロダクション環境ではこのスクリプトを使用してWebサーバを起動します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="o">/</span><span class="n">runner</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">Boot</span>
</pre></div>
</div>
<p><a class="reference external" href="http://www.oracle.com/technetwork/java/hotspotfaq-138619.html">JVM設定</a> を調整するには、
<code class="docutils literal notranslate"><span class="pre">runner</span></code> （または <code class="docutils literal notranslate"><span class="pre">runner.bat</span></code>）を修正します。
また、<code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> も参照してください。</p>
<p>Linux環境でシステム起動時にXitrumをバックグラウンドでスタートさせるには、一番簡単な方法は
<code class="docutils literal notranslate"><span class="pre">/etc/rc.local</span></code> に一行を追加します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">su</span> <span class="o">-</span> <span class="n">user_foo_bar</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">the</span><span class="o">/</span><span class="n">runner</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">above</span> <span class="o">&amp;</span>
</pre></div>
</div>
<p>他には <a class="reference external" href="http://cr.yp.to/daemontools.html">daemontools</a> が便利です。
CentOSへのインストール手順は <a class="reference external" href="http://whomwah.com/2008/11/04/installing-daemontools-on-centos5-x86_64/">こちらの手順</a> を参照してください。
あるいは <a class="reference external" href="http://supervisord.org/">Supervisord</a> を使用することもできます。</p>
<p><code class="docutils literal notranslate"><span class="pre">/etc/supervisord.conf</span></code> の例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">my_app</span><span class="p">]</span>
<span class="n">directory</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_app</span>
<span class="n">command</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_app</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">runner</span> <span class="n">quickstart</span><span class="o">.</span><span class="n">Boot</span>
<span class="n">autostart</span><span class="o">=</span><span class="n">true</span>
<span class="n">autorestart</span><span class="o">=</span><span class="n">true</span>
<span class="n">startsecs</span><span class="o">=</span><span class="mi">3</span>
<span class="n">user</span><span class="o">=</span><span class="n">my_user</span>
<span class="n">redirect_stderr</span><span class="o">=</span><span class="n">true</span>
<span class="n">stdout_logfile</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">my_app</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">stdout</span><span class="o">.</span><span class="n">log</span>
<span class="n">stdout_logfile_maxbytes</span><span class="o">=</span><span class="mi">10</span><span class="n">MB</span>
<span class="n">stdout_logfile_backups</span><span class="o">=</span><span class="mi">7</span>
<span class="n">stdout_capture_maxbytes</span><span class="o">=</span><span class="mi">1</span><span class="n">MB</span>
<span class="n">stdout_events_enabled</span><span class="o">=</span><span class="n">false</span>
<span class="n">environment</span><span class="o">=</span><span class="n">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">aws</span><span class="o">/</span><span class="nb">bin</span><span class="p">:</span><span class="o">~/</span><span class="nb">bin</span>
</pre></div>
</div>
<p>その他のツール:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://smarden.org/runit/">runit</a></p></li>
<li><p><a class="reference external" href="http://upstart.ubuntu.com/">upstart</a></p></li>
</ul>
</div>
<div class="section" id="id8">
<h3>ポートフォワーディングの設定<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>デフォルトではXitrumは8000ポートと4430ポートを使用します。
これらのポート番号は <code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> で設定することができます。</p>
<p><code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/iptables</span></code> を以下のコマンドで修正することによって、
80から8000へ、443から4430へポートフォワーディングを行うことができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span> <span class="o">-</span> <span class="n">root</span>
<span class="n">chmod</span> <span class="mi">700</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">restore</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">port</span> <span class="mi">8000</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">port</span> <span class="mi">4430</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">ports</span> <span class="mi">8000</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">REDIRECT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">ports</span> <span class="mi">4430</span>
<span class="n">iptables</span><span class="o">-</span><span class="n">save</span> <span class="o">-</span><span class="n">c</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
<span class="n">chmod</span> <span class="mi">644</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
</pre></div>
</div>
<p>もしApacheが80ポート、443ポートを使用している場合、停止する必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">httpd</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">chkconfig</span> <span class="n">httpd</span> <span class="n">off</span>
</pre></div>
</div>
<p>Iptablesについての参考情報:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.frozentux.net/iptables-tutorial/chunkyhtml/">Iptables チュートリアル</a></p></li>
</ul>
</div>
<div class="section" id="linux">
<h3>大量コネクションに対するLinux設定<a class="headerlink" href="#linux" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Macの場合、JDKは <a class="reference external" href="https://groups.google.com/forum/#!topic/spray-user/S-SNR2m0BWU">IO (NIO) に関わるパフォーマンスの問題</a> が存在します。</p>
<p>参考情報(英語):</p>
<ul class="simple">
<li><p><a class="reference external" href="http://docs.basho.com/riak/latest/ops/tuning/linux/">Linux Performance Tuning (Riak)</a></p></li>
<li><p><a class="reference external" href="http://docs.basho.com/riak/latest/ops/tuning/aws/">AWS Performance Tuning (Riak)</a></p></li>
<li><p><a class="reference external" href="http://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/">Ipsysctl tutorial</a></p></li>
<li><p><a class="reference external" href="http://www.frozentux.net/ipsysctl-tutorial/chunkyhtml/tcpvariables.html">TCP variables</a></p></li>
</ul>
<div class="section" id="id9">
<h4>ファイルディスクリプタ数の上限設定<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>各コネクションはLinuxにとってオープンファイルとしてみなされます。
1プロセスが同時オープン可能なファイルディスクリプタ数は、デフォルトで1024となっています。
この上限を変更するには <code class="docutils literal notranslate"><span class="pre">/etc/security/limits.conf</span></code> を編集します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span>  <span class="n">soft</span>  <span class="n">nofile</span>  <span class="mi">1024000</span>
<span class="o">*</span>  <span class="n">hard</span>  <span class="n">nofile</span>  <span class="mi">1024000</span>
</pre></div>
</div>
<p>変更を適用するには一度ログアウトして、再度ログインする必要があります。
一時的に適用するには <code class="docutils literal notranslate"><span class="pre">ulimit</span> <span class="pre">-n</span></code> と実行します。</p>
</div>
<div class="section" id="id10">
<h4>カーネルのチューニング<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="http://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-1">A Million-user Comet Application with Mochiweb（英語）</a> に紹介されているように、<code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code> を編集します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># General gigabit tuning</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">rmem_max</span> <span class="o">=</span> <span class="mi">16777216</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">wmem_max</span> <span class="o">=</span> <span class="mi">16777216</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_rmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">87380</span> <span class="mi">16777216</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_wmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">65536</span> <span class="mi">16777216</span>

<span class="c1"># This gives the kernel more memory for TCP</span>
<span class="c1"># which you need with many (100k+) open socket connections</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_mem</span> <span class="o">=</span> <span class="mi">50576</span> <span class="mi">64768</span> <span class="mi">98152</span>

<span class="c1"># Backlog</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">netdev_max_backlog</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_max_syn_backlog</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_syncookies</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># If you run clients</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">ip_local_port_range</span> <span class="o">=</span> <span class="mi">1024</span> <span class="mi">65535</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_tw_recycle</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_tw_reuse</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_fin_timeout</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>変更を適用するため、 <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sysctl</span> <span class="pre">-p</span></code> を実行します。
リブートの必要はありません。これでカーネルは大量のコネクションを扱うことができるようになります。</p>
</div>
<div class="section" id="id11">
<h4>バックログについて<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>TCPはコネクション確立のために3種類のハンドシェイクを行います。
リモートクライアントがサーバに接続するとき、クライアントはSYNパケットを送信します。
そしてサーバ側のOSはSYN-ACKパケットを返信します。
その後リモートクライアントは再びACKパケットを送信してコネクションが確立します。
Xitrumはコネクションが完全に確立した時にそれを取得します。</p>
<p><a class="reference external" href="https://sites.google.com/site/beingroot/articles/apache/socket-backlog-tuning-for-apache">Socket backlog tuning for Apache（英語）</a> によると、
コネクションタイムアウトは、WebサーバのバックログキューがSYN−ACKパケット送信で溢れてしまった際に、SYNパケットが失われることによって発生します。</p>
<p><a class="reference external" href="http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/configtuning-kernel-limits.html">FreeBSD Handbook（英語）</a> によると
デフォルトの128という設定は、高負荷なサーバ環境にとって、新しいコネクションを確実に受け付けるには低すぎるとあります。
そのような環境では、1024以上に設定することが推奨されています。
キューサイズを大きくすることはDoS攻撃を避ける意味でも効果があります。</p>
<p>Xitrumはバックログサイズを1024(memcachedと同じ値)としています。
しかし、前述のカーネルのチューニングをすることも忘れないで下さい。</p>
<p>バックログ設定値の確認方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">somaxconn</span>
</pre></div>
</div>
<p>または:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sysctl</span> <span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span>
</pre></div>
</div>
<p>一時的な変更方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sysctl</span> <span class="o">-</span><span class="n">w</span> <span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span><span class="o">=</span><span class="mi">1024</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="haproxy-tips">
<h3>HAProxy tips<a class="headerlink" href="#haproxy-tips" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>HAProxyをSockJSのために設定するには、<a class="reference external" href="https://github.com/sockjs/sockjs-node/blob/master/examples/haproxy.cfg">こちらのサンプル</a> を参照してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defaults</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">10</span><span class="n">s</span>
    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">10</span><span class="n">h</span>  <span class="c1"># Set to long time to avoid WebSocket connections being closed when there&#39;s no network activity</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">10</span><span class="n">h</span>  <span class="c1"># Set to long time to avoid ERR_INCOMPLETE_CHUNKED_ENCODING on Chrome</span>

<span class="n">frontend</span> <span class="n">xitrum_with_discourse</span>
    <span class="n">bind</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span>

    <span class="n">option</span> <span class="n">forwardfor</span>

    <span class="n">acl</span> <span class="n">is_discourse</span> <span class="n">path_beg</span> <span class="o">/</span><span class="n">forum</span>
    <span class="n">use_backend</span> <span class="n">discourse</span> <span class="k">if</span> <span class="n">is_discourse</span>
    <span class="n">default_backend</span> <span class="n">xitrum</span>

<span class="n">backend</span> <span class="n">xitrum</span>
    <span class="n">server</span> <span class="n">srv_xitrum</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span>

<span class="n">backend</span> <span class="n">discourse</span>
    <span class="n">server</span> <span class="n">srv_discourse</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">3000</span>
</pre></div>
</div>
<p>HAProxyを再起動せずに設定ファイルをロードするには、<a class="reference external" href="http://serverfault.com/questions/165883/is-there-a-way-to-add-more-backend-server-to-haproxy-without-restarting-haproxy">こちらのディスカッション</a> を参照してください。</p>
<p>HAProxyはNginxより簡単に使うことができます。
<a class="reference internal" href="index.html#document-cache"><span class="doc">キャッシュについての章</span></a> にあるように、Xitrumは <a class="reference external" href="https://gist.github.com/3293596">静的ファイルの配信に優れている</a> ため、
静的ファイルの配信にNginxを用意する必要はありません。その点からHAProxyはXitrumととても相性が良いと言えます。</p>
</div>
<div class="section" id="nginx-tips">
<h3>Nginx tips<a class="headerlink" href="#nginx-tips" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Nginx 1.2 の背後でXitrumを動かす場合、XitrumのWebSocketやSockJSの機能を使用するには、
<a class="reference external" href="https://github.com/yaoweibin/nginx_tcp_proxy_module">nginx_tcp_proxy_module</a> を使用する必要があります。
Nginx 1.3+ 以上はネイティブでWebSocketをサポートしています。</p>
<p>Nginxはデフォルトでは、HTTP 1.0をリバースプロキシのプロトコルとして使用します。
チャンクレスポンスを使用する場合、Nginxに HTTP 1.1をプロトコルとして使用することを伝える必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
  <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
  <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="n">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">8000</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>http keepaliveについての <a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">ドキュメント</a> にあるように、 <code class="docutils literal notranslate"><span class="pre">proxy_set_header</span> <span class="pre">Connection</span> <span class="pre">&quot;&quot;</span></code> と設定する必要もあります。</p>
</div>
<div class="section" id="heroku">
<h3>Herokuへのデプロイ<a class="headerlink" href="#heroku" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは <a class="reference external" href="https://www.heroku.com/">Heroku</a> 上で動かすこともできます。</p>
<div class="section" id="id17">
<h4>サインアップとリポジトリの作成<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="https://devcenter.heroku.com/articles/quickstart">公式ドキュメント</a> に沿って、サインアップしリポジトリを作成します。</p>
</div>
<div class="section" id="procfile">
<h4>Procfileの作成<a class="headerlink" href="#procfile" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Procfileを作成し、プロジェクトのルートディレクトリに保存します。
Herokuはこのファイルをもとに、起動時コマンドを実行します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">web</span><span class="p">:</span> <span class="n">target</span><span class="o">/</span><span class="n">xitrum</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">runner</span> <span class="o">&lt;</span><span class="n">YOUR_PACKAGE</span><span class="o">.</span><span class="n">YOUR_MAIN_CLASS</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="port">
<h4>Port設定の変更<a class="headerlink" href="#port" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>ポート番号はHerokuによって動的にアサインされるため、以下のように設定する必要があります。</p>
<p>config/xitrum.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>port {
  http              = ${PORT}
  # https             = 4430
  # flashSocketPolicy = 8430  # flash_socket_policy.xml will be returned
}
</pre></div>
</div>
<p>SSLを使用するには、<a class="reference external" href="https://addons.heroku.com/ssl">アドオン</a> が必要となります。</p>
</div>
<div class="section" id="id20">
<h4>ログレベルの設定<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>config/logback.xml:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">root</span> <span class="n">level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">appender</span><span class="o">-</span><span class="n">ref</span> <span class="n">ref</span><span class="o">=</span><span class="s2">&quot;CONSOLE&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">root</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Herokuで稼働するアプリのログをtailするには:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">heroku</span> <span class="n">logs</span> <span class="o">-</span><span class="n">tail</span>
</pre></div>
</div>
</div>
<div class="section" id="id21">
<h4><code class="docutils literal notranslate"><span class="pre">xitrum-package</span></code> のエイリアス作成<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>デプロイ実行時にHerokuは、<code class="docutils literal notranslate"><span class="pre">sbt/sbt</span> <span class="pre">clean</span> <span class="pre">compile</span> <span class="pre">stage</span></code> を実行します。
そのため、 <code class="docutils literal notranslate"><span class="pre">xitrum-package</span></code> に対するエイリアスを作成する必要があります。</p>
<p>build.sbt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">addCommandAlias</span><span class="p">(</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;;xitrum-package&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h4>Herokuへのプッシュ<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>デプロイプロセスは git push にふっくされます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">push</span> <span class="n">heroku</span> <span class="n">master</span>
</pre></div>
</div>
<p>詳しくはHerokuの <a class="reference external" href="https://devcenter.heroku.com/articles/getting-started-with-scala">公式ドキュメント for Scala</a> を参照してください.</p>
</div>
</div>
<div class="section" id="openshift">
<h3>OpenShiftへのデプロイ<a class="headerlink" href="#openshift" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは <a class="reference external" href="https://developers.openshift.com/">OpenShift</a> 上で動かすこともできます。</p>
<div class="section" id="id24">
<h4>サインアップとリポジトリの作成<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="https://developers.openshift.com/en/getting-started-overview.html">公式ガイド</a> に沿って、サインアップしリポジトリを作成します。
カートリッジには <a class="reference external" href="https://developers.openshift.com/en/diy-overview.html">DIY</a> を指定します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rhc</span> <span class="n">app</span> <span class="n">create</span> <span class="n">myapp</span> <span class="n">diy</span>
</pre></div>
</div>
</div>
<div class="section" id="id26">
<h4>プロジェクト構成<a class="headerlink" href="#id26" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>sbtを使用してXitrumアプリケーションをコンパイル、起動するために、<a class="reference external" href="http://stackoverflow.com/questions/23826770/play-openshift-deployment-sbt-using-some-directories-behind-the-scenes">いくつかの準備</a> が必要となります。
rhcコマンドで作成したプロジェクトディレクトリ内に`app`ディレクトリを作成し、xitrumアプリケーションのソースコードを配置します。
また、空の`static`と`fakehome`ディレクトリを作成します、
プロジェクトツリーは以下のようになります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├── .openshift
│   ├── README.md
│   ├── action_hooks
│   │   ├── README.md
│   │   ├── start
│   │   └── stop
│   ├── cron
│   └── markers
├── README.md
├── app
├── fakehome
├── misc
└── static
</pre></div>
</div>
</div>
<div class="section" id="action-hooks">
<h4>action_hooksの作成<a class="headerlink" href="#action-hooks" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>openshiftへpush時に実行されるスクリプトを以下のように修正します。</p>
<p>.openshift/action_hooks/start:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
IVY_DIR=$OPENSHIFT_DATA_DIR/.ivy2
mkdir -p $IVY_DIR
chown $OPENSHIFT_GEAR_UUID.$OPENSHIFT_GEAR_UUID -R &quot;$IVY_DIR&quot;
cd $OPENSHIFT_REPO_DIR/app
sbt/sbt xitrumPackage
nohup $OPENSHIFT_REPO_DIR/app/target/xitrum/script/runner quickstart.Boot &gt;&gt; nohup.out 2&gt;&amp;1 &amp; echo $! &gt; $OPENSHIFT_REPO_DIR/xitrum.pid &amp;
</pre></div>
</div>
<p>.openshift/action_hooks/top:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
source $OPENSHIFT_CARTRIDGE_SDK_BASH

# The logic to stop your application should be put in this script.
if [ -z &quot;$(ps -ef | grep `cat $OPENSHIFT_REPO_DIR/xitrum.pid` | grep -v grep)&quot; ]
then
    client_result &quot;Application is already stopped&quot;
else
    cat $OPENSHIFT_REPO_DIR/xitrum.pid | xargs kill
fi
</pre></div>
</div>
</div>
<div class="section" id="ip-port">
<h4>IP:Port設定の変更<a class="headerlink" href="#ip-port" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>IPとポート番号はopenshiftによって動的にアサインされるため、以下のように設定する必要があります。</p>
<p>config/xitrum.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Use opensift&#39;s Environment Variables
interface = ${OPENSHIFT_DIY_IP}

# Comment out the one you don&#39;t want to start.
port {
  http  = ${OPENSHIFT_DIY_PORT}
</pre></div>
</div>
</div>
<div class="section" id="sbt">
<h4>sbt引数の修正<a class="headerlink" href="#sbt" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>opensift上でsbtが動かすために、sbt起動スクリプトに以下のオプションを追加します。</p>
<p>sbt/sbt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>-Duser.home=$OPENSHIFT_REPO_DIR/fakehome -Dsbt.ivy.home=$OPENSHIFT_DATA_DIR/.ivy2 -Divy.home=$OPENSHIFT_DATA_DIR/.ivy2
</pre></div>
</div>
</div>
<div class="section" id="openshiftpush">
<h4>openshiftへのpush<a class="headerlink" href="#openshiftpush" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>アプリケーションを起動するにはopensiftへソースコードをプッシュします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">push</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-cluster"></span><div class="section" id="akkahazelcast">
<h2>AkkaとHazelcastでサーバーをクラスタリングする<a class="headerlink" href="#akkahazelcast" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Xitrumがプロキシサーバーやロードバランサーの後ろでクラスタ構成で動けるように設計されています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                                / Xitrumインスタンス1
プロキシサーバー・ロードバランサー ---- Xitrumインスタンス2
                                \ Xitrumインスタンス3
</pre></div>
</div>
<p><a class="reference external" href="http://akka.io/">Akka</a> と <a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">Hazelcast</a>
のクラスタリング機能を使ってキャッシュ、セッション、SockJSセッションをクラスタリングできます。</p>
<p>Hazelcastを使えばXitrumインスタンスがプロセス内メモリキャッシュサーバーとなります。
Memcacheのような追加サーバーは不要です。</p>
<p>AkkaとHazelcastクラスタリングを設定するには <code class="docutils literal notranslate"><span class="pre">config/akka.conf</span></code> 、 <a class="reference external" href="http://akka.io/docs/">Akka ドキュメント</a>、
<a class="reference external" href="http://hazelcast.org/documentation/">Hazelcast ドキュメント</a> を参考にしてください。</p>
<p>メモ: セッションは <a class="reference internal" href="index.html#document-scopes"><span class="doc">クライアント側のクッキーへ保存</span></a> することができます。</p>
</div>
<span id="document-handler"></span><div class="section" id="netty">
<h2>Nettyハンドラ<a class="headerlink" href="#netty" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>この章はXitrumを普通に使用する分には読む必要はありません。
理解するには <a class="reference external" href="http://netty.io/">Netty</a> の経験が必要です。</p>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Rack_(Web_server_interface)">Rack</a> 、
<a class="reference external" href="http://en.wikipedia.org/wiki/Web_Server_Gateway_Interface">WSGI</a> 、
<a class="reference external" href="http://en.wikipedia.org/wiki/PSGI">PSGI</a> にはミドルウェア構成があります。
<a class="reference external" href="http://netty.io/">Netty</a> には同じようなハンドラ構成があります。
XitrumはNettyの上で構築され、ハンドラ追加作成やハンドラのパイプライン変更などができ、
特定のユースケースにサーバーのパフォーマンスを最大化することができます。</p>
<p>この章では次の内容を説明します:</p>
<ul class="simple">
<li><p>Nettyハンドラ構成</p></li>
<li><p>Xitrumが提供するハンドラ一覧とそのデフォルト順番</p></li>
<li><p>ハンドラ一の追加作成と使用方法</p></li>
</ul>
<div class="section" id="id3">
<h3>Nettyハンドラの構成<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>それぞれのコネクションには、入出力データを処理するパイプラインがーつあります。
チャネルパイプラインは複数のハンドラによって構成され、ハンドラには以下の2種類あります:</p>
<ul class="simple">
<li><p>入力方向(Inbound): リクエスト方向クライアント -&gt; サーバー</p></li>
<li><p>出力方向(Inbound): レスポンス方向サーバー -&gt; クライアント</p></li>
</ul>
<p><a class="reference external" href="http://netty.io/4.0/api/io/netty/channel/ChannelPipeline.html">ChannelPipeline</a>
の資料を参考にしてください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                                               <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">Request</span>
                                          <span class="n">via</span> <span class="n">Channel</span> <span class="ow">or</span>
                                      <span class="n">ChannelHandlerContext</span>
                                                    <span class="o">|</span>
<span class="o">+---------------------------------------------------+---------------+</span>
<span class="o">|</span>                           <span class="n">ChannelPipeline</span>         <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>                                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+---------------------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span>  <span class="n">N</span>  <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span>  <span class="mi">1</span>  <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">|</span>                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span> <span class="n">N</span><span class="o">-</span><span class="mi">1</span> <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span>  <span class="mi">2</span>  <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">.</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">.</span>                                   <span class="o">.</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">ChannelHandlerContext</span><span class="o">.</span><span class="n">fireIN_EVT</span><span class="p">()</span> <span class="n">ChannelHandlerContext</span><span class="o">.</span><span class="n">OUT_EVT</span><span class="p">()</span><span class="o">|</span>
<span class="o">|</span>        <span class="p">[</span> <span class="n">method</span> <span class="n">call</span><span class="p">]</span>                       <span class="p">[</span><span class="n">method</span> <span class="n">call</span><span class="p">]</span>         <span class="o">|</span>
<span class="o">|</span>               <span class="o">.</span>                                   <span class="o">.</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">.</span>                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span>  <span class="mi">2</span>  <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span> <span class="n">M</span><span class="o">-</span><span class="mi">1</span> <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>               <span class="o">|</span>                                  \<span class="o">|/</span>              <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span> <span class="n">Inbound</span> <span class="n">Handler</span>  <span class="mi">1</span>  <span class="o">|</span>            <span class="o">|</span> <span class="n">Outbound</span> <span class="n">Handler</span>  <span class="n">M</span>  <span class="o">|</span>    <span class="o">|</span>
<span class="o">|</span>    <span class="o">+----------+----------+</span>            <span class="o">+-----------+----------+</span>    <span class="o">|</span>
<span class="o">|</span>              <span class="o">/|</span>\                                  <span class="o">|</span>               <span class="o">|</span>
<span class="o">+---------------+-----------------------------------+---------------+</span>
                <span class="o">|</span>                                  \<span class="o">|/</span>
<span class="o">+---------------+-----------------------------------+---------------+</span>
<span class="o">|</span>               <span class="o">|</span>                                   <span class="o">|</span>               <span class="o">|</span>
<span class="o">|</span>       <span class="p">[</span> <span class="n">Socket</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="p">]</span>                    <span class="p">[</span> <span class="n">Socket</span><span class="o">.</span><span class="n">write</span><span class="p">()</span> <span class="p">]</span>     <span class="o">|</span>
<span class="o">|</span>                                                                   <span class="o">|</span>
<span class="o">|</span>  <span class="n">Netty</span> <span class="n">Internal</span> <span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">Threads</span> <span class="p">(</span><span class="n">Transport</span> <span class="n">Implementation</span><span class="p">)</span>            <span class="o">|</span>
<span class="o">+-------------------------------------------------------------------+</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>ハンドラの追加作成<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumを起動する際に自由に
<a class="reference external" href="http://netty.io/4.0/api/io/netty/channel/ChannelInitializer.html">ChannelInitializer</a>
が設定できます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Server</span>

<span class="nb">object</span> <span class="n">Boot</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Array</span><span class="p">[</span><span class="n">String</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">Server</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">myChannelInitializer</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>HTTPSサーバーの場合、Xitrumが自動でパイプラインの先頭にSSLハンドラを追加します。
Xitrumが提供するハンドラを自分のパイプラインに再利用することも可能です。</p>
</div>
<div class="section" id="xitrum">
<h3>Xitrumが提供するハンドラ<a class="headerlink" href="#xitrum" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/handler/DefaultHttpChannelInitializer.scala">xitrum.handler.DefaultHttpChannelInitializer</a>
を参照してください。</p>
<p>共有可能なハンドラ（複数のコネクションで同じインスタンスを共有できるハンドラ）は上記
<code class="docutils literal notranslate"><span class="pre">DefaultHttpChannelInitializer</span></code> オブジェクトに置かれてあります。
使いたいXitrumハンドラを選択し自分のパイプラインに簡単に設定できます。</p>
<p>例えば、Xitrumのrouting/dispatcherは使用せずに独自のディスパッチャを使用して、
Xitrumからは静的ファイルのハンドラのみを利用する場合</p>
<p>以下のハンドラのみ設定します:</p>
<p>入力方向(Inbound):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HttpRequestDecoder</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PublicFileServer</span></code></p></li>
<li><p>独自のrouting/dispatcher</p></li>
</ul>
<p>出力方向(Outbound):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">HttpResponseEncoder</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ChunkedWriteHandler</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XSendFile</span></code></p></li>
</ul>
</div>
</div>
<span id="document-metrics"></span><div class="section" id="id1">
<h2>メトリクス<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>XitrumはあなたのアプリケーションのJVMのヒープメモリーとCPUの使用量、
そしてアクションの実行ステータスをAkkaクラスタ上の各ノードから収集します。
それらのデータはメトリクスとしてJSONデータで配信する事ができます。
またメトリクスをカスタマイズすることも可能です。</p>
<p>この機能は <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/">Coda Hale Metrics</a> を使用しています。</p>
<div class="section" id="id2">
<h3>メトリクスの収集<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="cpu">
<h4>ヒープメモリとCPU<a class="headerlink" href="#cpu" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>JVMのヒープメモリとCPUはAkkaのactor systemの各ノードから <a class="reference external" href="http://doc.akka.io/api/akka/2.3.0/index.html#akka.cluster.NodeMetrics">NodeMetrics</a> として収集されます。</p>
<p>ヒープメモリ:</p>
<img alt="_images/metrics_heapmemory.png" src="_images/metrics_heapmemory.png" />
<p>CPU: プロセッサ数とロードアベレージ</p>
<img alt="_images/metrics_cpu.png" src="_images/metrics_cpu.png" />
</div>
<div class="section" id="id3">
<h4>アクションの実行ステータス<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Xitrumは各ノードにおける各アクションの実行ステータスを <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/getting-started/#histograms">Histogram</a> として収集します。
アクションの実行回数や実行時間についてをここから知ることができます。</p>
<img alt="_images/metrics_action_count.png" src="_images/metrics_action_count.png" />
<p>特定のアクションの最新の実行時間:</p>
<img alt="_images/metrics_action_time.png" src="_images/metrics_action_time.png" />
</div>
<div class="section" id="id4">
<h4>カスタムメトリクスの収集<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>上記のメトリクスに加えて収集するメトリクスをカスタムすることができます。
<code class="docutils literal notranslate"><span class="pre">xitrum.Metrics</span></code> は <code class="docutils literal notranslate"><span class="pre">gauge</span></code>, <code class="docutils literal notranslate"><span class="pre">counter</span></code>, <code class="docutils literal notranslate"><span class="pre">meter</span></code>, <code class="docutils literal notranslate"><span class="pre">timer</span></code> そして <code class="docutils literal notranslate"><span class="pre">histogram</span></code> にアクセスするためのショートカットです。
これらの使い方は <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/">Coda Hale Metrics</a> と <a class="reference external" href="https://github.com/erikvanoosten/metrics-scala">そのScala実装</a> を参照ください。</p>
<p>例 Timer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.</span><span class="p">{</span><span class="n">Action</span><span class="p">,</span> <span class="n">Metrics</span><span class="p">}</span>
<span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>

<span class="nb">object</span> <span class="n">MyAction</span> <span class="p">{</span>
  <span class="n">lazy</span> <span class="n">val</span> <span class="n">myTimer</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;myTimer&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;my/action&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="kn">import</span> <span class="nn">MyAction._</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">myTimer</span><span class="o">.</span><span class="n">time</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Something</span> <span class="n">that</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">measure</span> <span class="n">execution</span> <span class="n">time</span>
      <span class="o">...</span>
    <span class="p">}</span>
    <span class="o">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>メトリクスの配信<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは最新のメトリクスをJSONフォーマットで定期的に配信します。
収集されたデータは揮発性であり、永続的に保存はされません。</p>
<p>ヒープメモリー:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;TYPE&quot;</span>      <span class="p">:</span> <span class="s2">&quot;heapMemory&quot;</span><span class="p">,</span>
  <span class="s2">&quot;SYSTEM&quot;</span>    <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
  <span class="s2">&quot;HOST&quot;</span>      <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
  <span class="s2">&quot;PORT&quot;</span>      <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
  <span class="s2">&quot;HASH&quot;</span>      <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">hashCode</span><span class="p">,</span>
  <span class="s2">&quot;TIMESTAMP&quot;</span> <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">NodeMetrics</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
  <span class="s2">&quot;USED&quot;</span>      <span class="p">:</span> <span class="n">Number</span> <span class="k">as</span> <span class="n">byte</span><span class="p">,</span>
  <span class="s2">&quot;COMMITTED&quot;</span> <span class="p">:</span> <span class="n">Number</span> <span class="k">as</span> <span class="n">byte</span><span class="p">,</span>
  <span class="s2">&quot;MAX&quot;</span>       <span class="p">:</span> <span class="n">Number</span> <span class="k">as</span> <span class="n">byte</span>
<span class="p">}</span>
</pre></div>
</div>
<p>CPU:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;TYPE&quot;</span>              <span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
  <span class="s2">&quot;SYSTEM&quot;</span>            <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">system</span><span class="p">,</span>
  <span class="s2">&quot;HOST&quot;</span>              <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
  <span class="s2">&quot;PORT&quot;</span>              <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
  <span class="s2">&quot;HASH&quot;</span>              <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">Address</span><span class="o">.</span><span class="n">hashCode</span><span class="p">,</span>
  <span class="s2">&quot;TIMESTAMP&quot;</span>         <span class="p">:</span> <span class="n">akka</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">NodeMetrics</span><span class="o">.</span><span class="n">timestamp</span>
  <span class="s2">&quot;SYSTEMLOADAVERAGE&quot;</span> <span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
  <span class="s2">&quot;CPUCOMBINED&quot;</span>       <span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
  <span class="s2">&quot;PROCESSORS&quot;</span>        <span class="p">:</span> <span class="n">Number</span>
<span class="p">}</span>
</pre></div>
</div>
<p>メトリクスレジストリは <a class="reference external" href="http://metrics.dropwizard.io/3.1.0/manual/json/">metrics-json</a> によってパースされます。.</p>
<div class="section" id="xitrum">
<h4>Xitrumデフォルトビューア<a class="headerlink" href="#xitrum" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>Xitrumはデフォルトで次のURLにメトリクスビューアを提供します。<code class="docutils literal notranslate"><span class="pre">/xitrum/metrics/viewer?api_key=&lt;xitrum.confの中のキー&gt;</span></code>
このURLでは上記のような <a class="reference external" href="http://d3js.org/">D3.js</a> によって生成されたグラフを参照することができます。</p>
<p>URLが動的に算出できます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Config</span>
<span class="kn">import</span> <span class="nn">xitrum.metrics.XitrumMetricsViewer</span>

<span class="n">url</span><span class="p">[</span><span class="n">XitrumMetricsViewer</span><span class="p">](</span><span class="s2">&quot;api_key&quot;</span> <span class="o">-&gt;</span> <span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">apiKey</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="jconsole">
<h4>Jconsoleビューア<a class="headerlink" href="#jconsole" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><a class="reference external" href="http://metrics.dropwizard.io/3.1.0/getting-started/#reporting-via-jmx">JVM Reporter</a> を使用することも可能です。</p>
<img alt="_images/metrics_jconsole.png" src="_images/metrics_jconsole.png" />
<p>JVM Reporterの開始方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.codahale.metrics.JmxReporter</span>

<span class="nb">object</span> <span class="n">Boot</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Array</span><span class="p">[</span><span class="n">String</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">Server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">JmxReporter</span><span class="o">.</span><span class="n">forRegistry</span><span class="p">(</span><span class="n">xitrum</span><span class="o">.</span><span class="n">Metrics</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>アプリケーション起動後 <a class="reference external" href="http://docs.oracle.com/javase/7/docs/technotes/guides/management/jconsole.html">jconsole</a> コマンドをターミナルから実行します。</p>
</div>
<div class="section" id="id8">
<h4>カスタムビューア<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>メトリクスはJSONとしてSockJS URL <code class="docutils literal notranslate"><span class="pre">xitrum/metrics/channel</span></code> から取得する事ができます。
<code class="docutils literal notranslate"><span class="pre">jsAddMetricsNameSpace</span></code> はそのURLへ接続するためのJavaScriptスニペットをビューに出力します。
JavaScriptでJSONハンドラを実装し、<code class="docutils literal notranslate"><span class="pre">initMetricsChannel</span></code> を呼び出してください。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.annotation.GET</span>
<span class="kn">import</span> <span class="nn">xitrum.metrics.MetricsViewer</span>

<span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;my/metrics/viewer&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MySubscriber</span> <span class="n">extends</span> <span class="n">MetricsViewer</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">jsAddMetricsNameSpace</span><span class="p">(</span><span class="s2">&quot;window&quot;</span><span class="p">)</span>
    <span class="n">jsAddToView</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">      function onValue(json) {</span>
<span class="s2">        console.log(json);</span>
<span class="s2">      }</span>
<span class="s2">      function onClose(){</span>
<span class="s2">        console.log(&quot;channel closed&quot;);</span>
<span class="s2">      }</span>
<span class="s2">      window.initMetricsChannel(onValue, onClose);</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">respondView</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h4>メトリクスの保存<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>メモリ消費を抑制するため、Xitrumは過去のメトリクス情報について保持することはありません。
データベースやファイルへの書き出しが必要な場合、独自のサブスクライバーを実装する必要があります。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">akka.actor.Actor</span>
<span class="kn">import</span> <span class="nn">xitrum.metrics.PublisherLookUp</span>

<span class="k">class</span> <span class="nc">MySubscriber</span> <span class="n">extends</span> <span class="n">Actor</span> <span class="k">with</span> <span class="n">PublisherLookUp</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">preStart</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">lookUpPublisher</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">receive</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">_</span> <span class="o">=&gt;</span>
  <span class="p">}</span>

  <span class="n">override</span> <span class="k">def</span> <span class="nf">doWithPublisher</span><span class="p">(</span><span class="n">globalPublisher</span><span class="p">:</span> <span class="n">ActorRef</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">context</span><span class="o">.</span><span class="n">become</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">When</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">multinode</span> <span class="n">environment</span>
      <span class="n">case</span> <span class="n">multinodeMetrics</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">NodeMetrics</span><span class="p">]</span> <span class="o">=&gt;</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">to</span> <span class="n">DB</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>

      <span class="o">//</span> <span class="n">When</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">single</span> <span class="n">node</span> <span class="n">environment</span>
      <span class="n">case</span> <span class="n">nodeMetrics</span><span class="p">:</span> <span class="n">NodeMetrics</span> <span class="o">=&gt;</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">to</span> <span class="n">DB</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>

      <span class="n">case</span> <span class="n">Publish</span><span class="p">(</span><span class="n">registryAsJson</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="o">//</span> <span class="n">Save</span> <span class="n">to</span> <span class="n">DB</span> <span class="ow">or</span> <span class="n">write</span> <span class="n">to</span> <span class="n">file</span><span class="o">.</span>

      <span class="n">case</span> <span class="n">_</span> <span class="o">=&gt;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-howto"></span><div class="section" id="howto">
<h2>HOWTO<a class="headerlink" href="#howto" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>この章ではいくつかの小さなtipsを紹介します。</p>
<div class="section" id="id1">
<h3>ベーシック認証<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>サイト全体や特定のアクションに <a class="reference external" href="http://ja.wikipedia.org/wiki/Basic%E8%AA%8D%E8%A8%BC">ベーシック認証</a> を適用することができます。</p>
<p><a class="reference external" href="http://ja.wikipedia.org/wiki/Digest%E8%AA%8D%E8%A8%BC">ダイジェスト認証</a> についてはman-in-the-middle攻撃に対して脆弱であることから、
Xitrumではサポートしていません。</p>
<p>よりセキュアなアプリケーションとするには、HTTPSを使用することを推奨します。（XitrumはApacheやNginxをリバースプロキシとして使用することなく、単独でHTTPSサーバを構築する事ができます。）</p>
<div class="section" id="id4">
<h4>サイト全体のベーシック認証設定<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> に以下を記載:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;basicAuth&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="s2">&quot;realm&quot;</span><span class="p">:</span>    <span class="s2">&quot;xitrum&quot;</span><span class="p">,</span>
  <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;xitrum&quot;</span><span class="p">,</span>
  <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;xitrum&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4>特定のアクションのベーシック認証設定<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>

<span class="k">class</span> <span class="nc">MyAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">beforeFilter</span> <span class="p">{</span>
    <span class="n">basicAuth</span><span class="p">(</span><span class="s2">&quot;Realm&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="n">username</span> <span class="o">==</span> <span class="s2">&quot;username&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">password</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>設定ファイルのロード<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="json">
<h4>JSONファイル<a class="headerlink" href="#json" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>JSONはネストした設定を記載するのに適した構造をしています。</p>
<p><code class="docutils literal notranslate"><span class="pre">config</span></code> ディレクトリに設定ファイルを保存します。
このディレクトリは、デベロップメントモードではbuild.sbtによって、プロダクションモードでは、<code class="docutils literal notranslate"><span class="pre">script/runner</span></code> (または <code class="docutils literal notranslate"><span class="pre">script/runner.bat</span></code> ) によって
自動的にクラスパスに含められます。</p>
<p>myconfig.json:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;God&quot;</span><span class="p">,</span>
  <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;Does God need a password?&quot;</span><span class="p">,</span>
  <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adam&quot;</span><span class="p">,</span> <span class="s2">&quot;Eva&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ロード方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Loader</span>

<span class="n">case</span> <span class="k">class</span> <span class="nc">MyConfig</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">children</span><span class="p">:</span> <span class="n">Seq</span><span class="p">[</span><span class="n">String</span><span class="p">])</span>
<span class="n">val</span> <span class="n">myConfig</span> <span class="o">=</span> <span class="n">Loader</span><span class="o">.</span><span class="n">jsonFromClasspath</span><span class="p">[</span><span class="n">MyConfig</span><span class="p">](</span><span class="s2">&quot;myconfig.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>備考:</p>
<ul class="simple">
<li><p>キーと文字列はダブルコーテーションで囲まれている必要があります。</p></li>
<li><p>現時点でJSONファイルにコメントを記載することはできません。</p></li>
</ul>
</div>
<div class="section" id="id7">
<h4>プロパティファイル<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>プロパティファイルを使用することもできます。
プロパティファイルは型安全ではないこと、UTF-8をサポートしてないこと、ネスト構造をサポートしていないことから、
JSONファイルを使用することができるのであれば、JSONを使用することをお勧めします。</p>
<p>myconfig.properties:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>username = God
password = Does God need a password?
children = Adam, Eva
</pre></div>
</div>
<p>ロード方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Loader</span>

<span class="o">//</span> <span class="n">Here</span> <span class="n">you</span> <span class="n">get</span> <span class="n">an</span> <span class="n">instance</span> <span class="n">of</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Properties</span>
<span class="n">val</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">Loader</span><span class="o">.</span><span class="n">propertiesFromClasspath</span><span class="p">(</span><span class="s2">&quot;myconfig.properties&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h4>型安全な設定ファイル<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>XitrumはAkkaを内包しています。Akkaには <a class="reference external" href="http://typesafe.com/company">Typesafe社</a> 製の <a class="reference external" href="https://github.com/typesafehub/config">config</a> というライブラリをが含まれており、設定ファイルロードについて、よりベターやり方を提供してくれます。</p>
<p>myconfig.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>username = God
password = Does God need a password?
children = [&quot;Adam&quot;, &quot;Eva&quot;]
</pre></div>
</div>
<p>ロード方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">com.typesafe.config.</span><span class="p">{</span><span class="n">Config</span><span class="p">,</span> <span class="n">ConfigFactory</span><span class="p">}</span>

<span class="n">val</span> <span class="n">config</span>   <span class="o">=</span> <span class="n">ConfigFactory</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;myconfig.conf&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">username</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">password</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">children</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getStringList</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id9">
<h3>シリアライズとデシリアライズ<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Array[Byte]</span></code> へのシリアライズ:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.SeriDeseri</span>
<span class="n">val</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toBytes</span><span class="p">(</span><span class="s2">&quot;my serializable object&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>バイト配列からのデシリアライズ:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">option</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromBytes</span><span class="p">[</span><span class="n">MyType</span><span class="p">](</span><span class="nb">bytes</span><span class="p">)</span>  <span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">MyType</span><span class="p">]</span>
</pre></div>
</div>
<p>ファイルへの保存:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Loader</span>
<span class="n">Loader</span><span class="o">.</span><span class="n">bytesToFile</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="s2">&quot;myObject.bin&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>ファイルからの読み込み:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="n">Loader</span><span class="o">.</span><span class="n">bytesFromFile</span><span class="p">(</span><span class="s2">&quot;myObject.bin&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id10">
<h3>データの暗号化<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>復号化する必要がないデータの暗号化にはMD5等を使用することができます。
復号化する必要があるデータを暗号化する場合、<code class="docutils literal notranslate"><span class="pre">xitrum.util.Secure</span></code> を使用します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.Secure</span>

<span class="o">//</span> <span class="n">Array</span><span class="p">[</span><span class="n">Byte</span><span class="p">]</span>
<span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&quot;my data&quot;</span><span class="o">.</span><span class="n">getBytes</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="n">Byte</span><span class="p">]]</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
</pre></div>
</div>
<p>レスポンスするHTMLに埋め込むなど、バイナリデータを文字列にエンコード/デコードする場合、
<code class="docutils literal notranslate"><span class="pre">xitrum.util.UrlSafeBase64</span></code> を使用します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">cookieなどのURLに含まれるデータをエンコード</span>
<span class="n">val</span> <span class="n">string</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">noPaddingEncode</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">Array</span><span class="p">[</span><span class="n">Byte</span><span class="p">]]</span>
<span class="n">val</span> <span class="n">encrypted2</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">autoPaddingDecode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</pre></div>
</div>
<p>上記の操作の組み合わせを1度に行う場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.util.SeriDeseri</span>

<span class="n">val</span> <span class="n">mySerializableObject</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MySerializableClass</span>

<span class="o">//</span> <span class="n">String</span>
<span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toSecureUrlSafeBase64</span><span class="p">(</span><span class="n">mySerializableObject</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Option</span><span class="p">[</span><span class="n">MySerializableClass</span><span class="p">]</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromSecureUrlSafeBase64</span><span class="p">[</span><span class="n">MySerializableClass</span><span class="p">](</span><span class="n">encrypted</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SeriDeseri</span></code> はシリアライズとデシリアライズに <a class="reference external" href="https://github.com/twitter/chill">Twitter Chill</a> を使用しています。
シリアライズ対象のデータはシリアライズ可能なものである必要があります。</p>
<p>暗号化キーの指定方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&quot;my data&quot;</span><span class="o">.</span><span class="n">getBytes</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">Secure</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">encrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">toSecureUrlSafeBase64</span><span class="p">(</span><span class="n">mySerializableObject</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
<span class="n">val</span> <span class="n">decrypted</span> <span class="o">=</span> <span class="n">SeriDeseri</span><span class="o">.</span><span class="n">fromSecureUrlSafeBase64</span><span class="p">[</span><span class="n">MySerializableClass</span><span class="p">](</span><span class="n">encrypted</span><span class="p">,</span> <span class="s2">&quot;my key&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>キーが指定されない場合、<code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> に記載された <code class="docutils literal notranslate"><span class="pre">secureKey</span></code> が使用されます。</p>
</div>
<div class="section" id="id11">
<h3>同一ドメイン配下における複数サイトの構成<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>同一ドメイン配下に、Nginx等のリバースプロキシを動かして、以下の様な複数のサイトを構成する場合、</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">site1</span><span class="o">/...</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">site2</span><span class="o">/...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">config/xitrum.conf</span></code> にて、 <code class="docutils literal notranslate"><span class="pre">baseUrl</span></code> を設定することができます。</p>
<p>JavaScriptからAjaxリクエスを行う正しいURLを取得するには、<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/js.scala">xitrum.js</a> の、<code class="docutils literal notranslate"><span class="pre">withBaseUrl</span></code> メソッドを使用します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 現在のサイトのbaseUrlが &quot;site1&quot; の場合、</span>
<span class="c1"># 結果は /site1/path/to/my/action になります。</span>
<span class="n">xitrum</span><span class="o">.</span><span class="n">withBaseUrl</span><span class="p">(</span><span class="s1">&#39;/path/to/my/action&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="markdownhtml">
<h3>MarkdownからHTMLへの変換<a class="headerlink" href="#markdownhtml" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>テンプレートエンジンとして、<a class="reference internal" href="index.html#document-template_engines"><span class="doc">Scalate</span></a> を使用するプロジェクトの場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.fusesource.scalamd.Markdown</span>
<span class="n">val</span> <span class="n">html</span> <span class="o">=</span> <span class="n">Markdown</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Scalateを使用しない場合、
build.sbtに以下の依存ライブラリを追記する必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s2">&quot;org.fusesource.scalamd&quot;</span> <span class="o">%%</span> <span class="s2">&quot;scalamd&quot;</span> <span class="o">%</span> <span class="s2">&quot;1.6&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>一時ディレクトリ<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>デフォルト( <code class="docutils literal notranslate"><span class="pre">xitrum.conf</span></code> の <code class="docutils literal notranslate"><span class="pre">tmpDir</span></code> の設定内容)では、カレントディレクトリ内の <code class="docutils literal notranslate"><span class="pre">tmp</span></code> というディレクトリが
一時ディレクトリとして、Scalateによってい生成された .scalaファイルや、大きなファイルのアップロードなどに使用されます。</p>
<p>プログラムから一時ディレクトリを使用する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xitrum</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">tmpDir</span><span class="o">.</span><span class="n">getAbsolutePath</span>
</pre></div>
</div>
<p>新規ファイルやディレクトリを一時ディレクトリに作成する場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">file</span> <span class="o">=</span> <span class="n">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">xitrum</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">tmpDir</span><span class="p">,</span> <span class="s2">&quot;myfile&quot;</span><span class="p">)</span>

<span class="n">val</span> <span class="nb">dir</span> <span class="o">=</span> <span class="n">new</span> <span class="n">java</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">xitrum</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">xitrum</span><span class="o">.</span><span class="n">tmpDir</span><span class="p">,</span> <span class="s2">&quot;mydir&quot;</span><span class="p">)</span>
<span class="nb">dir</span><span class="o">.</span><span class="n">mkdirs</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>ビデオストリーミング<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ビデオをストリーミングする方法はいくつかあります。
最も簡単な方法は:</p>
<ul class="simple">
<li><p>インターリーブされた.mp4ファイルをサーバに配置することで、ユーザーはダウンロード中にビデオを再生することができます。</p></li>
<li><p>そして、Xitrumのように <a class="reference external" href="http://en.wikipedia.org/wiki/Byte_serving">range requests</a> をサポートしたHTTPサーバーを用いることで、
ユーザーはダウンロードされていない部分をスキップしてビデオを利用することができます。</p></li>
</ul>
<p><a class="reference external" href="http://gpac.wp.mines-telecom.fr/mp4box/">MP4Box</a> を利用することで、
動画ファイルを500ミリ秒毎のチャンクにインターリーブすることができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MP4Box</span> <span class="o">-</span><span class="n">inter</span> <span class="mi">500</span> <span class="n">movie</span><span class="o">.</span><span class="n">mp4</span>
</pre></div>
</div>
</div>
</div>
<span id="document-deps"></span><div class="section" id="id1">
<h2>依存関係<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id2">
<h3>依存ライブラリ<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Xitrumは以下のライブラリにが依存しています。
つまりあなたのXitrumプロジェクトはこれらのライブラリを直接使用することができます。</p>
<img alt="_images/deps.png" src="_images/deps.png" />
<p>主な依存ライブラリ:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.scala-lang.org/">Scala</a>:
XitrumはScalaで書かれています。</p></li>
<li><p><a class="reference external" href="https://netty.io/">Netty</a>:
WebSocketやゼロコピーファイルサービングなど
Xitrumの非同期HTTP(S)サーバの多くの機能はNettyの機能を元に実現しています。</p></li>
<li><p><a class="reference external" href="http://akka.io/">Akka</a>:
主にSockJSのために。Akkaは <a class="reference external" href="https://github.com/typesafehub/config">Typesafe Config</a>
に依存しており、Xitrumもまたそれを使用しています。</p></li>
</ul>
<p>その他の主な依存ライブラリ:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://commons.apache.org/lang/">Commons Lang</a>:
JSONデータのエスケープに使用しています。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/glokka">Glokka</a>:
SockJS アクターのクラスタリングに使用しています。</p></li>
<li><p><a class="reference external" href="https://github.com/json4s/json4s">JSON4S</a>:
JSONのパースと生成のために使用します。
JSON4Sは <a class="reference external" href="http://paranamer.codehaus.org/">Paranamer</a> を依存ライブラリとして使用しています。</p></li>
<li><p><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Rhino">Rhino</a>:
Scalate内でCoffeeScriptをJavaScriptにコンパイルするために使用しています。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/sclasner">Sclasner</a>:
クラスファイルとjarファイルからHTTPルートをスキャンするために使用しています。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/scaposer">Scaposer</a>:
国際化対応のために使用しています。</p></li>
<li><p><a class="reference external" href="https://github.com/twitter/chill">Twitter Chill</a>:
クッキーとセッションのシリアライズ・デシリアライズに使用しています。
Chillは <a class="reference external" href="http://code.google.com/p/kryo/">Kryo</a> を元にしています。</p></li>
<li><p><a class="reference external" href="http://slf4s.org/">SLF4S</a>, <a class="reference external" href="http://logback.qos.ch/">Logback</a>:
ロギングに使用しています。</p></li>
</ul>
<p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new">Xitrum プロジェクトスケルトン</a> は</p>
<p>以下のツールを梱包しています:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/scala-xgettext">scala-xgettext</a>:
コンパイル時に .scala ファイルから <a class="reference internal" href="index.html#document-i18n"><span class="doc">国際化対応</span></a> 文字列を展開します。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-package">xitrum-package</a>:
本番環境へデプロイするために <a class="reference internal" href="index.html#document-deploy"><span class="doc">プロジェクトをパッケージング</span></a> します。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/scalive">Scalive</a>:
ScalaコンソールからJVMプロセスに接続し、動的なデバッギングを可能にします。</p></li>
</ul>
</div>
<div class="section" id="id3">
<h3>関連プロジェクト<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>デモ:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-new">xitrum-new</a>:
新規Xitrumプロジェクトのスケルトン。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-demos">xitrum-demos</a>:
Xitrumの各機能のデモプロジェクト。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-placeholder">xitrum-placeholder</a>:
Xitrumによる画像イメージアプリのデモ。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/comy">comy</a>:
XitrumによるURLショートナーアプリのデモ。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-multimodule-demo">xitrum-multimodule-demo</a>:
<a class="reference external" href="http://www.scala-sbt.org/">SBT</a> マルチモジュールプロジェクトのデモ。</p></li>
</ul>
<p>プラグイン:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-scalate">xitrum-scalate</a>:
Xitrumのデフォルトテンプレートエンジン。<a class="reference external" href="https://github.com/xitrum-framework/xitrum-new">Xitrum プロジェクトスケルトン</a> で使用しています。
別のテンプレートエンジンを使用することも、また必要がなければプロジェクトから削除してしまうことも可能です。
xitrum-scalateは <a class="reference external" href="http://scalate.fusesource.org/">Scalate</a> と <a class="reference external" href="https://github.com/chirino/scalamd">Scalamd</a> に依存しています。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">xitrum-hazelcast</a>:
キャッシュとサーバーサイドセッションのクラスタリングを行うプラグイン。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-ko">xitrum-ko</a>:
<a class="reference external" href="http://knockoutjs.com/">Knockoutjs</a> を簡単に使うためのプラグイン。</p></li>
</ul>
<p>その他のプロジェクト:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-doc">xitrum-doc</a>:
<a class="reference external" href="http://xitrum-framework.github.io/guide.html">Xitrum Guide</a> のソースコード。</p></li>
<li><p><a class="reference external" href="https://github.com/xitrum-framework/xitrum-framework.github.io">xitrum-hp</a>:
<a class="reference external" href="http://xitrum-framework.github.io/">Xitrum Homepage</a> のソースコード。</p></li>
</ul>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">目次</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-intro">はじめに</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">特徴</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">貢献者</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-tutorial">チュートリアル</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum">Xitrumプロジェクトの作成</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">起動</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#eclipse">Eclipseプロジェクトの作成</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#intellij-idea">IntelliJ IDEAプロジェクトのインポート</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">自動リロード</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#ide">IDEを使用する場合</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id7">SBTを使用する場合</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#dcevm">DCEVM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ignore">ignoreファイルの設定</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-action_view">Action と view</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#action">Action</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#futureaction">FutureAction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#actoraction">ActorAction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">クライアントへのレスポンス送信</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#view">テンプレートViewファイルのレスポンス</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#currentaction">currentActionのキャスト</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id2">Mustache</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#coffeescript">CoffeeScript</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">レイアウト</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id5">独立したレイアウトファイルを使用しないパターン</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#respondview">respondViewにレイアウトを直接指定するパターン</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#respondinlineview">respondInlineView</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#renderfragment">renderFragment</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">別のアクションに紐付けられたViewをレスポンスする場合</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id7">ひとつのアクションに複数のViewを紐付ける方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#component">Component</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-restful">RESTful APIs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">ルートのキャッシング</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#firstlast">ルートの優先順位(first、last)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#action">Actionへの複数パスの関連付け</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">ドットを含むルート</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">正規表現によるルーティング</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">パスの残り部分の取得</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">アクションへのリンク</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">他のアクションへのリダイレクト</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">他のアクションへのフォワード</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ajax">Ajaxリクエストの判定</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#csrf">CSRF対策</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#csrfcsrf">CSRF対策インプットとCSRF対策トークン</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">CSRFチェックの省略</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">ルーティングの操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">リクエストコンテンツの取得</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#swaggerapi">SwaggerによるAPIドキュメンテーション</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-template_engines">テンプレートエンジン</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">テンプレートエンジンの設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">テンプレートエンジンの削除</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">テンプレートエンジンの作成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-postback">ポストバック</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">レイアウト</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">フォーム</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#form">formエレメント以外への適用</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">コンファームダイアログ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">パラメーターの追加</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">ローディングイメージの表示</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-xml">XML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">XMLのアンエスケープ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">XMLエレメントのグループ化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xhtml">XHTMLの描画</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-js">JavaScript と JSON</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#javascript">JavaScript</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#javascriptview">JavaScriptフラグメントをViewに追加する方法</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id1">JavaScriptを直接レスポンスする方法</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#json">JSON</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#knockout-js">Knockout.jsプラグイン</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-async">非同期レスポンス</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#websocket">WebSocket</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#sockjs">SockJS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#chunk">Chunkレスポンス</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#iframe">無限iframe</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#event-source">Event Source</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-static">静的ファイル</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">ディスク上の静的ファイルの配信</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#index-html">index.htmlへのフォールバック</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">404 と 500</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#webjar">WebJarによるクラスパス上のリソースファイルの配信</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#webjars">WebJars</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">WebJars形式によるリソースの保存</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id11">クラスパス上の要素をレスポンスする場合</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#etagmax-age">ETagとmax-ageによるクライアントサイドキャッシュ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#gzip">GZIP</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id14">サーバーサイドキャッシュ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-flash">Flashのソケットポリシーファイル</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-scopes">スコープ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">リクエストスコープ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id3">リクエストパラメーター</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id4">パラメーターへのアクセス</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#at">&quot;at&quot;</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#atjson">&quot;atJson&quot;</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#requestvar">RequestVar</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">クッキー</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id6">クッキーに使用可能な文字</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">セッション</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#session-clear">session.clear()</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#sessionvar">SessionVar</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">セッションストア</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#object-vs-val">object vs. val</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-validation">バリデーション</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">デフォルトバリデーター</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">カスタムバリデーターの作成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-upload">ファイルアップロード</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#ajax">Ajax風ファイルアップロード</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-filter">アクションフィルター</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#before">Beforeフィルター</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#after">Afterフィルター</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#around">Aroundフィルター</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">フィルターの実行順番</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cache">サーバーサイドキャッシュ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">ページまたはアクションのキャッシュ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">オブジェクトのキャッシュ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">キャッシュの削除</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">キャッシュエンジンの設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">キャッシュ動作の仕組み</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-util-locallrucache">xitrum.util.LocalLruCache</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-i18n">I18n</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">ソースコード内への国際化メッセージの記載</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#pot">potファイルへのメッセージの展開</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#po">po ファイルの保存先</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">言語の設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">バリデーションメッセージ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">複数形への対応</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">日付と数値のフォーマット</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-log">ログ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-log">xitrum.Logオブジェクトを直接使用する</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">xitrum.Logトレイトを直接使用する</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">ログレベルをチェックする必要はありません</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id5">ログレベル、ログファイル等の設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#fluentd">Fluentd へのログ出力</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deploy">プロダクション環境へのデプロイ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">ディレクトリのパッケージ化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum-package">xitrum-packageのカスタマイズ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#jvmscala">稼働中のJVMプロセスに対するScalaコンソール接続</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#centosubuntuoraclejdk">CentOSまたはUbuntuへのOracleJDKインストール</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum">システム起動時にXitrumをスタートさせる</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id8">ポートフォワーディングの設定</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#linux">大量コネクションに対するLinux設定</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">ファイルディスクリプタ数の上限設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id10">カーネルのチューニング</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id11">バックログについて</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#haproxy-tips">HAProxy tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#nginx-tips">Nginx tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#heroku">Herokuへのデプロイ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id17">サインアップとリポジトリの作成</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#procfile">Procfileの作成</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#port">Port設定の変更</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id20">ログレベルの設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id21"><code class="docutils literal notranslate"><span class="pre">xitrum-package</span></code> のエイリアス作成</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id22">Herokuへのプッシュ</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#openshift">OpenShiftへのデプロイ</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id24">サインアップとリポジトリの作成</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id26">プロジェクト構成</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#action-hooks">action_hooksの作成</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#ip-port">IP:Port設定の変更</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#sbt">sbt引数の修正</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#openshiftpush">openshiftへのpush</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cluster">AkkaとHazelcastでサーバーをクラスタリングする</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-handler">Nettyハンドラ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">Nettyハンドラの構成</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id4">ハンドラの追加作成</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#xitrum">Xitrumが提供するハンドラ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-metrics">メトリクス</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">メトリクスの収集</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#cpu">ヒープメモリとCPU</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id3">アクションの実行ステータス</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id4">カスタムメトリクスの収集</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">メトリクスの配信</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#xitrum">Xitrumデフォルトビューア</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#jconsole">Jconsoleビューア</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id8">カスタムビューア</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id9">メトリクスの保存</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-howto">HOWTO</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id1">ベーシック認証</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id4">サイト全体のベーシック認証設定</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id5">特定のアクションのベーシック認証設定</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id6">設定ファイルのロード</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#json">JSONファイル</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id7">プロパティファイル</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#id8">型安全な設定ファイル</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id9">シリアライズとデシリアライズ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id10">データの暗号化</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id11">同一ドメイン配下における複数サイトの構成</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#markdownhtml">MarkdownからHTMLへの変換</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id12">一時ディレクトリ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id13">ビデオストリーミング</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-deps">依存関係</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#id2">依存ライブラリ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#id3">関連プロジェクト</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="#">Xitrum Scala Web Framework Guide 3.30.0 ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Xitrum Scala Web Framework Guide 3.30.0 ドキュメント</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Ngoc Dao.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>
