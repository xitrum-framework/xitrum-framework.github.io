
<!DOCTYPE html>

<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scopes &#8212; Tài liệu Xitrum Scala Web Framework Guide 3.30.0</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="next" title="Validation" href="validation.html" />
    <link rel="prev" title="Cung cấp flash socket policy file" href="flash.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Điều hướng</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Chỉ mục chung"
             accesskey="I">chỉ mục</a></li>
        <li class="right" >
          <a href="validation.html" title="Validation"
             accesskey="N">xem tiếp</a> |</li>
        <li class="right" >
          <a href="flash.html" title="Cung cấp flash socket policy file"
             accesskey="P">xem lại</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Tài liệu Xitrum Scala Web Framework Guide 3.30.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Scopes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="scopes">
<h1>Scopes<a class="headerlink" href="#scopes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="request">
<h2>Request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cac-loai-parameter">
<h3>Các loại parameter<a class="headerlink" href="#cac-loai-parameter" title="Permalink to this headline">¶</a></h3>
<p>Có 2 loại request parameter: textual parameter và file upload parameter (binary).</p>
<p>Có 3 loại textual parameter, thuộc kiểu <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Seq[String]]</span></code>:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">queryParams</span></code>: parameter nằm sau dấu ? trong URL ,ví dụ : <a class="reference external" href="http://example.com/blah?x=1&amp;y=2">http://example.com/blah?x=1&amp;y=2</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bodyTextParams</span></code>: parameter trong phần body của POST request</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pathParams</span></code>: parameter nhúng trong URL, ví dụ: <code class="docutils literal notranslate"><span class="pre">GET(&quot;articles/:id/:title&quot;)</span></code></p></li>
</ol>
<p>Các parameter được gộp thành kiểu <code class="docutils literal notranslate"><span class="pre">textParams</span></code> (từ 1 đến 3, kiểu sau sẽ override kiểu trước).</p>
<p><code class="docutils literal notranslate"><span class="pre">bodyFileParams</span></code> thuộc kiểu scala.collection.mutable.Map[String, Seq[<a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/multipart/FileUpload.html">FileUpload</a>]].</p>
</div>
<div class="section" id="truy-xuat-cac-parameter">
<h3>Truy xuất các parameter<a class="headerlink" href="#truy-xuat-cac-parameter" title="Permalink to this headline">¶</a></h3>
<p>Từ một action, bạn có thể truy cập đến các parameter trực tiếp, hoặc bạn có thể
sử dụng các accessor method.</p>
<p>Để truy cập <code class="docutils literal notranslate"><span class="pre">textParams</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">param(&quot;x&quot;)</span></code>: trả về <code class="docutils literal notranslate"><span class="pre">String</span></code>, throws exception nếu x không tồn tại</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paramo(&quot;x&quot;)</span></code>: trả về <code class="docutils literal notranslate"><span class="pre">Option[String]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params(&quot;x&quot;)</span></code>: trả về <code class="docutils literal notranslate"><span class="pre">Seq[String]</span></code>, Seq.empty nếu x không tồn tại</p></li>
</ul>
<p>Bạn có thể convert các text parameter thành các kiểu khác như Int, Long, Float, Double
một các tự động bằng cách sử dụng <code class="docutils literal notranslate"><span class="pre">param[Int](&quot;x&quot;)</span></code>, <code class="docutils literal notranslate"><span class="pre">params[Int](&quot;x&quot;)</span></code> v.v. Để convert
các text parameter thành các kiểu khác, override
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala-2.11/xitrum/scope/request/ParamAccess.scala">convertTextParam</a>.</p>
<p>Với các file upload parameter: <code class="docutils literal notranslate"><span class="pre">param[FileUpload](&quot;x&quot;)</span></code>, <code class="docutils literal notranslate"><span class="pre">params[FileUpload](&quot;x&quot;)</span></code> v.v.
Để biết chi tiết, hãy xem <a class="reference internal" href="upload.html"><span class="doc">Chương Upload</span></a>.</p>
</div>
<div class="section" id="at">
<h3>&quot;at&quot;<a class="headerlink" href="#at" title="Permalink to this headline">¶</a></h3>
<p>Để truyền tham số khi thực hiện một request (từ action đến view hoặc layout), có thể
sử dụng <code class="docutils literal notranslate"><span class="pre">at</span></code>. <code class="docutils literal notranslate"><span class="pre">at</span></code> thuộc kiểu <code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.HashMap[String,</span> <span class="pre">Any]</span></code>.
Nếu bạn từng tiếp xúc với Rails, bạn sẽ nhận ra rằng <code class="docutils literal notranslate"><span class="pre">at</span></code> là một bản sao của <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>
trong Rails.</p>
<p>Articles.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>  <span class="o">//</span> <span class="n">Get</span> <span class="kn">from</span> <span class="nn">DB</span>
    <span class="n">at</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">))</span> <span class="s2">&quot;My Site - &quot;</span> <span class="o">+</span> <span class="n">at</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;My Site&quot;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="atjson">
<h3>&quot;atJson&quot;<a class="headerlink" href="#atjson" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">atJson</span></code> là một helper method tự động convert <code class="docutils literal notranslate"><span class="pre">at(&quot;key&quot;)</span></code> sang JSON.
Khi bạn cần chuyển model từ Scala sang JavaScript.</p>
<p><code class="docutils literal notranslate"><span class="pre">atJson(&quot;key&quot;)</span></code> tương đương với <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.toJson(at(&quot;key&quot;))</span></code>:</p>
<p>Action.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">case</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">login</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">at</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span> <span class="s2">&quot;Admin&quot;</span><span class="p">)</span>
  <span class="n">respondView</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Action.ssp</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;script type=&quot;text/javascript&quot;&gt;
  var user = ${atJson(&quot;user&quot;)};
  alert(user.login);
  alert(user.name);
&lt;/script&gt;
</pre></div>
</div>
</div>
<div class="section" id="requestvar">
<h3>RequestVar<a class="headerlink" href="#requestvar" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">at</span></code> không typesafe bởi vì bạn có thể đặt mọi thứ vào trong map. Để typesafe
hơn, bạn nên sử dụng RequestVar một class đóng gói <code class="docutils literal notranslate"><span class="pre">at</span></code>.</p>
<p>RVar.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.RequestVar</span>

<span class="nb">object</span> <span class="n">RVar</span> <span class="p">{</span>
  <span class="nb">object</span> <span class="n">title</span> <span class="n">extends</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Articles.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;articles/:id&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ArticlesShow</span> <span class="n">extends</span> <span class="n">AppAction</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">val</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>  <span class="o">//</span> <span class="n">Get</span> <span class="kn">from</span> <span class="nn">DB</span>
    <span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">respondInlineView</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>AppAction.scala</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.Action</span>
<span class="kn">import</span> <span class="nn">xitrum.view.DocType</span>

<span class="n">trait</span> <span class="n">AppAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="n">override</span> <span class="k">def</span> <span class="nf">layout</span> <span class="o">=</span> <span class="n">DocType</span><span class="o">.</span><span class="n">html5</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">antiCsrfMeta</span><span class="p">}</span>
        <span class="p">{</span><span class="n">xitrumCss</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsDefaults</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">isDefined</span><span class="p">)</span> <span class="s2">&quot;My Site - &quot;</span> <span class="o">+</span> <span class="n">RVar</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">get</span> <span class="k">else</span> <span class="s2">&quot;My Site&quot;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="n">renderedView</span><span class="p">}</span>
        <span class="p">{</span><span class="n">jsForView</span><span class="p">}</span>
      <span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cookie">
<h2>Cookie<a class="headerlink" href="#cookie" title="Permalink to this headline">¶</a></h2>
<p>Bạn có thể đọc thêm Wikipedia về <a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_cookie">cookies</a>.</p>
<p>Trong một action, sử dụng <code class="docutils literal notranslate"><span class="pre">requestCookies</span></code>, <code class="docutils literal notranslate"><span class="pre">Map[String,</span> <span class="pre">String]</span></code>, để đọc cookie
gửi bởi trình duyệt.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requestCookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;myCookie&quot;</span><span class="p">)</span> <span class="n">match</span> <span class="p">{</span>
  <span class="n">case</span> <span class="kc">None</span>         <span class="o">=&gt;</span> <span class="o">...</span>
  <span class="n">case</span> <span class="n">Some</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Để gửi cookie đến trình duyệt, tạo một <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/DefaultCookie.html">DefaultCookie</a>
và thêm nó vào <code class="docutils literal notranslate"><span class="pre">responseCookies</span></code>, một <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> đã bao gồm <a class="reference external" href="http://netty.io/4.0/api/io/netty/handler/codec/http/Cookie.html">Cookie</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">val</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultCookie</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="n">cookie</span><span class="o">.</span><span class="n">setHttpOnly</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>  <span class="o">//</span> <span class="n">true</span><span class="p">:</span> <span class="n">JavaScript</span> <span class="n">cannot</span> <span class="n">access</span> <span class="n">this</span> <span class="n">cookie</span>
<span class="n">responseCookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</pre></div>
</div>
<p>Nếu bạn không set path của cookie bằng cách gọi <code class="docutils literal notranslate"><span class="pre">cookie.setPath(cookiePath)</span></code>,
path của nó sẽ là root path của site (<code class="docutils literal notranslate"><span class="pre">xitrum.Config.withBaseUrl(&quot;/&quot;)</span></code>).
Việc này để tránh việc trùng lặp cookie.</p>
<p>Để xóa cookie trên trình duyệt, gửi một cookie trùng tên và đặt max age của
cookie này là 0. Trình duyệt sẽ giải phóng cookie này ngay lập tức. Để báo với trình duyệt
xóa cookie khi tắt trình duyệt, đặt max age thành <code class="docutils literal notranslate"><span class="pre">Long.MinValue</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cookie</span><span class="o">.</span><span class="n">setMaxAge</span><span class="p">(</span><span class="n">Long</span><span class="o">.</span><span class="n">MinValue</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference external" href="http://mrcoles.com/blog/cookies-max-age-vs-expires/">Internet Explorer không hỗ trợ &quot;max-age&quot;</a>,
nhưng Netty có thể nhận diện và xuất ra &quot;max-age&quot; hoặc &quot;expires&quot; một cách chính xác. Đừng lo!</p>
<p>Trình duyệt sẽ không gửi các thuộc tính của cookie ngược trở lại server. Trình duyệt
sẽ <a class="reference external" href="http://en.wikipedia.org/wiki/HTTP_cookie#Cookie_attributes">chỉ gửi cặp name-value của cookie thôi</a>.</p>
<p>Nếu bạn muốn ngăn chặn các người dùng khác giả mạo cookie, sử dụng
<code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.toSecureUrlSafeBase64</span></code> và <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri.fromSecureUrlSafeBase64</span></code>.
Để biết thêm thông tin, xem <a class="reference internal" href="howto.html"><span class="doc">Làm sao mã hoá dữ liệu</span></a>.</p>
<div class="section" id="su-dung-ki-tu-trong-cookie">
<h3>Sử dụng kí tự trong cookie<a class="headerlink" href="#su-dung-ki-tu-trong-cookie" title="Permalink to this headline">¶</a></h3>
<p>Bạn không thể sử dụng <a class="reference external" href="http://stackoverflow.com/questions/1969232/allowed-characters-in-cookies">các ký đặc biệt trong cookie</a>.
Ví dụ, nếu bạn cần sử dụng kí tự UTF-8, bạn cần phải encode, bằng cách sử
dụng <code class="docutils literal notranslate"><span class="pre">xitrum.utill.UrlSafeBase64</span></code> hoặc <code class="docutils literal notranslate"><span class="pre">xitrum.util.SeriDeseri</span></code>.</p>
<p>Viết cookie:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span>
<span class="kn">import</span> <span class="nn">xitrum.util.UrlSafeBase64</span>

<span class="n">val</span> <span class="n">value</span>   <span class="o">=</span> <span class="s2">&quot;&quot;&quot;{&quot;identity&quot;:&quot;example@gmail.com&quot;,&quot;first_name&quot;:&quot;Alexander&quot;}&quot;&quot;&quot;</span>
<span class="n">val</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">noPaddingEncode</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="n">UTF_8</span><span class="p">))</span>
<span class="n">val</span> <span class="n">cookie</span>  <span class="o">=</span> <span class="n">new</span> <span class="n">DefaultCookie</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="n">encoded</span><span class="p">)</span>
<span class="n">responseCookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie</span><span class="p">)</span>
</pre></div>
</div>
<p>Đọc cookie:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">requestCookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">foreach</span> <span class="p">{</span> <span class="n">encoded</span> <span class="o">=&gt;</span>
  <span class="n">UrlSafeBase64</span><span class="o">.</span><span class="n">autoPaddingDecode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span><span class="o">.</span><span class="n">foreach</span> <span class="p">{</span> <span class="nb">bytes</span> <span class="o">=&gt;</span>
    <span class="n">val</span> <span class="n">value</span> <span class="o">=</span> <span class="n">new</span> <span class="n">String</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">CharsetUtil</span><span class="o">.</span><span class="n">UTF_8</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="s2">&quot;profile: &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="session">
<h2>Session<a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h2>
<p>Việc tương tác Session bao gồm lưu trữ, trả về dữ liệu, mã hóa, v.v. được làm tự động trong Xitrum.
Bạn không cần phải bận tâm về Session.</p>
<p>Trong action, bạn có thể sử dụng biến <code class="docutils literal notranslate"><span class="pre">session</span></code>, là một instance của
<code class="docutils literal notranslate"><span class="pre">scala.collection.mutable.Map[String,</span> <span class="pre">Any]</span></code>. Mọi thứ lưu trữ trong <code class="docutils literal notranslate"><span class="pre">session</span></code>
phải serializable.</p>
<p>Ví dụ, để đánh dấu một người dùng đã đăng nhập, bạn có để đặt username của người
dùng vào session:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">userId</span>
</pre></div>
</div>
<p>Sau đó, nếu bạn muốn kiểm tra người dùng đã đăng nhập hay chưa, chỉ cần kiểm tra
đã có username trong session hay chưa:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">isDefinedAt</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">))</span> <span class="n">println</span><span class="p">(</span><span class="s2">&quot;This user has logged in&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Việc lưu trữ user ID và lấy thông tin người dùng từ database mỗi lần truy cập thường
xuyên được sử dụng. Với cách này bạn sẽ luôn nhận được bản cập nhật thông tin người dùng
(bao gồm quyền và xác thực) ở mỗi lần truy cập.</p>
<div class="section" id="session-clear">
<h3>session.clear()<a class="headerlink" href="#session-clear" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://guides.rubyonrails.org/security.html#session-fixation">Với một dòng mã bạn có thể bảo vệ ứng xụng khỏi session fixation</a>.</p>
<p>Hãy đọc link trên đây để biết thêm về session fixation. Để ngăn chặn tấn công
bằng session fixation, trong action cho phép người dùng đăng nhập, gọi method
<code class="docutils literal notranslate"><span class="pre">session.clear()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@GET</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">LoginAction</span> <span class="n">extends</span> <span class="n">Action</span> <span class="p">{</span>
  <span class="k">def</span> <span class="nf">execute</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="n">session</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="o">//</span> <span class="n">Reset</span> <span class="n">first</span> <span class="n">before</span> <span class="n">doing</span> <span class="n">anything</span> <span class="k">else</span> <span class="k">with</span> <span class="n">the</span> <span class="n">session</span>
    <span class="n">session</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">userId</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Để thực hiện đăng xuất, cũng gọi method <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code>.</p>
</div>
<div class="section" id="sessionvar">
<h3>SessionVar<a class="headerlink" href="#sessionvar" title="Permalink to this headline">¶</a></h3>
<p>SessionVar, giống như RequestVar, là một cách làm cho session typesafe hơn.</p>
<p>Lấy một ví dụ, bạn muốn lưu trữ username vào session sau khi thực hiện đăng
nhập:</p>
<p>Khai báo session var:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xitrum.SessionVar</span>

<span class="nb">object</span> <span class="n">SVar</span> <span class="p">{</span>
  <span class="nb">object</span> <span class="n">username</span> <span class="n">extends</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sau khi đăng nhập thành công:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Hiển thị username:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">isDefined</span><span class="p">)</span>
  <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="p">{</span><span class="n">SVar</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">get</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span>
<span class="k">else</span>
  <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="p">{</span><span class="n">url</span><span class="p">[</span><span class="n">LoginAction</span><span class="p">]}</span><span class="o">&gt;</span><span class="n">Login</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Để xóa session var: <code class="docutils literal notranslate"><span class="pre">SVar.username.remove()</span></code></p></li>
<li><p>Để reset toàn bộ session: <code class="docutils literal notranslate"><span class="pre">session.clear()</span></code></p></li>
</ul>
</div>
<div class="section" id="luu-tru-session">
<h3>Lưu trữ session<a class="headerlink" href="#luu-tru-session" title="Permalink to this headline">¶</a></h3>
<p>Xitrum cung cấp 3 cách lưu trữ session.
Trong tệp <a class="reference external" href="https://github.com/xitrum-framework/xitrum-new/blob/master/config/xitrum.conf">config/xitrum.conf</a>
bạn có thể chọn các lưu trữ bạn muốn:</p>
<p>CookieSessionStore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Store sessions on client side</span>
<span class="n">store</span> <span class="o">=</span> <span class="n">xitrum</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">CookieSessionStore</span>
</pre></div>
</div>
<p>LruSessionStore:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simple in-memory server side session store</span>
<span class="n">store</span> <span class="p">{</span>
  <span class="s2">&quot;xitrum.local.LruSessionStore&quot;</span> <span class="p">{</span>
    <span class="n">maxElems</span> <span class="o">=</span> <span class="mi">10000</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Nếu bạn chạy một cụm nhiều máy chr, bạn có thể
<a class="reference external" href="https://github.com/xitrum-framework/xitrum-hazelcast">sử dụng Hazelcast để lưu trữ cluster-aware session</a>,</p>
<p>Lưu ý rằng khi bạn sử dụng CookieSessionStore hoặc Hazelcast, dữ liệu trong session
phải được serializable. Nếu bạn phải lưu trữ những thứ unserializable, sử dụng
LruSessionStore. Nếu bạn sử dụng LruSessionStore và vẫn muốn chạy một cụm nhiều
máy chủ, bạn phải sử dụng load balancer có hỗ trợ sticky sessions.</p>
<p>3 cách lưu trữ session trên đây đủ sử dụng trong các trường hợp thông thường.
Nếu bạn có một trường hợp đặc biệt và muốn sử dụng cách lưu trữ session riêng,
kế thừa
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/scope/session/SessionStore.scala">SessionStore</a>
hoặc
<a class="reference external" href="https://github.com/xitrum-framework/xitrum/blob/master/src/main/scala/xitrum/scope/session/ServerSessionStore.scala">ServerSessionStore</a>
và implement các abstract method.</p>
<p>Việc cấu hình có thể sử dụng một trong 2 cách:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="o">=</span> <span class="n">my</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">StoreClassName</span>
</pre></div>
</div>
<p>Hoặc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="p">{</span>
  <span class="s2">&quot;my.session.StoreClassName&quot;</span> <span class="p">{</span>
    <span class="n">option1</span> <span class="o">=</span> <span class="n">value1</span>
    <span class="n">option2</span> <span class="o">=</span> <span class="n">value2</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lưu trữ session ở cookie của client bất cứ khi nào có thể (serializable và
<a class="reference external" href="http://stackoverflow.com/questions/640938/what-is-the-maximum-size-of-a-web-browsers-cookies-key">nhỏ hơn 4KB dữ liệu</a>), it's more scalable.
Lưu trữ session ở phía server (trong bộ nhớ hoặc Database) chỉ khi cần thiết.</p>
<p>Good read:
<a class="reference external" href="http://www.technicalinfo.net/papers/WebBasedSessionManagement.html">Web Based Session Management - Best practices in managing HTTP-based client sessions</a>.</p>
</div>
<div class="section" id="luu-tru-session-o-client-hay-server">
<h3>Lưu trữ Session ở Client hay Server<a class="headerlink" href="#luu-tru-session-o-client-hay-server" title="Permalink to this headline">¶</a></h3>
<p>Có 2 hình thức lưu trữ session:</p>
<ul class="simple">
<li><p>Chỉ ở phía client</p></li>
<li><p>Kết hợp cả 2: client và server</p></li>
</ul>
<p>Với chỉ lưu trữ ở client:</p>
<ul class="simple">
<li><p>Dữ liệu trong session được lưu trữ trong cookie mã hóa ở phía client.</p></li>
<li><p>Phía server không cần phải lưu trữ bất cứ thứ gì.</p></li>
<li><p>Khi có một request truyền tới, server sẽ tiến hành giải mã dữ liệu.</p></li>
</ul>
<p>Kết hợp cả 2, client và server:</p>
<ul class="simple">
<li><p>Một session có 2 phần: session ID và session data.</p></li>
<li><p>Server lưu trữ dữ liệu trong session, theo cặp ID -&gt; data</p></li>
<li><p>ID cũng được lưu trữ trong cookie đã được mã hóa ở client.</p></li>
<li><p>Khi có một request truyền tới, server sẽ giải mã ID, và sử dụng ID để tìm data</p></li>
<li><p>Các này giống như sử dụng thẻ tín dụng. Số tiền không lưu trong thẻ tín dụng mà</p></li>
</ul>
<p>ở ID</p>
<p>Trong cả 2 cách, client phải lưu trữ một vài thứ trong cookie (dữ liệu được mã hóa
và ID được mã hóa). &quot;Lưu trữ session ở server&quot; có nghĩa là lưu trữ dữ liệu của
session ở phía server.</p>
</div>
</div>
<div class="section" id="object-vs-val">
<h2>object vs. val<a class="headerlink" href="#object-vs-val" title="Permalink to this headline">¶</a></h2>
<p>Sử dụng <code class="docutils literal notranslate"><span class="pre">object</span></code> thay vì <code class="docutils literal notranslate"><span class="pre">val</span></code>.</p>
<p><strong>Không làm như sau</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">object</span> <span class="n">RVar</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">title</span>    <span class="o">=</span> <span class="n">new</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
  <span class="n">val</span> <span class="n">category</span> <span class="o">=</span> <span class="n">new</span> <span class="n">RequestVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
<span class="p">}</span>

<span class="nb">object</span> <span class="n">SVar</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">username</span> <span class="o">=</span> <span class="n">new</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">String</span><span class="p">]</span>
  <span class="n">val</span> <span class="n">isAdmin</span>  <span class="o">=</span> <span class="n">new</span> <span class="n">SessionVar</span><span class="p">[</span><span class="n">Boolean</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Đoạn code trên là đúng cú pháp và sẽ được biên dịch nhưng không chạy, bởi vì các
Var bản thân chúng sử dụng class name để tìm kiếm. Khi sử dụng <code class="docutils literal notranslate"><span class="pre">val</span></code>, <code class="docutils literal notranslate"><span class="pre">title</span></code>
và <code class="docutils literal notranslate"><span class="pre">category</span></code> sẽ có chung class name &quot;xitrum.RequestVar&quot;. Tương tự với <code class="docutils literal notranslate"><span class="pre">username</span></code>
và <code class="docutils literal notranslate"><span class="pre">isAdmin</span></code>.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Scopes</a><ul>
<li><a class="reference internal" href="#request">Request</a><ul>
<li><a class="reference internal" href="#cac-loai-parameter">Các loại parameter</a></li>
<li><a class="reference internal" href="#truy-xuat-cac-parameter">Truy xuất các parameter</a></li>
<li><a class="reference internal" href="#at">&quot;at&quot;</a></li>
<li><a class="reference internal" href="#atjson">&quot;atJson&quot;</a></li>
<li><a class="reference internal" href="#requestvar">RequestVar</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cookie">Cookie</a><ul>
<li><a class="reference internal" href="#su-dung-ki-tu-trong-cookie">Sử dụng kí tự trong cookie</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session">Session</a><ul>
<li><a class="reference internal" href="#session-clear">session.clear()</a></li>
<li><a class="reference internal" href="#sessionvar">SessionVar</a></li>
<li><a class="reference internal" href="#luu-tru-session">Lưu trữ session</a></li>
<li><a class="reference internal" href="#luu-tru-session-o-client-hay-server">Lưu trữ Session ở Client hay Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#object-vs-val">object vs. val</a></li>
</ul>
</li>
</ul>

  <h4>Chủ đề trước</h4>
  <p class="topless"><a href="flash.html"
                        title="chương trước ">Cung cấp flash socket policy file</a></p>
  <h4>Chủ đề tiếp</h4>
  <p class="topless"><a href="validation.html"
                        title="chương tiếp">Validation</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/scopes.rst.txt"
            rel="nofollow">Hiển thị mã nguồn</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Thực hiện" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Điều hướng</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Chỉ mục chung"
             >chỉ mục</a></li>
        <li class="right" >
          <a href="validation.html" title="Validation"
             >xem tiếp</a> |</li>
        <li class="right" >
          <a href="flash.html" title="Cung cấp flash socket policy file"
             >xem lại</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Tài liệu Xitrum Scala Web Framework Guide 3.30.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Scopes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Ngoc Dao.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>